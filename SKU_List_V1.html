<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Etsy Listings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0a0a0a; color:#eee;}
    header { position: sticky; top:0; background:#111; border-bottom:1px solid #222; padding:10px 16px; display:flex; gap:8px; align-items:center; z-index:10;}
    .btn { background:#2962ff; color:#fff; border:0; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600;}
    .btn:disabled { opacity:.6; cursor:default;}
    .btn.secondary { background:#333; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:12px; padding:16px; }
    .card { background:#121212; border:1px solid #222; border-radius:14px; overflow:hidden; display:flex; flex-direction:column; }
    .thumb { width:100%; aspect-ratio: 1 / 1; object-fit:cover; background:#151515; }
    .meta { padding:12px; display:flex; flex-direction:column; gap:6px; }
    .title { font-size:14px; line-height:1.3; color:#fafafa; font-weight:600; }
    .sku { font-size:12px; color:#bbb; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a2a2a; color:#cfcfcf; }
    .status { margin-left:auto; font-size:12px; color:#9ad; }
    footer { position: sticky; bottom:0; background:#111; border-top:1px solid #222; padding:10px 16px; display:flex; gap:8px; align-items:center; }
    .pagebox { margin-left:auto; color:#aaa; }
    input[type="number"]{ background:#181818; color:#ddd; border:1px solid #2a2a2a; border-radius:8px; padding:8px; width:90px;}
    .search { flex: 1; }
    .search input { width:100%; background:#181818; color:#ddd; border:1px solid #2a2a2a; border-radius:8px; padding:10px 12px; }
  </style>
</head>
<body>

  <header>
    <button id="connectEtsyBtn" class="btn">Connect Etsy</button>
    <button id="refreshBtn" class="btn secondary">Refresh</button>

    <div class="search">
      <input id="searchInput" placeholder="Filter by titleâ€¦ (client-side)" />
    </div>

    <span id="authStatus" class="status">Not connected</span>
  </header>

  <main id="listContainer" class="grid" aria-live="polite"></main>

  <footer>
    <button id="prevBtn" class="btn secondary">Prev</button>
    <button id="nextBtn" class="btn">Next</button>
    <span class="pagebox">
      Page <span id="pageNum">1</span>
      &nbsp;â€¢&nbsp; Page size
      <input id="pageSize" type="number" min="1" max="100" value="100" />
    </span>
  </footer>

<script>
/** ============ Hard domain binding ============ */
const ORIGIN = "https://sku.goldenspike.app";
const functionsBaseUrl = ORIGIN + "/.netlify/functions";

/** ============ Token storage ============ */
const TOKEN_KEYS = {
  access : "access_token",
  refresh: "refresh_token",
  exp    : "expires_in",
  iat    : "issued_at"
};

function setTokens(tok){
  if (!tok) return;
  if (tok.access_token)  localStorage.setItem(TOKEN_KEYS.access, tok.access_token);
  if (tok.refresh_token) localStorage.setItem(TOKEN_KEYS.refresh, tok.refresh_token);
  if (tok.expires_in)    localStorage.setItem(TOKEN_KEYS.exp, tok.expires_in);
  if (tok.issued_at)     localStorage.setItem(TOKEN_KEYS.iat, tok.issued_at);
}
function getAccessToken(){ return localStorage.getItem(TOKEN_KEYS.access) || ""; }
function getRefreshToken(){ return localStorage.getItem(TOKEN_KEYS.refresh) || ""; }

function secondsUntilExpiry(){
  const exp = Number(localStorage.getItem(TOKEN_KEYS.exp)||0);
  const iat = Number(localStorage.getItem(TOKEN_KEYS.iat)||0);
  if (!exp || !iat) return 0;
  const now = Math.floor(Date.now()/1000);
  return (iat + exp) - now;
}

let __refreshTimer = null;
function scheduleTokenRefresh(){
  clearTimeout(__refreshTimer);
  const sec = Math.max(5, secondsUntilExpiry() - 90);
  __refreshTimer = setTimeout(refreshAccessToken, sec*1000);
}

async function refreshAccessToken(){
  const refresh_token = getRefreshToken();
  if (!refresh_token) return;
  const r = await fetch(`${functionsBaseUrl}/refreshEtsyToken`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ refresh_token })
  });
  const data = await r.json();
  if (r.ok){
    const issued_at = Math.floor(Date.now()/1000);
    setTokens({ ...data, issued_at });
    scheduleTokenRefresh();
    setAuthBadge();
  } else {
    console.warn("Refresh failed", data);
  }
}

/** ============ OAuth helpers (match design.html pattern) ============ */
function generateRandomString(length = 64){
  const charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
  let s=""; const rnd = crypto.getRandomValues(new Uint8Array(length));
  for (let i=0;i<length;i++) s += charset[rnd[i] % charset.length];
  return s;
}
async function generateCodeChallenge(codeVerifier){
  const data = new TextEncoder().encode(codeVerifier);
  const digest = await crypto.subtle.digest("SHA-256", data);
  let b64 = btoa(String.fromCharCode(...new Uint8Array(digest)));
  return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}

let __oauthInFlight = false;
async function startOAuth(reason = "manual"){
  if (__oauthInFlight) return;
  __oauthInFlight = true;
  try {
    const codeVerifier = generateRandomString(64);
    localStorage.setItem("etsy_code_verifier", codeVerifier);
    const codeChallenge = await generateCodeChallenge(codeVerifier);

    // Same CLIENT_ID style as design.html
    const CLIENT_ID  = "k75zdspz4r99txpqdji7i2em";
    const redirectUri = ORIGIN; // Etsy returns to https://sku.goldenspike.app
    const scope      = "listings_w listings_r transactions_r transactions_w";
    const state      = `reconnect_${Date.now()}_${reason}`;

    const etsyAuthUrl =
      "https://www.etsy.com/oauth/connect?response_type=code" +
      "&client_id=" + CLIENT_ID +
      "&redirect_uri=" + encodeURIComponent(redirectUri) +
      "&scope=" + encodeURIComponent(scope) +
      "&state=" + encodeURIComponent(state) +
      "&code_challenge=" + encodeURIComponent(codeChallenge) +
      "&code_challenge_method=S256";

    window.location.href = etsyAuthUrl;
  } catch (e) {
    console.error("OAuth boot failed:", e);
    __oauthInFlight = false;
  }
}

/** ============ API wrapper ============ */
async function apiFetch(path, init={}){
  const headers = new Headers(init.headers || {});
  const tok = getAccessToken();
  if (tok) headers.set("Access-Token", tok);
  return fetch(`${functionsBaseUrl}${path}`, { ...init, headers });
}

/** ============ Listings UI ============ */
const listContainer = document.getElementById("listContainer");
const pageNumEl     = document.getElementById("pageNum");
const pageSizeEl    = document.getElementById("pageSize");
const searchInput   = document.getElementById("searchInput");
const authStatusEl  = document.getElementById("authStatus");
const prevBtn       = document.getElementById("prevBtn");
const nextBtn       = document.getElementById("nextBtn");
const refreshBtn    = document.getElementById("refreshBtn");
const connectBtn    = document.getElementById("connectEtsyBtn");

let page = 1;
let lastBatch = [];

function setAuthBadge(){
  authStatusEl.textContent = getAccessToken() ? "Connected" : "Not connected";
}

function titlePassesFilter(t){
  const q = searchInput.value.trim().toLowerCase();
  if (!q) return true;
  return String(t||"").toLowerCase().includes(q);
}

function renderListings(items){
  listContainer.innerHTML = "";
  for (const it of items){
    if (!titlePassesFilter(it.title)) continue;

    const img = document.createElement("img");
    img.className = "thumb";
    img.alt = it.title || "Listing image";
    img.src = it.primary_image || "";

    const meta = document.createElement("div");
    meta.className = "meta";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = it.title || "(untitled)";

    const sku = document.createElement("div");
    sku.className = "sku";
    const firstSku = (Array.isArray(it.skus) && it.skus.length) ? it.skus[0] : "";
    sku.textContent = firstSku ? `SKU: ${firstSku} (Variant 1)` : "SKU: â€”";

    const row = document.createElement("div");
    row.className = "row";
    const idPill = document.createElement("span");
    idPill.className = "pill";
    idPill.textContent = `#${it.listing_id}`;
    const pricePill = document.createElement("span");
    pricePill.className = "pill";
    if (it.price) pricePill.textContent = `${it.price.amount/100} ${it.price.currency_code}`;
    row.appendChild(idPill);
    if (it.price) row.appendChild(pricePill);

    // ðŸ”¹ Edit SKUs button
    const editBtn = document.createElement("button");
    editBtn.className = "btn secondary";
    editBtn.textContent = "Edit SKUs";
    editBtn.style.marginLeft = "auto";
    editBtn.addEventListener("click", () => openSkuEditor(it));
    row.appendChild(editBtn);

    // ðŸ”¹ Generate button
    const genBtn = document.createElement("button");
    genBtn.className = "btn";
    genBtn.textContent = "Generate";
    genBtn.addEventListener("click", () => generateAndSaveSku(it, genBtn));
    row.appendChild(genBtn);

    meta.appendChild(title);
    meta.appendChild(sku);
    meta.appendChild(row);

    const card = document.createElement("div");
    card.className = "card";
    card.appendChild(img);
    card.appendChild(meta);
    // ðŸ”¹ SKU editor container (hidden until opened)
    const editor = document.createElement("div");
    editor.className = "meta";
    editor.style.display = "none";
    editor.dataset.role = "sku-editor";
    card.appendChild(editor);

    listContainer.appendChild(card);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SKU Editor helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchInventoryDetail(listingId){
  const r = await apiFetch(`/etsyListingInventoryDetailProxy?listingId=${encodeURIComponent(listingId)}`);
  if (!r.ok) throw new Error(`Failed to fetch inventory ${listingId}`);
  const js = await r.json();
  return Array.isArray(js.products) ? js.products : [];
}

function findCardFor(listingId){
  return [...listContainer.querySelectorAll(".card")]
    .find(c => c.querySelector(".pill")?.textContent === `#${listingId}`);
}

function buildSkuEditorDom(listing, products){
  const card   = findCardFor(listing.listing_id);
  const editor = card?.querySelector('[data-role="sku-editor"]');
  if (!editor) return;
  editor.innerHTML = "";

  const hdr = document.createElement("div");
  hdr.className = "title";
  hdr.textContent = "Edit SKU (Variant 1)";
  editor.appendChild(hdr);

  // Use only the first product (Variant 1)
  const p = (Array.isArray(products) && products.length) ? products[0] : { product_id: null, sku: "" };

  const row = document.createElement("div");
  row.className = "row";
  row.style.gap = "6px";
  row.style.alignItems = "center";

  const tag = document.createElement("span");
  tag.className = "pill";
  tag.textContent = "Variant 1";
  row.appendChild(tag);

  const input = document.createElement("input");
  input.type  = "text";
  input.value = p.sku || "";
  input.placeholder = "SKU";
  input.style.flex = "1";
  input.dataset.productId = p.product_id != null ? String(p.product_id) : "";
  input.className = "skuInput";
  input.maxLength = 64;
  row.appendChild(input);

  editor.appendChild(row);

  const actions = document.createElement("div");
  actions.className = "row";

  const cancel = document.createElement("button");
  cancel.className = "btn secondary";
  cancel.textContent = "Cancel";
  cancel.addEventListener("click", () => editor.style.display = "none");

  const save = document.createElement("button");
  save.className = "btn";
  save.textContent = "Save";
  save.addEventListener("click", async () => {
    const el = editor.querySelector(".skuInput");
    const item = { product_id: Number(el.dataset.productId), sku: el.value.trim() };
    save.disabled = true;
    try {
      const ok = await saveSkuUpdates(listing.listing_id, [item]); // only Variant 1
      if (ok){
        // Update visible SKU line on card
        listing.skus = [item.sku].filter(Boolean);
        const skuLine = card.querySelector(".sku");
        const firstSku = (Array.isArray(listing.skus) && listing.skus.length) ? listing.skus[0] : "";
        skuLine.textContent = firstSku ? `SKU: ${firstSku} (Variant 1)` : "SKU: â€”";
        editor.style.display = "none";
      }
    } catch (e){
      alert("Failed to update SKUs: " + e.message);
    } finally {
      save.disabled = false;
    }
  });

  actions.appendChild(cancel);
  actions.appendChild(save);
  editor.appendChild(actions);
}

async function openSkuEditor(listing){
  try {
    const products = await fetchInventoryDetail(listing.listing_id);
    buildSkuEditorDom(listing, products);
    const card = findCardFor(listing.listing_id);
    const editor = card?.querySelector('[data-role="sku-editor"]');
    if (editor) editor.style.display = "block";
  } catch (e){
    alert("Could not open SKU editor: " + e.message);
  }
}

async function saveSkuUpdates(listingId, items){
  const r = await apiFetch(`/etsyUpdateListingInventoryProxy`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ listing_id: Number(listingId), items })
  });
  if (!r.ok){
    const t = await r.text();
    throw new Error(`HTTP ${r.status}: ${t}`);
  }
  const js = await r.json();
  return !!js.ok;
}

async function fetchListingDescription(listingId){
  const r = await apiFetch(`/etsyListingGetProxy?listingId=${encodeURIComponent(listingId)}`);
  if (!r.ok) return "";
  const js = await r.json();
  // Etsy may return description as a long string; guard just in case
  return typeof js.description === "string" ? js.description : "";
}

function makeSkuFrom(title, listingId){
  const last4 = String(listingId).slice(-4);
  const firstWordMatch = String(title || "").match(/[A-Za-z0-9]+/);
  const raw = firstWordMatch ? firstWordMatch[0] : "SKU";
  const pretty = raw.charAt(0).toUpperCase() + raw.slice(1).toLowerCase();
  return `${pretty}_${last4}`;
}

async function fetchPrimaryImage(listingId){
  const r = await apiFetch(`/etsyListingImagesProxy?listingId=${encodeURIComponent(listingId)}`);
  if (!r.ok) return "";
  const js = await r.json();
  let best = null;
  if (Array.isArray(js.results) && js.results.length){
    best = js.results.find(x => x.is_primary) ||
           js.results.sort((a,b) => (a.rank||999) - (b.rank||999))[0] ||
           js.results[0];
  }
  return best?.url_fullxfull || best?.url_570xN || "";
}

async function fetchSkus(listingId){
  const r = await apiFetch(`/etsyListingInventoryProxy?listingId=${encodeURIComponent(listingId)}`);
  if (!r.ok) return [];
  const js = await r.json();
  return js.skus || [];
}

async function* pLimit(iterable, concurrency=6, worker){
  const queue = [...iterable]; const running = new Set();
  while (queue.length || running.size){
    while (queue.length && running.size < concurrency){
      const item = queue.shift();
      const p = Promise.resolve(worker(item)).finally(()=>running.delete(p));
      running.add(p);
    }
    if (running.size) yield await Promise.race(running);
  }
}

async function loadPage(p=1){
  const limit = Math.min(100, Math.max(1, Number(pageSizeEl.value||100)));
  const offset = (p-1) * limit;
  pageNumEl.textContent = String(p);

  const token = getAccessToken();
  if (!token){
    listContainer.innerHTML = `<div class="card"><div class="meta"><div class="title">Please connect Etsy first.</div></div></div>`;
    return;
  }

  const r = await apiFetch(`/etsyShopListingsProxy?limit=${limit}&offset=${offset}&state=active`);
  if (!r.ok){
    const t = await r.text();
    listContainer.innerHTML = `<div class="card"><div class="meta"><div class="title">Error loading listings: ${r.status}</div><div class="sku">${t}</div></div></div>`;
    return;
  }
  const js = await r.json();
  const raw = Array.isArray(js.results) ? js.results : (Array.isArray(js) ? js : []);

  const base = raw.map(x => ({
    listing_id: x.listing_id,
    title     : x.title,
    price     : x.price,
    primary_image: "",
    skus: []
  }));

  const jobs = base.map(item => item);
  for await (const done of pLimit(jobs, 6, async (item) => {
    const [img, skus] = await Promise.all([
      fetchPrimaryImage(item.listing_id),
      fetchSkus(item.listing_id)
    ]);
    item.primary_image = img;
    item.skus = (skus || []).slice(0, 1); // Variant 1 only
    return item;
  })) {
    // no-op; iteration fills in place
  }

  lastBatch = base;
  renderListings(lastBatch);

  prevBtn.disabled = p <= 1;
  nextBtn.disabled = raw.length < limit;
}

async function generateAndSaveSku(listing, btn){
  try {
    btn.disabled = true;
    // 1) Build SKU from TITLE ONLY
    const computedSku = makeSkuFrom(listing.title || "", listing.listing_id);

    // 2) Get Variant 1 product_id
    const products = await fetchInventoryDetail(listing.listing_id);
    const p0 = (Array.isArray(products) && products.length) ? products[0] : null;
    if (!p0 || p0.product_id == null) throw new Error("Missing Variant 1");

    // 3) Save (server enforces consistency across all variants)
    const ok = await saveSkuUpdates(listing.listing_id, [{ product_id: Number(p0.product_id), sku: computedSku }]);
    if (ok){
      listing.skus = [computedSku];
      const card = findCardFor(listing.listing_id);
      const skuLine = card?.querySelector(".sku");
      if (skuLine) skuLine.textContent = `SKU: ${computedSku} (Variant 1)`;
    }
  } catch (e){
    alert("Generate failed: " + e.message);
  } finally {
    btn.disabled = false;
  }
}

/** ============ Boot ============ */
function setAuthBadge(){ authStatusEl.textContent = getAccessToken() ? "Connected" : "Not connected"; }

document.addEventListener("DOMContentLoaded", async () => {
  // Handle OAuth returns
  const url = new URLSearchParams(location.search);

  // If we already have tokens in the URL (server redirect), store and clean URL
  const access_token  = url.get("access_token");
  const refresh_token = url.get("refresh_token");
  const expires_in    = url.get("expires_in");
  const issued_at     = url.get("issued_at");
  if (access_token && refresh_token && expires_in && issued_at){
    setTokens({ access_token, refresh_token, expires_in, issued_at });
    history.replaceState({}, "", ORIGIN + location.pathname); // clean query
  } else {
    // Standard OAuth code return â†’ pass code to the server for exchange
    const code = url.get("code");
    if (code){
      const v = localStorage.getItem("etsy_code_verifier");
      if (v){
        const qs = new URLSearchParams({ code, code_verifier: v, redirect_domain: "sku" });
        window.location.href = ORIGIN + "/.netlify/functions/exchangeToken?" + qs.toString();
        return;
      } else {
        console.error("No code verifier found in localStorage.");
      }
    }
  }

  setAuthBadge();

  document.getElementById("connectEtsyBtn").addEventListener("click", () => startOAuth("button"));
  document.getElementById("refreshBtn").addEventListener("click", () => loadPage(page));
  document.getElementById("prevBtn").addEventListener("click", () => { if (page>1){ page--; loadPage(page);} });
  document.getElementById("nextBtn").addEventListener("click", () => { page++; loadPage(page); });
  document.getElementById("pageSize").addEventListener("change", () => { page = 1; loadPage(page); });
  document.getElementById("searchInput").addEventListener("input", () => renderListings(lastBatch));

  if (getAccessToken()) loadPage(1);
});
</script>
</body>
</html>