<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Etsy Order & OAuth Integration</title>

  <!-- Materialize CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  >
  <style>
    /* Hide page initially for a fade-in effect */
    body {
      background-color: white;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0; /* hidden initially */
      transition: opacity 0s; /* fade-in controlled by JS */
    }

    /* Main UI Buttons */
    #connectEtsyBtn {
      position: absolute;
      left: 50px;
      top: 20px;
    }

    /* "Open Config" button */
    #openConfigBtn {
      position: absolute;
      left: 50px;
      top: 110px;
    }

    /* "Order Link" button */
    #orderLinkBtn {
      position: absolute;
      left: 120px;
      top: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      outline: none;
    }
    #orderLinkBtn img {
      width: 14px;
      height: 14px;
      display: block;
    }

    /* "Tracking Link" button */
    #trackingLinkBtn {
      position: absolute;
      left: 160px;
      top: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      outline: none;
      z-index: 9999;
      display: none; /* hidden by default */
    }
    #trackingLinkBtn img {
      width: 17px;
      height: 17px;
      display: block;
    }

    #etsyOrderNumber {
      position: absolute;
      left: 50px;
      top: 160px;
      margin: 0;
      padding: 0;
      line-height: 1.0;
      border: none;
      border-bottom: 1px solid #000;
      background: transparent !important;
      text-align: left;
      width: 250px; /* explicitly set => 250 */
      font-size: 1em;
      outline: none;
    }

    /* Photo Grid and Preview Boxes */
    #Photo_Grid {
      position: absolute;
      left: 400px;
      top: 160px;
      transform: scale(1.25);
      transform-origin: top left;
    }
    #photoGridContainer {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(2, auto);
      gap: 35px 5px;
    }
    .grid-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .preview-box {
      border: 1px solid black !important;
      background: #f9f9f9;
      width: 100%;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      user-select: none;
    }

    /* ====== PREVIEW-BOX OUTLINES (final) ============================= */

    /* Persistent selection ‚Üí 3 px orangered ring (sits just inside) */
    .preview-box.selected{
      outline:3px solid orangered;
      outline-offset:-3px;        /* hugs inner edge */
    }

    /* Hover  ‚Üí 3 px blue ring (always, even on selected tiles) */
    .preview-box:hover{
      box-shadow:0 0 0 3px dodgerblue;   /* outer ring rides outside the outline */
    }

    .preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform-origin: center center;
      transition: transform 0.2s ease;
    }

    /* 16 text-box-absolute elements */
    .text-box-absolute {
      position: absolute;
      border: none !important;
      outline: none !important;
      background: transparent !important;
      text-decoration: none !important;
      box-shadow: none !important;
      font-size: 0.8em !important;
      width: 60px;
      height: 20px;
      text-align: left;
      line-height: 1.0;
      padding: 0 2px 2px 2px;
      box-sizing: border-box;
    }

    /* Order Details text area */
    #orderDetails {
      position: absolute;
      border: 1px solid black;
      width: 300px; /* explicitly => 300 */
      height: 175px; /* explicitly => 175 */
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      line-height: 1.5;
      resize: none;
      text-align: left;
      overflow-y: auto;
    }

    /* Ship To Address text area */
    #shipAddressBox {
      position: absolute;
      border: 1px solid black;
      width: 300px;
      height: 90px;
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      line-height: 1.4;
      resize: none;
      text-align: left;
      white-space: pre-wrap;
      overflow-y: auto;
    }

    /* Customer Message History text area */
    #customerMessageHistory {
      position: absolute;
      border: 1px solid black;
      width: 300px; /* => 300 */
      height: 175px; /* => 175 */
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      line-height: 1.5;
      resize: none;
      text-align: left;
      overflow-y: auto;
    }

    /* Single-line text boxes */
      #dateOrdered,
      #shipDate,
      #labelCreationDate,
      #employeeName,
      #completedByEmployee,
      #shippingPriority {
      position: absolute;
      width: 200px;
      height: 20px;
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
    }
    #dateOrdered {
      font-weight: bold !important;
      border-bottom: 1px solid black !important;
    }
    #shipDate {
      font-weight: bold !important;
      border-bottom: 1px solid black !important;
    }
    #employeeName {
      font-weight: bold;
    }
    #labelCreationDate {
      font-weight: bold !important;
      font-style: italic !important;
      border-bottom: 1px solid black !important;
    }
    #completedByEmployee {
      font-weight: bold !important;
      font-style: italic !important;
      border-bottom: 1px solid black !important;
    }

    /* Title texts */
    #titleOrderDate,
    #titleOrderDate2,
    #titleShipDate,
    #titleOrderDetails,
    #titleBritesMessages,
    #titlePurchasedItems,
    #titleOrderNumber {
      position: absolute;
      font-size: 0.7em;
      margin: 0;
      padding: 0;
    }



    #titleOrderDate2 {
      font-weight: bold;
    }
    #titleOrderCompletedOn,
    #titleOrderCompletedBy,
    #titleSignedInAs {
      position: absolute;
      font-size: 0.7em;
      margin: 0;
      padding: 0;
    }
    #titleOrderCompletedOn {
      left: 50px;
      top: 460px;
    }
    #titleOrderCompletedBy {
      left: 50px;
      top: 480px;
    }
    #titleSignedInAs {
      left: 50px;
      top: 500px;
    }

    /* Configuration Modal styling */
    #configModal.modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      height: auto !important;
      max-height: 70vh !important;
      width: auto !important;
      max-width: 650px !important;
      overflow-y: scroll !important;
    }

    /* "Signature Box" */
    #signatureBox {
      position: absolute;
      left: 400px;
      top: 360px;
      width: 50px;
      height: 25px;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      user-select: none;
      border-bottom: 1px solid black !important;
    }

    /* shipping title style */
    #titleShipping{
      font-size:1.65em !important;
      font-weight: Bold !important;
    }

    #titleShipping{
    font-size:1.7em !important;
    font-weight:bold !important;
    text-decoration:none !important;   /* üîª kills underline */
    border-bottom:none !important;     /* in case it came from a border */
  }

    /*
     * Always-center the user login modal,
     * but use a relative container so we can move
     * the text/prompt inside with "Open Config."
     */
    #userLoginModal.modal {
  position: fixed !important;
  top: 35% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  width: 400px !important;
  height: 200px !important;
  margin: 0 !important;
  z-index: 9999 !important;
  overflow: hidden !important; /* or 'auto' if you prefer scrolling */
}

  #titleShippingPriority {
    position: absolute;
    font-size: 0.7em;
    margin: 0;
    padding: 0;
  }

#userLoginModalContainer {
  position: static !important; /* so content doesn‚Äôt shrink weirdly */
  height: auto !important;
  width: auto !important;
}

/* ‚§µÔ∏è hard-hide the signature box */
#signatureBox { display:none !important; }

/* ====== Brites chat stream =================================== */
    .msg-box{
      position:absolute;
      border:1px solid #000;
      background:#fafafa;
      font:14px/1.4 Arial, sans-serif;
      overflow-y:auto;
      white-space:pre-wrap;
      padding:1px;
    }
    .msg{margin:1px 0 !important; }
    .msg .meta{display:block;font-size:11px;opacity:1;margin-bottom:2px !important; }
    .msg.sent    {text-align:right;color:#1565c0;}
    .msg.received{text-align:left; color:#333;}

  </style>

  <!-- üÜï remove underline from the dropdown trigger -->
  <style id="dropdownNoUnderline">
    .select-dropdown.dropdown-trigger,
    .select-dropdown.dropdown-trigger:hover,
    .select-dropdown.dropdown-trigger:focus{
      text-decoration:none !important;
      border-bottom:none !important;
    }
    

  </style>

</head>

<body>
  <!-- WRAP SCREEN ONE CONTENT IN THIS CONTAINER -->
  <div id="screenOne">
    <button id="connectEtsyBtn" class="configurable btn waves-effect waves-light">Connect to Etsy</button>
    <button id="openConfigBtn" class="configurable btn waves-effect waves-light">Open Config</button>
    <button id="signOutBtn" class="configurable btn waves-effect waves-light">Sign Out</button>

    <!-- "Order Link" button -->
    <button id="orderLinkBtn" name="Order Link">
      <img src="assets/Globe.png" alt="Order Link Icon" />
    </button>

    <!-- "Tracking Link" button -->
    <button id="trackingLinkBtn" name="Tracking Link">
      <img src="assets/USPS.png" alt="Tracking Link Icon" />
    </button>

    <!-- Etsy Order Fields -->
    <input type="text" id="etsyOrderNumber" placeholder="Etsy Order Number" />

    <!-- Order Number Paste button -->
    <button id="pasteOrderBtn" class="btn"
            style="position:absolute; left:310px; top:160px;
                   width:65px; height:35px; line-height:35px;
                   font-size:0.8em; text-align:center;">
      Paste
    </button>

    <!-- Tracking Number Paste button -->
    <button id="pasteTrackingBtn" class="btn"
            style="position:absolute; left:410px; top:110px;
                   width:65px; height:35px; line-height:35px;
                   font-size:0.8em; text-align:center;">
      Paste
    </button>

    <!-- üü° anchor: immediately after <input id="shipDate" ‚Ä¶/> -->
    <input type="text" id="labelCreationDate"    readonly />
    <input type="text" id="completedByEmployee"  readonly />
    <!-- üÜï‚Äî‚Äî new draggable title -->
    <input id="titleShipping" type="text" value="Assembly_1"  readonly />
    <!-- ‚ñ≤ nothing else changes here -->

    <input type="text" id="shippingPriority" readonly />

    <!-- Photo Grid -->
    <div id="Photo_Grid">
      <div id="photoGridContainer">
        <div class="grid-cell">
          <div class="preview-box" id="previewCell0">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell1">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell2">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell3">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell4">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell5">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell6">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell7">Empty</div>
        </div>
      </div>
    </div>

    <!-- 16 text-box-absolute elements -->
    <input type="text" id="quantityCell0" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell1" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell2" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell3" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell4" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell5" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell6" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell7" class="text-box-absolute" readonly />

    <input type="text" id="metalCell0" class="text-box-absolute" readonly />
    <input type="text" id="metalCell1" class="text-box-absolute" readonly />
    <input type="text" id="metalCell2" class="text-box-absolute" readonly />
    <input type="text" id="metalCell3" class="text-box-absolute" readonly />
    <input type="text" id="metalCell4" class="text-box-absolute" readonly />
    <input type="text" id="metalCell5" class="text-box-absolute" readonly />
    <input type="text" id="metalCell6" class="text-box-absolute" readonly />
    <input type="text" id="metalCell7" class="text-box-absolute" readonly />

    <textarea id="orderDetails" readonly></textarea>
    <textarea id="shipAddressBox" readonly></textarea>

    <!-- ‚ñº‚ñº NEW COPY BUTTON ‚ñº‚ñº -->
    <button id="copyOrderDetailsBtn" class="btn"
            style="position:absolute; left:260px; top:162px;
                   width:50px; height:24px; font-size:0.65em;
                   display:flex; align-items:center; justify-content:center;
                   background-color:#555 !important; color:#fff; padding:0;">
      Copy
    </button>
    <!-- ‚ñ≤‚ñ≤ NEW COPY BUTTON ‚ñ≤‚ñ≤ -->
    <div id="customerMessageHistory" class="msg-box"></div>
    <input id="britesMsgInput"
       type="text"
       placeholder="Message"
       style="font-size:0.8em; width:100%;"/>

    <div id="titleOrderDate">Order Date:</div>
    <div id="titleOrderDate2" style="font-weight:bold;"></div>
    <div id="titleShipDate">Ship By:</div>
    <div id="titleSignedInAs">Signed In As:</div>
    <div id="titleShippingPriority">Shipping Priority</div>

    <div id="titleOrderDetails">Order Details:</div>
    <div id="titleBritesMessages">Brites Messages</div>
    <div id="titlePurchasedItems">Purchased Items</div>
    <div id="titleOrderNumber">Order Number</div>

    <input type="text" id="dateOrdered" readonly />
    <input type="text" id="shipDate" readonly />
    <input type="text" id="employeeName" placeholder="Employee Name" />

    <div id="signatureBox">Sig Box</div>

    <div id="configModal" class="modal">
      <div class="modal-content">
        <table class="striped" id="configTable">
          <thead>
            <tr>
              <th>Component Name</th>
              <th>Left (px)</th>
              <th>Top (px)</th>
              <th>Width (px)</th>
              <th>Height (px)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <a href="#!" id="saveConfigBtn" class="modal-close waves-effect waves-green btn">
          Save Config
        </a>
      </div>
    </div>

    <button id="goScreenTwoBtn" class="btn"
            style="position:absolute; left:180px; top:110px;
                   width:65px; height:24px; line-height:24px;
                   font-size:0.8em; text-align:center;">
      Send
    </button>

    <!-- ‚ñº‚ñº NEW: tracking / carrier / complete-order ‚ñº‚ñº -->
    <input id="trackingNumberInput"
           type="text"
           placeholder="Tracking #"
           style="position:absolute; left:260px; top:110px;
                  width:140px; height:24px; font-size:1.0em;" />

          <div id="carrierSelectWrap"
               style="position:absolute; left:410px; top:110px;
                      width:110px; height:24px;">
            <select id="carrierSelect"
                    style="width:100%; height:100%; font-size:0.75em;">
              <option value="" disabled selected>Carrier</option>
              <option value="chitchats">ChitChats</option>
              <option value="usps">USPS</option>
            </select>
          </div>

    <button id="completeOrderBtn" class="btn"
            style="position:absolute; left:530px; top:110px;
                   width:110px; height:24px; line-height:24px;
                   font-size:0.85em; text-align:center;">
      Complete Order
    </button>
    <!-- ‚ñ≤‚ñ≤ END new controls ‚ñ≤‚ñ≤ -->

  </div>

  <div id="secondaryContainer"></div>

  <!-- Brites chat image-viewer -->
  <div id="chatImgModal" class="modal">
    <div class="modal-content" style="padding:0;">
      <img id="chatImgModalImg" src="" style="width:100%;height:auto;display:block;">
    </div>
  </div>

  <!-- The user login modal -->
  <div id="userLoginModal" class="modal">
    <!-- A wrapper with position: relative, so children can be absolutely placed -->
    <div id="userLoginModalContainer" class="modal-content" style="position:relative;">
      <h5 id="loginModalTitle">User Log In</h5>
      <p id="loginModalPrompt">Please enter your 6-digit Employee Number:</p>
      <input
      type="text"
                   id="employeeNumberInput"
                   placeholder="000000"
                   maxlength="6"
                   inputmode="numeric"
                   autocomplete="one-time-code"
                   pattern="[0-9]{6}"
      />
    </div>
    <div id="loginModalFooter" class="modal-footer">
      <button id="employeeLoginBtn" class="btn">Log In</button>
    </div>
  </div>

  <!-- jQuery & Materialize -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"
  ></script>

  <!-- 1) Firebase loaded first, define db for global usage -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Firebase Storage (needed for image uploads) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBXhQLsYRa4i0bX1TPTRiElF9Zjy5vSHlA",
      authDomain: "gokudatabase.firebaseapp.com",
      projectId: "gokudatabase",
      storageBucket: "gokudatabase.firebasestorage.app",
      messagingSenderId: "1078662308113",
      appId: "1:1078662308113:web:41df0e5d229ff2af7a6cb0"
    };
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore(); // define globally
    firebase.auth().signInAnonymously()
      .then(()=>console.log("Anon auth ‚úî"))
      .catch(err=>console.error("Anon auth ‚ùå", err));
  </script>

  <script>
    /********** Global Variables **********/
    window.receiptIsGift = null;
    window.receiptGiftMessage = null;
    window.receiptGiftWrap = null;
    window.receiptGiftWrapPrice = null;
    window.receiptGiftMessageFrom = null;    
    window.orderName = "";
    window.orderStatus = "";
    window.orderIsShipped = "";
    window.cachedOrderItems = [];
    window.orderShippedTimestamp = null;
    window.orderShipments = [];
    window.currentTracking = null;
    window.currentCarrier = null;

    /* ‚îÄ‚îÄ‚îÄ helper: keep only one .selected box ‚îÄ‚îÄ‚îÄ */
    function highlightSelectedPreview(box){
      /* remove an earlier selection, if any */
      document.querySelectorAll(".preview-box.selected")
              .forEach(el => el.classList.remove("selected"));
      /* light up the newly clicked box */
      if(box) box.classList.add("selected");
    }

    /* helper: enforce vertical gaps WITHOUT touching left/right margins */
    function applyChatSpacing() {
      document.querySelectorAll("#customerMessageHistory .msg").forEach(el => {
        /* top & bottom only */
        el.style.setProperty("margin-top",    "5px", "important");
        el.style.setProperty("margin-bottom", "5px", "important");

        const meta = el.querySelector(".meta");
        if (meta) meta.style.setProperty("margin-bottom", "3px", "important");
      });
    }

    /* observe chat container and re-enforce spacing whenever nodes change */
    const chatContainer = document.getElementById("customerMessageHistory");
    if (chatContainer) {
      /* initial pass */
      applyChatSpacing();

  /* keep re-applying after any DOM mutations */
  new MutationObserver(applyChatSpacing)
    .observe(chatContainer, { childList: true, subtree: true });
}

    /* ===== CHAT TIMESTAMP util ========================================= */
    function formatChatTimestamp(date){
      return (date instanceof Date ? date : new Date(date))
        .toLocaleString("en-US",{
          month : "short",
          day   : "2-digit",
          hour  : "numeric",
          minute: "2-digit",
          hour12: true
        })
        .replace(/\s([ap])\.?m/i,(_,p)=>` ${p.toLowerCase()}m`); // ‚Üí ‚Äúpm‚Äù / ‚Äúam‚Äù
    }

    /* ===== utility: pleasant two-note chime ================================= */
    function playChime(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();

        // helper to schedule a note (freq in Hz, start offset in s)
        const note = (freq, when, dur = 0.18) =>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "sine";
          osc.frequency.value = freq;
          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.start(ctx.currentTime + when);
          osc.stop (ctx.currentTime + when + dur);

          // quick fade-out to avoid click
          gain.gain.setValueAtTime(0.6, ctx.currentTime + when);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + when + dur);
        };

        // WhatsApp-ish up-step: E6 ‚Üí A6
        note(1319, 0.00);   // E6
        note(1760, 0.20);   // A6
      }catch(err){
        console.warn("AudioContext error:", err);
      }
    }

// Strong normalization for all the weird label combos
function normalizeMetalLabel(raw){
  let metalSel = String(raw || "");

  // 0) kill noisy labels (even when smashed together)
  //    e.g. "Metal Choice / Necklace LengthGold - 20" ‚Üí "... Gold - 20"
  //    - split camelCase first so "LengthGold" ‚Üí "Length Gold"
  metalSel = metalSel.replace(/([a-z])([A-Z])/g, "$1 $2");

  // remove label heads
  metalSel = metalSel
    .replace(/\bmetal\s*choice\b\s*\/?/gi, "")
    .replace(/\bengraving\s*option\b\s*\/?/gi, "")
    .trim();

  // 1) strip add-ons / counts / bullets
  metalSel = metalSel
    .replace(/\+\s*engraving/gi, "")
    .replace(/\+\s*engrave/gi, "")
    .replace(/\b1-5\s*Characters\b/gi, "")
    .replace(/\b6-10\s*Characters\b/gi, "")
    .replace(/\b11\s*\+\s*Characters\b/gi, "")
    .replace(/\b1-5\s*¬∑\s*Character(?:s)?\b/gi, "")
    .replace(/\b6-10\s*¬∑\s*Character(?:s)?\b/gi, "")
    .replace(/\b11\+\s*¬∑\s*Character(?:s)?\b/gi, "")
    .replace(/[¬∑‚Ä¢]/g, " ")
    .replace(/\s{2,}/g, " ")
    .trim();

  // 2) remove "Necklace Length" (with or without separators), trailing sizes
  metalSel = metalSel
    .replace(/\bnecklace\s*length\b[\s\/:]*/gi, "")
    .replace(/\s*-\s*\d+(\.\d+)?\s*(?:["‚Ä≤‚Äù‚Äù])?$/g, "") // remove "- 20" or - 20" etc
    .trim();

  const norm = metalSel.toLowerCase();

  // 3) canonical mapping ‚Äî explicit beats generic
  if (/(?:14k\s*)?(?:rose\s*gold|rosegold|rose\s*gold\s*filled|rosegold\s*filled|rosefilled)\b/.test(norm)) {
    return "Rose Gold";
  }
  if (/(?:14k\s*)?(?:gold\s*filled|goldfilled)\b/.test(norm)) {
    return "Gold Filled";
  }
  if (/(?:color\s*)?sterling\s*silver\b|silv[ae]?r\b/.test(norm)) {
    return "Silver";
  }
  if (/\b14k\b/.test(norm)) {
    return "14K";
  }
  if (/\bgold\b/.test(norm)) {
    // ‚úÖ plain "gold" ‚Üí Gold (not Gold Filled)
    return "Gold";
  }
  return metalSel; // fallback (unmapped)
}


function metalToBadge(label){
  const canon = normalizeMetalLabel(label);
  switch ((canon || "").toLowerCase()){
    case "14k":        return "üü° 14K";
    case "rose gold":  return "üü†";
    case "silver":     return "‚ö™";
    case "gold filled":return "üü°";
    case "gold":       return "üü°";
    default:           return "";
  }
}

    /* Replace any &quot; entity with a plain single quote */
    function deQuote(s){
      return (s == null ? "" : String(s)).replace(/&quot;/g, '"');
    }

    /* globals for realtime listener */
    let chatUnsub = null;        // holds the active Firestore unsubscribe fn
    let firstBatch = true;       // suppress chime on initial load

    /* ‚îÄ‚îÄ‚îÄ realtime Brites chat listener (now supports images) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function startBritesListener(orderId){
      if(chatUnsub) chatUnsub();
      chatUnsub = db
        .collection("Brites_Orders").doc(orderId)
        .collection("messages").orderBy("timestamp","asc")
        .onSnapshot(snap=>{
          const box = document.getElementById("customerMessageHistory");
          if(!box) return;

          let html = "";

          /* buyer‚Äôs original note (if any) */
          if (window.buyerMessageText && window.buyerMessageText.length){
            const ts = formatChatTimestamp(new Date());
            html += `<div class="msg received">
                       <span class="meta">Customer ‚Ä¢ ${ts}</span>
                       ${escapeHtml(window.buyerMessageText)}
                     </div>`;
          }

          snap.forEach(doc=>{
            const d  = doc.data();
            const dt = formatChatTimestamp(d.timestamp?.toDate() || new Date());

            const emp = (document.getElementById("employeeName").value||"")
                         .trim().toLowerCase();
            const bubbleCls =
              (d.senderName && d.senderName.trim().toLowerCase()===emp)
                ? "sent" : "received";

            /* üîó image vs. text */
            if (d.imageUrl){
              html += `<div class="msg ${bubbleCls}">
                         <span class="meta">${d.senderName} ‚Ä¢ ${dt}</span>
                         <a href="#!" class="img-link" data-src="${d.imageUrl}">üì∑ Image</a>
                       </div>`;
            } else {
              html += `<div class="msg ${bubbleCls}">
                         <span class="meta">${d.senderName} ‚Ä¢ ${dt}</span>
                         <span>${escapeHtml(d.text)}</span>
                       </div>`;
            }
          });

          /* üîî chime after initial batch */
          if (!firstBatch && snap.docChanges().some(c=>c.type==="added")) playChime();
          firstBatch = false;

          box.innerHTML = html.replace(/&quot;/g, '"');
          box.scrollTop = box.scrollHeight;
          applyChatSpacing();
        });
    }
    /* basic XSS guard */
    function escapeHtml(str=""){
      return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",
                                         "\"":"&quot;","'":"&#039;"}[m]));
    }

    window.isEmployeeLoggedIn = false; // We'll use this to guard the real-time listener
        let lastScanProcessed = null;      // üîë remember most-recent scanned order

    /********************************************************
     * Base URL & Global Variables
     ********************************************************/
    const functionsBaseUrl = window.location.origin + "/.netlify/functions";

    /* ===== Etsy OAuth boot + auto-refresh wiring (match design/sorting) ===== */
    const TOKEN_KEYS = {
      access  : "access_token",
      refresh : "refresh_token",
      expires : "token_expires_at"   // epoch seconds
    };

    let __refreshPromise = null;  // single-flight guard

    function scheduleTokenRefresh(){
      clearTimeout(window.__etsyRefreshTimer);
      const exp = Number(localStorage.getItem(TOKEN_KEYS.expires) || 0);
      if (!exp){
        if (localStorage.getItem(TOKEN_KEYS.refresh)){
          window.__etsyRefreshTimer = setTimeout(refreshAccessToken, 55 * 60 * 1000);
        }
        return;
      }
      const now = Math.floor(Date.now()/1000);
      const leadSec = 120;
      const delayMs = Math.max(5000, (exp - now - leadSec) * 1000);
      window.__etsyRefreshTimer = setTimeout(refreshAccessToken, delayMs);
    }

    function setTokens({ access_token, refresh_token, expires_in, issued_at }){
      if (access_token)  localStorage.setItem(TOKEN_KEYS.access,  access_token);
      if (refresh_token) localStorage.setItem(TOKEN_KEYS.refresh, refresh_token);
      const now = Math.floor(Date.now()/1000);
      const iat = Number(issued_at || now);
      const exp = iat + Number(expires_in || 3600);
      localStorage.setItem(TOKEN_KEYS.expires, String(exp));
      scheduleTokenRefresh();
    }

    async function refreshAccessToken(){
      if (__refreshPromise) return __refreshPromise;
      const rt = localStorage.getItem(TOKEN_KEYS.refresh);
      if (!rt) return;
      __refreshPromise = (async () => {
        try{
          const resp = await fetch(`${functionsBaseUrl}/refreshEtsyToken`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh_token: rt })
          });
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const data = await resp.json();
          setTokens({
            access_token : data.access_token,
            // Etsy rotates refresh_token; if omitted, keep old
            refresh_token: data.refresh_token || rt,
            expires_in   : data.expires_in,
            issued_at    : data.issued_at || Math.floor(Date.now()/1000)
          });
          M.toast?.({ html: "Etsy token refreshed" });
          return true;
        }catch(err){
          console.warn("Token refresh failed:", err);
          // Clear & start headless OAuth (no button clicks)
          localStorage.removeItem(TOKEN_KEYS.access);
          localStorage.removeItem(TOKEN_KEYS.expires);
          await startOAuth("refresh-failed");
          throw err;
        }finally{
          __refreshPromise = null;
        }
      })();
      return __refreshPromise;
    }

    async function ensureFreshToken(){
      const exp = Number(localStorage.getItem(TOKEN_KEYS.expires) || 0);
      if (!exp) return;
      const now = Math.floor(Date.now()/1000);
      if (exp - now <= 120) await refreshAccessToken();
    }

    /* Resilient fetch against our Functions:
       - ensures token freshness
       - retries once on 401 after refresh
       - if still 401, kicks off headless OAuth and throws */
    async function apiFetch(path, init = {}){
      await ensureFreshToken();
      let token = localStorage.getItem(TOKEN_KEYS.access) || "";
      let resp  = await fetch(`${functionsBaseUrl}${path}`, {
        ...init,
        headers: { ...(init.headers || {}), "access-token": token }
      });
      if (resp.status === 401){
        try{
          await refreshAccessToken();
          token = localStorage.getItem(TOKEN_KEYS.access) || "";
          resp  = await fetch(`${functionsBaseUrl}${path}`, {
            ...init,
            headers: { ...(init.headers || {}), "access-token": token }
          });
        }catch(_) {}
      }
      if (resp.status === 401){
        localStorage.removeItem(TOKEN_KEYS.access);
        localStorage.removeItem(TOKEN_KEYS.expires);
        await startOAuth("401");
        throw new Error("Unauthorized");
      }
      return resp;
    }

    (function () {
      const url = new URLSearchParams(window.location.search);
    
      // Tokens returned by exchangeToken.js (access, refresh, expires_in, issued_at)
      const a = url.get("access_token");
      if (a){
        setTokens({
          access_token : a,
          refresh_token: url.get("refresh_token"),
          expires_in   : url.get("expires_in"),
          issued_at    : url.get("issued_at")
        });
        window.history.replaceState({}, document.title, window.location.pathname);
        M.toast?.({ html: "Connection Successful!" });
        return;
      }
    
      // Standard OAuth code return ‚Üí hand back to server for code‚Üítokens
      const code = url.get("code");
      if (code){
        const v = localStorage.getItem("etsy_code_verifier");
        if (v){
          const qs = new URLSearchParams({ code, code_verifier: v, redirect_domain: "assembly-1" });
          window.location.href = "/.netlify/functions/exchangeToken?" + qs.toString();
          return;
        }else{
          console.error("No code verifier found in localStorage.");
        }
      }
    
      // Page load without query: rehydrate or refresh or boot OAuth
      if (localStorage.getItem(TOKEN_KEYS.access)) {
        scheduleTokenRefresh();
      } else if (localStorage.getItem(TOKEN_KEYS.refresh)) {
        refreshAccessToken();
      } else {
        // No tokens at all ‚Üí start OAuth silently (like design/sorting)
        startOAuth("boot");
      }
    })();

    function generateRandomString(length){
      var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      var text = "";
      for(var i = 0; i < length; i++){
        text += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return text;
    }
    async function generateCodeChallenge(codeVerifier){
      var encoder = new TextEncoder();
      var data = encoder.encode(codeVerifier);
      var digest = await crypto.subtle.digest("SHA-256", data);
      var base64String = btoa(String.fromCharCode.apply(null, new Uint8Array(digest)));
      return base64String.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

     // Headless OAuth starter (no UI clicks needed)
    let __oauthInFlight = false;
    async function startOAuth(reason = "auto"){
      if (__oauthInFlight) return;
      __oauthInFlight = true;
      try{
        const codeVerifier = generateRandomString(64);
        localStorage.setItem("etsy_code_verifier", codeVerifier);
        const codeChallenge = await generateCodeChallenge(codeVerifier);
        const CLIENT_ID   = "k75zdspz4r99txpqdji7i2em";
        const redirectUri = "https://assembly-1.goldenspike.app";
        const scope       = "listings_w listings_r transactions_r transactions_w";
        const state       = `reconnect_${Date.now()}_${reason}`;
        const etsyAuthUrl =
          "https://www.etsy.com/oauth/connect?response_type=code" +
          "&client_id=" + CLIENT_ID +
          "&redirect_uri=" + encodeURIComponent(redirectUri) +
          "&scope=" + encodeURIComponent(scope) +
          "&state=" + encodeURIComponent(state) +
          "&code_challenge=" + encodeURIComponent(codeChallenge) +
          "&code_challenge_method=S256";
        window.location.href = etsyAuthUrl;
      }catch(e){
        console.error("OAuth boot failed:", e);
        __oauthInFlight = false;
      }
    }

    /*
     * Incorporate the new login modal elements in the config array so they're adjustable.
     */
      var configComponentIDs = [
        "connectEtsyBtn","openConfigBtn","signOutBtn","orderLinkBtn","trackingLinkBtn","etsyOrderNumber","Photo_Grid","quantityCell0","quantityCell1","quantityCell2","quantityCell3",
        "quantityCell4", "shippingPriority", "quantityCell5","quantityCell6","quantityCell7",
        "metalCell0","metalCell1","metalCell2","metalCell3",
        "metalCell4","metalCell5","metalCell6","metalCell7",
        "orderDetails", "shipAddressBox", "copyOrderDetailsBtn", "customerMessageHistory","britesMsgInput","dateOrdered","shipDate",
        "employeeName","trackingNumberInput","carrierSelectWrap","completeOrderBtn",
        "titleOrderDate","titleOrderDate2","titleShipDate",
        "titleSignedInAs",
        "titleOrderDetails","titleShippingPriority","titleBritesMessages","titlePurchasedItems","titleOrderNumber",
        "titleShipping",                // üÜï make ‚ÄúShipping‚Äù configurable
        "goScreenTwoBtn",
        /* Existing modal references */
        "userLoginModal",
        /* Newly added for positioning the login elements */
        "userLoginModalContainer",
        "pasteOrderBtn",
        "pasteTrackingBtn",
        "loginModalTitle",
        "loginModalPrompt",
        "employeeNumberInput",
        "loginModalFooter",
        "employeeLoginBtn"
      ];

    // Updated default positions block
    const defaultPositions = {
      connectEtsyBtn:       { left: 1062, top: 781,  width: 107, height: 35 },
      openConfigBtn:        { left: 1184, top: 781,  width: 132, height: 35 },
      orderLinkBtn:         { left: 639,  top: 127,   width: 30,  height: 30 },
      trackingLinkBtn:      { left: 134,  top: 248,  width: 15,  height: 16 },
      etsyOrderNumber:      { left: 11,   top: 7,    width: 282, height: 45 },
      Photo_Grid:           { left: 538,  top: 162,  width: 632, height: 272 },

      quantityCell0:        { left: 536,  top: 339,  width: 152, height: 45 },
      quantityCell1:        { left: 737,  top: 339,  width: 152, height: 45 },
      quantityCell2:        { left: 937,  top: 339,  width: 153, height: 45 },
      quantityCell3:        { left: 1136, top: 339,  width: 153, height: 45 },
      quantityCell4:        { left: 535,  top: 568,  width: 153, height: 45 },
      quantityCell5:        { left: 737,  top: 568,  width: 153, height: 45 },
      quantityCell6:        { left: 937,  top: 568,  width: 153, height: 45 },
      quantityCell7:        { left: 1136, top: 568,  width: 153, height: 45 },

      metalCell0:           { left: 537,  top: 354,  width: 153, height: 45 },
      metalCell1:           { left: 737,  top: 354,  width: 153, height: 45 },
      metalCell2:           { left: 937,  top: 354,  width: 153, height: 45 },
      metalCell3:           { left: 1136, top: 354,  width: 153, height: 45 },
      metalCell4:           { left: 536,  top: 583,  width: 153, height: 45 },
      metalCell5:           { left: 737,  top: 583,  width: 153, height: 45 },
      metalCell6:           { left: 937,  top: 583,  width: 153, height: 45 },
      metalCell7:           { left: 1136, top: 583,  width: 153, height: 45 },

      orderDetails:           { left: 10,   top: 162,  width: 300, height: 342 },
      shipAddressBox:         { left: 324,   top: 162,  width: 200, height: 186 },
      customerMessageHistory: { left: 10,   top: 577,  width: 300, height: 266 },
      britesMsgInput:         { left: 14, top: 543, width: 295, height: 23 },

      dateOrdered:          { left: 10,   top: 100,  width: 145, height: 30 },
      shipDate:             { left: 164,  top: 100,  width: 145, height: 30 },
      employeeName:         { left: 1226, top: 23,   width: 98, height: 30 },

      titleOrderDate:       { left: 10,   top: 82,   width: 99,  height: 25 },
      titleOrderDate2:      { left: 127,  top: 209,  width: 145, height: 15 },
      titleShipDate:        { left: 167,  top: 82,   width: 99,  height: 15 },
      titleSignedInAs:      { left: 1226, top: 7,    width: 75,  height: 15 },
      titleOrderDetails:    { left: 11,   top: 144,  width: 99,  height: 15 },
      titleBritesMessages:    { left: 10,   top: 518,  width: 95,  height: 15 },
      titlePurchasedItems:  { left: 538,  top: 135,   width: 99,  height: 15 },
      titleOrderNumber:     { left: 11,   top: 7,    width: 99,  height: 15 },

      goScreenTwoBtn:       { left: 245, top: 536,    width: 65, height: 31 },
      signatureBox:         { left: 624,  top: 19,   width: 105, height: 34 },

      // The modal elements:
      userLoginModal:       { left: 0,    top: 0,    width: 0,   height: 0 },
      userLoginModalContainer: { left:0,  top: 0,    width: 0,   height: 0 },
      loginModalTitle:      { left: 130,    top: 0,    width: 250,   height: 0 },
      loginModalPrompt:     { left: 40,    top: 90,    width: 325,   height: 0 },
      employeeNumberInput:  { left: 40,   top: 60,   width: 75, height: 35 },
      loginModalFooter:     { left: 20,    top: 0,    width: 250,   height: 0 },
      employeeLoginBtn:     { left: 130,   top: 150,   width: 100, height: 35 },
      trackingNumberInput:{ left:677, top:674, width:308, height:23 },
      carrierSelectWrap:  { left:539, top:664, width:107, height:23 },
      completeOrderBtn:    { left:678, top:730, width:300, height:65 },
      titleShipping:        { left: 700, top: 10, width: 200, height: 30 },
      copyOrderDetailsBtn: { left: 242, top: 165, width: 65, height: 35 },
      shippingPriority: { left: 324, top: 106, width: 200, height: 24 },
      titleShippingPriority: { left: 324, top: 82, width: 200, height: 15 },
      pasteOrderBtn:     { left: 296, top: 165, width: 65, height: 35 },
      pasteTrackingBtn:  { left: 822, top: 670, width: 65, height: 35 },
      signOutBtn:           { left: 1356,  top: 17, width: 103, height: 35 }

    };

    function loadPositions(){
      for(var i=0; i<configComponentIDs.length; i++){
        var id = configComponentIDs[i];
        var el = document.getElementById(id);
        if(!el) continue;

        var def = defaultPositions[id] || { left:0, top:0, width:0, height:0 };

        var left = localStorage.getItem("pos-"+id+"-left");
        var top  = localStorage.getItem("pos-"+id+"-top");
        var w    = localStorage.getItem("pos-"+id+"-width");
        var h    = localStorage.getItem("pos-"+id+"-height");

        if(left === null)  left = def.left;
        if(top === null)   top  = def.top;
        if(w === null)     w    = def.width;
        if(h === null)     h    = def.height;

        el.style.position = "absolute";
        el.style.left   = left + "px";
        el.style.top    = top  + "px";
        el.style.width  = w    + "px";
        el.style.height = h    + "px";
      }
    }

    function populateConfigTable(){
      var tbody = document.getElementById("configTable").querySelector("tbody");
      tbody.innerHTML = "";

      for(var i=0; i<configComponentIDs.length; i++){
        var id = configComponentIDs[i];
        var el = document.getElementById(id);
        if(!el) continue;

        var compName = (el.textContent && el.textContent.trim()) || (el.value && el.value.trim()) || id;
        var cs = window.getComputedStyle(el);

        var leftVal = (cs.left === "auto") ? 0 : parseInt(cs.left, 10);
        var topVal = (cs.top === "auto") ? 0 : parseInt(cs.top, 10);
        var widthVal = (cs.width === "auto") ? 0 : parseInt(cs.width, 10);
        var heightVal = (cs.height === "auto") ? 0 : parseInt(cs.height, 10);

        var row = document.createElement("tr");
        row.innerHTML = `
          <td>${compName}</td>
          <td><input type='number' value='${leftVal}' data-id='${id}' class='left-input'></td>
          <td><input type='number' value='${topVal}' data-id='${id}' class='top-input'></td>
          <td><input type='number' value='${widthVal}' data-id='${id}' class='width-input'></td>
          <td><input type='number' value='${heightVal}' data-id='${id}' class='height-input'></td>
        `;
        tbody.appendChild(row);

        row.querySelector(".left-input").addEventListener("input", function(){
          var tgt = document.getElementById(this.getAttribute("data-id"));
          if(tgt) tgt.style.left = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".top-input").addEventListener("input", function(){
          var tgt2 = document.getElementById(this.getAttribute("data-id"));
          if(tgt2) tgt2.style.top = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".width-input").addEventListener("input", function(){
          var tgt3 = document.getElementById(this.getAttribute("data-id"));
          if(tgt3) tgt3.style.width = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".height-input").addEventListener("input", function(){
          var tgt4 = document.getElementById(this.getAttribute("data-id"));
          if(tgt4) tgt4.style.height = parseInt(this.value, 10) + "px";
        });
      }
    }

    function saveConfiguration(){
      for(var i=0; i<configComponentIDs.length; i++){
        var id = configComponentIDs[i];
        var el = document.getElementById(id);
        if(el){
          var cs = window.getComputedStyle(el);
          var leftVal = parseInt(cs.left, 10) || 0;
          var topVal = parseInt(cs.top, 10) || 0;
          var widthVal = parseInt(cs.width, 10) || 0;
          var heightVal = parseInt(cs.height, 10) || 0;
          localStorage.setItem("pos-"+id+"-left", leftVal);
          localStorage.setItem("pos-"+id+"-top", topVal);
          localStorage.setItem("pos-"+id+"-width", widthVal);
          localStorage.setItem("pos-"+id+"-height", heightVal);
        }
      }
      console.log("Configuration saved.");
    }

      document.addEventListener("DOMContentLoaded", function () {
        M.AutoInit();

        // Fade in body
        document.body.style.opacity = 0;
        setTimeout(function () {
          loadPositions();
          document.body.style.opacity = 1;
        }, 250);

        // Show the ‚ÄúUser Log In‚Äù modal on load
        const userLoginModalElem = document.getElementById("userLoginModal");
        const userLoginModal = M.Modal.init(userLoginModalElem, { dismissible: false });

        // --- employee auto-restore + OAuth guard ---------------------------
        const oauthFlag  = localStorage.getItem("oauth_in_progress");
        const savedEmpID = localStorage.getItem("employee_id");
        const savedEmpNm = localStorage.getItem("employee_name");

        /* A. employee already verified ‚Äî stay logged-in */
        if (savedEmpID) {
          window.isEmployeeLoggedIn = true;
          document.getElementById("employeeName").value = savedEmpNm || "";
          startScannedOrderListener();

          // if we‚Äôre just back from OAuth, clear flag for NEXT real reload
          if (oauthFlag) setTimeout(() => localStorage.removeItem("oauth_in_progress"), 1000);
        }
        /* B. nobody stored ‚Üí show login (unless mid-OAuth) */
        else if (!oauthFlag) {
          userLoginModal.open();
        }

      // "Log In" button for employees
      var employeeLoginBtn = document.getElementById("employeeLoginBtn");
      var employeeNumberInput = document.getElementById("employeeNumberInput");
      
      /* ‚ï≠‚îÄ‚òÖ mask each typed digit with * while keeping raw value ‚òÖ‚îÄ‚ïÆ */
       (function(){
         const inp = employeeNumberInput;
         inp.dataset.raw = "";
         inp.addEventListener("keydown", e=>{
           if(e.key === "Backspace"){
             inp.dataset.raw = inp.dataset.raw.slice(0,-1);
           } else if(/^[0-9]$/.test(e.key)){
             if(inp.dataset.raw.length === 6){ e.preventDefault(); return; }
             inp.dataset.raw += e.key;
           } else if(e.key.length > 1){ return; }           /* ignore Ctrl, etc */
           else { e.preventDefault(); return; }             /* block non-digits */
           e.preventDefault();
           inp.value = "*".repeat(inp.dataset.raw.length);  /* render stars */
         });
       })();

      if(employeeLoginBtn){
        employeeLoginBtn.addEventListener("click", async function(){
          try {
             var empNumber = employeeNumberInput.dataset.raw || "";
             if(!/^[0-9]{6}$/.test(empNumber)){
               M.toast({html: "Please enter a valid 6-digit Employee Number!"});
              return;
            }
              var responseEN = await fetch(
                "/.netlify/functions/firebaseOrders?orderId=" +
                encodeURIComponent("Employee Numbers")
              );                         // ‚Üê closes fetch( ‚Ä¶ )

              if (!responseEN.ok) {
              M.toast({ html: "Error fetching Employee Numbers doc!" });
              return;
            }
            var resultEN = await responseEN.json();
            if(!resultEN.success || !resultEN.data){
              M.toast({ html: "No data found for Employee Numbers doc!" });
              return;
            }
            var docDataEN = resultEN.data;
            if(docDataEN[empNumber]){
              var nameFound = docDataEN[empNumber];
              M.toast({ html: "Welcome, " + nameFound + "!" });

              /* remember the current employee for future reloads */
              localStorage.setItem("employee_id",  empNumber);
              localStorage.setItem("employee_name", nameFound);

              document.getElementById("employeeName").value = nameFound;
              userLoginModal.close();
              window.isEmployeeLoggedIn = true;
              startScannedOrderListener();
            } else {
              M.toast({ html: "Employee # " + empNumber + " not found in DB!" });
            }
          } catch(errEN){
            console.error("Error in employee login flow:", errEN);
            M.toast({ html: "Error: " + errEN.message });
          }
        });
      }

      /* ‚îÄ‚îÄ Copy ORDER-FROM Name ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("copyOrderDetailsBtn")
        .addEventListener("click", () => {
          const val = document.getElementById("orderDetails").value || "";
          const m   = val.match(/ORDER FROM[:\s]+([^\r\n]+)/i); // capture name
          if (!m || !m[1].trim()) {
            M.toast({ html: "Name not found." });
            return;
          }
          const name = m[1].trim();
          navigator.clipboard.writeText(name)
            .then(()   => M.toast({ html: `Copied ${name} ‚úî` }))
            .catch(err => M.toast({ html: "Copy failed: " + err.message }));
        });

        /* ‚îÄ‚îÄ Paste: Order Number ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        document.getElementById("pasteOrderBtn")
          ?.addEventListener("click", async () => {
            try {
              const txt = (await navigator.clipboard.readText() || "").trim();
              if (!txt) { M.toast?.({ html: "Clipboard is empty" }); return; }
              const inp = document.getElementById("etsyOrderNumber");
              inp.value = txt;
              inp.dispatchEvent(new Event("input", { bubbles: true }));
              M.toast?.({ html: "Order # pasted" });
            } catch (err) {
              M.toast?.({ html: "Paste failed: " + err.message });
            }
          });

        /* ‚îÄ‚îÄ Paste: Tracking Number ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        document.getElementById("pasteTrackingBtn")
          ?.addEventListener("click", async () => {
            try {
              const txt = (await navigator.clipboard.readText() || "").trim();
              if (!txt) { M.toast?.({ html: "Clipboard is empty" }); return; }
              const inp = document.getElementById("trackingNumberInput");
              inp.value = txt;
              inp.dispatchEvent(new Event("input", { bubbles: true }));
              M.toast?.({ html: "Tracking # pasted" });
            } catch (err) {
              M.toast?.({ html: "Paste failed: " + err.message });
            }
          });

      /* Open Config ‚Üí show modal + disable live UI clicks           */
      document.getElementById("openConfigBtn").addEventListener("click", function(){
        populateConfigTable();
        var modalElem = document.getElementById("configModal");
        var instance  = M.Modal.getInstance(modalElem);
        instance.open();
        document.body.classList.add("configOpen");        // üîë flag ON
      });

      /* ===== Sign-Out ===== */
      document.getElementById("signOutBtn").addEventListener("click", () => {
        /* clear employee & login state */
        localStorage.removeItem("employee_id");
        localStorage.removeItem("employee_name");
        window.isEmployeeLoggedIn = false;
        if (chatUnsub) chatUnsub();                 // stop Brites listener
        /* show modal again */
        M.Modal.getInstance(document.getElementById("userLoginModal")).open();
        /* optional: blank out name field */
        document.getElementById("employeeName").value = "";
        M.toast({ html: "Signed out." });
      });

      /* Save Config ‚Üí close modal + re-enable live UI clicks        */
      document.getElementById("saveConfigBtn").addEventListener("click", function(){
        saveConfiguration();
        document.body.classList.remove("configOpen");     // üîë flag OFF
      });

      const connectEtsyBtn = document.getElementById("connectEtsyBtn");
      if (connectEtsyBtn){
        connectEtsyBtn.addEventListener("click", () => startOAuth("manual"));
      }

      var etsyOrderInput = document.getElementById("etsyOrderNumber");
      etsyOrderInput.addEventListener("keydown", async function(e){
        if(e.key === "Enter"){
          const orderNumber = etsyOrderInput.value.trim();
          const orderData = await pullEtsyOrderDetails(orderNumber);
          // üÜï Always pull ShipStation Ship-To immediately after loading order meta
          await loadShipToAddress(orderNumber);
          // üéÅ NEW ‚Äì also pull Gift Message from ShipStation
          await loadGiftMessage(orderNumber);

          if(orderData){
            await updateImageGrid(orderData);
            startBritesListener(orderNumber);
          }
            try {
              const respPD = await fetch("/.netlify/functions/firebaseOrders?orderId=" + encodeURIComponent(orderNumber));
              const resPD = await respPD.json();

            if(!respPD.ok){
              if(resPD.error && resPD.error.toLowerCase().includes("not found")){
                // Doc not found => clear fields quietly, no error
                document.getElementById("labelCreationDate").value = "";
                document.getElementById("completedByEmployee").value = "";
                document.getElementById("signatureBox").innerHTML = "Sig Box";

                // üÜï also clear Address Box
                const ab = document.getElementById("shipAddressBox");
                if (ab) ab.value = "";

                return;
              } else {
                throw new Error(resPD.error || "Unknown error from firebaseOrders function");
              }
            }

              // If we reach here => doc is found or newly created
              const docDataPD = resPD.data || {};
              const dbOrderNum = docDataPD["Order Number"];
              if (dbOrderNum !== orderNumber) {
                // M.toast({ html: "Order mismatch: doc has '" + dbOrderNum + "', expected '" + orderNumber + "'" });
                return;
              }

              /* ‚îÄ‚îÄ Brites message history ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
              if (typeof docDataPD["Brites Messages"] === "string") {
                document.getElementById("customerMessageHistory").innerText =
                  docDataPD["Brites Messages"];
                M.toast({ html: "Brites Messages loaded!" });
              } else {
                document.getElementById("customerMessageHistory").innerText = "";
              }

              /* ‚îÄ‚îÄ Shipping-label creation date ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
              if (docDataPD["Shipping Label Timestamps"]) {
                const dt = new Date(docDataPD["Shipping Label Timestamps"]);
                const lblDateEl = document.getElementById("labelCreationDate");
                if (!isNaN(dt.valueOf()) && lblDateEl) {
                  const monthNamesF2 = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                  const dd   = ("0" + dt.getDate()).slice(-2);
                  const mStr = monthNamesF2[dt.getMonth()];
                  const yyyy = dt.getFullYear();
                  const hh   = ("0" + dt.getHours()).slice(-2);
                  const mm   = ("0" + dt.getMinutes()).slice(-2);
                  const finalStr = dd + " " + mStr + " " + yyyy + ", " + hh + ":" + mm;
                  lblDateEl.value = finalStr;
                } else if (lblDateEl) {
                  lblDateEl.value = "";
                }
              } else {
                const lblDateEl = document.getElementById("labelCreationDate");
                if (lblDateEl) lblDateEl.value = "";
              }

              /* ‚îÄ‚îÄ Completed-by employee ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
              const dbEmpNameRaw = docDataPD["Employee Name"];
              let dbEmpName = "";
              if (typeof dbEmpNameRaw === "string") {
                dbEmpName = dbEmpNameRaw.trim();
              }
              const compEmpEl = document.getElementById("completedByEmployee");
              if (compEmpEl) compEmpEl.value = dbEmpName;

              /* ‚îÄ‚îÄ Signature box image ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
              const sigBox = document.getElementById("signatureBox");
              if (dbEmpName && sigBox) {
                const imageFile = encodeURIComponent(dbEmpName + ".jpg");
                sigBox.innerHTML = `<img src="/assets/${imageFile}"
                                     style="width:100%; height:100%; object-fit:cover;"
                                     alt="Signature for ${dbEmpName}">`;
              } else if (sigBox) {
                sigBox.innerHTML = "Sig Box";
              }
            } catch (errPD) {
              // Real error from network or code, not doc-not-found
              M.toast({ html: "Error: " + errPD.message });
              console.error("Failed to pull data from Firestore:", errPD);
            }
          }
        });

      document.getElementById("orderLinkBtn").addEventListener("click", function(){
        var baseUrl = "https://www.etsy.com/your/orders/sold?ref=seller-platform-mcnav&order_id=0000000000";
        var currentOrder = etsyOrderInput.value.trim();
        if(!currentOrder){
          console.log("No order number entered.");
          return;
        }
        var customLink = baseUrl.replace("0000000000", currentOrder);
        window.open(customLink, "_blank");
      });

      document.getElementById("trackingLinkBtn").addEventListener("click", function(){
        if(!window.currentTracking){
          console.log("No tracking number available.");
          return;
        }
        var templateUrl = "";
        if(window.currentCarrier && window.currentCarrier.toUpperCase() !== "USPS"){
          templateUrl = "https://chitchats.com/tracking/0000000000000";
          templateUrl = templateUrl.replace("0000000000000", window.currentTracking);
        } else {
          templateUrl = "https://tools.usps.com/go/TrackConfirmAction_input?qtc_tLabels1=0000000000000000000000000000000000";
          templateUrl = templateUrl.replace("0000000000000000000000000000000000", window.currentTracking);
        }
        window.open(templateUrl, "_blank");
      });

      var previewBoxes = document.querySelectorAll('.preview-box');
      previewBoxes.forEach(function(box){
        var isDragging = false;
        var lastX = 0;
        var lastY = 0;
        box.addEventListener('wheel', function(e){
          var img = box.querySelector('img');
          if(!img) return;
          e.preventDefault();
          var currentScale = parseFloat(img.dataset.scale) || 1;
          var offsetX = parseFloat(img.dataset.offsetX) || 0;
          var offsetY = parseFloat(img.dataset.offsetY) || 0;
          if(e.deltaY < 0){
            currentScale *= 1.1;
          } else {
            currentScale /= 1.1;
            if(currentScale <= 1){
              currentScale = 1;
              offsetX = 0;
              offsetY = 0;
            }
          }
          currentScale = Math.max(1, Math.min(4, currentScale));
          img.dataset.scale = currentScale;
          img.dataset.offsetX = offsetX;
          img.dataset.offsetY = offsetY;
          img.style.transform = "translate(" + offsetX + "px, " + offsetY + "px) scale(" + currentScale + ")";
        });
        box.addEventListener('mousedown', function(e){
          var img = box.querySelector('img');
          if(!img) return;
          var currentScale = parseFloat(img.dataset.scale) || 1;
          if(currentScale <= 1) return;
          e.preventDefault();
          isDragging = true;
          lastX = e.clientX;
          lastY = e.clientY;
        });
        box.addEventListener('mousemove', function(e){
          if(!isDragging) return;
          e.preventDefault();
          var img = box.querySelector('img');
          if(!img) return;
          var currentScale = parseFloat(img.dataset.scale) || 1;
          var offsetX = parseFloat(img.dataset.offsetX) || 0;
          var offsetY = parseFloat(img.dataset.offsetY) || 0;
          var dx = e.clientX - lastX;
          var dy = e.clientY - lastY;
          offsetX += dx;
          offsetY += dy;
          img.dataset.offsetX = offsetX;
          img.dataset.offsetY = offsetY;
          img.style.transform = "translate(" + offsetX + "px, " + offsetY + "px) scale(" + currentScale + ")";
          lastX = e.clientX;
          lastY = e.clientY;
        });
        box.addEventListener('mouseup', function(){
          isDragging = false;
        });
        box.addEventListener('mouseleave', function(){
          isDragging = false;
        });
      });

      /* === Drag-drop image upload + click-viewer ===================== */
      (function attachImageDnD(){
        const chatBox   = document.getElementById("customerMessageHistory");
        const orderInp  = document.getElementById("etsyOrderNumber");
        const empNameEl = document.getElementById("employeeName");
        if(!chatBox) return;

        /* drag-over glow */
        const onEnter = e=>{e.preventDefault(); chatBox.style.outline="2px dashed dodgerblue";};
        const onLeave = e=>{e.preventDefault(); chatBox.style.outline="";};
        ["dragenter","dragover"].forEach(x=>chatBox.addEventListener(x,onEnter));
        ["dragleave","drop"].forEach(x=>chatBox.addEventListener(x,onLeave));

        /* drop ‚Üí Storage ‚Üí Firestore */
        chatBox.addEventListener("drop", async e=>{
          e.preventDefault();
          const images = [...e.dataTransfer.files].filter(f=>f.type.startsWith("image/"));
          if(!images.length) return;

          const orderId = orderInp.value.trim();
          if(!orderId){ M.toast({html:"Enter order # first"}); return; }
          const staff   = (empNameEl.value||"Staff").trim();

          for (const file of images) {
            try {
              const path = `chatImages/${orderId}/${Date.now()}_${file.name}`;

              /* üöÄ one-liner: resumable PUT upload + URL */
              const url = await window.uploadViaResumable(path, file);

              await db.collection("Brites_Orders")
                .doc(orderId).collection("messages")
                .add({
                  imageUrl  : url,
                  text      : "Image attachment",
                  senderName: staff,
                  senderRole: "staff",
                  timestamp : firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch(err) {
              console.error("upload error:", err);
              M.toast({ html: "Upload failed: " + err.message });
            }
          }
        });

        /* click any .img-link ‚Üí modal */
        document.addEventListener("click", e=>{
          if(!e.target.classList.contains("img-link")) return;
          document.getElementById("chatImgModalImg").src = e.target.dataset.src;
          M.Modal.getInstance(document.getElementById("chatImgModal")).open();
        });

        /* one-time modal init */
        M.Modal.init(document.getElementById("chatImgModal"));
      })();

    /* =========================================================
     *  Send Brites Msg ‚Äì POST via Netlify function
     * =======================================================*/
    const sendBtn   = document.getElementById("goScreenTwoBtn");
    const newMsgInp = document.getElementById("britesMsgInput");

    if (sendBtn) {
      sendBtn.addEventListener("click", async () => {
        const orderId = document.getElementById("etsyOrderNumber").value.trim();
        const msgTxt  = (newMsgInp.value || "").trim();
        const staff   = (document.getElementById("employeeName").value || "Staff").trim();

        if (!orderId || !msgTxt) {
          M.toast({ html: "Enter order # and message." });
          return;
        }

        try {
          const resp = await fetch("/.netlify/functions/firebaseOrders", {
            method : "POST",
            headers: { "Content-Type": "application/json" },
            body   : JSON.stringify({
              orderNumber : orderId,
              newMessage  : msgTxt,
              employeeName: staff
            })
          });
          const json = await resp.json();
          if (!resp.ok || !json.success) throw new Error(json.error || "Server error");
          newMsgInp.value = "";                // clear box on success
        } catch (err) {
          console.error("Send error:", err);
          M.toast({ html: "Error: " + err.message });
        }
      });
    }

    /* =========================================================
     *  Complete Order ‚Äì POST tracking to Etsy (via Netlify)
     * =======================================================*/
    const completeBtn = document.getElementById("completeOrderBtn");
    const trackingInp = document.getElementById("trackingNumberInput");
    const carrierSel  = document.getElementById("carrierSelect");

    if (completeBtn) {
      completeBtn.addEventListener("click", async () => {
        const receiptId = document.getElementById("etsyOrderNumber").value.trim();
        const tracking  = (trackingInp.value || "").trim();
        const carrier   = carrierSel.value;          // "chitchats" | "usps"

        if (!receiptId) { M.toast({ html: "Enter order #"   }); return; }
        if (!tracking)  { M.toast({ html: "Enter tracking #" }); return; }
        if (!carrier)   { M.toast({ html: "Choose carrier"  }); return; }

        /* helper ‚Üí perform one POST via resilient apiFetch */
        const postTracking = () =>
          apiFetch("/trackOrderProxy", {
            method : "POST",
            headers: { "Content-Type": "application/json" },
            body   : JSON.stringify({ receiptId, tracking, carrier })
          });

        try {
          let resp         = await postTracking();
          let payload      = await resp.text();              // Etsy proxy returns raw text
          let errMsg       = "";

          /* 401s are auto-handled inside apiFetch (refresh + headless OAuth). */

          /* ‚îÄ‚îÄ forbidden (403) usually means missing shipping permission scope ‚îÄ‚îÄ */
          if (resp.status === 403) {
            errMsg = "Forbidden ‚Äì Etsy says this action isn‚Äôt allowed.";
          } else if (!resp.ok) {
            /* try to JSON-parse any error payload, else show raw text */
            try   { errMsg = JSON.parse(payload).error || "Server error"; }
            catch { errMsg = payload || "Server error"; }
          }

          if (errMsg) throw new Error(errMsg);

          /* üéâ success */
          M.toast({ html: "Etsy order marked complete üéâ" });
          trackingInp.value        = "";
          carrierSel.selectedIndex = 0;

        } catch (err) {
          console.error(err);
          M.toast({ html: "Complete failed: " + err.message });
        }
      });
    }

    async function updateImageGrid(data){
      var items = [];
      if(data.transactions && Array.isArray(data.transactions)){
        items = data.transactions;
      } else if(data.shipments && Array.isArray(data.shipments)){
        items = data.shipments;
      } else if(Array.isArray(data)){
        items = data;
      } else if(data.results && Array.isArray(data.results)){
        items = data.results;
      } else if(data.orders && Array.isArray(data.orders)){
        items = data.orders;
      } else if(typeof data === "object" && data !== null){
        for(var key in data){
          if(Array.isArray(data[key])){
            items = data[key];
            break;
          }
        }
      }
      window.cachedOrderItems = items;
      for(var i=0; i<8; i++){
        var cell = document.getElementById("previewCell" + i);
        var qtyBox = document.getElementById("quantityCell" + i);
        var metalBox = document.getElementById("metalCell" + i);
        if(cell){
          if(i < items.length){
            var item = items[i];
            try {
              var images = await fetchListingImages(item.listing_id);
              if(images && images.length > 0){
                cell.innerHTML =
                  '<img src="' + images[0].url_fullxfull + '" alt="Listing Image ' + i + '" data-scale="1" data-offsetX="0" data-offsetY="0">';
              } else {
                cell.innerHTML = "No images found";
              }
            } catch(errA){
              console.error("Error fetching listing " + item.listing_id + ": ", errA);
              cell.innerHTML = "Error loading image";
            }
            cell.style.cursor = "pointer";
            (function(idx){
              cell.onclick = function(){
                highlightSelectedPreview(this); // NEW ‚Üí 3 px orangered outline
                showItemDetails(idx);           // existing detail pop-up
              };
            })(i);
            if(qtyBox){
              var actualQty = (item.quantity != null) ? item.quantity : 0;
              qtyBox.value = " Quantity: " + actualQty;
            }
            if (metalBox) {
              metalBox.classList.add("detail-box"); // optional: match your example style

              let metalSel = "";

              if (item.variations && Array.isArray(item.variations)) {
                const acceptedMetalNames = [
                  "metal","metal choice","metal - engraving",
                  "metal colour","color","metal choice / engraving option",
                  // ‚Äî NEW ‚Äî
                  "number of discs / metal","number of discs/metal",
                  "metal/necklace length","metal/necklace length/engrave",
                  "number of discs / metal"
                ];

                /* ‚ë† try by variation label (includes 'color/colour' prefixes) */
                let metalVar = item.variations.find(v => {
                  const name = (v.formatted_name || "").trim().toLowerCase();
                  return (
                    name.includes("metal") ||
                    name.startsWith("color") || name.startsWith("colour") ||
                    acceptedMetalNames.includes(name)
                  );
                });

                /* ‚ë° if not found, sniff values for metal-y words */
                if (!metalVar) {
                  metalVar = item.variations.find(v => {
                    const val = (v.formatted_value || "").toLowerCase();
                    return /rose\s*gold|rosegold|rosefilled|gold\s*filled|goldfilled|\bgold\b|silv[ae]?r|sterling\s*silver|14k|white\s*gold/.test(val);
                  });
                }

                if (metalVar && metalVar.formatted_value) {
                  metalSel = String(metalVar.formatted_value);

                  /* strip engraving flags, character-count junk, collapse spaces */
                  metalSel = metalSel
                    .replace(/\+\s*engraving/gi, "")
                    .replace(/\+\s*engrave/gi, "")
                    .replace(/\b1-5\s*Characters\b/gi, "")
                    .replace(/\b6-10\s*Characters\b/gi, "")
                    .replace(/\b11\s*\+\s*Characters\b/gi, "")
                    .replace(/\b1-5\s*¬∑\s*Character(?:s)?\b/gi, "")
                    .replace(/\b6-10\s*¬∑\s*Character(?:s)?\b/gi, "")
                    .replace(/\b11\+\s*¬∑\s*Character(?:s)?\b/gi, "")
                    .replace(/\s{2,}/g, " ")
                    .trim();

                  /* split camelCase, drop length noise, normalize odd punctuation */
                  metalSel = metalSel.replace(/([a-z])([A-Z])/g, "$1 $2");
                  metalSel = metalSel
                    .replace(/\bnecklace\s*length\b[\s\/:]*/gi, "")
                    .replace(/\s*-\s*\d+(\.\d+)?\s*$/g, "")
                    .trim();
                  metalSel = metalSel.replace(/[¬∑‚Ä¢]/g, " ").trim();

                  const norm = metalSel.toLowerCase();

                  /* map to canonical labels */
                  if (/(?:14k\s*)?(?:rose\s*gold|rosegold|rose\s*gold\s*filled|rosegold\s*filled|rosefilled)\b/.test(norm)) {
                    metalSel = "Rose Gold";
                  } else if (/(?:14k\s*)?(?:gold\s*filled|goldfilled)\b/.test(norm)) {
                    metalSel = "Gold Filled";
                  } else if (/(?:color\s*)?sterling\s*silver\b|silv[ae]?r\b/.test(norm)) {
                    metalSel = "Silver";
                  } else if (/\b14k\b/.test(norm)) {
                    metalSel = "14K";
                  } else if (/\bgold\b/.test(norm)) {
                    // lone 'gold' ‚Üí default to Gold Filled per your rule
                    metalSel = "Gold Filled";
                  }

                  metalSel = metalSel.replace(/\s{2,}/g, " ").trim();
                }
              }

              metalBox.value = " Metal: " + deQuote(metalSel || "No Metal");
            }
          } else {
            cell.innerHTML = "Empty";
            cell.style.cursor = "default";
            cell.onclick = null;
            if(qtyBox) qtyBox.value = "";
            if(metalBox) metalBox.value = "";
          }
        }
      }
      if(items.length > 0){
        highlightSelectedPreview(document.getElementById("previewCell0")); // NEW
        showItemDetails(0);
      } else {
        document.getElementById("orderDetails").value = " ORDER DETAILS:\n\nNo items found.";
      }
    }

    function showItemDetails(index){
      if(!window.cachedOrderItems || !window.cachedOrderItems[index]){
        console.warn("No item at index:", index);
        return;
      }
      var item = window.cachedOrderItems[index];
      var details = "";
      if(window.orderName){
        details += " ORDER FROM: " + window.orderName + "\n";
      }
      if(window.orderStatus){
        details += " Order Status: " + window.orderStatus + "\n";
      }

      /*
       * REVISED CODE TO HIDE ONLY "Shipped!" TEXT
       * We still append "Shipping Status:" but skip the literal "Shipped!" if it equals "Shipped!"
       */
      if (window.orderIsShipped === "Shipped!") {
        // Only show "Shipping Status:" with no further text
        details += " Shipping Status:\n";
      } else if (typeof window.orderIsShipped === "string") {
        // For other string statuses, append them normally
        details += " Shipping Status: " + window.orderIsShipped + "\n";
      } else {
        // If there's no recognized "shipped" string or it's boolean false, fallback
        details += " Shipping Status:\n";
      }

      // If there's shipping data, we proceed as normal
      if(window.orderIsShipped === "Shipped!" && window.orderShipments && window.orderShipments.length > 0){
        var ship = window.orderShipments[0];
        if(ship.carrier_name){
          details += " Carrier Name: " + ship.carrier_name + "\n";
          window.currentCarrier = ship.carrier_name;
        }
        if(ship.tracking_code){
          details += " Tracking Number:\n" + ship.tracking_code + "\n\n";
          window.currentTracking = ship.tracking_code;
          if(window.currentCarrier && window.currentCarrier.toUpperCase() !== "USPS"){
            document.getElementById("trackingLinkBtn").querySelector("img").src = "assets/ChitChats.png";
          } else {
            document.getElementById("trackingLinkBtn").querySelector("img").src = "assets/USPS.png";
          }
        } else {
          details += "\n";
          window.currentTracking = null;
        }
        if(window.currentTracking){
          document.getElementById("trackingLinkBtn").style.display = "block";
        }
      } else {
        document.getElementById("trackingLinkBtn").style.display = "none";
      }

      details += " ORDER DETAILS:\n\n";
      if(item.title){
        var firstFour = item.title.trim().split(" ").slice(0,4).join(" ");
        details += " Title: " + firstFour + "\n";
      }
      if(item.sku){
        details += " SKU: " + item.sku + "\n";
      }
      if(item.variations && Array.isArray(item.variations)){
        var acceptedMetalNames2 = [
          "metal","metal choice","metal - engraving","metal colour",
          "color","metal choice / engraving option"
        ];
        var acceptedLengthNames2 = [
          "length","necklace length","metal/necklace length",
          "metal choice / necklace length","necklace length in inches"
        ];
        for(var j=0; j<item.variations.length; j++){
          var v2 = item.variations[j];
          if(!v2.formatted_name || !v2.formatted_value) continue;
          var nameLower2 = v2.formatted_name.trim().toLowerCase();
          var val2 = deQuote(v2.formatted_value.trim());
          if(nameLower2 === "personalization" && val2 === "Not requested on this item."){
            val2 = "Not Requested";
            details += " Personalization: " + val2 + "\n";
          } else if(acceptedMetalNames2.indexOf(nameLower2) >= 0){

            const mBadge = metalToBadge(val2);
            details += ` ${mBadge ? mBadge + " " : ""}Metal Choice: ${val2}\n`;

          } else if(acceptedLengthNames2.indexOf(nameLower2) >= 0){
            var lengthMap2 = {
              "14&quot;": "14 Inches",
              "16&quot;": "16 Inches",
              "18&quot;": "18 Inches",
              "20&quot;": "20 Inches",
              "14\"\"": "14 Inches",
              "16\"\"": "16 Inches",
              "18\"\"": "18 Inches",
              "20\"\"": "20 Inches"
            };
            if(lengthMap2[val2]){
              val2 = lengthMap2[val2];
            }
            details += " Item Length: " + val2 + "\n";
          } else {
            details += " " + v2.formatted_name + ": " + v2.formatted_value + "\n";
          }
        }
      }
      /* üéÅ  ‚îÄ‚îÄ Gift indicators ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      const giftIcon = "üéÅ";           // 20 % larger icon is not possible in a plain textarea,
                                       // but the emoji renders slightly bigger than text on most OSes.

      /* a. Marked-as-Gift */
      if (window.receiptIsGift === true){
        details += ` ${giftIcon} Marked as Gift: Yes\n`;
      } else if (window.receiptIsGift === false){
        details += " Marked as Gift: No\n";
      }

      /* b. Gift Message */
      if (window.receiptGiftMessage){
        details += ` ${giftIcon} Gift Message: ${window.receiptGiftMessage}\n`;
      }

      /* c. Gift Wrapping */
      if (window.receiptGiftWrap === true){
        details += ` ${giftIcon} Gift Wrapping: Yes\n`;
      } else if (window.receiptGiftWrap === false){
        details += " Gift Wrapping: No\n";
      }

      document.getElementById("orderDetails").value = deQuote(details);
    }

    async function fetchListingImages(listingId){
      const responseLI = await fetch("/.netlify/functions/etsyImages?listingId=" + listingId, {
        headers: { "access-token": localStorage.getItem("access_token") }
      });
      if(!responseLI.ok){
        throw new Error("Error fetching images for listing " + listingId + ": " + responseLI.statusText);
      }
      const dataLI = await responseLI.json();
      return dataLI.results;
    }

    function pullEtsyOrderDetails(orderNumber){
      console.log("Pulling Etsy order details for order number:", orderNumber);
      var token = localStorage.getItem("access_token");
      return fetch("/.netlify/functions/etsyOrderProxy?orderId=" + encodeURIComponent(orderNumber), {
        headers: { "access-token": token }
      })
      .then(function(r){ return r.json(); })
      .then(function(data){
        console.log("Etsy Order Data:", data);
        // Gift fields now sourced from Etsy receipt
        window.receiptIsGift = Boolean(data.is_gift);

        // üéÅ  Gift message now fetched from ShipStation (see loadGiftMessage)
        window.receiptGiftMessage     = "";
        window.receiptGiftMessageFrom = "";

        // Etsy receipts include gift_wrap_price as a money object { amount, divisor, currency_code }
        const gwp = data.gift_wrap_price;
        const gwAmount =
          (gwp && typeof gwp.amount === "number" && typeof gwp.divisor === "number" && gwp.divisor)
            ? (gwp.amount / gwp.divisor)
            : (typeof data.gift_wrap_price === "number" ? data.gift_wrap_price : null);
        window.receiptGiftWrapPrice =
          (typeof gwAmount === "number" && !Number.isNaN(gwAmount)) ? gwAmount : null;
        window.receiptGiftWrap =
          (typeof window.receiptGiftWrapPrice === "number" && window.receiptGiftWrapPrice > 0);

        /* store buyer note so the chat listener can render it (still from Etsy) */
        window.buyerMessageText  = (data.message_from_buyer || "").trim();
        window.orderShipments = data.shipments || [];
        var titleDate2 = document.getElementById("titleOrderDate2");
        titleDate2.textContent = "";
        if(data.name){
          window.orderName = data.name;
        } else {
          window.orderName = "";
        }
        if(data.status){
          window.orderStatus = data.status;
        } else {
          window.orderStatus = "";
        }
        if(data.is_shipped === true){
          window.orderIsShipped = "Shipped!";
        } else if(data.is_shipped === false){
          window.orderIsShipped = "Not Shipped";
        } else {
          window.orderIsShipped = "";
        }
        var foundStamp = null;
        if(data.shipped_timestamp && data.is_shipped === true){
          foundStamp = data.shipped_timestamp;
        }
        else if(data.transactions && Array.isArray(data.transactions) && data.transactions.length > 0
                && data.transactions[0].shipped_timestamp && data.is_shipped === true){
          foundStamp = data.transactions[0].shipped_timestamp;
        }
        window.orderShippedTimestamp = foundStamp;
        if(window.orderIsShipped === "Shipped!" && window.orderShippedTimestamp){
          var d4 = new Date(window.orderShippedTimestamp * 1000);
          var monthNames4 = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          var day4 = ("0" + d4.getDate()).slice(-2);
          var mStr4 = monthNames4[d4.getMonth()];
          var y4 = d4.getFullYear();
          titleDate2.textContent = "Shipped On: " + day4 + " " + mStr4 + " " + y4;
        }

        if(data.transactions && data.transactions.length > 0){
          var firstTrans = data.transactions[0];
          var monthNamesF = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          if(firstTrans.created_timestamp){
            var dT = new Date(firstTrans.created_timestamp * 1000);
            var ddT = ("0" + dT.getDate()).slice(-2);
            var mmT = monthNamesF[dT.getMonth()];
            var yyT = dT.getFullYear();
            document.getElementById("dateOrdered").value = " " + ddT + " " + mmT + " " + yyT;
          } else {
            document.getElementById("dateOrdered").value = "";
          }
          var shipEl = document.getElementById("shipDate");
          shipEl.style.color = "";
          if(firstTrans.expected_ship_date){
            var sTS = new Date(firstTrans.expected_ship_date * 1000);
            var sDay = ("0" + sTS.getDate()).slice(-2);
            var sMonth = monthNamesF[sTS.getMonth()];
            var sYear = sTS.getFullYear();
            shipEl.value = " " + sDay + " " + sMonth + " " + sYear;
            if(window.orderIsShipped === "Shipped!"){
              shipEl.style.color = "#006400";
            } else {
              var todayD = new Date();
              todayD.setHours(0,0,0,0);
              var dueDateD = new Date(sYear, sTS.getMonth(), sDay);
              dueDateD.setHours(0,0,0,0);
              if(dueDateD.getTime() === todayD.getTime()){
                shipEl.style.color = "orange";
              } else {
                shipEl.style.color = "";
              }
            }
          } else {
            shipEl.value = "";
          }
        } else {
          document.getElementById("dateOrdered").value = "";
          var shipEl2 = document.getElementById("shipDate");
          shipEl2.value = "";
          shipEl2.style.color = "";
        }
        return data;
      })
      .catch(function(err){
        console.error("Error fetching Etsy order details:", err);
        return null;
      });
    }

      /* ===== ShipStation ‚Äî load ‚ÄúShip To‚Äù by orderNumber ======================= */
      async function loadShipToAddress(orderNumber){
        try {
          const box = document.getElementById("shipAddressBox");
          if (!box) return;
          box.value = "SHIP TO:\n(Loading...)";

          const resp = await fetch(
            "/.netlify/functions/ssGetOrderAddress?orderNumber=" + encodeURIComponent(orderNumber)
          );
          if (!resp.ok) {
            box.value = "SHIP TO:\n(Not found)";
            box.style.color = "";
            return;
          }

          const data = await resp.json();
          const ship = data.shipTo || null;
          if (!ship) {
            box.value = "SHIP TO:\n(Not found)";
            box.style.color = "";
            return;
          }

          // NEW: set Shipping Priority box from SS
          const prEl = document.getElementById("shippingPriority");
          if (prEl) {
            const svc = (data.serviceCode || "").toString();
            const carrier = (data.carrierCode || "").toString();

            const amount = (typeof data.shippingAmount === "number")
              ? data.shippingAmount
              : (data.shippingAmount && typeof data.shippingAmount.amount === "number")
                ? data.shippingAmount.amount
                : null;

            const cost = (amount != null)
              ? amount.toLocaleString(undefined, { style: "currency", currency: "USD" })
              : "‚Äî";

            const label = [carrier, svc].filter(Boolean).join(" / ");
            prEl.value = label ? `${label} ‚Ä¢ ${cost}` : `${cost}`;

            // Make it bold (CSS also enforces this, but we set it here too for safety)
            prEl.style.fontWeight = "bold";

            // If price is exactly $18 or $55 ‚Üí orange
            const amt = Number(amount);
            prEl.style.color = (amt === 18 || amt === 55) ? "orange" : "";
          }


          // If a tile is selected, refresh details to show gift fields
          const sel = document.querySelector(".preview-box.selected");
          if (sel) {
            const idx = parseInt(sel.id.replace("previewCell",""), 10);
            if (!Number.isNaN(idx)) showItemDetails(idx);
          }

          const lines = [];
          const add = v => { if (v) lines.push(String(v)); };

          add(ship.name || "");
          const street = [ship.street1, ship.street2, ship.street3].filter(Boolean).join(" ");
          add(street);
          add([ship.city, ship.state, ship.postalCode].filter(Boolean).join(", "));
          add(ship.country);
          if (ship.phone) add("Phone: " + ship.phone);

          box.value = "SHIP TO:\n" + lines.filter(Boolean).join("\n");

          // ‚îÄ‚îÄ Auto-select Carrier based on destination country (match shipping-1.html) ‚îÄ‚îÄ
          const carrierSelectEl = document.getElementById("carrierSelect");
          if (carrierSelectEl) {
            const countryRaw = (ship.countryCode || ship.country || "").toString().trim().toUpperCase();
            const isUS = (countryRaw === "US" || countryRaw === "USA" || countryRaw === "UNITED STATES");
            const target = isUS ? "usps" : "chitchats";

            // set native <select> value
            carrierSelectEl.value = target;
            carrierSelectEl.dispatchEvent(new Event("change", { bubbles: true }));

            // refresh Materialize wrapper so the visible label updates
            try {
              let inst = M.FormSelect.getInstance(carrierSelectEl);
              if (inst) inst.destroy();
              inst = M.FormSelect.init(carrierSelectEl);
              if (inst && inst.input) {
                inst.input.value = (target === "usps" ? "USPS" : "ChitChats");
              }
            } catch (_) { /* Materialize not ready? safe to ignore */ }
          }

          // Text color only for international (non-US/CA) addresses
          const countryRaw = (ship.country || ship.countryCode || "").toString().trim();
          const c = countryRaw.toLowerCase();
          const isUS = c.startsWith("united states") || c === "usa" || c === "us" || c === "u.s." || c === "u.s.a.";
          const isCA = c === "canada" || c === "ca";
          box.style.color = (isUS || isCA) ? "" : "orangered";
        } catch (e) {
          console.error("loadShipToAddress:", e);
          const box = document.getElementById("shipAddressBox");
          if (box) {
            box.value = "SHIP TO:\n(Error loading)";
            box.style.color = "";
          }
        }
      }

      /* ===== ShipStation ‚Äî Gift Message (orderNumber) ===================== */
      async function loadGiftMessage(orderNumber) {
        try {
          const resp = await fetch(
            "/.netlify/functions/ssGetGiftMessage?orderNumber=" +
            encodeURIComponent(orderNumber)
          );
          if (!resp.ok) throw new Error("ShipStation response " + resp.status);

          const data = await resp.json();
          window.receiptGiftMessage     = (data.giftMessage || "").trim();
          window.receiptGiftMessageFrom = (data.giftFrom    || "").trim();

          /* refresh details pane if a tile is selected */
          const sel = document.querySelector(".preview-box.selected");
          if (sel) {
            const idx = parseInt(sel.id.replace("previewCell", ""), 10);
            if (!Number.isNaN(idx)) showItemDetails(idx);
          }
        } catch (err) {
          console.error("loadGiftMessage:", err);
          window.receiptGiftMessage     = "";
          window.receiptGiftMessageFrom = "";
        }
      }

    /* ---------------------------------------------------------
     *  Firestore listener for employee-scanned order numbers
     * --------------------------------------------------------*/
    function startScannedOrderListener(){
      if (!window.isEmployeeLoggedIn){
        console.warn("startScannedOrderListener called but user not logged in!");
        return;
      }

      let firstSnap = true;                       // üîë skip the initial payload
      db.collection("Brites_Orders")
        .doc("assembly-scan-1")
        .onSnapshot(docSnap => {
          if (!window.isEmployeeLoggedIn) return;

          /* ignore Firestore‚Äôs first delivery; wait for *changes* */
          if (firstSnap){ firstSnap = false; return; }

          if (docSnap.exists){
            const data = docSnap.data();
            if (data && data["Order Number"]){
              const orderNumber   = data["Order Number"];
              if (orderNumber === lastScanProcessed) return;   // duplicate ‚Üí ignore
              lastScanProcessed = orderNumber;                 // remember newest hit
              const etsyOrderInput = document.getElementById("etsyOrderNumber");
              etsyOrderInput.value = orderNumber;

              /* simulate user hitting Enter ‚Üí kicks off full load */
              etsyOrderInput.dispatchEvent(
                new KeyboardEvent("keydown", { key:"Enter", keyCode:13, which:13 })
              );

              /* one-shot: wipe the field so it can‚Äôt be reused */
              db.collection("Brites_Orders")
                .doc("assembly-scan-1")
                .set({ "Order Number": firebase.firestore.FieldValue.delete() }, { merge:true });

            }
          }
        });
    }
    });   // ‚Üê closes DOMContentLoaded handler
  </script>

  <!-- helper: force every upload to use resumable PUT -->
  <script type="module">
    /* modular imports */
    import {
      initializeApp,
      getApp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getStorage,
      ref,
      uploadBytesResumable
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import { getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import {
      getAuth,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    /* reuse the compat-initialised config */
    let modApp;
    try {
      modApp = getApp();                       // already exists? (unlikely)
    } catch {
      // pull the options off the compat app & spin a modular twin
      const compatOpts = firebase.app().options;
      modApp = initializeApp(compatOpts);
    }

    const storage = getStorage(modApp);        // OK ‚Äì default app now present
    const auth   = getAuth(modApp);
    signInAnonymously(auth).catch(console.error);

    /* expose a single resumable uploader */
    window.uploadViaResumable = async (path, file) => {
      const storageRef = ref(storage, path);
      const task       = uploadBytesResumable(
        storageRef,
        file,
        { contentType: file.type }
      );

      await new Promise((res, rej) =>
        task.on("state_changed", null, rej, res)
      );
      return await getDownloadURL(storageRef);
    };
  </script>

  
  <!-- üÜï hard-hide unused fields -->
  <style id="hideUnusedFields">
  #labelCreationDate,
  #completedByEmployee { display:none !important; }
  </style>

<!-- FINAL chat-bubble override: placed last so nothing beats it -->
<style id="chatSpacingOverride">
  /* base bubble */
  .msg{
    display:flex !important;
    flex-direction:column !important;
    row-gap:0 !important;               /* no extra flex gap             */
    padding:2px 12px 4px !important;    /* top 2 ‚Ä¢ lr 12 ‚Ä¢ bottom 4       */
    margin:5px 0   !important;          /* bubble-to-bubble spacing       */
    max-width:75%;
    border-radius:7px !important;
    color:#fff !important;
    font-size:0.85em;
  }

  /* tighten date-stamp ‚Üî text, keep within bubble */
  .msg .meta{
    margin:4px 0 1px 0 !important;        /* bottom 1 px only               */
    line-height:1   !important;         /* compact line box               */
  }

  /* wrap long text nicely */
  .msg > span:not(.meta){
    white-space:pre-wrap !important;
    word-break:break-word !important;
    overflow-wrap:anywhere !important;
  }

  /* RIGHT-justified (staff) bubble */
  .msg.sent{
    background:#797d7f !important;
    margin-left:auto  !important;       /* push to right edge             */
    text-align:right  !important;
    align-items:flex-end !important;    /* children follow right edge     */
  }
  .msg.sent .meta{
    font-size:0.65em !important;
    color:rgba(255,255,255,0.6) !important;
  }

  /* LEFT-justified (customer) bubble */
  .msg.received{
    background:#5dade2 !important;
    margin-right:auto !important;       /* push to left edge              */
    text-align:left   !important;
    align-items:flex-start !important;  /* children follow left edge      */
  }
  .msg.received .meta{
    font-size:0.65em !important;
    color:rgba(255,255,255,0.8) !important;
  }

  /* disable live controls */
  body.configOpen #screenOne select{ pointer-events:none !important; }
  body.configOpen #screenOne select,
  body.configOpen #screenOne button{ pointer-events:none !important;
  }

  /* re-enable inside modal */
  body.configOpen #configModal select{ pointer-events:auto !important; }
  body.configOpen #configModal select,
  body.configOpen #configModal button{
    pointer-events:auto !important;
  }

  /* allow dragging the Carrier dropdown while Config is open */
  body.configOpen #carrierSelect{ pointer-events:auto !important; }

</style>

</body>
</html>