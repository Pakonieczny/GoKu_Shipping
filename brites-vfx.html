<!-- brites-vfx.html — Single-file Sora-2 demo (with on-page error overlay + function pings) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sora-2 Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' data: blob:;
                 img-src 'self' data: blob: https:;
                 media-src 'self' blob: https:;
                 connect-src 'self' https:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline'">
  <style>
    html, body { margin:0; padding:24px; font-family: system-ui, sans-serif; background:#f7f7f7; color:#111; }
    h1 { margin:0 0 12px; }
    label { display:block; margin: 12px 0 4px; }
    button { padding: 10px 16px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; background:#fff; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .log { margin-top: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space: pre-wrap; background:#fff; border:1px solid #ddd; padding:10px; border-radius:8px; }
    video { width: 360px; max-width: 100%; margin-top: 16px; border-radius: 8px; background:#000; }
    progress { width: 320px; height: 10px; }
    #error-overlay{position:fixed;inset:0;background:rgba(255,255,255,.96);color:#b00;z-index:99999;padding:20px;overflow:auto;display:none}
    #error-overlay h2{margin:0 0 8px}
    #error-overlay pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>Sora-2 Quick Test</h1>

  <label for="prompt">Prompt</label>
  <textarea id="prompt" rows="5" style="width:100%;">A wide shot of gentle ocean waves at sunset, slow dolly forward, soft golden light, subtle ambient surf.</textarea>

  <div class="row">
    <label for="model">Model
      <select id="model">
        <option value="sora-2" selected>sora-2</option>
        <option value="sora-2-pro">sora-2-pro</option>
      </select>
    </label>

    <label for="size">Size
      <select id="size">
        <option value="720x1280">720x1280 (vertical)</option>
        <option value="1280x720">1280x720 (landscape)</option>
      </select>
    </label>

    <label for="seconds">Seconds
      <select id="seconds">
        <option value="4" selected>4</option>
        <option value="8">8</option>
        <option value="12">12</option>
      </select>
    </label>
  </div>

  <div class="row" style="margin-top:12px;">
    <button id="goBtn" type="button">Generate</button>
    <progress id="prog" max="100" value="2" hidden></progress>
    <span id="status" aria-live="polite"></span>
  </div>

  <pre class="log" id="log" aria-live="polite"></pre>
  <video id="outVid" controls hidden></video>

  <div id="error-overlay">
    <h2>Runtime Error</h2>
    <pre id="err-pre"></pre>
  </div>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const sleep = (ms) => new Promise(r => setTimeout(r, ms));

      function log(x){
        const el = $('log');
        el.textContent = (el.textContent ? el.textContent + '\n' : '') + x;
      }

      function showError(e) {
        try {
          const p = $('err-pre');
          $('error-overlay').style.display = 'block';
          p.textContent = (typeof e === 'string') ? e : (e?.stack || e?.message || JSON.stringify(e, null, 2));
        } catch {}
      }
      window.addEventListener('error', (ev) => showError(ev.error || ev.message || ev));
      window.addEventListener('unhandledrejection', (ev) => showError(ev.reason || ev));

      function safeJSON(text) { try { return JSON.parse(text); } catch { return { raw: text }; } }
      async function readJSON(resp) { const txt = await resp.text(); return safeJSON(txt); }

      // Deep, cautious search for a video URL
      function deepScanForVideoUrl(obj) {
        function isHttpish(s) {
          return typeof s === 'string' && /^https?:\/\//.test(s);
        }
        function looksLikeVideoUrl(s) {
          return isHttpish(s) && /\.(mp4|webm|mov)(\?|#|$)/i.test(s);
        }
        function isVideoishMeta(o) {
          const meta = `${o?.mime||''} ${o?.type||''} ${o?.kind||''} ${o?.role||''} ${o?.content_type||''}`;
          return /(video|mp4|webm|quicktime)/i.test(meta);
        }
        function pickFromRecord(o) {
          const cand = [
            o?.video_url, o?.download_url, o?.cdn_url, o?.signed_url,
            o?.url, o?.uri, o?.href, o?.file_url, o?.source, o?.src
          ];
          for (const c of cand) {
            if (isHttpish(c) && (looksLikeVideoUrl(c) || isVideoishMeta(o))) return c;
          }
          if (typeof o?.video === 'string' && isHttpish(o.video)) return o.video;
          if (o?.video && isHttpish(o.video.url)) return o.video.url;
          if (o?.media && isHttpish(o.media.url)) return o.media.url;
          return null;
        }
        const seen = new Set();
        const stack = [obj];
        while (stack.length) {
          const cur = stack.pop();
          if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
          seen.add(cur);
          const direct = pickFromRecord(cur);
          if (direct) return direct;
          for (const k in cur) {
            const v = cur[k];
            if (!v) continue;
            if (Array.isArray(v)) {
              for (const it of v) {
                const got = pickFromRecord(it);
                if (got) return got;
                if (it && typeof it === 'object') stack.push(it);
                else if (typeof it === 'string' && looksLikeVideoUrl(it)) return it;
              }
            } else if (typeof v === 'object') {
              stack.push(v);
            } else if (typeof v === 'string' && looksLikeVideoUrl(v)) {
              return v;
            }
          }
        }
        return null;
      }

      function pickVideoUrl(job) {
        try {
          if (job.video_url) return job.video_url;

          const arrays = [
            job.assets, job.files, job.results, job.output, job.result?.files,
            job.result?.assets, job.output?.files, job.output?.assets,
            job.render?.outputs, job.media?.sources
          ].filter(Array.isArray);
          for (const arr of arrays) {
            const hit = arr.find(a => {
              const meta = `${a?.mime||''} ${a?.type||''} ${a?.kind||''} ${a?.role||''} ${a?.content_type||''}`;
              return /(video|mp4|webm|quicktime)/i.test(meta);
            }) || arr.find(a => {
              const s = a?.url || a?.uri || a?.href || a?.download_url || a?.signed_url || a?.cdn_url || a?.file_url;
              return typeof s === 'string' && /\.(mp4|webm|mov)(\?|#|$)/i.test(s);
            });
            if (hit) {
              return hit.url || hit.uri || hit.href || hit.download_url || hit.signed_url || hit.cdn_url || hit.file_url || null;
            }
          }

          if (job.output?.video?.url) return job.output.video.url;
          if (job.result?.video?.url) return job.result.video.url;

          const deep = deepScanForVideoUrl(job);
          if (deep) return deep;
        } catch {}
        return null;
      }

      async function pingFunctions() {
        try {
          const s = await fetch('/.netlify/functions/soraStatus?id=ping', { method: 'GET' });
          log(`soraStatus ping → ${s.status}`);
        } catch (e) { log('soraStatus ping failed: ' + (e?.message || e)); }

        try {
          const c = await fetch('/.netlify/functions/soraCreate', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ prompt:'__ping__' })
          });
          const preview = (await c.text()).slice(0, 200);
          log(`soraCreate ping → ${c.status} ${preview}...`);
        } catch (e) { log('soraCreate ping failed: ' + (e?.message || e)); }
      }

      // NOTE: seconds is a STRING per API requirements
      async function createJob() {
        const prompt = $('prompt').value.trim();
        const model = $('model').value;
        const size = $('size').value;
        const seconds = $('seconds').value;

        const resp = await fetch('/.netlify/functions/soraCreate', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt, model, size, seconds })
        });
        const data = await readJSON(resp);
        if (!resp.ok) throw new Error(JSON.stringify(data));
        return data;
      }

      async function getStatus(id) {
        const resp = await fetch('/.netlify/functions/soraStatus?id=' + encodeURIComponent(id));
        const data = await readJSON(resp);
        if (!resp.ok) throw new Error(JSON.stringify(data));
        return data;
      }

      document.addEventListener('DOMContentLoaded', async () => {
        document.documentElement.style.visibility = 'visible';
        document.body.style.visibility = 'visible';

        log('Booting… If this stalls here, check the red error overlay or the function pings below.');
        await pingFunctions();

        $('goBtn').onclick = async () => {
          $('goBtn').disabled = true;
          $('outVid').hidden = true;
          $('prog').hidden = false;
          $('prog').value = 3;
          $('status').textContent = 'starting…';
          $('log').textContent = '';

          try {
            const job = await createJob();
            log('created: ' + job.id);
            $('status').textContent = 'queued';
            let pct = 5;

            while (true) {
              await sleep(3000);
              const s = await getStatus(job.id);
              log(JSON.stringify({ id: s.id, status: s.status }, null, 2));
              $('status').textContent = s.status || 'processing';
              $('prog').value = Math.min(95, pct += 7);

              const st = (s.status || '').toLowerCase();
              if (st === 'completed' || st === 'succeeded') {
                $('prog').value = 100;
                const url = pickVideoUrl(s);
                if (!url) {
                  // dump a short preview to help debugging
                  log('No URL found. Keys: ' + Object.keys(s).join(', '));
                  log('Sample: ' + JSON.stringify(s.assets || s.output || s.result || s.results || {}, null, 2).slice(0, 800));
                  log('No URL found — dumping full payload preview…');
                  log((JSON.stringify(s, null, 2) || '').slice(0, 12000));
                  throw new Error('Completed but no video URL found in response.');
                }
                $('outVid').src = url;
                $('outVid').hidden = false;
                $('status').textContent = 'done';
                break;
              }
              if (st === 'failed' || st === 'error') {
                throw new Error('Generation failed: ' + (s.error?.message || s.status || 'unknown error'));
              }
            }
          } catch (e) {
            log('ERROR: ' + (e?.message || e));
            $('status').textContent = 'error';
            showError(e);
          } finally {
            $('prog').hidden = true;
            $('goBtn').disabled = false;
          }
        };
      });
    })();
  </script>
</body>
</html>