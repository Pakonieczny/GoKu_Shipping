<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Etsy Order & OAuth Integration</title>

  <!-- Materialize CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  >
  <style>
    /* Hide page initially for a fade-in effect */
    body {
      background-color: white;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0; /* hidden initially */
      transition: opacity 0s; /* fade-in controlled by JS */
    }

    /* Main UI Buttons */
    #connectEtsyBtn {
      position: absolute;
      left: 50px;
      top: 20px;
    }

    /* "Open Config" button */
    #openConfigBtn {
      position: absolute;
      left: 50px;
      top: 110px;
    }

    /* "Order Link" button */
    #orderLinkBtn {
      position: absolute;
      left: 120px;
      top: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      outline: none;
    }
    #orderLinkBtn img {
      width: 14px;
      height: 14px;
      display: block;
    }

    @keyframes ccSpin { to { transform: rotate(360deg); } }
    .cc-spinner {
    display:none; width:16px; height:16px;
    border:4px solid #cfd8dc; border-top-color:#26a69a; 
    border-radius:50%; animation: ccSpin .8s linear infinite;
    vertical-align: middle; margin-left: 6px;
  }

    /* "Tracking Link" button */
    #trackingLinkBtn {
      position: absolute;
      left: 160px;
      top: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      outline: none;
      z-index: 9999;
      display: none; /* hidden by default */
    }
    #trackingLinkBtn img {
      width: 17px;
      height: 17px;
      display: block;
    }

    #etsyOrderNumber {
      position: absolute;
      left: 50px;
      top: 160px;
      margin: 0;
      padding: 0;
      line-height: 1.0;
      border: none;
      border-bottom: 1px solid #000;
      background: transparent !important;
      text-align: left;
      width: 250px; /* explicitly set => 250 */
      font-size: 1em;
      outline: none;
    }

    /* Photo Grid and Preview Boxes */
    #Photo_Grid {
      position: absolute;
      left: 400px;
      top: 160px;
      transform: scale(1.25);
      transform-origin: top left;
    }
    #photoGridContainer {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(2, auto);
      gap: 35px 5px;
    }
    .grid-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .preview-box {
      border: 1px solid black !important;
      background: #f9f9f9;
      width: 100%;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      user-select: none;
    }

    /* ====== PREVIEW-BOX OUTLINES (final) ============================= */

    /* Persistent selection ‚Üí 3 px orangered ring (sits just inside) */
    .preview-box.selected{
      outline:3px solid orangered;
      outline-offset:-3px;        /* hugs inner edge */
    }

    /* Hover  ‚Üí 3 px blue ring (always, even on selected tiles) */
    .preview-box:hover{
      box-shadow:0 0 0 3px dodgerblue;   /* outer ring rides outside the outline */
    }

    .preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform-origin: center center;
      transition: transform 0.2s ease;
    }

    /* 16 text-box-absolute elements */
    .text-box-absolute {
      position: absolute;
      border: none !important;
      outline: none !important;
      background: transparent !important;
      text-decoration: none !important;
      box-shadow: none !important;
      font-size: 0.8em !important;
      width: 60px;
      height: 20px;
      text-align: left;
      line-height: 1.0;
      padding: 0 2px 2px 2px;
      box-sizing: border-box;
    }

    /* Order Details text area */
    #orderDetails {
      position: absolute;
      border: 1px solid black;
      width: 300px; /* explicitly => 300 */
      height: 175px; /* explicitly => 175 */
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      line-height: 1.5;
      resize: none;
      text-align: left;
      overflow-y: auto;
    }

    /* Ship To Address text area */
    #shipAddressBox {
      position: absolute;
      border: 1px solid black;
      width: 300px;
      height: 90px;
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      line-height: 1.4;
      resize: none;
      text-align: left;
      white-space: pre-wrap;
      overflow-y: auto;
    }

    /* Customer Message History text area */
    #customerMessageHistory {
      position: absolute;
      border: 1px solid black;
      width: 300px; /* => 300 */
      height: 175px; /* => 175 */
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      line-height: 1.5;
      resize: none;
      text-align: left;
      overflow-y: auto;
    }

    /* Single-line text boxes */
      #dateOrdered,
      #shipDate,
      #labelCreationDate,
      #employeeName,
      #completedByEmployee,
      #shippingPriority {
      position: absolute;
      width: 200px;
      height: 20px;
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
    }
    #dateOrdered {
      font-weight: bold !important;
      border-bottom: 1px solid black !important;
    }
    #shipDate {
      font-weight: bold !important;
      border-bottom: 1px solid black !important;
    }
    #employeeName {
      font-weight: bold;
    }
    #labelCreationDate {
      font-weight: bold !important;
      font-style: italic !important;
      border-bottom: 1px solid black !important;
    }
    #completedByEmployee {
      font-weight: bold !important;
      font-style: italic !important;
      border-bottom: 1px solid black !important;
    }

    /* Title texts */
    #titleOrderDate,
    #titleOrderDate2,
    #titleShipDate,
    #titleOrderDetails,
    #titleBritesMessages,
    #titlePurchasedItems,
    #titleOrderNumber {
      position: absolute;
      font-size: 0.7em;
      margin: 0;
      padding: 0;
    }



    #titleOrderDate2 {
      font-weight: bold;
    }
    #titleOrderCompletedOn,
    #titleOrderCompletedBy,
    #titleSignedInAs {
      position: absolute;
      font-size: 0.7em;
      margin: 0;
      padding: 0;
    }
    #titleOrderCompletedOn {
      left: 50px;
      top: 460px;
    }
    #titleOrderCompletedBy {
      left: 50px;
      top: 480px;
    }
    #titleSignedInAs {
      left: 50px;
      top: 500px;
    }

    /* Configuration Modal styling */
    #configModal.modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      height: auto !important;
      max-height: 70vh !important;
      width: auto !important;
      max-width: 650px !important;
      overflow-y: scroll !important;
    }

    /* "Signature Box" */
    #signatureBox {
      position: absolute;
      left: 400px;
      top: 360px;
      width: 50px;
      height: 25px;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      user-select: none;
      border-bottom: 1px solid black !important;
    }

    /* shipping title style */
    #titleShipping{
      font-size:1.65em !important;
      font-weight: Bold !important;
    }

    #titleShipping{
    font-size:1.7em !important;
    font-weight:bold !important;
    text-decoration:none !important;   /* üîª kills underline */
    border-bottom:none !important;     /* in case it came from a border */
  }

    /*
     * Always-center the user login modal,
     * but use a relative container so we can move
     * the text/prompt inside with "Open Config."
     */
    #userLoginModal.modal {
  position: fixed !important;
  top: 35% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  width: 400px !important;
  height: 200px !important;
  margin: 0 !important;
  z-index: 9999 !important;
  overflow: hidden !important; /* or 'auto' if you prefer scrolling */
}

  #titleShippingPriority {
    position: absolute;
    font-size: 0.7em;
    margin: 0;
    padding: 0;
  }

#userLoginModalContainer {
  position: static !important; /* so content doesn‚Äôt shrink weirdly */
  height: auto !important;
  width: auto !important;
}

/* ‚§µÔ∏è hard-hide the signature box */
#signatureBox { display:none !important; }

/* ====== Brites chat stream =================================== */
    .msg-box{
      position:absolute;
      border:1px solid #000;
      background:#fafafa;
      font:14px/1.4 Arial, sans-serif;
      overflow-y:auto;
      white-space:pre-wrap;
      padding:1px;
    }
    .msg{margin:1px 0 !important; }
    .msg .meta{display:block;font-size:11px;opacity:1;margin-bottom:2px !important; }
    .msg.sent    {text-align:right;color:#1565c0;}
    .msg.received{text-align:left; color:#333;}

   /* ===== Chit Chats Edit Shipment Wizard ===== */
    /* üÜï Line item tranches */
    .cc-tranche{
      border:1px solid #e0e0e0;
      border-radius:10px;
      padding:10px;
      margin:10px 0;
      background:#fff;}
    #ccEditModal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:9999;}
    #ccEditCard{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:860px;max-height:86vh;overflow:auto;background:#fff;border-radius:12px;
      box-shadow:0 18px 60px rgba(0,0,0,.25);}
    #ccEditHead{padding:14px 18px;border-bottom:1px solid #ececec;display:flex;align-items:center;gap:10px}
    #ccEditTitle{font-weight:700;font-size:18px}
    .cc-steps{display:flex;gap:8px;margin-left:auto}
    .cc-step-pill{padding:6px 10px;border-radius:999px;border:1px solid #ddd;font-size:12px;color:#666}
    .cc-step-pill.active{background:#242424;color:#fff;border-color:#242424}
    .cc-body{padding:18px 20px}
    .cc-step{display:none}
    .cc-step.active{display:block}
    .cc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .cc-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .cc-field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
    .cc-field label{font-size:12px;color:#444}
    .cc-field input,.cc-field select,.cc-field textarea{padding:8px 10px;border:1px solid #bbb;border-radius:8px;font-size:14px}
    #ccRates{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
    #ccRates li{border:1px solid #ddd;border-radius:10px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    #ccRates li.selected{outline:2px solid #1976d2}
    #ccEditFoot{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid #ececec;background:#fafafa;border-radius:0 0 12px 12px}
    #ccEditFoot button{padding:9px 14px;border-radius:8px;border:0;background:#333;color:#fff;cursor:pointer}
    #ccEditFoot button[disabled]{opacity:.5;cursor:not-allowed}
    #ccVerifyModal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:10000; }
    #ccVerifyCard  { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
                 width:860px; max-height:86vh; overflow:auto; background:#fff; border-radius:12px;
                 box-shadow:0 18px 60px rgba(0,0,0,.25); }

  </style>

  <style id="ccGridNoOverlapFix">
  /* Grid columns shrink correctly and inputs stay inside their cells */
  .cc-grid     { display: grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr) !important; gap: 12px !important; }
  .cc-grid-3   { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)) !important; gap: 12px !important; }

  .cc-field { min-width: 0 !important; overflow: hidden; }

  .cc-field input,
  .cc-field select,
  .cc-field textarea {
    width: 100% !important;
    box-sizing: border-box !important;
    max-width: 100% !important;
  }

  .cc-field input,
  .cc-field textarea { text-overflow: ellipsis; }

  .cc-field label { white-space: nowrap; }
 </style>

  <!-- üÜï remove underline from the dropdown trigger -->
  <style id="dropdownNoUnderline">
    .select-dropdown.dropdown-trigger,
    .select-dropdown.dropdown-trigger:hover,
    .select-dropdown.dropdown-trigger:focus{
      text-decoration:none !important;
      border-bottom:none !important;
    }

  /* OrangeRed field highlight (field-scoped) */
  .cc-field.cc-missing > input,
  .cc-field.cc-missing > select,
  .cc-field.cc-missing > textarea { border: 2px solid orangered !important; box-shadow: 0 0 0 2px rgba(255,69,0,.12); }
  .cc-field.cc-missing > label { color: orangered !important; }
  /* Address diff colors */
  .cc-diff-add { color: orangered; font-weight:700; }
  .cc-diff-del { color:#b00020; text-decoration:line-through; }
    

  </style>

</head>

<body>
  <!-- WRAP SCREEN ONE CONTENT IN THIS CONTAINER -->
  <div id="screenOne">
    <button id="connectEtsyBtn" class="configurable btn waves-effect waves-light">Connect to Etsy</button>
    <button id="openConfigBtn" class="configurable btn waves-effect waves-light">Open Config</button>
    <button id="signOutBtn" class="configurable btn waves-effect waves-light">Sign Out</button>

    <!-- "Order Link" button -->
    <button id="orderLinkBtn" name="Order Link">
      <img src="assets/Globe.png" alt="Order Link Icon" />
    </button>

    <!-- "Tracking Link" button -->
    <button id="trackingLinkBtn" name="Tracking Link">
      <img src="assets/USPS.png" alt="Tracking Link Icon" />
    </button>

    <!-- Etsy Order Fields -->
    <input type="text" id="etsyOrderNumber" placeholder="Etsy Order Number" />

    <!-- Order Number Paste button -->
    <button id="pasteOrderBtn" class="btn"
            style="position:absolute; left:310px; top:160px;
                   width:65px; height:35px; line-height:35px;
                   font-size:0.8em; text-align:center;
                   background-color:#555 !important; color:#fff; padding:0;">
      Paste
    </button>

    <!-- Tracking Number Paste button -->
    <button id="pasteTrackingBtn" class="btn"
            style="position:absolute; left:410px; top:110px;
                   width:65px; height:35px; line-height:35px;
                   font-size:0.8em; text-align:center;
                   background-color:#555 !important; color:#fff; padding:0;">
      Paste
    </button>

    <!-- ‚ñº‚ñº Chit Chats controls (always visible) ‚ñº‚ñº -->
    <div id="ccControls" style="position:absolute; left:50px; top:190px;">
      <input id="ccShipmentId" type="text" placeholder="CC Shipment ID" readonly
             style="width:180px; height:24px; font-size:0.9em; margin-right:6px;" />

    <span id="ccIdSpinner"
      class="cc-spinner"
      aria-live="polite"
      aria-label="Looking up shipment in Chit Chats"
      title="Looking up shipment in Chit Chats"></span>

      <!-- Batch dropdown (wrapped so Config can move/resize the visible control) -->
      <div id="ccBatchSelectWrap"
           style="position:absolute; width:180px; height:28px; margin-right:6px;">
        <select id="ccBatchSelect" style="width:100%; height:100%; font-size:0.9em;">
          <option value="">Select Batch‚Ä¶</option>
        </select>
      </div>

      <!-- Optional name for *new* batches -->
      <input id="ccBatchName" type="text" placeholder="New batch name (optional)"
             style="width:170px; height:24px; font-size:0.9em; margin-right:6px;" />

      <button id="ccCreateBatchBtn" class="btn"
              style="height:24px; line-height:24px; font-size:0.8em;">Create Batch</button>

      <button id="ccAddToBatchBtn" class="btn"
              style="height:24px; line-height:24px; font-size:0.8em; margin-left:6px;">Add‚ÜíBatch</button>

      <!-- <button id="ccRemoveFromBatchBtn" class="btn"
              style="height:24px; line-height:24px; font-size:0.8em; margin-left:6px;">Remove From Batch</button> -->
    </div>

   <!-- CC Edit Shipment button -->
  <button id="ccEditBtn" class="btn" style="position:absolute; left:50px; top:225px; height:28px; line-height:28px;">
    Edit Shipment‚Ä¶
  </button>


  <!-- CC Edit Shipment Modal -->
  <div id="ccEditModal" role="dialog" aria-modal="true">
    <div id="ccEditCard">
      <div id="ccEditHead">
        <div id="ccEditTitle">Edit Shipment</div>
        <div class="cc-steps">
          <div class="cc-step-pill" data-step="0">Recipient</div>
          <div class="cc-step-pill" data-step="1">Description</div>
          <div class="cc-step-pill" data-step="2">Package</div>
          <div class="cc-step-pill" data-step="3">Postage</div>
        </div>
      </div>
      <div class="cc-body">
        <!-- Step 0: Recipient -->
        <section id="ccStep0" class="cc-step">
          <div class="cc-grid">
            <div class="cc-field"><label>Full name</label><input id="cc_to_name"></div>
            <div class="cc-field"><label>Email (optional)</label><input id="cc_to_email" type="email"></div>
            <div class="cc-field"><label>Address 1</label><input id="cc_to_address_1"></div>
            <div class="cc-field"><label>Address 2</label><input id="cc_to_address_2"></div>
            <div class="cc-field"><label>City</label><input id="cc_to_city"></div>
            <div class="cc-field"><label>State/Province</label><input id="cc_to_province_code"></div>
            <div class="cc-field"><label>Postal/Zip</label><input id="cc_to_postal_code"></div>
            <div class="cc-field"><label>Country (2-letter)</label><input id="cc_to_country_code" placeholder="US or CA"></div>
            <div class="cc-field"><label>Phone (optional)</label><input id="cc_to_phone"></div>
          </div>
        </section>

        <!-- Step 1: Description / Customs -->
        <section id="ccStep1" class="cc-step">
          <div class="cc-grid">
            <div class="cc-field"><label>Package contents</label>
              <select id="cc_package_contents">
                <option value="merchandise" selected>Merchandise</option>
                <option value="documents">Documents</option>
                <option value="gift">Gift</option>
                <option value="sample">Sample</option>
                <option value="return">Return</option>
              </select>
            </div>

            <div class="cc-field"><label>Value currency</label>
              <select id="cc_value_currency">
                <option value="CAD">CAD</option>
                <option value="USD">USD</option>
              </select>
            </div>

            <div class="cc-field">
              <label>Customs Tax Reference Number</label>
              <input id="cc_customs_tax_reference_number" placeholder="IOSS / VAT / EORI, etc.">
            </div>

          </div>
          <h4 style="margin:12px 0 4px;">Line items</h4>
          <div id="cc_line_items_container"></div>
          <!-- üÜï Grand Total footer (sum of all "Item value") -->
          <div id="cc_line_items_total" class="cc-tranche" style="margin-top:10px; display:flex; justify-content:flex-end; align-items:center; gap:10px;">
            <span style="font-weight:700;">Grand Total <span id="cc_grand_total_currency"></span>:</span>
            <input id="cc_grand_total" type="number" step="0.01" readonly
                   style="width:140px; font-weight:700; text-align:right;">
          </div>

          <template id="cc_line_item_tpl">
            <div class="cc-tranche cc-line-item" data-index="__IDX__">
              <h5 style="margin:0 0 6px; font-size:13px; color:#555;">Line item <span class="cc-li-number">__NUM__</span></h5>
              <div class="cc-grid-3">
                <div class="cc-field"><label>Description</label>
                  <input class="cc_item_description" placeholder="Item description">
                </div>
                <div class="cc-field"><label>SKU</label>
                  <input class="cc_item_sku" placeholder="SKU">
                </div>
                <div class="cc-field"><label>Quantity</label>
                  <input class="cc_item_qty" type="number" min="1" value="1">
                </div>
                <div class="cc-field"><label>Unit value</label>
                  <input class="cc_item_unit_value" type="number" step="0.01">
                </div>
                <div class="cc-field"><label>Item value</label>
                  <input class="cc_item_value" type="number" step="0.01" readonly>
                </div>

                <div class="cc-field"><label>Origin country</label>
                  <input class="cc_item_origin_country" placeholder="CA">
                </div>
                <div class="cc-field"><label>HS code</label>
                  <input class="cc_item_hs_tariff_code" placeholder="7113.19.5091">
                </div>
                <div class="cc-field"><label>Country of manufacture</label>
                  <input class="cc_item_manufacture_country" placeholder="CA">
                </div>

                <div class="cc-field"><label>Manufacturer name</label>
                  <input class="cc_item_manufacturer_contact" placeholder="Brites Jewelry Inc.">
                </div>
                <div class="cc-field"><label>Manufacturer address</label>
                  <input class="cc_item_manufacturer_street" placeholder="450 Matheson Blvd, East">
                </div>
                <div class="cc-field"><label>Manufacturer city</label>
                  <input class="cc_item_manufacturer_city" placeholder="Mississauga">
                </div>
                <div class="cc-field"><label>Manufacturer province</label>
                  <input class="cc_item_manufacturer_province_code" placeholder="ON">
                </div>
                <div class="cc-field"><label>Manufacturer postal</label>
                  <input class="cc_item_manufacturer_postal_code" placeholder="L4Z 1R5">
                </div>
                <div class="cc-field"><label>Manufacturer phone</label>
                  <input class="cc_item_manufacturer_phone">
                </div>
                <div class="cc-field"><label>Manufacturer email</label>
                  <input class="cc_item_manufacturer_email">
                </div>
              </div>
            </div>
          </template>
        </section>

        <!-- Step 2: Package -->
        <section id="ccStep2" class="cc-step">
          <div class="cc-grid-3">
            <div class="cc-field"><label>Package type</label>
              <select id="cc_package_type">
                <option value="parcel">Parcel</option>
                <option value="thick_envelope">Thick envelope</option>
                <option value="envelope">Envelope</option>
                <option value="letter">Letter</option>
                <option value="card">Card</option>
              </select>
            </div>
            <div class="cc-field"><label>Size unit</label><select id="cc_size_unit"><option>cm</option><option>in</option></select></div>
            <div class="cc-field"><label>Weight unit</label><select id="cc_weight_unit"><option>g</option><option>oz</option><option>kg</option><option>lb</option></select></div>
            <div class="cc-field"><label>Length (X)</label><input id="cc_size_x" type="number" step="0.1"></div>
            <div class="cc-field"><label>Width (Y)</label><input id="cc_size_y" type="number" step="0.1"></div>
            <div class="cc-field"><label>Height (Z)</label><input id="cc_size_z" type="number" step="0.1"></div>
            <div class="cc-field"><label>Weight</label><input id="cc_weight" type="number" step="0.01"></div>
            <div class="cc-field"><label>Insurance?</label><select id="cc_insurance_requested"><option value="false">No</option><option value="true">Yes</option></select></div>
            <div class="cc-field"><label>Signature Required?</label><select id="cc_signature_requested"><option value="false">No</option><option value="true">Yes</option></select></div>
            <div class="cc-field"><label>Media Mail?</label><select id="cc_media_mail_requested"><option value="false">No</option><option value="true">Yes</option></select></div>
            <div class="cc-field"><label>Ship date</label><input id="cc_ship_date" type="date" placeholder="YYYY-MM-DD"></div>
          </div>
        </section>

        <!-- Step 3: Postage -->
        <section id="ccStep3" class="cc-step">
          <ul id="ccRates"></ul>
        </section>
      </div>
      <div id="ccEditFoot">
        <div style="display:flex;gap:8px">
          <button id="ccClose">Close</button>
          <button id="ccBack">Back</button>
        </div>
        <div style="display:flex;gap:8px">
          <button id="ccNext">Next</button>
          <button id="ccRefreshRates">Refresh Rates</button>
          <button id="ccBuy" disabled>Buy & Print</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Address Verify Modal (replaces the old overlay) -->
  <div id="ccVerifyModal" role="dialog" aria-modal="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:10000;">
    <div id="ccVerifyCard" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
         width:860px; max-height:86vh; overflow:auto; background:#fff; border-radius:12px;
         box-shadow:0 18px 60px rgba(0,0,0,.25);">
      <div style="padding:14px 18px; border-bottom:1px solid #ececec; display:flex; align-items:center; gap:10px">
        <div style="font-weight:700; font-size:18px">Edit Shipment</div>
        <div class="cc-steps" style="margin-left:auto; display:flex; gap:8px;">
          <div class="cc-step-pill active">Recipient</div>
          <div class="cc-step-pill">Description</div>
          <div class="cc-step-pill">Package</div>
          <div class="cc-step-pill">Postage</div>
        </div>
      </div>

      <div class="cc-body" style="padding:18px 20px;">
        <h4 style="margin:0 0 6px;">Verify shipping address</h4>
        <p style="margin-top:0; color:#444;">
          We found a similar address in our database. This is only a suggestion. As the shipper it is your
          responsibility to ensure the <a href="#!" style="text-decoration:underline;">recipient's address</a> is correct.
          Select the address you wish to use:
        </p>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:28px; align-items:start;">
          <div>
            <h5 style="margin:0 0 8px 0; font-size:16px;">Original Address:</h5>
            <div id="ccVerifyOriginal" style="white-space:pre-line; font-size:15px;"></div>
            <button id="ccAddrEdit" class="btn-flat" style="margin-top:8px;">Edit</button>
          </div>

          <div>
            <h5 style="margin:0 0 8px 0; font-size:16px;">Suggested Address:</h5>
            <div id="ccVerifySuggested" style="white-space:pre-line; font-size:15px;"></div>
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-top:1px solid #ececec; background:#fafafa; border-radius:0 0 12px 12px">
        <div>
          <button id="ccVerifyClose" class="btn-flat">Close</button>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="ccKeepOriginal" class="btn grey darken-3">Keep Original Address</button>
          <button id="ccUseSuggested" class="btn">Use Suggested Address</button>
        </div>
      </div>
    </div>
  </div>

    <!-- üü° anchor: immediately after <input id="shipDate" ‚Ä¶/> -->
    <input type="text" id="labelCreationDate"    readonly />
    <input type="text" id="completedByEmployee"  readonly />
    <!-- üÜï‚Äî‚Äî new draggable title -->
    <input id="titleShipping" type="text" value="Shipping_1"  readonly />
    <!-- ‚ñ≤ nothing else changes here -->

    <input type="text" id="shippingPriority" readonly />

    <!-- Photo Grid -->
    <div id="Photo_Grid">
      <div id="photoGridContainer">
        <div class="grid-cell">
          <div class="preview-box" id="previewCell0">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell1">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell2">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell3">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell4">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell5">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell6">Empty</div>
        </div>
        <div class="grid-cell">
          <div class="preview-box" id="previewCell7">Empty</div>
        </div>
      </div>
    </div>

    <!-- 16 text-box-absolute elements -->
    <input type="text" id="quantityCell0" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell1" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell2" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell3" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell4" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell5" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell6" class="text-box-absolute" readonly />
    <input type="text" id="quantityCell7" class="text-box-absolute" readonly />

    <input type="text" id="metalCell0" class="text-box-absolute" readonly />
    <input type="text" id="metalCell1" class="text-box-absolute" readonly />
    <input type="text" id="metalCell2" class="text-box-absolute" readonly />
    <input type="text" id="metalCell3" class="text-box-absolute" readonly />
    <input type="text" id="metalCell4" class="text-box-absolute" readonly />
    <input type="text" id="metalCell5" class="text-box-absolute" readonly />
    <input type="text" id="metalCell6" class="text-box-absolute" readonly />
    <input type="text" id="metalCell7" class="text-box-absolute" readonly />

    <textarea id="orderDetails" readonly></textarea>
    <textarea id="shipAddressBox" readonly></textarea>

    <!-- ‚ñº‚ñº NEW COPY BUTTON ‚ñº‚ñº -->
    <button id="copyOrderDetailsBtn" class="btn"
            style="position:absolute; left:260px; top:162px;
                   width:50px; height:24px; font-size:0.8em;
                   display:flex; align-items:center; justify-content:center;
                   background-color:#555 !important; color:#fff; padding:0;">
      Copy
    </button>
    <!-- ‚ñ≤‚ñ≤ NEW COPY BUTTON ‚ñ≤‚ñ≤ -->
    <div id="customerMessageHistory" class="msg-box"></div>
    <input id="britesMsgInput"
       type="text"
       placeholder="Message"
       style="font-size:0.8em; width:100%;"/>

    <div id="titleOrderDate">Order Date:</div>
    <div id="titleOrderDate2" style="font-weight:bold;"></div>
    <div id="titleShipDate">Ship By:</div>
    <div id="titleSignedInAs">Signed In As:</div>
    <div id="titleShippingPriority">Shipping Priority</div>

    <div id="titleOrderDetails">Order Details:</div>
    <div id="titleBritesMessages">Brites Messages</div>
    <div id="titlePurchasedItems">Purchased Items</div>
    <div id="titleOrderNumber">Order Number</div>

    <input type="text" id="dateOrdered" readonly />
    <input type="text" id="shipDate" readonly />
    <input type="text" id="employeeName" placeholder="Employee Name" />

    <div id="signatureBox">Sig Box</div>

    <div id="configModal" class="modal">
      <div class="modal-content">
        <table class="striped" id="configTable">
          <thead>
            <tr>
              <th>Component Name</th>
              <th>Left (px)</th>
              <th>Top (px)</th>
              <th>Width (px)</th>
              <th>Height (px)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <a href="#!" id="saveConfigBtn" class="modal-close waves-effect waves-green btn">
          Save Config
        </a>
      </div>
    </div>

    <button id="goScreenTwoBtn" class="btn"
            style="position:absolute; left:180px; top:110px;
                   width:65px; height:24px; line-height:24px;
                   font-size:0.8em; text-align:center;">
      Send
    </button>

    <!-- ‚ñº‚ñº NEW: tracking / carrier / complete-order ‚ñº‚ñº -->
    <input id="trackingNumberInput"
           type="text"
           placeholder="Tracking #"
           style="position:absolute; left:260px; top:110px;
                  width:140px; height:24px; font-size:1.0em;" />

    <div id="carrierSelectWrap"
         style="position:absolute; left:410px; top:110px;
                width:110px; height:24px;">
      <select id="carrierSelect"
              style="width:100%; height:100%; font-size:0.75em;">
        <option value="" disabled selected>Carrier</option>
        <option value="chitchats">ChitChats</option>
        <option value="usps">USPS</option>
      </select>
    </div>

    <button id="completeOrderBtn" class="btn"
            style="position:absolute; left:530px; top:110px;
                   width:110px; height:24px; line-height:24px;
                   font-size:1.1em; text-align:center;">
      Complete Order
    </button>

  </div>

  <div id="secondaryContainer"></div>

  <!-- Brites chat image-viewer -->
  <div id="chatImgModal" class="modal">
    <div class="modal-content" style="padding:0;">
      <img id="chatImgModalImg" src="" style="width:100%;height:auto;display:block;">
    </div>
  </div>

  <!-- The user login modal -->
  <div id="userLoginModal" class="modal">
    <!-- A wrapper with position: relative, so children can be absolutely placed -->
    <div id="userLoginModalContainer" class="modal-content" style="position:relative;">
      <h5 id="loginModalTitle">User Log In</h5>
      <p id="loginModalPrompt">Please enter your 6-digit Employee Number:</p>
      <input
      type="text"
                   id="employeeNumberInput"
                   placeholder="000000"
                   maxlength="6"
                   inputmode="numeric"
                   autocomplete="one-time-code"
                   pattern="[0-9]{6}"
      />
    </div>
    <div id="loginModalFooter" class="modal-footer">
      <button id="employeeLoginBtn" class="btn">Log In</button>
    </div>
  </div>

  <!-- jQuery & Materialize -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"
  ></script>

  <!-- 1) Firebase loaded first, define db for global usage -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Firebase Storage (needed for image uploads) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBXhQLsYRa4i0bX1TPTRiElF9Zjy5vSHlA",
      authDomain: "gokudatabase.firebaseapp.com",
      projectId: "gokudatabase",
      storageBucket: "gokudatabase.firebasestorage.app",
      messagingSenderId: "1078662308113",
      appId: "1:1078662308113:web:41df0e5d229ff2af7a6cb0"
    };
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore(); // define globally
    firebase.auth().signInAnonymously()
      .then(()=>console.log("Anon auth ‚úî"))
      .catch(err=>console.error("Anon auth ‚ùå", err));
  </script>

  <script>
    /********** Global Variables **********/
    window.receiptIsGift = null;
    window.receiptGiftMessage = null;
    window.receiptGiftWrap = null;
    window.receiptGiftWrapPrice = null;
    window.receiptGiftMessageFrom = null;    
    window.orderName = "";
    window.orderStatus = "";
    window.orderIsShipped = "";
    window.cachedOrderItems = [];
    window.orderShippedTimestamp = null;
    window.orderShipments = [];
    window.currentTracking = null;
    window.currentCarrier = null;

    /* ‚îÄ‚îÄ‚îÄ helper: keep only one .selected box ‚îÄ‚îÄ‚îÄ */
    function highlightSelectedPreview(box){
      /* remove an earlier selection, if any */
      document.querySelectorAll(".preview-box.selected")
              .forEach(el => el.classList.remove("selected"));
      /* light up the newly clicked box */
      if(box) box.classList.add("selected");
    }

    /* helper: enforce vertical gaps WITHOUT touching left/right margins */
    function applyChatSpacing() {
      document.querySelectorAll("#customerMessageHistory .msg").forEach(el => {
        /* top & bottom only */
        el.style.setProperty("margin-top",    "5px", "important");
        el.style.setProperty("margin-bottom", "5px", "important");

        const meta = el.querySelector(".meta");
        if (meta) meta.style.setProperty("margin-bottom", "3px", "important");
      });
    }

    /* observe chat container and re-enforce spacing whenever nodes change */
    const chatContainer = document.getElementById("customerMessageHistory");
    if (chatContainer) {
      /* initial pass */
      applyChatSpacing();

  /* keep re-applying after any DOM mutations */
  new MutationObserver(applyChatSpacing)
    .observe(chatContainer, { childList: true, subtree: true });
}

    /* ===== CHAT TIMESTAMP util ========================================= */
    function formatChatTimestamp(date){
      return (date instanceof Date ? date : new Date(date))
        .toLocaleString("en-US",{
          month : "short",
          day   : "2-digit",
          hour  : "numeric",
          minute: "2-digit",
          hour12: true
        })
        .replace(/\s([ap])\.?m/i,(_,p)=>` ${p.toLowerCase()}m`); // ‚Üí ‚Äúpm‚Äù / ‚Äúam‚Äù
    }

    /* ===== utility: pleasant two-note chime ================================= */
    function playChime(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();

        // helper to schedule a note (freq in Hz, start offset in s)
        const note = (freq, when, dur = 0.18) =>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "sine";
          osc.frequency.value = freq;
          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.start(ctx.currentTime + when);
          osc.stop (ctx.currentTime + when + dur);

          // quick fade-out to avoid click
          gain.gain.setValueAtTime(0.6, ctx.currentTime + when);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + when + dur);
        };

        // WhatsApp-ish up-step: E6 ‚Üí A6
        note(1319, 0.00);   // E6
        note(1760, 0.20);   // A6
      }catch(err){
        console.warn("AudioContext error:", err);
      }
    }

    function extractOrderTitle(){
    const raw = (document.getElementById("orderDetails")?.value || "");
    const m = raw.match(/^\s*Title:\s*(.+)$/mi);
    return (m ? m[1] : "").trim();
  }

// Strong normalization for all the weird label combos
function normalizeMetalLabel(raw){
  let metalSel = String(raw || "");

  // 0) kill noisy labels (even when smashed together)
  //    e.g. "Metal Choice / Necklace LengthGold - 20" ‚Üí "... Gold - 20"
  //    - split camelCase first so "LengthGold" ‚Üí "Length Gold"
  metalSel = metalSel.replace(/([a-z])([A-Z])/g, "$1 $2");

  // remove label heads
  metalSel = metalSel
    .replace(/\bmetal\s*choice\b\s*\/?/gi, "")
    .replace(/\bengraving\s*option\b\s*\/?/gi, "")
    .trim();

  // 1) strip add-ons / counts / bullets
  metalSel = metalSel
    .replace(/\+\s*engraving/gi, "")
    .replace(/\+\s*engrave/gi, "")
    .replace(/\b1-5\s*Characters\b/gi, "")
    .replace(/\b6-10\s*Characters\b/gi, "")
    .replace(/\b11\s*\+\s*Characters\b/gi, "")
    .replace(/\b1-5\s*¬∑\s*Character(?:s)?\b/gi, "")
    .replace(/\b6-10\s*¬∑\s*Character(?:s)?\b/gi, "")
    .replace(/\b11\+\s*¬∑\s*Character(?:s)?\b/gi, "")
    .replace(/[¬∑‚Ä¢]/g, " ")
    .replace(/\s{2,}/g, " ")
    .trim();

  // 2) remove "Necklace Length" (with or without separators), trailing sizes
  metalSel = metalSel
    .replace(/\bnecklace\s*length\b[\s\/:]*/gi, "")
    .replace(/\s*-\s*\d+(\.\d+)?\s*(?:["‚Ä≤‚Äù‚Äù])?$/g, "") // remove "- 20" or - 20" etc
    .trim();

  const norm = metalSel.toLowerCase();

  // 3) canonical mapping ‚Äî explicit beats generic
  if (/(?:14k\s*)?(?:rose\s*gold|rosegold|rose\s*gold\s*filled|rosegold\s*filled|rosefilled)\b/.test(norm)) {
    return "Rose Gold";
  }
  if (/(?:14k\s*)?(?:gold\s*filled|goldfilled)\b/.test(norm)) {
    return "Gold Filled";
  }
  if (/(?:color\s*)?sterling\s*silver\b|silv[ae]?r\b/.test(norm)) {
    return "Silver";
  }
  if (/\b14k\b/.test(norm)) {
    return "14K";
  }
  if (/\bgold\b/.test(norm)) {
    // ‚úÖ plain "gold" ‚Üí Gold (not Gold Filled)
    return "Gold";
  }
  return metalSel; // fallback (unmapped)
}


function metalToBadge(label){
  const canon = normalizeMetalLabel(label);
  switch ((canon || "").toLowerCase()){
    case "14k":        return "üü° 14K";
    case "rose gold":  return "üü†";
    case "silver":     return "‚ö™";
    case "gold filled":return "üü°";
    case "gold":       return "üü°";
    default:           return "";
  }
}

    /* Replace any &quot; entity with a plain single quote */
    function deQuote(s){
      return (s == null ? "" : String(s)).replace(/&quot;/g, '"');
    }

    function sanitizeVatRef(raw){
      return (String(raw || "")
        .toUpperCase()
        .replace(/[^A-Z0-9]/g, "")
        .slice(0, 20)) || null;
    }

   // Day-only YYYY-MM-DD using local time (fixes UTC off-by-one)
   function _ymdLocal(d) {
     const yyyy = d.getFullYear();
     const mm   = String(d.getMonth() + 1).padStart(2, "0");
     const dd   = String(d.getDate()).padStart(2, "0");
     return `${yyyy}-${mm}-${dd}`;
   }
   function normalizeShipDate(s){
     const t = String(s || "").trim().toLowerCase();
     const now = new Date();
     const today = _ymdLocal(now);
     if (!t || t === "today") return today;
     if (t === "tomorrow") {
       const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
       return _ymdLocal(d);
     }

     function sanitizeVatRef(raw){
      return (String(raw || "")
        .toUpperCase()
        .replace(/[^A-Z0-9]/g, "")
        .slice(0, 20)) || null;
    }

    // Prefer API's 'today' token or pass-through YYYY-MM-DD; avoid parsing
   function getShipDateForApi(){
     const el = document.getElementById("cc_ship_date");
     const raw = String(el && el.value || "").trim();
     return raw ? raw : "today";
   }
     if (/^\d{4}-\d{2}-\d{2}$/.test(t)) return t;
     const d = new Date(t);
     return Number.isNaN(d.getTime()) ? today : _ymdLocal(d);
   }

   // Set sane defaults when the page is ready (prevents empty/past dates)
    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("cc_ship_date");
      if (el && !el.value) {
        const tz = new Date();
        const yyyy = tz.getFullYear();
        const mm = String(tz.getMonth()+1).padStart(2,"0");
        const dd = String(tz.getDate()).padStart(2,"0");
        el.value = `${yyyy}-${mm}-${dd}`;
        el.min   = el.value; // prevent past dates
      }

      /* üÜï Pre-fill Chit Chats Package defaults (Step 2) */
      (function prefillPackageDefaults(){
        const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
        const setIfBlank = (id, val) => {
          const el = document.getElementById(id);
          if (el && String(el.value||"").trim()==="") el.value = val;
        };
        // i)  Package type ‚Üí Thick Envelope
        set("cc_package_type", "thick_envelope");
        // ii) Size unit ‚Üí In
        set("cc_size_unit", "in");
        // iii) Weight unit ‚Üí lbs (select uses 'lb')
        set("cc_weight_unit", "lb");
        // iv‚Äìvi) Dimensions & weight
        setIfBlank("cc_size_x", "6");     // Length (X)
        setIfBlank("cc_size_y", "4");     // Width (Y)
        setIfBlank("cc_size_z", "1");     // Height (Z)
        setIfBlank("cc_weight", "0.25");  // Weight
      })();

      // üÜï keep currency badge in sync with selector
      const curSel = document.getElementById("cc_value_currency");
      if (curSel) curSel.addEventListener("change", updateGrandTotal);

    });

    /* üß∑ Last-line defense: block clicks while over limit */
    (function attachGrandTotalGuards(){
      const GRAND_TOTAL_LIMIT = 300;
      const guard = (e) => {
        const total = Number(document.getElementById("cc_grand_total")?.value || 0);
        const cur   = (document.getElementById("cc_value_currency")?.value || "").toUpperCase();
        if (total >= GRAND_TOTAL_LIMIT){
          e.stopImmediatePropagation?.(); e.preventDefault();
          window.M?.toast && M.toast({
            html: `Grand Total must be below $${GRAND_TOTAL_LIMIT} ${cur ? `(${cur})` : ""} to proceed.`,
            classes: "red darken-2"
          });
          return false;
        }
        return true;
      };
      ["ccNext","ccRefreshRates","ccBuy"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener("click", guard, true); // capture: intercept before other handlers
      });
    })();

    /* globals for realtime listener */
    let chatUnsub = null;        // holds the active Firestore unsubscribe fn
    let firstBatch = true;       // suppress chime on initial load

    /* ‚îÄ‚îÄ‚îÄ realtime Brites chat listener (now supports images) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function startBritesListener(orderId){
      if(chatUnsub) chatUnsub();
      chatUnsub = db
        .collection("Brites_Orders").doc(orderId)
        .collection("messages").orderBy("timestamp","asc")
        .onSnapshot(snap=>{
          const box = document.getElementById("customerMessageHistory");
          if(!box) return;

          let html = "";

          /* buyer‚Äôs original note (if any) */
          if (window.buyerMessageText && window.buyerMessageText.length){
            const ts = formatChatTimestamp(new Date());
            html += `<div class="msg received">
                       <span class="meta">Customer ‚Ä¢ ${ts}</span>
                       ${escapeHtml(window.buyerMessageText)}
                     </div>`;
          }

          snap.forEach(doc=>{
            const d  = doc.data();
            const dt = formatChatTimestamp(d.timestamp?.toDate() || new Date());

            const emp = (document.getElementById("employeeName").value||"")
                         .trim().toLowerCase();
            const bubbleCls =
              (d.senderName && d.senderName.trim().toLowerCase()===emp)
                ? "sent" : "received";

            /* üîó image vs. text */
            if (d.imageUrl){
              html += `<div class="msg ${bubbleCls}">
                         <span class="meta">${d.senderName} ‚Ä¢ ${dt}</span>
                         <a href="#!" class="img-link" data-src="${d.imageUrl}">üì∑ Image</a>
                       </div>`;
            } else {
              html += `<div class="msg ${bubbleCls}">
                         <span class="meta">${d.senderName} ‚Ä¢ ${dt}</span>
                         <span>${escapeHtml(d.text)}</span>
                       </div>`;
            }
          });

          /* üîî chime after initial batch */
          if (!firstBatch && snap.docChanges().some(c=>c.type==="added")) playChime();
          firstBatch = false;

          box.innerHTML = html.replace(/&quot;/g, '"');
          box.scrollTop = box.scrollHeight;
          applyChatSpacing();
        });
    }
    /* basic XSS guard */
    function escapeHtml(str=""){
      return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",
                                         "\"":"&quot;","'":"&#039;"}[m]));
    }

    window.isEmployeeLoggedIn = false; // We'll use this to guard the real-time listener
        let lastScanProcessed = null;      // üîë remember most-recent scanned order

    /********************************************************
     * Base URL & Global Variables
     ********************************************************/
    const functionsBaseUrl = window.location.origin + "/.netlify/functions";

    /* ===== Etsy OAuth boot + auto-refresh wiring (match design/sorting) ===== */
    const TOKEN_KEYS = {
      access  : "access_token",
      refresh : "refresh_token",
      expires : "token_expires_at"   // epoch seconds
    };

    let __refreshPromise = null;  // single-flight guard

    // Extract a numeric unit price from Etsy's various shapes
    function extractUnitPriceFromEtsy(item){
      const pickNum = v => (v == null ? NaN : Number(v));
      const src = item?.price ?? item?.transaction_price ?? item?.listing_price ?? item?.variation_price ?? null;
      if (src && typeof src === "object") {
        const amount  = pickNum(src.amount ?? src.value ?? src.gross ?? src.net);
        const divisor = pickNum(src.divisor ?? 100);
        if (!Number.isNaN(amount)) return amount / (divisor || 1);
      }
      const num = pickNum(src);
      return Number.isNaN(num) ? NaN : num;
    }

    // Extract SKU across the common Etsy transaction shapes
    function extractSkuFromEtsy(it){
      // direct field
      if (it?.sku) return String(it.sku);
      // nested product data
      if (it?.product_data?.sku) return String(it.product_data.sku);
      if (it?.product?.sku) return String(it.product.sku);
      // variations array with sku on an element
      if (Array.isArray(it?.variations)) {
        const v = it.variations.find(x => x && x.sku);
        if (v?.sku) return String(v.sku);
      }
      if (Array.isArray(it?.product_variations)) {
        const v = it.product_variations.find(x => x && x.sku);
        if (v?.sku) return String(v.sku);
      }
      return "";
    }

    /* ======================= */
    function prefillCustomsFromEtsy(){
      try {
        renderCcLineItemsFromCached();
      } catch (e){
        console.warn("prefillCustomsFromEtsy() failed:", e);
      }
    }

    function buildEtsyDesc(it){
    const title = (it?.title || it?.listing_title || it?.name || "Item").toString();
    const props = it?.property_values || it?.variations || [];
    const varStr = Array.isArray(props)
      ? props.map(p => {
          const k = p?.property_name || p?.name || p?.property_name_formatted || "";
          const v = p?.value || (Array.isArray(p?.values) ? p.values[0] : p?.formatted_value) || "";
          return (k && v) ? `${k}: ${v}` : (v || k || "");
        }).filter(Boolean).join(", ")
      : "";
    return varStr ? `${title} (${varStr})` : title;
  }

  function groupUniqueItems(items){
    const map = new Map();
    for (const it of (items || [])){
      const sku = it?.__sku ?? extractSkuFromEtsy(it) ?? "";
      const unit = (typeof it.__unitValue === "number" && isFinite(it.__unitValue))
        ? it.__unitValue
        : (Number(it?.price?.amount || it?.price || 0) / (Number(it?.price?.divisor || 100) || 1)) || 0;

      const qty  = (typeof it.__qty === "number" && isFinite(it.__qty))
        ? it.__qty
        : Number(it?.quantity || it?.qty || it?.purchase_quantity || 1);

        const desc = buildEtsyDesc(it);
        const key  = `${it?.listing_id || it?.listingId || desc}||${desc}||${sku}`;
        const cur  = map.get(key) || { desc, unit, qty:0, raw: it, sku };
      // If unit varies slightly across identical SKUs (discounts/rounding), prefer lower (customer paid)
      cur.unit = Math.min(cur.unit || unit, unit || cur.unit || 0);
      cur.qty += qty || 0;
      map.set(key, cur);
    }
    return Array.from(map.values());
  }

  function renderCcLineItemsFromCached(){
    const container = document.getElementById("cc_line_items_container");
    const tpl = document.getElementById("cc_line_item_tpl");
    if (!container || !tpl) return;

    container.innerHTML = "";

    const items = Array.isArray(window.cachedOrderItems) ? window.cachedOrderItems : [];
    const groups = groupUniqueItems(items);

    // sensible defaults (mirror old single-field defaults)
    const defaults = {
      origin_country: "CA",
      hs: "7113.19.5091",
      manuf_country: "CA",
      m_contact: "Brites Jewelry Inc.",
      m_street:  "450 Matheson Blvd, East",
      m_city:    "Mississauga",
      m_prov:    "ON",
      m_postal:  "L4Z-1R5",
      m_phone:   "416-606-2476",
      m_email:   "michelle@custombrites.com"
    };

    groups.forEach((g, i) => {
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.dataset.index = String(i);
      node.querySelector(".cc-li-number").textContent = String(i+1);

      const $ = sel => node.querySelector(sel);
      const qDesc = $(".cc_item_description");
      const qSku  = $(".cc_item_sku");
      const qQty  = $(".cc_item_qty");
      const qUnit = $(".cc_item_unit_value");
      const qVal  = $(".cc_item_value");

      qDesc.value = g.desc || "Item";
      qSku.value  = (g.sku || (g.raw ? extractSkuFromEtsy(g.raw) : "") || "") + "";
      qQty.value  = String(Math.max(1, Math.round(g.qty || 1)));
      qUnit.value = (Number(g.unit || 0)).toFixed(2);
      qVal.value  = (Number(qQty.value) * Number(qUnit.value)).toFixed(2);

      const bindRecalc = () => {
        const iv = (Number(qQty.value || 0) * Number(qUnit.value || 0));
        qVal.value = isFinite(iv) ? iv.toFixed(2) : "";
        updateGrandTotal();
      };
      qQty.addEventListener("input", bindRecalc);
      qUnit.addEventListener("input", bindRecalc);

      // defaults
      $(".cc_item_origin_country").value             = defaults.origin_country;
      $(".cc_item_hs_tariff_code").value             = defaults.hs;
      $(".cc_item_manufacture_country").value        = defaults.manuf_country;
      $(".cc_item_manufacturer_contact").value       = defaults.m_contact;
      $(".cc_item_manufacturer_street").value        = defaults.m_street;
      $(".cc_item_manufacturer_city").value          = defaults.m_city;
      $(".cc_item_manufacturer_province_code").value = defaults.m_prov;
      $(".cc_item_manufacturer_postal_code").value   = defaults.m_postal;
      $(".cc_item_manufacturer_phone").value         = defaults.m_phone;
      $(".cc_item_manufacturer_email").value         = defaults.m_email;

      container.appendChild(node);
    });

    // üÜï compute total once after render
    updateGrandTotal();

    // If no items (edge), render one empty tranche so user can fill manually
    if (!groups.length){
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.dataset.index = "0";
      node.querySelector(".cc-li-number").textContent = "1";
      container.appendChild(node);
    }
  }

  function collectCcLineItems(){
    const out = [];
    const nodes = document.querySelectorAll("#cc_line_items_container .cc-line-item");
    nodes.forEach(node => {
      const $ = sel => node.querySelector(sel);
      const line = {
        description: ($(".cc_item_description")?.value || "").trim(),
        sku         : ($(".cc_item_sku")?.value || "").trim() || null,
        quantity    : Number($(".cc_item_qty")?.value || 1),
        unit_value  : Number($(".cc_item_unit_value")?.value || 0),
        // NEW: total item value from the UI field (falls back later if blank)
        value       : Number($(".cc_item_value")?.value || 0),
        origin_country      : ($(".cc_item_origin_country")?.value || "").trim().toUpperCase() || null,
        hs_tariff_code      : ($(".cc_item_hs_tariff_code")?.value || "").trim() || null,
        manufacture_country : ($(".cc_item_manufacture_country")?.value || "").trim().toUpperCase() || null,
        manufacturer_contact       : ($(".cc_item_manufacturer_contact")?.value || "").trim() || null,
        manufacturer_street        : ($(".cc_item_manufacturer_street")?.value || "").trim() || null,
        manufacturer_city          : ($(".cc_item_manufacturer_city")?.value || "").trim() || null,
        manufacturer_province_code : ($(".cc_item_manufacturer_province_code")?.value || "").trim() || null,
        manufacturer_postal_code   : ($(".cc_item_manufacturer_postal_code")?.value || "").trim() || null,
        manufacturer_phone         : ($(".cc_item_manufacturer_phone")?.value || "").trim() || null,
        manufacturer_email         : ($(".cc_item_manufacturer_email")?.value || "").trim() || null
      };
      if (line.description) out.push(line);
    });
    return out;
  }

  /* üÜï Build Chit Chats-ready line items for your snippet */
  function buildLineItems(){
    const toCountry = (document.getElementById("cc_to_country_code")?.value || "").trim().toUpperCase();
    const currency  = (document.getElementById("cc_value_currency")?.value || (toCountry === "CA" ? "CAD" : "USD")).toUpperCase();

    return collectCcLineItems().map(li => ({
      description   : li.description,
      quantity      : Number(li.quantity) || 1,
      value_amount  : toMoney(li.unit_value), // per-unit; Chit Chats multiplies by quantity
      currency_code : currency,
      hs_tariff_code: li.hs_tariff_code || undefined,
      sku_code      : li.sku || undefined,
      origin_country: (li.origin_country || "").toUpperCase() || undefined
    }));
  }

  /* üÜï Sum all ".cc_item_value" and show it in #cc_grand_total */
  function updateGrandTotal(){
    try{
      const vals = Array.from(document.querySelectorAll("#cc_line_items_container .cc_item_value"))
        .map(el => Number(el.value || 0))
        .filter(n => Number.isFinite(n));
      const total = vals.reduce((a,b)=>a+b, 0);
      const cur = (document.getElementById("cc_value_currency")?.value || "").toUpperCase();
      const out = document.getElementById("cc_grand_total");
      if (out) out.value = total.toFixed(2);
      const curEl = document.getElementById("cc_grand_total_currency");
      if (curEl) curEl.textContent = cur ? `(${cur})` : "";

      /* üîí Over-limit enforcement */
      const GRAND_TOTAL_LIMIT = 300; // currency-agnostic hard cap
      const over = total >= GRAND_TOTAL_LIMIT;
      const nextBtn    = document.getElementById("ccNext");
      const buyBtn     = document.getElementById("ccBuy");
      const rateBtn    = document.getElementById("ccRefreshRates");
      [nextBtn, buyBtn, rateBtn].forEach(b => { if (b) b.disabled = over; });

      // fire toast only on state change ‚Üí avoid spam while typing
      window.__gtOverLimit = window.__gtOverLimit ?? false;
      if (over !== window.__gtOverLimit){
        window.__gtOverLimit = over;
        if (over && window.M?.toast){
          M.toast({
            html: `Grand Total is $${total.toFixed(2)} ${cur ? `(${cur})` : ""}. Reduce below $${GRAND_TOTAL_LIMIT} to continue.`,
            classes: "red darken-2"
          });
        }
      }

    }catch(e){
      console.warn("updateGrandTotal() failed:", e);
    }
  }

    /* =======================*/
    async function maybeLoadEtsyTransactions(receiptId){
      try{
        if(!receiptId) return [];

        // Always use apiFetch so we inherit token refresh/retry behavior
        const res = await apiFetch(`/etsyOrderProxy?orderId=${encodeURIComponent(receiptId)}&include=transactions`);
        if(!res?.ok) return [];
        const out = await res.json();

        // ---- normalize "transactions" array out of various shapes ----
        let items = [];
        if (Array.isArray(out)) items = out;
        else if (Array.isArray(out?.transactions)) items = out.transactions;
        else if (Array.isArray(out?.data?.transactions)) items = out.data.transactions;
        else if (Array.isArray(out?.results)) items = out.results;

        // ---- helpers ----
        function parseMoney(m){
          if (!m && m !== 0) return null;
          if (typeof m === "number" || typeof m === "string") return Number(m);
          if (typeof m === "object"){
            if (typeof m.amount === "number" && typeof m.divisor === "number" && m.divisor) return m.amount / m.divisor;
            if (typeof m.value  === "number") return m.value;
            if (typeof m.cents  === "number") return m.cents / 100;
            if (typeof m.amount === "string") return Number(m.amount);
          }
          return null;
        }
        const round2 = n => Math.round((Number(n)||0) * 100) / 100;

        // ----- extract an order-level discount if present -----
        const orderDiscountCandidates = [
          out?.discount_amt, out?.discount_amount, out?.total_discounts,
          out?.receipt?.discount_amt, out?.receipt?.discount_amount, out?.receipt?.total_discounts,
          out?.data?.discount_amt, out?.data?.discount_amount, out?.data?.total_discounts,
          out?.data?.receipt?.discount_amt, out?.data?.receipt?.discount_amount, out?.data?.receipt?.total_discounts
        ];
        let orderLevelDiscount = 0;
        for (const c of orderDiscountCandidates){
          const v = parseMoney(c);
          if (v && v > 0){ orderLevelDiscount = v; break; }
        }

        // ----- first pass: derive qty and BASE (pre-discount) unit value -----
        const baseNormalized = items.map(it => {
          const qty = it.quantity ?? it.qty ?? it.purchase_quantity ?? it.count ?? null;

          const baseUnit =
            parseMoney(it.price) ??
            parseMoney(it.unit_price) ??
            parseMoney(it.original_unit_price) ??
            parseMoney(it.variation_price) ?? null;

          return {
            ...it,
            __qty: (qty!=null ? Number(qty) : null),
            __unitValueBase: (baseUnit!=null ? Number(baseUnit) : null)
          };
        });

        // ----- compute total pre-discount line value for pro-rating -----
        const totalPreDiscount = baseNormalized.reduce((sum, it) => {
          const q = (typeof it.__qty === "number" && isFinite(it.__qty)) ? it.__qty : 0;
          const u = (typeof it.__unitValueBase === "number" && isFinite(it.__unitValueBase)) ? it.__unitValueBase : 0;
          return sum + (q > 0 && u >= 0 ? (q * u) : 0);
        }, 0);

        // ----- second pass: apply item-level + pro-rated order-level discounts -----
        const normalized = baseNormalized.map(it => {
          const qty = (typeof it.__qty === "number" && isFinite(it.__qty) && it.__qty > 0) ? it.__qty : 1;
          const baseU = (typeof it.__unitValueBase === "number" && isFinite(it.__unitValueBase) && it.__unitValueBase >= 0)
            ? it.__unitValueBase : 0;

          // pull any item-specific discount fields we might see
          let itemLevelDiscount = 0;
          const itemDiscountCandidates = [
            it.discount_amt, it.discount_amount, it.item_discount, it.order_discount, it.total_discount,
            it.seller_coupon_discount_amount, it.price_discount, it.price_discount_amount
          ];
          for (const c of itemDiscountCandidates){
            const v = parseMoney(c);
            if (v && v > 0) itemLevelDiscount += v;
          }
          // arrays like applied_discounts: [{amount}, ...]
          if (Array.isArray(it.applied_discounts)){
            for (const d of it.applied_discounts){
              const v = parseMoney(d?.amount ?? d?.discount_amount);
              if (v && v > 0) itemLevelDiscount += v;
            }
          }

          // pro-rate any order-level discount by line share of the pre-discount total
          const linePre = baseU * qty;
          const share = (orderLevelDiscount > 0 && totalPreDiscount > 0) ? (linePre / totalPreDiscount) : 0;
          const orderDiscountForLine = orderLevelDiscount * share;

          const totalDiscountForLine = (itemLevelDiscount || 0) + (orderDiscountForLine || 0);
          const perUnitDiscount = totalDiscountForLine / qty;

          const effectiveUnit = round2(Math.max(0, baseU - perUnitDiscount));

          return {
            ...it,
            __qty: qty,
            __unitValueBase: round2(baseU),     // for reference/debug
            __unitValue: effectiveUnit,         // ‚Üê this is what prefillCustomsFromEtsy will use
            __sku: extractSkuFromEtsy(it) || null,
            __discounts: {
              itemLevel: round2(itemLevelDiscount || 0),
              orderLevelAllocated: round2(orderDiscountForLine || 0),
              perUnitApplied: round2(perUnitDiscount || 0)
            }
          };
        });

        // Cache for the UI prefill + preview tiles
        window.cachedOrderItems = normalized;
        return normalized;
      } catch(err){
        console.error("maybeLoadEtsyTransactions error:", err);
        return [];
      }
    }

    function scheduleTokenRefresh(){
      clearTimeout(window.__etsyRefreshTimer);
      const exp = Number(localStorage.getItem(TOKEN_KEYS.expires) || 0);
      if (!exp){
        if (localStorage.getItem(TOKEN_KEYS.refresh)){
          window.__etsyRefreshTimer = setTimeout(refreshAccessToken, 55 * 60 * 1000);
        }
        return;
      }
      const now = Math.floor(Date.now()/1000);
      const leadSec = 120;
      const delayMs = Math.max(5000, (exp - now - leadSec) * 1000);
      window.__etsyRefreshTimer = setTimeout(refreshAccessToken, delayMs);
    }

    function setTokens({ access_token, refresh_token, expires_in, issued_at }){
      if (access_token)  localStorage.setItem(TOKEN_KEYS.access,  access_token);
      if (refresh_token) localStorage.setItem(TOKEN_KEYS.refresh, refresh_token);
      const now = Math.floor(Date.now()/1000);
      const iat = Number(issued_at || now);
      const exp = iat + Number(expires_in || 3600);
      localStorage.setItem(TOKEN_KEYS.expires, String(exp));
      scheduleTokenRefresh();
    }

    async function refreshAccessToken(){
      if (__refreshPromise) return __refreshPromise;
      const rt = localStorage.getItem(TOKEN_KEYS.refresh);
      if (!rt) return;
      __refreshPromise = (async () => {
        try{
          const resp = await fetch(`${functionsBaseUrl}/refreshEtsyToken`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh_token: rt })
          });
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const data = await resp.json();
          setTokens({
            access_token : data.access_token,
            // Etsy rotates refresh_token; if omitted, keep old
            refresh_token: data.refresh_token || rt,
            expires_in   : data.expires_in,
            issued_at    : data.issued_at || Math.floor(Date.now()/1000)
          });
          M.toast?.({ html: "Etsy token refreshed" });
          return true;
        }catch(err){
          console.warn("Token refresh failed:", err);
          // Clear & start headless OAuth (no button clicks)
          localStorage.removeItem(TOKEN_KEYS.access);
          localStorage.removeItem(TOKEN_KEYS.expires);
          await startOAuth("refresh-failed");
          throw err;
        }finally{
          __refreshPromise = null;
        }
      })();
      return __refreshPromise;
    }

    async function ensureFreshToken(){
      const exp = Number(localStorage.getItem(TOKEN_KEYS.expires) || 0);
      if (!exp) return;
      const now = Math.floor(Date.now()/1000);
      if (exp - now <= 120) await refreshAccessToken();
    }

    /* Resilient fetch against our Functions:
       - ensures token freshness
       - retries once on 401 after refresh
       - if still 401, kicks off headless OAuth and throws */
    async function apiFetch(path, init = {}){
      await ensureFreshToken();
      let token = localStorage.getItem(TOKEN_KEYS.access) || "";

      let resp = await fetch(`${functionsBaseUrl}${path}`, {
        ...init,
        headers: { ...(init.headers || {}), "access-token": token }
      });

      if (resp.status === 401){
        try{
          await refreshAccessToken();
          token = localStorage.getItem(TOKEN_KEYS.access) || "";
          resp  = await fetch(`${functionsBaseUrl}${path}`, {
            ...init,
            headers: { ...(init.headers || {}), "access-token": token }
          });
        }catch(_){}
      }

      if (resp.status === 401){
        localStorage.removeItem(TOKEN_KEYS.access);
        localStorage.removeItem(TOKEN_KEYS.expires);
        await startOAuth("401");
        throw new Error("Unauthorized");
      }
      return resp;
    }

    (function () {
      // Handle OAuth callback & wire up page events (fully closed)
      const url = new URL(window.location.href);
      const oauthCode  = url.searchParams.get("code");
      const oauthState = url.searchParams.get("state");
      const hasCallback = Boolean(oauthCode);

      // Legacy (server-initiated) OAuth kept for reference but NOT used
      async function startOAuthLegacy(reason = "manual") {
        try {
          const resp = await fetch(`${functionsBaseUrl}/startEtsyOAuth`, { method: "POST" });
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const { authUrl } = await resp.json();
          if (!authUrl) throw new Error("No authUrl from server");
          window.location.href = authUrl;
        } catch (err) {
          console.error("startOAuth failed:", err);
          M.toast?.({ html: "OAuth error: " + err.message });
        }
      }
    
      async function finishOAuthIfNeeded() {
        if (!hasCallback) return;
        try {
          const resp = await fetch(`${functionsBaseUrl}/completeEtsyOAuth`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code: oauthCode, state: oauthState })
          });
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const data = await resp.json();
          setTokens({
            access_token : data.access_token,
            refresh_token: data.refresh_token,
            expires_in   : data.expires_in,
            issued_at    : data.issued_at
          });
          window.history.replaceState({}, document.title, window.location.pathname);
          M.toast?.({ html: "Etsy connected" });
        } catch (err) {
          console.error("OAuth completion failed:", err);
          M.toast?.({ html: "OAuth completion failed" });
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Route button to HEADLESS PKCE flow defined later (global)
        document.getElementById("connectEtsyBtn")
          ?.addEventListener("click", () => window.startOAuth?.("manual"));
        // Headless PKCE handles its own callback via /exchangeToken; no legacy finish step
        // finishOAuthIfNeeded();
      });
    })();

      // Money helpers (global + idempotent)
      if (typeof window.toMoney !== "function") {
        window.toMoney = function toMoney(n){
          const v = Number(n || 0);
          return Number.isFinite(v) ? (Math.round(v * 100)/100).toFixed(2) : "0.00";
        };
      }
    
// ‚Äî OAuth query handling (self-contained; safe to return inside)
(() => {
  const qs = new URLSearchParams(window.location.search);

      // Tokens returned by exchangeToken.js (access, refresh, expires_in, issued_at)
      const a = qs.get("access_token");
      if (a) {
        setTokens({
          access_token : a,
          refresh_token: qs.get("refresh_token"),
          expires_in   : qs.get("expires_in"),
          issued_at    : qs.get("issued_at")
        });
        window.history.replaceState({}, document.title, window.location.pathname);
        M.toast?.({ html: "Connection Successful!" });
        return;
      }

      // Standard OAuth code return ‚Üí hand back to server for code‚Üítokens
      const code = qs.get("code");
      if (code) {
        const v = localStorage.getItem("etsy_code_verifier");
        if (v) {
          const next = new URLSearchParams({ code, code_verifier: v, redirect_domain: "shipping-1" });
          window.location.href = "/.netlify/functions/exchangeToken?" + next.toString();
          return;
        } else {
          console.error("No code verifier found in localStorage.");
        }
      }

      // Page load without query: rehydrate or refresh or boot OAuth
      if (localStorage.getItem(TOKEN_KEYS.access)) {
        scheduleTokenRefresh();
      } else if (localStorage.getItem(TOKEN_KEYS.refresh)) {
        refreshAccessToken();
      } else {
        // No tokens at all ‚Üí start OAuth silently (like design/sorting)
        startOAuth("boot");
      }
    })();

    // Ensure a single, global source of truth for the proxy endpoint
    (function(){
      const fnBase = "/.netlify/functions";
      const DEFAULT_FN = `${fnBase}/testChitChats`; // rename if your function name differs

      function getCcEndpoint(){
        if (window.chitChatsFn) return window.chitChatsFn; // prefer explicit global if set
        const base = location.hostname.includes("goldenspike")
          ? "https://shipping-1.goldenspike.app/.netlify/functions"
          : "/.netlify/functions";
        return `${base}/testChitChats`; // keep this in sync with your function name
      }

      // Expose both, so either style of call site works
      window.getCcEndpoint = getCcEndpoint;
      window.chitChatsFn   = window.chitChatsFn || DEFAULT_FN;
    })();

    function generateRandomString(length){
      var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      var text = "";
      for(var i = 0; i < length; i++){
        text += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return text;
    }
    async function generateCodeChallenge(codeVerifier){
      var encoder = new TextEncoder();
      var data = encoder.encode(codeVerifier);
      var digest = await crypto.subtle.digest("SHA-256", data);
      var base64String = btoa(String.fromCharCode.apply(null, new Uint8Array(digest)));
      return base64String.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

     // Headless OAuth starter (no UI clicks needed)
    let __oauthInFlight = false;
    async function startOAuth(reason = "auto"){
      if (__oauthInFlight) return;
      __oauthInFlight = true;
      try{
        const codeVerifier = generateRandomString(64);
        localStorage.setItem("etsy_code_verifier", codeVerifier);
        const codeChallenge = await generateCodeChallenge(codeVerifier);
        const CLIENT_ID   = "k75zdspz4r99txpqdji7i2em";
        const redirectUri = "https://shipping-1.goldenspike.app";
        const scope       = "listings_w listings_r transactions_r transactions_w";
        const state       = `reconnect_${Date.now()}_${reason}`;
        const etsyAuthUrl =
          "https://www.etsy.com/oauth/connect?response_type=code" +
          "&client_id=" + CLIENT_ID +
          "&redirect_uri=" + encodeURIComponent(redirectUri) +
          "&scope=" + encodeURIComponent(scope) +
          "&state=" + encodeURIComponent(state) +
          "&code_challenge=" + encodeURIComponent(codeChallenge) +
          "&code_challenge_method=S256";
        window.location.href = etsyAuthUrl;
      }catch(e){
        console.error("OAuth boot failed:", e);
        __oauthInFlight = false;
      }
    }

    /*
     * Incorporate the new login modal elements in the config array so they're adjustable.
     */
      var configComponentIDs = [
        "connectEtsyBtn","openConfigBtn","signOutBtn","orderLinkBtn","trackingLinkBtn","etsyOrderNumber","Photo_Grid","quantityCell0","quantityCell1","quantityCell2","quantityCell3",
        "quantityCell4", "shippingPriority", "quantityCell5","quantityCell6","quantityCell7",
        "metalCell0","metalCell1","metalCell2","metalCell3",
        "metalCell4","metalCell5","metalCell6","metalCell7",
        "orderDetails", "shipAddressBox", "copyOrderDetailsBtn", "customerMessageHistory","britesMsgInput","dateOrdered","shipDate",
        "employeeName","trackingNumberInput","carrierSelectWrap","completeOrderBtn",
        "titleOrderDate","titleOrderDate2","titleShipDate",
        "titleSignedInAs",
        "titleOrderDetails","titleShippingPriority","titleBritesMessages","titlePurchasedItems","titleOrderNumber",
        "titleShipping",                // üÜï make ‚ÄúShipping‚Äù configurable
        "goScreenTwoBtn",
        /* Existing modal references */
        "userLoginModal",
        /* Newly added for positioning the login elements */
        "userLoginModalContainer",
        "pasteOrderBtn",
        "pasteTrackingBtn",
        "loginModalTitle",
        "loginModalPrompt",
        "employeeNumberInput",
        "loginModalFooter",
        "employeeLoginBtn",
        "ccControls","ccShipmentId","ccIdSpinner","ccBatchSelectWrap","ccBatchName",
        "ccCreateBatchBtn","ccAddToBatchBtn","ccRemoveFromBatchBtn",
        "ccEditBtn"
      ];

    // Updated default positions block
    const defaultPositions = {
      connectEtsyBtn:       { left: 1062, top: 781,  width: 107, height: 35 },
      openConfigBtn:        { left: 1184, top: 781,  width: 132, height: 35 },
      orderLinkBtn:         { left: 639,  top: 127,   width: 30,  height: 30 },
      trackingLinkBtn:      { left: 134,  top: 248,  width: 15,  height: 16 },
      etsyOrderNumber:      { left: 11,   top: 7,    width: 282, height: 45 },
      Photo_Grid:           { left: 538,  top: 162,  width: 632, height: 272 },

      quantityCell0:        { left: 536,  top: 339,  width: 152, height: 45 },
      quantityCell1:        { left: 737,  top: 339,  width: 152, height: 45 },
      quantityCell2:        { left: 937,  top: 339,  width: 153, height: 45 },
      quantityCell3:        { left: 1136, top: 339,  width: 153, height: 45 },
      quantityCell4:        { left: 535,  top: 568,  width: 153, height: 45 },
      quantityCell5:        { left: 737,  top: 568,  width: 153, height: 45 },
      quantityCell6:        { left: 937,  top: 568,  width: 153, height: 45 },
      quantityCell7:        { left: 1136, top: 568,  width: 153, height: 45 },

      metalCell0:           { left: 537,  top: 354,  width: 153, height: 45 },
      metalCell1:           { left: 737,  top: 354,  width: 153, height: 45 },
      metalCell2:           { left: 937,  top: 354,  width: 153, height: 45 },
      metalCell3:           { left: 1136, top: 354,  width: 153, height: 45 },
      metalCell4:           { left: 536,  top: 583,  width: 153, height: 45 },
      metalCell5:           { left: 737,  top: 583,  width: 153, height: 45 },
      metalCell6:           { left: 937,  top: 583,  width: 153, height: 45 },
      metalCell7:           { left: 1136, top: 583,  width: 153, height: 45 },

      orderDetails:           { left: 10,   top: 162,  width: 300, height: 342 },
      shipAddressBox:         { left: 324,   top: 162,  width: 200, height: 186 },
      customerMessageHistory: { left: 10,   top: 577,  width: 300, height: 266 },
      britesMsgInput:         { left: 14, top: 543, width: 295, height: 23 },

      dateOrdered:          { left: 10,   top: 100,  width: 145, height: 30 },
      shipDate:             { left: 164,  top: 100,  width: 145, height: 30 },
      employeeName:         { left: 1226, top: 23,   width: 98, height: 30 },

      titleOrderDate:       { left: 10,   top: 82,   width: 99,  height: 25 },
      titleOrderDate2:      { left: 127,  top: 209,  width: 145, height: 15 },
      titleShipDate:        { left: 167,  top: 82,   width: 99,  height: 15 },
      titleSignedInAs:      { left: 1226, top: 7,    width: 75,  height: 15 },
      titleOrderDetails:    { left: 11,   top: 144,  width: 99,  height: 15 },
      titleBritesMessages:    { left: 10,   top: 518,  width: 95,  height: 15 },
      titlePurchasedItems:  { left: 538,  top: 135,   width: 99,  height: 15 },
      titleOrderNumber:     { left: 11,   top: 7,    width: 99,  height: 15 },

      goScreenTwoBtn:       { left: 245, top: 536,    width: 65, height: 31 },
      signatureBox:         { left: 624,  top: 19,   width: 105, height: 34 },

      // The modal elements:
      userLoginModal:       { left: 0,    top: 0,    width: 0,   height: 0 },
      userLoginModalContainer: { left:0,  top: 0,    width: 0,   height: 0 },
      loginModalTitle:      { left: 130,    top: 0,    width: 250,   height: 0 },
      loginModalPrompt:     { left: 40,    top: 90,    width: 325,   height: 0 },
      employeeNumberInput:  { left: 40,   top: 60,   width: 75, height: 35 },
      loginModalFooter:     { left: 20,    top: 0,    width: 250,   height: 0 },
      employeeLoginBtn:     { left: 130,   top: 150,   width: 100, height: 35 },
      trackingNumberInput:{ left:677, top:674, width:308, height:23 },
      carrierSelectWrap:  { left:539, top:664, width:107, height:23 },
      completeOrderBtn:    { left:678, top:730, width:300, height:65 },
      titleShipping:        { left: 700, top: 10, width: 200, height: 30 },
      copyOrderDetailsBtn: { left: 242, top: 165, width: 65, height: 35 },
      shippingPriority: { left: 324, top: 106, width: 200, height: 24 },
      titleShippingPriority: { left: 324, top: 82, width: 200, height: 15 },
      pasteOrderBtn:     { left: 299, top: 16, width: 70, height: 35 },
      pasteTrackingBtn:  { left: 998, top: 663, width: 70, height: 35 },
      signOutBtn:           { left: 1400,  top: 17, width: 103, height: 35 },
      ccControls:            { left: 1400,  top: 50, width: 150, height: 45 },
      ccShipmentId:          { left: 1400,  top: 80, width: 175, height: 45 },
      ccIdSpinner:           { left: 1580,  top: 86, width: 16,  height: 16 },
      ccBatchSelectWrap:     { left: 1400, top: 110, width:  175, height: 45 },
      ccBatchName:           { left: 1400, top: 140, width: 175, height: 45 },
      ccCreateBatchBtn:      { left: 1400, top: 170, width: 175, height: 45 },
      ccAddToBatchBtn:       { left: 1400, top: 200, width: 175, height: 45 },
      ccRemoveFromBatchBtn:  { left: 1400, top: 230, width: 175, height: 45 },
      ccEditBtn:             { left: 50,   top: 225, width: 120, height: 28 }

    };

    function loadPositions(){
      for(var i=0; i<configComponentIDs.length; i++){
        var id = configComponentIDs[i];
        var el = document.getElementById(id);
        if(!el) continue;

        var def = defaultPositions[id] || { left:0, top:0, width:0, height:0 };

        var left = localStorage.getItem("pos-"+id+"-left");
        var top  = localStorage.getItem("pos-"+id+"-top");
        var w    = localStorage.getItem("pos-"+id+"-width");
        var h    = localStorage.getItem("pos-"+id+"-height");

        if(left === null)  left = def.left;
        if(top === null)   top  = def.top;
        if(w === null)     w    = def.width;
        if(h === null)     h    = def.height;

        el.style.position = "absolute";
        el.style.left   = left + "px";
        el.style.top    = top  + "px";
        el.style.width  = w    + "px";
        el.style.height = h    + "px";
      }
    }

    function populateConfigTable(){
      var tbody = document.getElementById("configTable").querySelector("tbody");
      tbody.innerHTML = "";

      for(var i=0; i<configComponentIDs.length; i++){
        var id = configComponentIDs[i];
        var el = document.getElementById(id);
        if(!el) continue;

        var compName = (el.textContent && el.textContent.trim()) || (el.value && el.value.trim()) || id;
        var cs = window.getComputedStyle(el);

        var leftVal = (cs.left === "auto") ? 0 : parseInt(cs.left, 10);
        var topVal = (cs.top === "auto") ? 0 : parseInt(cs.top, 10);
        var widthVal = (cs.width === "auto") ? 0 : parseInt(cs.width, 10);
        var heightVal = (cs.height === "auto") ? 0 : parseInt(cs.height, 10);

        var row = document.createElement("tr");
        row.innerHTML = `
          <td>${compName}</td>
          <td><input type='number' value='${leftVal}' data-id='${id}' class='left-input'></td>
          <td><input type='number' value='${topVal}' data-id='${id}' class='top-input'></td>
          <td><input type='number' value='${widthVal}' data-id='${id}' class='width-input'></td>
          <td><input type='number' value='${heightVal}' data-id='${id}' class='height-input'></td>
        `;
        tbody.appendChild(row);

        row.querySelector(".left-input").addEventListener("input", function(){
          var tgt = document.getElementById(this.getAttribute("data-id"));
          if(tgt) tgt.style.left = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".top-input").addEventListener("input", function(){
          var tgt2 = document.getElementById(this.getAttribute("data-id"));
          if(tgt2) tgt2.style.top = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".width-input").addEventListener("input", function(){
          var tgt3 = document.getElementById(this.getAttribute("data-id"));
          if(tgt3) tgt3.style.width = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".height-input").addEventListener("input", function(){
          var tgt4 = document.getElementById(this.getAttribute("data-id"));
          if(tgt4) tgt4.style.height = parseInt(this.value, 10) + "px";
        });
      }
    }

    function saveConfiguration(){
      for(var i=0; i<configComponentIDs.length; i++){
        var id = configComponentIDs[i];
        var el = document.getElementById(id);
        if(el){
          var cs = window.getComputedStyle(el);
          var leftVal = parseInt(cs.left, 10) || 0;
          var topVal = parseInt(cs.top, 10) || 0;
          var widthVal = parseInt(cs.width, 10) || 0;
          var heightVal = parseInt(cs.height, 10) || 0;
          localStorage.setItem("pos-"+id+"-left", leftVal);
          localStorage.setItem("pos-"+id+"-top", topVal);
          localStorage.setItem("pos-"+id+"-width", widthVal);
          localStorage.setItem("pos-"+id+"-height", heightVal);
        }
      }
      console.log("Configuration saved.");
    }

      document.addEventListener("DOMContentLoaded", function () {
        M.AutoInit();

        // Fade in body
        document.body.style.opacity = 0;
        setTimeout(function () {
          loadPositions();
          document.body.style.opacity = 1;
        }, 250);

        // Show the ‚ÄúUser Log In‚Äù modal on load
        const userLoginModalElem = document.getElementById("userLoginModal");
        const userLoginModal = M.Modal.init(userLoginModalElem, { dismissible: false });

        // --- employee auto-restore + OAuth guard ---------------------------
        const oauthFlag  = localStorage.getItem("oauth_in_progress");
        const savedEmpID = localStorage.getItem("employee_id");
        const savedEmpNm = localStorage.getItem("employee_name");

        /* A. employee already verified ‚Äî stay logged-in */
        if (savedEmpID) {
          window.isEmployeeLoggedIn = true;
          document.getElementById("employeeName").value = savedEmpNm || "";
          startScannedOrderListener();

          // if we‚Äôre just back from OAuth, clear flag for NEXT real reload
          if (oauthFlag) setTimeout(() => localStorage.removeItem("oauth_in_progress"), 1000);
        }
        /* B. nobody stored ‚Üí show login (unless mid-OAuth) */
        else if (!oauthFlag) {
          userLoginModal.open();
        }

      // "Log In" button for employees
      var employeeLoginBtn = document.getElementById("employeeLoginBtn");
      var employeeNumberInput = document.getElementById("employeeNumberInput");
      
      /* ‚ï≠‚îÄ‚òÖ mask each typed digit with * while keeping raw value ‚òÖ‚îÄ‚ïÆ */
       (function(){
         const inp = employeeNumberInput;
         inp.dataset.raw = "";
         inp.addEventListener("keydown", e=>{
           if(e.key === "Backspace"){
             inp.dataset.raw = inp.dataset.raw.slice(0,-1);
           } else if(/^[0-9]$/.test(e.key)){
             if(inp.dataset.raw.length === 6){ e.preventDefault(); return; }
             inp.dataset.raw += e.key;
           } else if(e.key.length > 1){ return; }           /* ignore Ctrl, etc */
           else { e.preventDefault(); return; }             /* block non-digits */
           e.preventDefault();
           inp.value = "*".repeat(inp.dataset.raw.length);  /* render stars */
         });
       })();

      if(employeeLoginBtn){
        employeeLoginBtn.addEventListener("click", async function(){
          try {
             var empNumber = employeeNumberInput.dataset.raw || "";
             if(!/^[0-9]{6}$/.test(empNumber)){
               M.toast({html: "Please enter a valid 6-digit Employee Number!"});
              return;
            }
              var responseEN = await fetch(
                "/.netlify/functions/firebaseOrders?orderId=" +
                encodeURIComponent("Employee Numbers")
              );                         // ‚Üê closes fetch( ‚Ä¶ )

              if (!responseEN.ok) {
              M.toast({ html: "Error fetching Employee Numbers doc!" });
              return;
            }
            var resultEN = await responseEN.json();
            if(!resultEN.success || !resultEN.data){
              M.toast({ html: "No data found for Employee Numbers doc!" });
              return;
            }
            var docDataEN = resultEN.data;
            if(docDataEN[empNumber]){
              var nameFound = docDataEN[empNumber];
              M.toast({ html: "Welcome, " + nameFound + "!" });

              /* remember the current employee for future reloads */
              localStorage.setItem("employee_id",  empNumber);
              localStorage.setItem("employee_name", nameFound);

              document.getElementById("employeeName").value = nameFound;
              userLoginModal.close();
              window.isEmployeeLoggedIn = true;
              startScannedOrderListener();
            } else {
              M.toast({ html: "Employee # " + empNumber + " not found in DB!" });
            }
          } catch(errEN){
            console.error("Error in employee login flow:", errEN);
            M.toast({ html: "Error: " + errEN.message });
          }
        });
      }

      /* ‚îÄ‚îÄ Copy ORDER-FROM Name ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("copyOrderDetailsBtn")
        .addEventListener("click", () => {
          const val = document.getElementById("orderDetails").value || "";
          const m   = val.match(/ORDER FROM[:\s]+([^\r\n]+)/i); // capture name
          if (!m || !m[1].trim()) {
            M.toast({ html: "Name not found." });
            return;
          }
          const name = m[1].trim();
          navigator.clipboard.writeText(name)
            .then(()   => M.toast({ html: `Copied ${name} ‚úî` }))
            .catch(err => M.toast({ html: "Copy failed: " + err.message }));
        });

      /* ‚îÄ‚îÄ Paste: Order Number (+ auto-Enter) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("pasteOrderBtn")
        ?.addEventListener("click", async () => {
          try {
            // üîì New order ‚Üí thaw post-buy freeze, clear CC id, refresh batches
            window.ccPostBuyFrozen = false;
            window.ccMuteIdInput   = false;
            const idEl = document.getElementById("ccShipmentId");
            if (idEl) { idEl.value = ""; idEl.dataset.setAt = String(Date.now()); }
            window.ccShipmentId = "";
            try { await fetchBatches(); } catch {}

            const txt = (await navigator.clipboard.readText() || "").trim();
            if (!txt) { M.toast?.({ html: "Clipboard is empty" }); return; }

            const inp = document.getElementById("etsyOrderNumber");
            inp.value = txt;
            inp.dispatchEvent(new Event("input", { bubbles: true }));
            M.toast?.({ html: "Order # pasted" });

            /* ‚õî Cancel any in-flight ccShipmentId search and pending slow-pass */
            try { window.ccSearchAbort?.abort(); } catch {}
            if (window.ccSlowTimer) { clearTimeout(window.ccSlowTimer); window.ccSlowTimer = null; }
            window.ccSpin && window.ccSpin(false);

            // üîé Also refresh ccShipmentId 500ms after paste (independent of auto-Enter)
            setTimeout(() => window.refreshFromOrderIfChitChats?.(), 500);
            // focus, then simulate pressing Enter after 100ms
            inp.focus();
            setTimeout(() => {
              const ev = new KeyboardEvent("keydown", { key: "Enter", bubbles: true });
              inp.dispatchEvent(ev);
            }, 100);
          } catch (err) {
            M.toast?.({ html: "Paste failed: " + err.message });
          }
        });

        /* ‚îÄ‚îÄ Paste: Tracking Number ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        document.getElementById("pasteTrackingBtn")
          ?.addEventListener("click", async () => {
            try {
              const txt = (await navigator.clipboard.readText() || "").trim();
              if (!txt) { M.toast?.({ html: "Clipboard is empty" }); return; }
              const inp = document.getElementById("trackingNumberInput");
              inp.value = txt;
              inp.dispatchEvent(new Event("input", { bubbles: true }));
              M.toast?.({ html: "Tracking # pasted" });
            } catch (err) {
              M.toast?.({ html: "Paste failed: " + err.message });
            }
          });

      /* Open Config ‚Üí show modal + disable live UI clicks           */
      document.getElementById("openConfigBtn").addEventListener("click", function(){
        populateConfigTable();
        var modalElem = document.getElementById("configModal");
        var instance  = M.Modal.getInstance(modalElem);
        instance.open();
        document.body.classList.add("configOpen");        // üîë flag ON
      });

      /* ===== Sign-Out ===== */
      document.getElementById("signOutBtn").addEventListener("click", () => {
        /* clear employee & login state */
        localStorage.removeItem("employee_id");
        localStorage.removeItem("employee_name");
        window.isEmployeeLoggedIn = false;
        if (chatUnsub) chatUnsub();                 // stop Brites listener
        /* show modal again */
        M.Modal.getInstance(document.getElementById("userLoginModal")).open();
        /* optional: blank out name field */
        document.getElementById("employeeName").value = "";
        M.toast({ html: "Signed out." });
      });

      /* Save Config ‚Üí close modal + re-enable live UI clicks        */
      document.getElementById("saveConfigBtn").addEventListener("click", function(){
        saveConfiguration();
        document.body.classList.remove("configOpen");     // üîë flag OFF
      });

      const connectEtsyBtn = document.getElementById("connectEtsyBtn");
      if (connectEtsyBtn){
        connectEtsyBtn.addEventListener("click", () => startOAuth("manual"));
      }

      var etsyOrderInput = document.getElementById("etsyOrderNumber");

      etsyOrderInput.addEventListener("keydown", async function (e) {
        if (e.key !== "Enter") return;

          /* ‚õî Cancel any in-flight ccShipmentId search and pending slow-pass */
          try { window.ccSearchAbort?.abort(); } catch {}
          if (window.ccSlowTimer) { clearTimeout(window.ccSlowTimer); window.ccSlowTimer = null; }
          window.ccSpin && window.ccSpin(false);

        // New order ‚Üí thaw post-buy freeze, clear CC id, refresh batches
        window.ccPostBuyFrozen = false;
        window.ccMuteIdInput   = false;
        const idEl = document.getElementById("ccShipmentId");
        if (idEl) { idEl.value = ""; idEl.dataset.setAt = String(Date.now()); }
        window.ccShipmentId = "";
        try { await fetchBatches(); } catch {}

        const orderNumber = etsyOrderInput.value.trim();
        if (!orderNumber) return;

        const orderData = await pullEtsyOrderDetails(orderNumber);
        await loadShipToAddress(orderNumber);
        // (Gift message now sourced from Etsy receipt; no ShipStation call)

        // ‚úÖ Moved INSIDE the async handler:
        // Prefer transactions (they carry quantity + unit price) for customs autofill
        const tx = await maybeLoadEtsyTransactions(orderNumber);
        if (tx.length) {
          await updateImageGrid({ transactions: tx });
        } else if (orderData) {
          await updateImageGrid(orderData);
        }
        startBritesListener(orderNumber);

        try {
          const respPD = await fetch("/.netlify/functions/firebaseOrders?orderId=" + encodeURIComponent(orderNumber));
          const resPD  = await respPD.json();

          if (!respPD.ok) {
            if (resPD.error && resPD.error.toLowerCase().includes("not found")) {
              document.getElementById("labelCreationDate").value = "";
              document.getElementById("completedByEmployee").value = "";
              document.getElementById("signatureBox").innerHTML = "Sig Box";
              const ab = document.getElementById("shipAddressBox"); if (ab) ab.value = "";
              document.getElementById("customerMessageHistory").innerText = "";
              return;
            }
            throw new Error(resPD.error || "Unknown error from firebaseOrders function");
          }

          const docDataPD = resPD.data || {};
          const histBox = document.getElementById("customerMessageHistory");
          const boxIsEmpty = !histBox || !histBox.innerHTML.trim();
          if (boxIsEmpty && typeof docDataPD["Brites Messages"] === "string") {
            histBox.innerText = docDataPD["Brites Messages"];
            M.toast({ html: "Brites Messages loaded!" });
          }

          if (docDataPD["Shipping Label Timestamps"]) {
            const dt = new Date(docDataPD["Shipping Label Timestamps"]);
            const lblDateEl = document.getElementById("labelCreationDate");
            if (!isNaN(dt.valueOf()) && lblDateEl) {
              const monthNamesF2 = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
              const dd = ("0" + dt.getDate()).slice(-2);
              const mStr = monthNamesF2[dt.getMonth()];
              const yyyy = dt.getFullYear();
              const hh = ("0" + dt.getHours()).slice(-2);
              const mm = ("0" + dt.getMinutes()).slice(-2);
              lblDateEl.value = `${dd} ${mStr} ${yyyy}, ${hh}:${mm}`;
            } else if (lblDateEl) {
              lblDateEl.value = "";
            }
          } else {
            const lblDateEl = document.getElementById("labelCreationDate");
            if (lblDateEl) lblDateEl.value = "";
          }

          const dbEmpNameRaw = docDataPD["Employee Name"];
          const dbEmpName = typeof dbEmpNameRaw === "string" ? dbEmpNameRaw.trim() : "";
          const compEmpEl = document.getElementById("completedByEmployee");
          if (compEmpEl) compEmpEl.value = dbEmpName;

          const sigBox = document.getElementById("signatureBox");
          if (dbEmpName && sigBox) {
            const imageFile = encodeURIComponent(dbEmpName + ".jpg");
            sigBox.innerHTML = `<img src="/assets/${imageFile}" style="width:100%; height:100%; object-fit:cover;" alt="Signature for ${dbEmpName}">`;
          } else if (sigBox) {
            sigBox.innerHTML = "Sig Box";
          }
        } catch (e2) {
          console.error(e2);
        }
      });

      document.getElementById("trackingLinkBtn").addEventListener("click", function(){
        if(!window.currentTracking){
          console.log("No tracking number available.");
          return;
        }
        var templateUrl = "";
        if(window.currentCarrier && window.currentCarrier.toUpperCase() !== "USPS"){
          templateUrl = "https://chitchats.com/tracking/0000000000000";
          templateUrl = templateUrl.replace("0000000000000", window.currentTracking);
        } else {
          templateUrl = "https://tools.usps.com/go/TrackConfirmAction_input?qtc_tLabels1=0000000000000000000000000000000000";
          templateUrl = templateUrl.replace("0000000000000000000000000000000000", window.currentTracking);
        }
        window.open(templateUrl, "_blank");
      });

      var previewBoxes = document.querySelectorAll('.preview-box');
      previewBoxes.forEach(function(box){
        var isDragging = false;
        var lastX = 0;
        var lastY = 0;
        box.addEventListener('wheel', function(e){
          var img = box.querySelector('img');
          if(!img) return;
          e.preventDefault();
          var currentScale = parseFloat(img.dataset.scale) || 1;
          var offsetX = parseFloat(img.dataset.offsetX) || 0;
          var offsetY = parseFloat(img.dataset.offsetY) || 0;
          if(e.deltaY < 0){
            currentScale *= 1.1;
          } else {
            currentScale /= 1.1;
            if(currentScale <= 1){
              currentScale = 1;
              offsetX = 0;
              offsetY = 0;
            }
          }
          currentScale = Math.max(1, Math.min(4, currentScale));
          img.dataset.scale = currentScale;
          img.dataset.offsetX = offsetX;
          img.dataset.offsetY = offsetY;
          img.style.transform = "translate(" + offsetX + "px, " + offsetY + "px) scale(" + currentScale + ")";
        });
        box.addEventListener('mousedown', function(e){
          var img = box.querySelector('img');
          if(!img) return;
          var currentScale = parseFloat(img.dataset.scale) || 1;
          if(currentScale <= 1) return;
          e.preventDefault();
          isDragging = true;
          lastX = e.clientX;
          lastY = e.clientY;
        });
        box.addEventListener('mousemove', function(e){
          if(!isDragging) return;
          e.preventDefault();
          var img = box.querySelector('img');
          if(!img) return;
          var currentScale = parseFloat(img.dataset.scale) || 1;
          var offsetX = parseFloat(img.dataset.offsetX) || 0;
          var offsetY = parseFloat(img.dataset.offsetY) || 0;
          var dx = e.clientX - lastX;
          var dy = e.clientY - lastY;
          offsetX += dx;
          offsetY += dy;
          img.dataset.offsetX = offsetX;
          img.dataset.offsetY = offsetY;
          img.style.transform = "translate(" + offsetX + "px, " + offsetY + "px) scale(" + currentScale + ")";
          lastX = e.clientX;
          lastY = e.clientY;
        });
        box.addEventListener('mouseup', function(){
          isDragging = false;
        });
        box.addEventListener('mouseleave', function(){
          isDragging = false;
        });
      });

      /* === Drag-drop image upload + click-viewer ===================== */
      (function attachImageDnD(){
        const chatBox   = document.getElementById("customerMessageHistory");
        const orderInp  = document.getElementById("etsyOrderNumber");
        const empNameEl = document.getElementById("employeeName");
        if(!chatBox) return;

        /* drag-over glow */
        const onEnter = e=>{e.preventDefault(); chatBox.style.outline="2px dashed dodgerblue";};
        const onLeave = e=>{e.preventDefault(); chatBox.style.outline="";};
        ["dragenter","dragover"].forEach(x=>chatBox.addEventListener(x,onEnter));
        ["dragleave","drop"].forEach(x=>chatBox.addEventListener(x,onLeave));

        /* drop ‚Üí Storage ‚Üí Firestore */
        chatBox.addEventListener("drop", async e=>{
          e.preventDefault();
          const images = [...e.dataTransfer.files].filter(f=>f.type.startsWith("image/"));
          if(!images.length) return;

          const orderId = orderInp.value.trim();
          if(!orderId){ M.toast({html:"Enter order # first"}); return; }
          const staff   = (empNameEl.value||"Staff").trim();

          for (const file of images) {
            try {
              const path = `chatImages/${orderId}/${Date.now()}_${file.name}`;

              /* üöÄ one-liner: resumable PUT upload + URL */
              const url = await window.uploadViaResumable(path, file);

              await db.collection("Brites_Orders")
                .doc(orderId).collection("messages")
                .add({
                  imageUrl  : url,
                  text      : "Image attachment",
                  senderName: staff,
                  senderRole: "staff",
                  timestamp : firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch(err) {
              console.error("upload error:", err);
              M.toast({ html: "Upload failed: " + err.message });
            }
          }
        });

        /* click any .img-link ‚Üí modal */
        document.addEventListener("click", e=>{
          if(!e.target.classList.contains("img-link")) return;
          document.getElementById("chatImgModalImg").src = e.target.dataset.src;
          M.Modal.getInstance(document.getElementById("chatImgModal")).open();
        });

        /* one-time modal init */
        M.Modal.init(document.getElementById("chatImgModal"));
      })();

    /* =========================================================
     *  Send Brites Msg ‚Äì POST via Netlify function
     * =======================================================*/
    const sendBtn   = document.getElementById("goScreenTwoBtn");
    const newMsgInp = document.getElementById("britesMsgInput");

    if (sendBtn) {
      sendBtn.addEventListener("click", async () => {
        const orderId = document.getElementById("etsyOrderNumber").value.trim();
        const msgTxt  = (newMsgInp.value || "").trim();
        const staff   = (document.getElementById("employeeName").value || "Staff").trim();

        if (!orderId || !msgTxt) {
          M.toast({ html: "Enter order # and message." });
          return;
        }

        try {
          const resp = await fetch("/.netlify/functions/firebaseOrders", {
            method : "POST",
            headers: { "Content-Type": "application/json" },
            body   : JSON.stringify({
              orderNumber : orderId,
              newMessage  : msgTxt,
              employeeName: staff
            })
          });
          const json = await resp.json();
          if (!resp.ok || !json.success) throw new Error(json.error || "Server error");
          newMsgInp.value = "";                // clear box on success
        } catch (err) {
          console.error("Send error:", err);
          M.toast({ html: "Error: " + err.message });
        }
      });
    }

    /* =========================================================
     *  Complete Order ‚Äì POST tracking to Etsy (via Netlify)
     * =======================================================*/
    const completeBtn = document.getElementById("completeOrderBtn");
    const trackingInp = document.getElementById("trackingNumberInput");
    const carrierSel  = document.getElementById("carrierSelect");

    if (completeBtn) {
      completeBtn.addEventListener("click", async () => {
        const receiptId = document.getElementById("etsyOrderNumber").value.trim();
        const tracking  = (trackingInp.value || "").trim();
        const carrier   = carrierSel.value;          // "chitchats" | "usps"

        if (!receiptId) { M.toast({ html: "Enter order #"   }); return; }
        if (!tracking)  { M.toast({ html: "Enter tracking #" }); return; }
        if (!carrier)   { M.toast({ html: "Choose carrier"  }); return; }

        try {
          // Ensure Etsy access token is fresh, then read it
          if (typeof ensureFreshToken === "function") {
            await ensureFreshToken();
          }
          const etsyAccess = (window.TOKEN_KEYS && localStorage.getItem(TOKEN_KEYS.access)) || "";

          // Use current Chit Chats shipment (if visible) as source-of-truth
          const ccId = (document.getElementById("ccShipmentId")?.value || "").trim();

          const resp = await window.callCc("PATCH", {
            action           : "complete",
            receipt_id       : receiptId,
            shipment_id      : ccId,
            tracking         : tracking,
            carrier          : carrier,       // "usps" | "chitchats"
            notify           : true,
            etsy_access_token: etsyAccess
          });

          if (!resp || resp.error) {
            throw new Error(resp?.error || "Server error");
          }

          M.toast({ html: "Etsy order marked complete üéâ" });
          trackingInp.value        = "";
          carrierSel.selectedIndex = 0;
        } catch (err) {
          console.error(err);
          M.toast({ html: "Complete failed: " + err.message });
        }
      });
    }

    async function updateImageGrid(data){
      var items = [];
      if(data.transactions && Array.isArray(data.transactions)){
        items = data.transactions;
      } else if(data.shipments && Array.isArray(data.shipments)){
        items = data.shipments;
      } else if(Array.isArray(data)){
        items = data;
      } else if(data.results && Array.isArray(data.results)){
        items = data.results;
      } else if(data.orders && Array.isArray(data.orders)){
        items = data.orders;
      } else if(typeof data === "object" && data !== null){
        for(var key in data){
          if(Array.isArray(data[key])){
            items = data[key];
            break;
          }
        }
      }
      window.cachedOrderItems = items;
      for(var i=0; i<8; i++){
        var cell = document.getElementById("previewCell" + i);
        var qtyBox = document.getElementById("quantityCell" + i);
        var metalBox = document.getElementById("metalCell" + i);
        if(cell){
          if(i < items.length){
            var item = items[i];
            try {
              var images = await fetchListingImages(item.listing_id);
              if(images && images.length > 0){
                cell.innerHTML =
                  '<img src="' + images[0].url_fullxfull + '" alt="Listing Image ' + i + '" data-scale="1" data-offsetX="0" data-offsetY="0">';
              } else {
                cell.innerHTML = "No images found";
              }
            } catch(errA){
              console.error("Error fetching listing " + item.listing_id + ": ", errA);
              cell.innerHTML = "Error loading image";
            }
            cell.style.cursor = "pointer";
            (function(idx){
            cell.onclick = function(){
              highlightSelectedPreview(this);
              showItemDetails(idx);
              prefillCustomsFromEtsy();       // <‚Äî keep Step 1 in sync with selected item
            };
            })(i);
            if(qtyBox){
              var actualQty = (item.quantity != null) ? item.quantity : 0;
              qtyBox.value = " Quantity: " + actualQty;
            }
            if (metalBox) {
              metalBox.classList.add("detail-box"); // optional: match your example style

              let metalSel = "";

              if (item.variations && Array.isArray(item.variations)) {
                const acceptedMetalNames = [
                  "metal","metal choice","metal - engraving",
                  "metal colour","color","metal choice / engraving option",
                  // ‚Äî NEW ‚Äî
                  "number of discs / metal","number of discs/metal",
                  "metal/necklace length","metal/necklace length/engrave",
                  "number of discs / metal"
                ];

                /* ‚ë† try by variation label (includes 'color/colour' prefixes) */
                let metalVar = item.variations.find(v => {
                  const name = (v.formatted_name || "").trim().toLowerCase();
                  return (
                    name.includes("metal") ||
                    name.startsWith("color") || name.startsWith("colour") ||
                    acceptedMetalNames.includes(name)
                  );
                });

                /* ‚ë° if not found, sniff values for metal-y words */
                if (!metalVar) {
                  metalVar = item.variations.find(v => {
                    const val = (v.formatted_value || "").toLowerCase();
                    return /rose\s*gold|rosegold|rosefilled|gold\s*filled|goldfilled|\bgold\b|silv[ae]?r|sterling\s*silver|14k|white\s*gold/.test(val);
                  });
                }

                if (metalVar && metalVar.formatted_value) {
                  metalSel = String(metalVar.formatted_value);

                  /* strip engraving flags, character-count junk, collapse spaces */
                  metalSel = metalSel
                    .replace(/\+\s*engraving/gi, "")
                    .replace(/\+\s*engrave/gi, "")
                    .replace(/\b1-5\s*Characters\b/gi, "")
                    .replace(/\b6-10\s*Characters\b/gi, "")
                    .replace(/\b11\s*\+\s*Characters\b/gi, "")
                    .replace(/\b1-5\s*¬∑\s*Character(?:s)?\b/gi, "")
                    .replace(/\b6-10\s*¬∑\s*Character(?:s)?\b/gi, "")
                    .replace(/\b11\+\s*¬∑\s*Character(?:s)?\b/gi, "")
                    .replace(/\s{2,}/g, " ")
                    .trim();

                  /* split camelCase, drop length noise, normalize odd punctuation */
                  metalSel = metalSel.replace(/([a-z])([A-Z])/g, "$1 $2");
                  metalSel = metalSel
                    .replace(/\bnecklace\s*length\b[\s\/:]*/gi, "")
                    .replace(/\s*-\s*\d+(\.\d+)?\s*$/g, "")
                    .trim();
                  metalSel = metalSel.replace(/[¬∑‚Ä¢]/g, " ").trim();

                  const norm = metalSel.toLowerCase();

                  /* map to canonical labels */
                  if (/(?:14k\s*)?(?:rose\s*gold|rosegold|rose\s*gold\s*filled|rosegold\s*filled|rosefilled)\b/.test(norm)) {
                    metalSel = "Rose Gold";
                  } else if (/(?:14k\s*)?(?:gold\s*filled|goldfilled)\b/.test(norm)) {
                    metalSel = "Gold Filled";
                  } else if (/(?:color\s*)?sterling\s*silver\b|silv[ae]?r\b/.test(norm)) {
                    metalSel = "Silver";
                  } else if (/\b14k\b/.test(norm)) {
                    metalSel = "14K";
                  } else if (/\bgold\b/.test(norm)) {
                    // lone 'gold' ‚Üí default to Gold Filled per your rule
                    metalSel = "Gold Filled";
                  }

                  metalSel = metalSel.replace(/\s{2,}/g, " ").trim();
                }
              }

              metalBox.value = " Metal: " + deQuote(metalSel || "No Metal");
            }
          } else {
            cell.innerHTML = "Empty";
            cell.style.cursor = "default";
            cell.onclick = null;
            if(qtyBox) qtyBox.value = "";
            if(metalBox) metalBox.value = "";
          }
        }
      }
      if(items.length > 0){
        highlightSelectedPreview(document.getElementById("previewCell0")); // NEW
        showItemDetails(0);
      } else {
        document.getElementById("orderDetails").value = " ORDER DETAILS:\n\nNo items found.";
      }
    }

     function showItemDetails(index){
      // Track active preview tile (duplicated intentionally per request)
      window.selectedPreviewIndex = index;
      window.selectedPreviewIndex = index;
      if(!window.cachedOrderItems || !window.cachedOrderItems[index]){
        console.warn("No item at index:", index);
        return;
      }
      var item = window.cachedOrderItems[index];
      var details = "";
      if(window.orderName){
        details += " ORDER FROM: " + window.orderName + "\n";
      }
      if(window.orderStatus){
        details += " Order Status: " + window.orderStatus + "\n";
      }

      /*
       * REVISED CODE TO HIDE ONLY "Shipped!" TEXT
       * We still append "Shipping Status:" but skip the literal "Shipped!" if it equals "Shipped!"
       */
      if (window.orderIsShipped === "Shipped!") {
        // Only show "Shipping Status:" with no further text
        details += " Shipping Status:\n";
      } else if (typeof window.orderIsShipped === "string") {
        // For other string statuses, append them normally
        details += " Shipping Status: " + window.orderIsShipped + "\n";
      } else {
        // If there's no recognized "shipped" string or it's boolean false, fallback
        details += " Shipping Status:\n";
      }

      // If there's shipping data, we proceed as normal
      if(window.orderIsShipped === "Shipped!" && window.orderShipments && window.orderShipments.length > 0){
        var ship = window.orderShipments[0];
        if(ship.carrier_name){
          details += " Carrier Name: " + ship.carrier_name + "\n";
          window.currentCarrier = ship.carrier_name;
        }
        if(ship.tracking_code){
          details += " Tracking Number:\n" + ship.tracking_code + "\n\n";
          window.currentTracking = ship.tracking_code;
          if(window.currentCarrier && window.currentCarrier.toUpperCase() !== "USPS"){
            document.getElementById("trackingLinkBtn").querySelector("img").src = "assets/ChitChats.png";
          } else {
            document.getElementById("trackingLinkBtn").querySelector("img").src = "assets/USPS.png";
          }
        } else {
          details += "\n";
          window.currentTracking = null;
        }
        if(window.currentTracking){
          document.getElementById("trackingLinkBtn").style.display = "block";
        }
      } else {
        document.getElementById("trackingLinkBtn").style.display = "none";
      }

      details += " ORDER DETAILS:\n\n";
      if(item.title){
        var firstFour = item.title.trim().split(" ").slice(0,4).join(" ");
        details += " Title: " + firstFour + "\n";
      }
      if(item.sku){
        details += " SKU: " + item.sku + "\n";
      }
      if(item.variations && Array.isArray(item.variations)){
        var acceptedMetalNames2 = [
          "metal","metal choice","metal - engraving","metal colour",
          "color","metal choice / engraving option"
        ];
        var acceptedLengthNames2 = [
          "length","necklace length","metal/necklace length",
          "metal choice / necklace length","necklace length in inches"
        ];
        for(var j=0; j<item.variations.length; j++){
          var v2 = item.variations[j];
          if(!v2.formatted_name || !v2.formatted_value) continue;
          var nameLower2 = v2.formatted_name.trim().toLowerCase();
          var val2 = deQuote(v2.formatted_value.trim());
          if(nameLower2 === "personalization" && val2 === "Not requested on this item."){
            val2 = "Not Requested";
            details += " Personalization: " + val2 + "\n";
          } else if(acceptedMetalNames2.indexOf(nameLower2) >= 0){

            const mBadge = metalToBadge(val2);
            details += ` ${mBadge ? mBadge + " " : ""}Metal Choice: ${val2}\n`;

          } else if(acceptedLengthNames2.indexOf(nameLower2) >= 0){
            var lengthMap2 = {
              "14&quot;": "14 Inches",
              "16&quot;": "16 Inches",
              "18&quot;": "18 Inches",
              "20&quot;": "20 Inches",
              "14\"\"": "14 Inches",
              "16\"\"": "16 Inches",
              "18\"\"": "18 Inches",
              "20\"\"": "20 Inches"
            };
            if(lengthMap2[val2]){
              val2 = lengthMap2[val2];
            }
            details += " Item Length: " + val2 + "\n";
          } else {
            details += " " + v2.formatted_name + ": " + v2.formatted_value + "\n";
          }
        }
      }
      /* üéÅ  ‚îÄ‚îÄ Gift indicators ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      const giftIcon = "üéÅ";           // 20 % larger icon is not possible in a plain textarea,
                                       // but the emoji renders slightly bigger than text on most OSes.

      /* a. Marked-as-Gift */
      if (window.receiptIsGift === true){
        details += ` ${giftIcon} Marked as Gift: Yes\n`;
      } else if (window.receiptIsGift === false){
        details += " Marked as Gift: No\n";
      }

      /* b. Gift Message */
      if (window.receiptGiftMessage){
        details += ` ${giftIcon} Gift Message: ${window.receiptGiftMessage}\n`;
      }

      /* c. Gift Wrapping */
      if (window.receiptGiftWrap === true){
        details += ` ${giftIcon} Gift Wrapping: Yes\n`;
      } else if (window.receiptGiftWrap === false){
        details += " Gift Wrapping: No\n";
      }

      document.getElementById("orderDetails").value = deQuote(details);
      // Auto-fill qty + unit value for the currently selected item
      prefillCustomsFromEtsy();
    }

    async function fetchListingImages(listingId){
      const responseLI = await fetch("/.netlify/functions/etsyImages?listingId=" + listingId, {
        headers: { "access-token": localStorage.getItem("access_token") }
      });
      if(!responseLI.ok){
        throw new Error("Error fetching images for listing " + listingId + ": " + responseLI.statusText);
      }
      const dataLI = await responseLI.json();
      return dataLI.results;
    }

    function pullEtsyOrderDetails(orderNumber){
      console.log("Pulling Etsy order details for order number:", orderNumber);
      var token = localStorage.getItem("access_token");
      return fetch("/.netlify/functions/etsyOrderProxy?orderId=" + encodeURIComponent(orderNumber), {
        headers: { "access-token": token }
      })
      .then(function(r){ return r.json(); })
      .then(function(data){
        console.log("Etsy Order Data:", data);
        // Gift fields now sourced from Etsy receipt
        window.receiptIsGift = Boolean(data.is_gift);

// üéÅ Pull from Etsy (gift_message if present, else buyer message)
window.receiptGiftMessage     = String((data.gift_message || data.message_from_buyer || "")).trim();
window.receiptGiftMessageFrom = String((data.buyer_email || data.buyer_name || "")).trim();

        // Etsy receipts include gift_wrap_price as a money object { amount, divisor, currency_code }
        const gwp = data.gift_wrap_price;
        const gwAmount =
          (gwp && typeof gwp.amount === "number" && typeof gwp.divisor === "number" && gwp.divisor)
            ? (gwp.amount / gwp.divisor)
            : (typeof data.gift_wrap_price === "number" ? data.gift_wrap_price : null);
        window.receiptGiftWrapPrice =
          (typeof gwAmount === "number" && !Number.isNaN(gwAmount)) ? gwAmount : null;
        window.receiptGiftWrap =
          (typeof window.receiptGiftWrapPrice === "number" && window.receiptGiftWrapPrice > 0);

        /* store buyer note so the chat listener can render it (still from Etsy) */
        window.buyerMessageText  = (data.message_from_buyer || "").trim();
        window.orderShipments = data.shipments || [];
        var titleDate2 = document.getElementById("titleOrderDate2");
        titleDate2.textContent = "";
        if(data.name){
          window.orderName = data.name;
        } else {
          window.orderName = "";
        }
        if(data.status){
          window.orderStatus = data.status;
        } else {
          window.orderStatus = "";
        }
        if(data.is_shipped === true){
          window.orderIsShipped = "Shipped!";
        } else if(data.is_shipped === false){
          window.orderIsShipped = "Not Shipped";
        } else {
          window.orderIsShipped = "";
        }
        var foundStamp = null;
        if(data.shipped_timestamp && data.is_shipped === true){
          foundStamp = data.shipped_timestamp;
        }
        else if(data.transactions && Array.isArray(data.transactions) && data.transactions.length > 0
                && data.transactions[0].shipped_timestamp && data.is_shipped === true){
          foundStamp = data.transactions[0].shipped_timestamp;
        }
        window.orderShippedTimestamp = foundStamp;
        if(window.orderIsShipped === "Shipped!" && window.orderShippedTimestamp){
          var d4 = new Date(window.orderShippedTimestamp * 1000);
          var monthNames4 = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          var day4 = ("0" + d4.getDate()).slice(-2);
          var mStr4 = monthNames4[d4.getMonth()];
          var y4 = d4.getFullYear();
          titleDate2.textContent = "Shipped On: " + day4 + " " + mStr4 + " " + y4;
        }

        if(data.transactions && data.transactions.length > 0){
          var firstTrans = data.transactions[0];
          var monthNamesF = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          if(firstTrans.created_timestamp){
            var dT = new Date(firstTrans.created_timestamp * 1000);
            var ddT = ("0" + dT.getDate()).slice(-2);
            var mmT = monthNamesF[dT.getMonth()];
            var yyT = dT.getFullYear();
            document.getElementById("dateOrdered").value = " " + ddT + " " + mmT + " " + yyT;
          } else {
            document.getElementById("dateOrdered").value = "";
          }
          var shipEl = document.getElementById("shipDate");
          shipEl.style.color = "";
          if(firstTrans.expected_ship_date){
            var sTS = new Date(firstTrans.expected_ship_date * 1000);
            var sDay = ("0" + sTS.getDate()).slice(-2);
            var sMonth = monthNamesF[sTS.getMonth()];
            var sYear = sTS.getFullYear();
            shipEl.value = " " + sDay + " " + sMonth + " " + sYear;
            if(window.orderIsShipped === "Shipped!"){
              shipEl.style.color = "#006400";
            } else {
              var todayD = new Date();
              todayD.setHours(0,0,0,0);
              var dueDateD = new Date(sYear, sTS.getMonth(), sDay);
              dueDateD.setHours(0,0,0,0);
              if(dueDateD.getTime() === todayD.getTime()){
                shipEl.style.color = "orange";
              } else {
                shipEl.style.color = "";
              }
            }
          } else {
            shipEl.value = "";
          }
        } else {
          document.getElementById("dateOrdered").value = "";
          var shipEl2 = document.getElementById("shipDate");
          shipEl2.value = "";
          shipEl2.style.color = "";
        }
        return data;
      })
      .catch(function(err){
        console.error("Error fetching Etsy order details:", err);
        return null;
      });
    }

      // Global address helpers (guarded so we don't double-define)
  if (typeof window.normalizeToAddressShape !== "function") {
    window.normalizeToAddressShape = function normalizeToAddressShape(raw){
      // Accept Chit Chats shapes: { to:{‚Ä¶} }, { address:{‚Ä¶} }, or flat
      const src = raw && typeof raw === "object" ? (raw.to || raw.address || raw) : {};
      const get = (...keys) => {
        for (const k of keys) {
          const v = src?.[k];
          if (v != null && String(v).trim() !== "") return String(v).trim();
        }
        return "";
      };
      const cc = (get("to_country_code","country_code","country","country_iso2") || "").toUpperCase();
      return {
        to_name          : get("to_name","name","recipient_name","full_name"),
        to_address_1     : get("to_address_1","address_1","address1","street1","line1","street"),
        to_address_2     : get("to_address_2","address_2","address2","street2","line2","unit","suite","apt","apartment","unit_number"),
        to_city          : get("to_city","city","locality","town"),
        to_province_code : get("to_province_code","province_code","state_code","state","province","region","administrative_area"),
        to_postal_code   : get("to_postal_code","postal_code","zip","zip_code","postcode"),
        to_country_code  : cc
      };
    };
  }

  if (typeof window.fmtAddress !== "function") {
    window.fmtAddress = function fmtAddress(a){
      if (!a) return "";
      const name = a.to_name || "";
      const l1   = a.to_address_1 || "";
      const l2   = a.to_address_2 || "";
      const city = a.to_city || "";
      const prov = a.to_province_code || "";
      const pc   = a.to_postal_code || "";
      const cc   = (a.to_country_code || "").toUpperCase();
      const country  = cc === "US" ? "United States" : cc === "CA" ? "Canada" : cc;
      const street   = [l1, l2].filter(Boolean).join("\n");
      const cityLine = city && prov ? `${city}, ${prov} ${pc}` : [city, prov, pc].filter(Boolean).join(" ");
      return [name, street, cityLine, country].filter(Boolean).join("\n");
    };
  }

      /* ===== ShipStation ‚Äî load ‚ÄúShip To‚Äù by orderNumber ======================= */
  async function loadShipToAddress(orderNumber){
  try {
    const box = document.getElementById("shipAddressBox");
    if (!box) return;
    box.value = "SHIP TO:\n(Loading...)";

    const fnBase = "/.netlify/functions";

    // 1) Find the imported Chit Chats shipment by Etsy order/receipt id
    const searchResp = await fetch(
      `${fnBase}/chitChatSearch?orderId=${encodeURIComponent(orderNumber)}&pendingOnly=0&fast=1&timeoutMs=9000&pageSize=500`
    );
    if (!searchResp.ok) throw new Error("ChitChats search " + searchResp.status);
    const searchData = await searchResp.json();
    const hit = (searchData.shipments || [])[0];
    if (!hit) {
      box.value = "SHIP TO:\n(Not found)";
      box.style.color = "";
      return;
    }

    // 2) Hydrate the full shipment to get address fields
    const shipResp = await fetch(
      `${fnBase}/testChitChats?resource=shipment&id=${encodeURIComponent(hit.id)}`
    );
    if (!shipResp.ok) throw new Error("ChitChats shipment " + shipResp.status);
    const detail = await shipResp.json();
    const sh = detail.shipment || detail;

// 3) Normalize + format (handles {to:{‚Ä¶}} | {address:{‚Ä¶}} | flat)
const to = normalizeToAddressShape(sh);
box.value = "SHIP TO:\n" + fmtAddress(to);
// debug (optional): see what keys were present if street didn't render
if (!to.to_address_1) console.debug("No street in shipment:", { keys:Object.keys(sh||{}), to:sh?.to });

    // 4) Auto-pick carrier: USPS for US domestic, ChitChats for everything else
    const carrierSelectEl = document.getElementById("carrierSelect");
    if (carrierSelectEl) {
      const c = String(to.to_country_code || "").toUpperCase();
      const target = (c === "US" || c === "USA" || c.includes("UNITED STATES")) ? "usps" : "chitchats";
      carrierSelectEl.value = target;
      carrierSelectEl.dispatchEvent(new Event("change", { bubbles: true }));
      try {
        let inst = M.FormSelect.getInstance(carrierSelectEl);
        if (inst) inst.destroy();
        inst = M.FormSelect.init(carrierSelectEl);
        if (inst && inst.input) inst.input.value = (target === "usps" ? "USPS" : "ChitChats");
      } catch {}
    }

    // 5) Colorize for international (non US/CA)
    const c2 = String(to.to_country_code || "").trim().toLowerCase();
    const isUS = c2.startsWith("united states") || c2 === "usa" || c2 === "us" || c2 === "u.s." || c2 === "u.s.a.";
    const isCA = c2 === "canada" || c2 === "ca";
    box.style.color = (isUS || isCA) ? "" : "orangered";
  } catch (e) {
    console.error("loadShipToAddress (CC):", e);
    const box = document.getElementById("shipAddressBox");
    if (box) {
      box.value = "SHIP TO:\n(Error loading)";
      box.style.color = "";
    }
  }
}

      /* ===== ShipStation ‚Äî Gift Message (orderNumber) ===================== */
      async function loadGiftMessage(orderNumber) {
  try {
    // Use what pullEtsyOrderDetails already fetched
    const fromEtsy = String(window.receiptGiftMessage || window.buyerMessageText || "").trim();
    window.receiptGiftMessage     = fromEtsy;
    window.receiptGiftMessageFrom = String(window.receiptGiftMessageFrom || "").trim();
    const sel = document.querySelector(".preview-box.selected");
    if (sel) {
      const idx = parseInt(sel.id.replace("previewCell", ""), 10);
      if (!Number.isNaN(idx)) showItemDetails(idx);
    }
  } catch (err) {
    console.error("loadGiftMessage (no-SS):", err);
    window.receiptGiftMessage     = "";
    window.receiptGiftMessageFrom = "";
  }
}

    /* ---------------------------------------------------------
     *  Firestore listener for employee-scanned order numbers
     * --------------------------------------------------------*/
    function startScannedOrderListener(){
      if (!window.isEmployeeLoggedIn){
        console.warn("startScannedOrderListener called but user not logged in!");
        return;
      }

      let firstSnap = true;                       // üîë skip the initial payload
      db.collection("Brites_Orders")
        .doc("shipping-scan-1")
        .onSnapshot(docSnap => {
          if (!window.isEmployeeLoggedIn) return;

          /* ignore Firestore‚Äôs first delivery; wait for *changes* */
          if (firstSnap){ firstSnap = false; return; }

          if (docSnap.exists){
            const data = docSnap.data();
            if (data && data["Order Number"]){
              const orderNumber   = data["Order Number"];
              if (orderNumber === lastScanProcessed) return;   // duplicate ‚Üí ignore
              lastScanProcessed = orderNumber;                 // remember newest hit
              const etsyOrderInput = document.getElementById("etsyOrderNumber");
              etsyOrderInput.value = orderNumber;

              /* simulate user hitting Enter ‚Üí kicks off full load */
              etsyOrderInput.dispatchEvent(
                new KeyboardEvent("keydown", { key:"Enter", keyCode:13, which:13 })
              );

              /* one-shot: wipe the field so it can‚Äôt be reused */
              db.collection("Brites_Orders")
                .doc("shipping-scan-1")
                .set({ "Order Number": firebase.firestore.FieldValue.delete() }, { merge:true });

            }
          }
        });
    }
    });   // ‚Üê closes DOMContentLoaded handler

    /* =========================================================
     *  Chit Chats ‚Äî search by order/tracking + batch add/remove
     *  Requires Netlify functions:
     *    - /.netlify/functions/chitChatSearch
     *    - /.netlify/functions/testChitChats
     *  Integrates with:
     *    #etsyOrderNumber, #trackingNumberInput, #carrierSelect
     *    #trackingLinkBtn (opens CC or USPS tracking)
     * =======================================================*/
    (function initChitChatsIntegration(){

      const carrierSel     = document.getElementById("carrierSelect");
      const orderInp       = document.getElementById("etsyOrderNumber");
      const trackingInp    = document.getElementById("trackingNumberInput");
      const ccShipEl       = document.getElementById("ccShipmentId");
      const ccBatchSelect  = document.getElementById("ccBatchSelect");
      const ccBatchName    = document.getElementById("ccBatchName");
      const createBtn      = document.getElementById("ccCreateBatchBtn");
      const addBtn         = document.getElementById("ccAddToBatchBtn");
      const removeBtn      = document.getElementById("ccRemoveFromBatchBtn");

      // Make lookups callable from outside the IIFE (e.g., Paste button)
      window.refreshFromOrderIfChitChats    = refreshFromOrderIfChitChats;
      window.refreshFromTrackingIfChitChats = refreshFromTrackingIfChitChats;

      /* ‚îÄ‚îÄ Guard: ignore immediate blank rewrites of #ccShipmentId ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      (function guardCcShipmentId(){
        const el = document.getElementById("ccShipmentId");
        if (!el || el._guarded) return;
        const desc = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, "value");
        if (!desc || typeof desc.get !== "function" || typeof desc.set !== "function") return;
        Object.defineProperty(el, "value", {
          configurable: true,
          get(){ return desc.get.call(this); },
          set(v){
            const isBlank = v == null || String(v).trim() === "";
            const fresh   = this.dataset.setAt && (Date.now() - Number(this.dataset.setAt)) < 2000;
            if (fresh && isBlank) return;     // üö´ ignore ‚Äújust after set‚Äù blanking
            desc.set.call(this, v);
           // ‚úÖ stop spinner immediately when a real value lands
        if (!isBlank) { window.ccSpin && window.ccSpin(false); }          }
        });
        el._guarded = true;

      // Spinner just for Chit Chats shipment-id lookups
      const ccSpinnerEl = document.getElementById("ccIdSpinner");
      let _ccSpinDepth = 0;
      function ccSpin(on){
        if (!ccSpinnerEl) return;
        if (on) { _ccSpinDepth++; ccSpinnerEl.style.display = "inline-block"; }
        else    { _ccSpinDepth = Math.max(0, _ccSpinDepth - 1);
                  if (_ccSpinDepth === 0) ccSpinnerEl.style.display = "none"; }
      }
      window.ccSpin = ccSpin; // ‚Üê expose globally

      })();

      // NEW: current in-flight ChitChats search + slow-pass timer
      window.ccSearchAbort = null;
      window.ccSlowTimer   = null;

      // Always use the Netlify functions base
      const fnBase = "/.netlify/functions";
      // Single source of truth for the Chit Chats proxy function name:
      const chitChatsFn = `${fnBase}/testChitChats`; // ‚Üê change 'testChitChats' here if your function is named differently

      // expose globally so any IIFE/module can access it
      window.chitChatsFn = chitChatsFn;
      
      // Resolve the proxy endpoint even if the global isn't set yet
      function getCcEndpoint(){
        if (typeof window !== "undefined" && window.chitChatsFn) return window.chitChatsFn;
        const base = location.hostname.includes("goldenspike")
          ? "https://shipping-1.goldenspike.app/.netlify/functions"
          : "/.netlify/functions";
        return `${base}/testChitChats`;
      }

      // --- Utils
      const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; };
      const reinitSelect = (el) => {
        try {
          if (window.M && window.M.FormSelect) {
            const inst = window.M.FormSelect.getInstance(el);
            if (inst) inst.destroy();
            window.M.FormSelect.init(el);
          }
        } catch {}
      };

      // Remember a batch we want to select (only if it‚Äôs still open)
      let _desiredBatchId = "";

      /** Try to select a batch id if it exists in the current open-only options */
      function preselectBatchIfOpen(id){
        _desiredBatchId = String(id || "").trim();
        if (!_desiredBatchId || !ccBatchSelect) return;

        const has = Array.from(ccBatchSelect.options || []).some(o => o.value === _desiredBatchId);
        if (has) {
          ccBatchSelect.value = _desiredBatchId;
          reinitSelect(ccBatchSelect);
        }
      }

      async function safeJSON(resp){
        const txt = await resp.text();
        try { return JSON.parse(txt); } catch { return { error: txt.slice(0,200) }; }
      }
      // Use the deployed proxy function (testChitChats) and its "search" resource
      // Always limit to Pending (open) batches on the server
      async function callSearch(params){
        window.ccSpin && window.ccSpin(true);

        // Build query
        const qs = new URLSearchParams({
          fast: "1",
          pendingOnly: String(params?.pendingOnly ?? "1"),
          timeoutMs: "9000",
          pageSize: String(params?.pageSize ?? "500"),
          ...(params || {})
        }).toString();

        // üî™ Cancel any in-flight search, then create a fresh controller
        try { window.ccSearchAbort?.abort(); } catch {}
        const ctrl = new AbortController();
        window.ccSearchAbort = ctrl;

        try {
          const resp = await fetch(`${fnBase}/testChitChats?resource=search&${qs}`, {
            credentials: "include",
            signal: ctrl.signal
          });
          return await safeJSON(resp);
        } catch (err) {
          // Swallow user-initiated cancels quietly
          if (err?.name === "AbortError") return { aborted: true };
          throw err;
        } finally {
          // Only clear if we're still the active controller
          if (window.ccSearchAbort === ctrl) window.ccSearchAbort = null;
          window.ccSpin && window.ccSpin(false);
        }
      }

      // --- UI setters
      function setShipmentUI(s){
        if (!s) {
          // Do not wipe a previously found id on a miss/timeout. Keep showing the last good value.
          return;
        }

        const sid = s?.id != null ? String(s.id) : "";
        if (ccShipEl) {
          ccShipEl.value = sid;
          ccShipEl.dataset.setAt = String(Date.now()); // üïí stamp when we set it
          // ‚úÖ hide spinner as soon as the textbox updates
          window.ccSpin && window.ccSpin(false);
        }        
        window.ccShipmentId    = sid;
        window.currentCarrier  = "ChitChats";
        window.currentTracking = s.carrier_tracking_code || sid || window.currentTracking;

        // If this shipment already belongs to a batch, try to preselect it (only if it‚Äôs open)
        if (s.batch_id != null) {
          preselectBatchIfOpen(String(s.batch_id));
        }
      }

        // --- Lookups
         function pickBestShipment(target, list = []){
          const norm = (s) => String(s || "").toLowerCase().replace(/[^a-z0-9]/g,"");
          const t = norm(target);
          const fields = (s) => [s.order_id, s.order_number, s.reference, s.reference_number, s.reference_value, s.carrier_tracking_code, s.tracking_code, s.tracking_number];
          const exact = list.find(s => fields(s).some(v => norm(v) === t));
          if (exact) return exact;
          const partial = list.find(s => fields(s).some(v => {
            const n = norm(v); return n && (n.includes(t) || t.includes(n));
          }));
          return partial || list[0] || null;
        }

      async function refreshFromOrderIfChitChats(){
        if (window.ccPostBuyFrozen) return;
        const orderId = (orderInp?.value || "").trim();
        if (!orderId) return;

        // NEW: cancel any pending slow-pass timer from a previous lookup
        if (window.ccSlowTimer) { clearTimeout(window.ccSlowTimer); window.ccSlowTimer = null; }

        try {
          const fast = await callSearch({ orderId, fast: "1", pendingOnly: "0" });
          const hit  = pickBestShipment(orderId, (fast.shipments || []));
          if (hit) { setShipmentUI(hit); return; }

          // Slow pass (fallback pages) ‚Äì schedule and remember the timer id
          window.ccSlowTimer = setTimeout(async () => {
            try {
              const slow = await callSearch({ orderId, fast: "0", pendingOnly: "0" });
              const s2   = pickBestShipment(orderId, (slow.shipments || []));
              if (s2) setShipmentUI(s2);
            } catch {}
          }, 900);
        } catch (e) {
          console.warn("order search failed", e);
        }
      }

      /* NEW: search by tracking number (mirrors order flow) */
      async function refreshFromTrackingIfChitChats(){
        if (window.ccPostBuyFrozen) return;
        const tracking = (trackingInp?.value || "").trim();
        if (!tracking) return;
        try {
          // Fast pass (uses vendor search)
          const fast = await callSearch({ tracking, fast: "1", pendingOnly: "0" });
          const hit  = pickBestShipment(tracking, (fast.shipments || []));
          if (hit) { setShipmentUI(hit); return; }
          // Slow pass (fallback pages)
          setTimeout(async () => {
            try {
              const slow = await callSearch({ tracking, fast: "0", pendingOnly: "0" });
              const s2   = pickBestShipment(tracking, (slow.shipments || []));
              if (s2) setShipmentUI(s2);
            } catch {}
          }, 900);
        } catch (e) {
          console.warn("tracking search failed", e);
        }
      }

      // make accessible to the Paste button‚Äôs 500ms trigger
      window.refreshFromOrderIfChitChats    = refreshFromOrderIfChitChats;
      window.refreshFromTrackingIfChitChats = refreshFromTrackingIfChitChats;

      // --- Listeners (debounced + change)
      orderInp   ?.addEventListener("input",  debounce(refreshFromOrderIfChitChats, 250));
      orderInp   ?.addEventListener("change", refreshFromOrderIfChitChats);
      trackingInp?.addEventListener("input",  debounce(refreshFromTrackingIfChitChats, 250));
      trackingInp?.addEventListener("change", refreshFromTrackingIfChitChats);

      // Enter-to-search for reliability (manual entry/paste)
      // üîÅ Order: run lookup 500ms after a *real* Enter press so UI settles first.
      orderInp?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();

          // üîì New order ‚Üí thaw post-buy freeze, clear CC id, refresh batches
          window.ccPostBuyFrozen = false;
          window.ccMuteIdInput   = false;
          const idEl = document.getElementById("ccShipmentId");
          if (idEl) { idEl.value = ""; idEl.dataset.setAt = String(Date.now()); }
          window.ccShipmentId = "";
          try { fetchBatches(); } catch {}

          // üî™ kill any live CC search and pending slow-pass; we‚Äôre switching orders
          try { window.ccSearchAbort?.abort(); } catch {}
          if (window.ccSlowTimer) { clearTimeout(window.ccSlowTimer); window.ccSlowTimer = null; }
          window.ccSpin && window.ccSpin(false);

          if (e.isTrusted) setTimeout(() => window.refreshFromOrderIfChitChats?.(), 500); // ‚Üê 500ms delay
        }
      });

      // Tracking remains immediate on Enter
      trackingInp?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          refreshFromTrackingIfChitChats();
        }
      });

      // Kick if fields already have values
      if ((orderInp?.value || "").trim())    refreshFromOrderIfChitChats();
      if ((trackingInp?.value || "").trim()) refreshFromTrackingIfChitChats();

      // --- Batches
      async function fetchBatches(){
        try {
          // Open-only (pending) batches; received/closed are excluded by the API filter
          const resp = await fetch(`${window.getCcEndpoint()}?resource=batches&status=open`, { credentials: "include" });
          const data = await safeJSON(resp);
          const raw  = (data && (data.batches ?? data.data)) ?? data;
          const list = Array.isArray(raw) ? raw : [];

          ccBatchSelect.innerHTML =
            `<option value="">Select Batch‚Ä¶</option>` +
            list.map(b => {
              const label = (b.description || b.name || `Batch ${b.id}`) + (b.status ? ` ‚Ä¢ ${b.status}` : "");
              return `<option value="${b.id}">${label}</option>`;
            }).join("");

          reinitSelect(ccBatchSelect);

          // If a shipment just told us its batch, try to apply it now (only works if still open)
          if (_desiredBatchId) preselectBatchIfOpen(_desiredBatchId);
        } catch (e) {
          console.warn("fetchBatches failed", e);
          if (window.M?.toast) M.toast({ html: "Failed to load Chit Chats batches" });
        }
      }

      // Call once on load, and whenever config opens
      fetchBatches();
      document.getElementById("openConfigBtn")?.addEventListener("click", fetchBatches);

      // Create a named batch
      createBtn?.addEventListener("click", async () => {
        try {
          const desc = (ccBatchName.value || "").trim() || `UI ${new Date().toISOString().slice(0,10)}`;
          const resp = await fetch(`${window.getCcEndpoint()}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ action: "create", description: desc })
          });
          const out = await safeJSON(resp);
          if (!resp.ok || !out?.success) throw new Error(out?.error || JSON.stringify(out||{}));
          await fetchBatches();
          if (out.id) {
            ccBatchSelect.value = out.id;
            reinitSelect(ccBatchSelect);
          }
          ccBatchName.value = "";
          if (window.M?.toast) M.toast({ html: "Batch created!" });
        } catch (e) {
          console.error(e);
          if (window.M?.toast) M.toast({ html: "Create batch failed" });
        }
      });

      // Add/Remove current shipment
      async function mutateBatch(op){
        const shipmentId = String(window.ccShipmentId ?? "").trim();
        const batchId    = String(ccBatchSelect?.value ?? "").trim();
        if (!shipmentId) { if (window.M?.toast) M.toast({ html: "No shipment loaded yet" }); return; }
        if (!batchId)    { if (window.M?.toast) M.toast({ html: "Choose a batch first" });  return; }
        try {
          const url  = `${getCcEndpoint()}?id=${encodeURIComponent(shipmentId)}`;
          const resp = await fetch(url, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ action: op, batch_id: batchId })
          });
          const out = await safeJSON(resp);
          if (!resp.ok || !out?.success) throw new Error(out?.error || JSON.stringify(out||{}));
          if (window.M?.toast) M.toast({ html: op === "add" ? "Added to batch" : "Removed from batch" });
        } catch (e) {
          console.error(e);
          if (window.M?.toast) M.toast({ html: "Batch update failed" });
        }
      }
      addBtn   ?.addEventListener("click", () => mutateBatch("add"));
      removeBtn?.addEventListener("click", () => mutateBatch("remove"));

      // Tiny API ping so connectivity issues are obvious in console
      (async () => {
        try {
          const ping = await fetch(getCcEndpoint());
          if (!ping.ok) console.warn("Chit Chats function ping failed", ping.status);
        } catch (e) {
          console.warn("Chit Chats function unreachable:", e);
        }
      })();

      // Expose minimal hooks for the Enter-key flow
      window.cc = {
        searchByOrder:    refreshFromOrderIfChitChats,
        searchByTracking: refreshFromTrackingIfChitChats
      };
    })();

    // Global helper ‚Äî returns "YYYY-MM-DD" from #cc_ship_date or "today"
    function getShipDateForApi() {
      const el = document.getElementById("cc_ship_date");
      const raw = String((el && el.value) || "").trim();
      return raw ? raw : "today";
    }
    window.getShipDateForApi = getShipDateForApi; // optional, explicit

      // üÜï Promise-based payload preview modal
      async function openCcPayloadModal(previewList){
        const modal   = document.getElementById("ccPayloadModal");
        const pre     = document.getElementById("ccPayloadPre");
        const btnOK   = document.getElementById("ccPayloadConfirm");
        const btnCancel = document.getElementById("ccPayloadCancel");

        // Pretty-print
        pre.textContent = JSON.stringify(previewList, null, 2);
        modal.style.display = "block";

        return new Promise(resolve => {
          const close = (ok) => {
            modal.style.display = "none";
            btnOK.removeEventListener("click", onOK);
            btnCancel.removeEventListener("click", onCancel);
            resolve(ok);
          };
          const onOK = () => close(true);
          const onCancel = () => close(false);

          btnOK.addEventListener("click", onOK, { once:true });
          btnCancel.addEventListener("click", onCancel, { once:true });
        });
      }

    /* ===== Chit Chats Edit Shipment Wizard (create ‚Üí refresh rates ‚Üí buy) ===== */
    (function(){
      const modal     = document.getElementById("ccEditModal");
      const editBtn   = document.getElementById("ccEditBtn");
      const pillNodes = Array.from(document.querySelectorAll(".cc-step-pill"));
      const steps     = [0,1,2,3].map(i => document.getElementById("ccStep"+i));
      const ratesList = document.getElementById("ccRates");
      const btnClose  = document.getElementById("ccClose");
      const btnBack   = document.getElementById("ccBack");
      const btnNext   = document.getElementById("ccNext");
      const btnRefresh= document.getElementById("ccRefreshRates");
      const btnBuy    = document.getElementById("ccBuy");
      const idInput   = document.getElementById("ccShipmentId");
      // Single source of truth: once we buy, freeze auto-refreshes that key off ccShipmentId
      window.ccPostBuyFrozen ??= false;
      // Capture-phase guard: block all ccShipmentId-driven rechecks after Buy
      const blockIfFrozen = (e) => {
        if (window.ccPostBuyFrozen) {
          e.stopImmediatePropagation();
          e.preventDefault();
        }
      };
      idInput?.addEventListener("input",  blockIfFrozen, true);
      idInput?.addEventListener("change", blockIfFrozen, true);
      idInput?.addEventListener("keydown",blockIfFrozen, true);
      idInput?.addEventListener("keyup",  blockIfFrozen, true);

      const fnBase    = "/.netlify/functions";

      let currentStep = 0, selectedPostageType = null;
      window.ccBlockRatesUntilStep2 = true; // üö´ block pricing until Step 2

      function set(id, v) {
        const el = document.getElementById(id);
        if (!el) return;
        if ("value" in el) el.value = String(v);
        else el.textContent = String(v);
        // Never re-trigger lookups for the Chit Chats id once we've bought.
        const isCcId = id === "ccShipmentId";
        const suppress = isCcId && (window.ccMuteIdInput || window.ccPostBuyFrozen);
        if (!suppress) {
          try { el.dispatchEvent(new Event("input", { bubbles: true })); } catch {}
        }
      }

      // NEW: fillOnce ‚Äî only sets when the field is empty and not user-edited
      function fillOnce(id, val) {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.dataset.userEdited === "1") return;
        const hasVal = String(el.value ?? "").trim().length > 0;
        if (hasVal) return;
        if (val == null || (typeof val === "number" && !Number.isFinite(val))) return;
        el.value = String(val);
        try { el.dispatchEvent(new Event("input", { bubbles: true })); } catch {}
      }
    
      // NEW: mark qty/unit_value as user-edited when the user types
      document.addEventListener("DOMContentLoaded", () => {
        ["cc_item_qty","cc_item_unit_value"].forEach(id => {
          const el = document.getElementById(id);
          el?.addEventListener("input", () => { el.dataset.userEdited = "1"; });
        });
      });

      function showStep(i){
        // Ensure the editor modal is visible when stepping between wizard pages
        if (modal && modal.style.display !== "block") modal.style.display = "block";
        currentStep = Math.max(0, Math.min(3, i));
        window.ccBlockRatesUntilStep2 = currentStep < 2; // only allow pricing once we enter Step 2+
        steps.forEach((el,idx) => el.classList.toggle("active", idx===currentStep));
        pillNodes.forEach((el,idx) => el.classList.toggle("active", idx===currentStep));
        btnBack.disabled = currentStep === 0;
        btnNext.disabled = currentStep === 3;
        btnRefresh.style.display = currentStep === 3 ? "inline-block" : "none";
        btnBuy.style.display     = currentStep === 3 ? "inline-block" : "none";
        /* After toggling .active classes, trigger autofill when entering Step 1 */
        if (currentStep === 1) {
          prefillCustomsFromEtsy();
          // one-shot safety: if something blanks them right after open, re-fill once
          setTimeout(() => {
            const q = document.getElementById("cc_item_qty");
            const u = document.getElementById("cc_item_unit_value");
            if (q && !String(q.value || "").trim() && q.dataset.userEdited !== "1") prefillCustomsFromEtsy();
            if (u && !String(u.value || "").trim() && u.dataset.userEdited !== "1") prefillCustomsFromEtsy();
          }, 300);
        }
      }

      /* (B) Removed ‚Äî this ran too early and ignored the selected tile.
      Use prefillCustomsFromEtsy() on tile selection + modal open instead. */

      // (C) Static defaults you requested
      // NOTE: These fields are sent as ISO/codes to Chit Chats later; we‚Äôll set sensible values.
      set("cc_item_origin_country", "CA");           // API prefers 2-letter country code
      set("cc_item_hs_tariff_code", "7113.19.5091");
      set("cc_item_manufacture_country", "CA");      // API prefers 2-letter country code
      set("cc_item_manufacturer_contact", "Brites Jewelry Inc.");
      set("cc_item_manufacturer_street",  "450 Matheson Blvd, East");
      set("cc_item_manufacturer_city",    "Mississauga");
      set("cc_item_manufacturer_province_code", "ON");   // API prefers code (ON)
      set("cc_item_manufacturer_postal_code",   "L4Z-1R5");
      set("cc_item_manufacturer_phone",         "416-606-2476");
      set("cc_item_manufacturer_email",         "michelle@custombrites.com");
    

      function parseShipToBox(){
        const box = document.getElementById("shipAddressBox");
        const txt = (box?.value || "").replace(/^SHIP TO:\s*/i, "").trim();
        const raw = txt.split(/\n+/).map(l => l.trim()).filter(Boolean);
        const lines = raw.filter(l => !/^phone\s*:?/i.test(l)); // drop phone line from parsing

        const out = {};
        out.to_name = lines[0] || "";

        // Country: look anywhere, not just the last line
        const joined = lines.join("\n");
        if (/canada/i.test(joined)) out.to_country_code = "CA";
        else if (/(united\s*states|USA|US)/i.test(joined)) out.to_country_code = "US";

        // Pick the most likely "City ST ZIP" line from the bottom up
        let candidate = "";
        for (let i = lines.length - 1; i >= 0; i--) {
          const l = lines[i];
          if (/,/.test(l) || /\b[A-Za-z]{2}\s+[A-Za-z0-9][A-Za-z0-9 -]{2,}\b/.test(l)) { candidate = l; break; }
        }

        // Accept all of the following:
        //   City, ST ZIP
        //   City, ST, ZIP   ‚Üê (extra comma before ZIP)
        //   City ST ZIP     ‚Üê (no comma)
        let m =
          candidate.match(/^([^,]+),\s*([A-Za-z]{2})(?:,|\s)+([A-Za-z0-9][A-Za-z0-9 -]{2,})$/) ||
          candidate.match(/^(.+?)\s+([A-Za-z]{2})\s+([A-Za-z0-9][A-Za-z0-9 -]{2,})$/);

        if (m) {
          out.to_city = m[1].trim();
          out.to_province_code = m[2].trim();
          out.to_postal_code = m[3].trim();
        }

        // Street lines
        out.to_address_1 = lines[1] || "";
        const unitMatch = (lines[1] || "").match(/\b(apt|unit|suite|#)\s*[\w-]+/i);
        out.to_address_2 = unitMatch ? unitMatch[0] : "";

        // If country still unknown, infer from postal format
        if (!out.to_country_code) {
          const pc = out.to_postal_code || "";
          if (/^[A-Za-z]\d[A-Za-z]\s?\d[A-Za-z]\d$/i.test(pc)) out.to_country_code = "CA";
          else if (/^\d{5}(-\d{4})?$/.test(pc)) out.to_country_code = "US";
        }

        return out;
      }

      async function modalOpen(){
      // Keep ccShipmentId locked post-purchase (no re-checks). Do not thaw here.
        /* INSERT inside modalOpen(), near the top after local refs */
        {
          // Make sure we have the transactions for this order before showing Step 1
          const receiptId = (document.getElementById("etsyOrderNumber")?.value || "").trim();
          if (receiptId && (!Array.isArray(window.cachedOrderItems) || window.cachedOrderItems.length === 0)) {
            maybeLoadEtsyTransactions(receiptId).then(() => prefillCustomsFromEtsy());
          } else {
            prefillCustomsFromEtsy();
          }
        }
        const seed = parseShipToBox();
        document.getElementById("cc_to_name").value           = seed.to_name || "";
        document.getElementById("cc_to_address_1").value      = seed.to_address_1 || "";
        document.getElementById("cc_to_address_2").value      = seed.to_address_2 || "";
        document.getElementById("cc_to_city").value           = seed.to_city || "";
        document.getElementById("cc_to_province_code").value  = seed.to_province_code || "";
        document.getElementById("cc_to_postal_code").value    = seed.to_postal_code || "";
        document.getElementById("cc_to_country_code").value   = seed.to_country_code || "";

        selectedPostageType = null;
        btnBuy.disabled = true;
        ratesList.innerHTML = "";



        modal.style.display = "block";
        // Do NOT call showStep(1) here; verify must appear first.
        // Kick off the verification flow immediately:
        // Fill again when the Edit modal opens
        prefillCustomsFromEtsy();
        maybeVerifyAddressBeforeStep1(true);
      }
       function modalClose(){
        modal.style.display = "none";
        // Do not thaw post-purchase; keep re-checks disabled for this session.
      }

      /* ---------- Enhanced fetch wrapper (keeps raw error for mapping) ---------- */
      async function callCc(method, body, qs=""){
        window.callCc = callCc;
        const resp = await fetch(`${getCcEndpoint()}${qs}`, {     
          method,
          headers: { "Content-Type":"application/json" },
          body: body ? JSON.stringify(body) : undefined
        });
        const text = await resp.text();
        let data; try { data = JSON.parse(text); } catch { data = text; }

        if (!resp.ok) {
          const pick = k => (data && typeof data[k] === "string" ? data[k] : null);
          const message = typeof data === "string"
            ? data
            : (pick("error") || pick("message") || JSON.stringify(data, null, 2));

          const e = new Error(message);
          e.status = resp.status;
          e.raw    = data;
          try { console.debug("ChitChats proxy error", resp.status, data); } catch {}
          throw e;
        }
        return data;
      }

      // Keep the ID field and global in sync wherever a shipment gets created/refreshed
      function pushShipmentId(id){
        const v = String(id ?? "");
        window.ccShipmentId = v;
        const el = document.getElementById("ccShipmentId");
        if (el) {
          const prev = el.value;
          el.value = v;
          el.dataset.setAt = String(Date.now());
          // ‚õî do not fire 'input' if muted or frozen
          if (!window.ccMuteIdInput && !window.ccPostBuyFrozen && v !== prev) {
            try { el.dispatchEvent(new Event("input", { bubbles: true })); } catch {}
          }
        }
      }

      async function ensureShipment(){
        const id = (idInput.value || "").trim();

        // Creating a shipment? Hard-fail if country is missing.
        if (!id) {
          const to = buildTo();
          if (!to.country_code) {
            markMissing(0, ["cc_to_country_code"]);
            M.toast?.({ html: "Country is required (e.g., CA or US)." });
            showStep(0);
            throw new Error("Missing recipient country_code");
          }
        }

        if (id) return await callCc("GET", null, `?resource=shipment&id=${encodeURIComponent(id)}`);
        const out = await callCc("POST", { action:"create_shipment", shipment: buildShipmentPayload() });
        pushShipmentId(out?.id);
        return out.shipment || (out.id ? await callCc("GET", null, `?resource=shipment&id=${encodeURIComponent(out.id)}`) : null);
      }

      /* ---------- Buy ‚Üí Poll Chit Chats for label ‚Üí Print inline (no tabs); QZ optional ---------- */

      /* Feature flag: leave QZ code in the file, but disable it by default */
      const USE_QZ = false;


      async function replaceShipmentWithCorrections() {
        // Hard guard: a create requires country_code
        const to = buildTo();
        if (!to.country_code) {
          markMissing(0, ["cc_to_country_code"]);
          M.toast?.({ html: "Country is required (e.g., CA or US)." });
          showStep(0);
          throw new Error("Missing recipient country_code");
        }

        // ‚ö†Ô∏è Proxy only supports PATCH: refresh|buy|add|remove
        // So we DO NOT call refund/delete here.
        // We simply create a new shipment with corrected recipient + line_items.
        const created = await callCc("POST", { action: "create_shipment", shipment: buildShipmentPayload() });
        const newId   = created?.id || created?.shipment?.id;
        if (newId) pushShipmentId(newId);
        return created;
      }


      /* Enhanced fetch wrapper you already use: callCc(method, body, qs) */
      /* Helper that ensures we have a shipment object: ensureShipment()  */
      /* Helper to set the visible shipment id + window.ccShipmentId: pushShipmentId(id) */
      /* Prefer ZPL for thermal; PDF/PNG as fallback */
      function pickLabelFromShipment(s) {
        const zpl = s.postage_label_zpl_url || s.postageLabelZplUrl;
        const pdf = s.postage_label_pdf_url || s.postageLabelPdfUrl || s.label_pdf_url || s.labelPdfUrl;
        const png = s.postage_label_png_url || s.postageLabelPngUrl || s.label_png_url || s.labelPngUrl;
        return { zpl, pdf, png };
      }

      /* --- Inline-print helpers (no new tab) --- */
      async function fetchCcLabelBlob(fmt, shipmentId) {
        const u = `/.netlify/functions/testChitChats?resource=label&id=${encodeURIComponent(shipmentId)}&format=${encodeURIComponent(fmt)}`;
        const r = await fetch(u, { method: "GET" });
        if (!r.ok) throw new Error(`label ${fmt} fetch failed: ${r.status}`);
        const ct = r.headers.get("content-type") || (fmt === "pdf" ? "application/pdf" : "image/png");
        const buf = await r.arrayBuffer();
        return new Blob([buf], { type: ct });
      }

      function printBlobInPlace(blob) {
        return new Promise((resolve, reject) => {
          const url = URL.createObjectURL(blob);
          const iframe = document.createElement("iframe");
          iframe.style.position = "fixed";
          iframe.style.right = "0";
          iframe.style.bottom = "0";
          iframe.style.width = "0";
          iframe.style.height = "0";
          iframe.style.border = "0";
          iframe.onload = () => {
            try {
              const w = iframe.contentWindow;
              // Let the PDF viewer initialize before printing
              setTimeout(() => {
                w.focus();
                w.print();
                resolve();
                setTimeout(() => { URL.revokeObjectURL(url); iframe.remove(); }, 1000);
              }, 250);
            } catch (e) {
              URL.revokeObjectURL(url);
              iframe.remove();
              reject(e);
            }
          };
          iframe.src = url;
          document.body.appendChild(iframe);
        });
      }

      /* Poll GET ?resource=shipment&id=‚Ä¶ until label URLs appear (Chit Chats returns them when status turns ready) */
      async function waitForLabelUrls(shipmentId, attempts = 10, delayMs = 2000) {
        for (let i = 0; i < attempts; i++) {
          const out = await callCc("GET", null, `?resource=shipment&id=${encodeURIComponent(shipmentId)}`);
          const s   = out?.shipment || out || {};
          const { zpl, pdf, png } = pickLabelFromShipment(s);
          if (zpl || pdf || png) return { zpl, pdf, png, shipment: s };
          await sleep(delayMs);
        }
        return { zpl:null, pdf:null, png:null, shipment:null };
      }

      /* ---------- QZ Tray helpers (works if QZ + signing are set up; otherwise gracefully falls back) ---------- */
      async function connectQZ() {
        if (!window.qz) throw new Error("QZ Tray not found");
        if (!qz.websocket.isActive()) {
          // If you already call qz.security.setCertificatePromise / setSignaturePromise elsewhere, this is a no-op.
          // If not, wire them to your signing endpoint (recommended by QZ). Example placeholder:
          if (!qz.security.getCertificatePromise?.()) {
            qz.security.setCertificatePromise((resolve, reject) => {
              // TODO: replace with your cert fetch; demo loads from a static path
              fetch("/qz/digital-certificate.txt").then(r => r.text()).then(resolve).catch(reject);
            });
          }
          if (!qz.security.getSignaturePromise?.()) {
            qz.security.setSignaturePromise(toSign => (resolve, reject) => {
              // Server-side signing is required. Provide a Netlify function that signs `toSign`.
              fetch("/.netlify/functions/qz-sign", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ toSign }) })
                .then(r => r.text()).then(resolve).catch(reject);
            });
          }
          await qz.websocket.connect({ retries: 1, delay: 500 });
        }
      }

      async function qzPrintZpl(zplText, printerName = null) {
        await connectQZ();
        const cfg = qz.configs.create(printerName || null, { // null ‚Üí default printer
          // 4x6 label hints (many Zebra drivers obey this)
          size: { width: 4, height: 6 },
          units: "in",
          rasterize: false
        });
        return qz.print(cfg, [{ type: "raw", data: zplText }]);
      }

      async function qzPrintPdfUrl(pdfUrl, printerName = null) {
        await connectQZ();
        const cfg = qz.configs.create(printerName || null, {
          size: { width: 4, height: 6 },
          units: "in",
          rasterize: true // render PDF to pixels for thermal reliability
        });
        // QZ can fetch the URL itself
        return qz.print(cfg, [{ type: "pdf", data: pdfUrl }]);
      }

      async function qzPrintPngUrl(pngUrl, printerName = null) {
        await connectQZ();
        const cfg = qz.configs.create(printerName || null, {
          size: { width: 4, height: 6 },
          units: "in"
        });
        return qz.print(cfg, [{ type: "image", data: pngUrl }]);
      }

      /* Browser fallback: open the label and trigger native print */
      async function openAndAutoPrintLabel(url, win) {
        let target = (win && !win.closed) ? win : null;
        if (!target) { try { target = window.open("", "_blank", "noopener,noreferrer"); } catch {} }
        if (!target) { window.location.href = url; return; }
        const isPdf = /\.pdf(\?|$)/i.test(url);
        const html = isPdf
          ? `<!doctype html><html><head><meta charset="utf-8"><title>Label</title></head>
             <body style="margin:0"><iframe src="${url}" style="border:0;width:100vw;height:100vh"></iframe>
             <script>function p(){try{window.focus();window.print();}catch(e){}}
             window.addEventListener('load',()=>setTimeout(p,900));setTimeout(p,2500);<\/script></body></html>`
          : `<!doctype html><html><head><meta charset="utf-8"><title>Label</title></head>
             <body style="margin:0"><img src="${url}" style="display:block;width:100%;height:auto"/>
             <script>function p(){try{window.focus();window.print();}catch(e){}}
             window.addEventListener('load',()=>setTimeout(p,900));setTimeout(p,2500);<\/script></body></html>`;
        target.document.open(); target.document.write(html); target.document.close();
      }

      /* Main flow: buy ‚Üí poll ‚Üí print (no new tab) */      
      async function buyCcThenPrint() {
        try {

          // No stub window: we will print inline in the same tab.
          // Mute ccShipmentId 'input' side-effects during Buy so it doesn't auto-refresh.
          window.ccPostBuyFrozen = true; // freeze immediately on Buy

          // 1) Ensure we have a shipment (create if missing)
          const s0 = await ensureShipment();
          const shipmentId = (s0?.shipment?.id ?? s0?.id ?? idInput?.value ?? "").toString();
          if (!shipmentId) throw new Error("No shipment id");

          // 2) Pick selected rate‚Äôs postage_type (required by Chit Chats /buy)
          let postageType = "unknown";
          const selectedLi = ratesList?.querySelector("li.selected");
          if (selectedLi?.dataset?.postageType) postageType = selectedLi.dataset.postageType;

          // 3) Buy label
          await callCc("PATCH", { action: "buy", shipment_id: shipmentId, postage_type: postageType });

          // 4) Poll for label URLs (Chit Chats may return postage_requested first)
          const { zpl, pdf, png, shipment } = await waitForLabelUrls(shipmentId, 12, 1500);

          // 5) Preferred: inline browser print (PDF first, then PNG). No tabs, no redirect.
          let printed = false;
          try {
            const pdfBlob = await fetchCcLabelBlob("pdf", shipmentId);
            await printBlobInPlace(pdfBlob);
            printed = true;
          } catch {}  // fall through to PNG
          if (!printed) {
            try {
              const pngBlob = await fetchCcLabelBlob("png", shipmentId);
              await printBlobInPlace(pngBlob);
              printed = true;
            } catch {}
          }
          if (!printed) throw new Error("Label purchased, but not ready yet.");

           // 6) Lock out auto-refresh for ccShipmentId going forward
          window.ccPostBuyFrozen = true;

          // (Optional UI updates)
          if (shipment?.carrier_tracking_code) {
            const t = document.getElementById("trackingNumberInput");
            if (t) { t.value = shipment.carrier_tracking_code; t.dispatchEvent(new Event("input", { bubbles:true })); }
          }

          // Success UX: close the Edit modal after we have the label & invoked print
          try {
            const modalEl = document.getElementById("ccEditModal");
            if (modalEl) modalEl.style.display = "none";
          } catch {}
          M.toast?.({ html: "Label printed." });
        } catch (err) {
          console.error(err);
          M.toast?.({ html: "Buy/print failed: " + (err.message || err) });
        } finally {

          // Only unmute if we did NOT freeze (i.e., only on failure path)
          if (!window.ccPostBuyFrozen) window.ccMuteIdInput = false;
        }
      }

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       * Buy ‚Üí Poll for label ‚Üí Print
       * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      const sleep = (ms) => new Promise(res => setTimeout(res, ms));

      // Open a placeholder print window right away to preserve user gesture
      function openPrintStub(){
        let win = null;
        try { win = window.open("", "_blank", "noopener,noreferrer"); } catch {}
        if (!win) return null;
        const html = `<!doctype html><html><head><meta charset="utf-8"><title>Generating label‚Ä¶</title>
          <style>
            body{margin:0;display:flex;align-items:center;justify-content:center;height:100vh;font:16px system-ui,Arial}
            .spinner{width:42px;height:42px;border:4px solid #ddd;border-top-color:#26a69a;border-radius:50%;animation:spin .9s linear infinite;margin:12px auto}
            @keyframes spin{to{transform:rotate(360deg)}}
          </style></head>
          <body>
            <div>
              <div class="spinner"></div>
              <div>Generating label in Chit Chats‚Ä¶ don‚Äôt close this tab.</div>
            </div>
          </body></html>`;
        try { win.document.open(); win.document.write(html); win.document.close(); } catch {}
        return win;
      }

      // Poll Chit Chats until a usable label URL appears
      async function waitForLabelUrl(shipmentId, attempts = 8, delayMs = 3000) {
        for (let i = 0; i < attempts; i++) {
          try {
            const out = await callCc("GET", null, `?resource=shipment&id=${encodeURIComponent(shipmentId)}`);
            const s   = out?.shipment || out || {};
            const url =
              s.label_url ||
              s.labelUrl ||
              s.label_download_url ||
              (s.label && (s.label.url || s.label.download_url)) ||
              (Array.isArray(s.labels) && (s.labels[0]?.url || s.labels[0]?.label_url)) ||
              null;
            if (url) return url;
          } catch (_) {
            // ignore and retry (handles transient API states)
          }
          await sleep(delayMs);
        }
        return null;
      }

      // Open the label and auto-trigger the print dialog (PDF or image)
      async function openAndAutoPrintLabel(url, win) {
        let target = (win && !win.closed) ? win : null;
        if (!target) {
          try { target = window.open("", "_blank", "noopener,noreferrer"); } catch {}
        }
        if (!target) {
          // Popup blocked ‚Üí fallback to same-tab open
          window.location.href = url;
          return;
        }
        const isPdf = /\.pdf(\?|$)/i.test(url);
        const isImg = /\.(png|jpe?g|webp)(\?|$)/i.test(url);
        const html = isPdf
          ? `<!doctype html><html><head><meta charset="utf-8"><title>Label</title></head>
             <body style="margin:0">
               <iframe src="${url}" style="border:0;width:100vw;height:100vh"></iframe>
               <script>
                 function p(){ try{ window.focus(); window.print(); }catch(e){} }
                 window.addEventListener('load', ()=> setTimeout(p, 900));
                 setTimeout(p, 2500);
               <\/script>
             </body></html>`
          : `<!doctype html><html><head><meta charset="utf-8"><title>Label</title></head>
             <body style="margin:0;display:flex;align-items:center;justify-content:center">
               <img id="lab" src="${url}" style="max-width:100vw;max-height:100vh"/>
               <script>
                 const img = document.getElementById('lab');
                 img.addEventListener('load', ()=> { try{ window.focus(); window.print(); }catch(e){} });
                 setTimeout(()=>{ try{ window.focus(); window.print(); }catch(e){} }, 2500);
               <\/script>
             </body></html>`;
        try {
        target.document.open();
        target.document.write(html);
        target.document.close();
        } catch {
          try { target.location.href = url; } catch {}
        }
      }

async function ccValidateAgainstApi(step){
  const payload    = buildShipmentPayload();
  const rawId      = (document.getElementById("ccShipmentId")?.value || "").trim();
  const hasValidId = /^[A-Za-z0-9_-]{8,}$/.test(rawId);

  try {
    // ‚úÖ Step 0: verify address only ‚Äî NO rates here
    if (step === 0) {
      await callCc("POST", { action: "verify_to", to: buildTo() });
      return [];
    }

    // ‚úÖ Step 1: ensure a draft shipment exists, or replace it ‚Äî NO rates here
    if (step === 1) {
      if (!hasValidId) {
        // Create draft (first time)
        const created = await callCc("POST", { action: "create_shipment", shipment: buildShipmentPayload() });
        if (created?.id) {
          pushShipmentId(created.id);
          const idInput = document.getElementById("ccShipmentId");
          if (idInput) idInput.value = created.id;
        }
        return [];
      }

      // Replace existing draft (not purchased)
      const response = await callCc("PATCH", {
        action     : "replace_shipment",
        shipment_id: rawId,
        payload    : buildShipmentPayload()
      });
      if (response?.id) {
        pushShipmentId(response.id);
        const idInput = document.getElementById("ccShipmentId");
        if (idInput) idInput.value = response.id;
      }
      return [];
    }

    // üîï Steps ‚â•2: never fetch rates here; Step 2 ‚Üí Next will handle it explicitly.
    return [];
  } catch (e) {
    handleCcApiError(step, e);
    const stepEl = document.getElementById("ccStep" + step);
    const ids = Array.from(stepEl.querySelectorAll(".cc-field.cc-missing [id]")).map(n => n.id);
    return ids;
  }
}

       function buildTo(){
         return {
           name          : document.getElementById("cc_to_name").value.trim(),
           address_1     : document.getElementById("cc_to_address_1").value.trim(),
           address_2     : document.getElementById("cc_to_address_2").value.trim() || null,
           city          : document.getElementById("cc_to_city").value.trim(),
           province_code : document.getElementById("cc_to_province_code").value.trim(),
           postal_code   : document.getElementById("cc_to_postal_code").value.trim(),
           country_code  : document.getElementById("cc_to_country_code").value.trim().toUpperCase(),
           phone         : document.getElementById("cc_to_phone").value.trim() || null,
           email         : document.getElementById("cc_to_email").value.trim() || null
         };
       }

       // Normalize money to a Number with 2-decimal precision (no strings)
       function fix2(n){
         const v = Number(n || 0);
         if (!Number.isFinite(v)) return 0;
         return Math.round(v * 100) / 100;
       }

        function toMoney(n){
         const v = Number(n || 0);
         if (!Number.isFinite(v)) return "0.00";
         return (Math.round(v * 100)/100).toFixed(2);
       }

        function buildShipmentPayload(){
          const toObj         = buildTo();
          const toCountry     = toObj.country_code;
          const valueCurrency = (document.getElementById("cc_value_currency")?.value || (toCountry === "CA" ? "CAD" : "USD"));

          // multi-item support
          const lines      = collectCcLineItems();
          const totalValue = lines.reduce((sum, li) => sum + (Number(li.unit_value||0) * Number(li.quantity||0)), 0);
          const grandInput = Number(document.getElementById("cc_grand_total")?.value || 0);
          const grandTotal = (Number.isFinite(grandInput) && grandInput > 0) ? grandInput : totalValue;

          // customs line items
          const line_items = lines.map(li => ({
            description                : li.description,
            quantity                   : Number(li.quantity) || 1,
            value_amount               : toMoney(li.unit_value),
            currency_code              : valueCurrency.toLowerCase(),
            hs_tariff_code             : li.hs_tariff_code || undefined,
            sku_code                   : li.sku || undefined,
            origin_country             : (li.origin_country || "").toUpperCase() || undefined,
            manufacture_country        : li.manufacture_country || undefined,
            manufacturer_contact       : li.manufacturer_contact || undefined,
            manufacturer_street        : li.manufacturer_street || undefined,
            manufacturer_city          : li.manufacturer_city || undefined,
            manufacturer_province_code : li.manufacturer_province_code || undefined,
            manufacturer_postal_code   : li.manufacturer_postal_code || undefined,
            manufacturer_phone         : li.manufacturer_phone || undefined,
            manufacturer_email         : li.manufacturer_email || undefined
          }));

          // package block
          const pkg = {
            package_type         : document.getElementById("cc_package_type").value,
            size_unit            : document.getElementById("cc_size_unit").value,
            size_x               : Number(document.getElementById("cc_size_x").value || 0),
            size_y               : Number(document.getElementById("cc_size_y").value || 0),
            size_z               : Number(document.getElementById("cc_size_z").value || 0),
            weight_unit          : document.getElementById("cc_weight_unit").value,
            weight               : Number(document.getElementById("cc_weight").value || 0),
            insurance_requested  : document.getElementById("cc_insurance_requested").value === "true",
            signature_requested  : document.getElementById("cc_signature_requested").value === "true",
            media_mail_requested : document.getElementById("cc_media_mail_requested").value === "true",
            ship_date            : normalizeShipDate(document.getElementById("cc_ship_date").value)
          };

          // ‚úÖ top-level vat_reference (required placement by Chit Chats API)
          const vatRef = sanitizeVatRef(document.getElementById("cc_customs_tax_reference_number")?.value);

          return {
            to           : toObj,
            package      : pkg,
            vat_reference: vatRef || undefined,
            customs      : {
              package_contents: document.getElementById("cc_package_contents").value,
              value           : toMoney(grandTotal),
              value_currency  : valueCurrency.toLowerCase(),
              line_items
              // (no nested vat_reference ‚Äî top-level is authoritative)
            }
          };
        }

function buildRefreshPayload(){
  // gather units/dims
  const wUnit = document.getElementById("cc_weight_unit").value;
  const weight = Number(document.getElementById("cc_weight").value || 0);
  const sUnit = document.getElementById("cc_size_unit").value;
  const sx = Number(document.getElementById("cc_size_x").value || 0);
  const sy = Number(document.getElementById("cc_size_y").value || 0);
  const sz = Number(document.getElementById("cc_size_z").value || 0);

  // compute totals & items first
  const toCountry     = document.getElementById("cc_to_country_code").value.trim().toUpperCase();
  const valueCurrency = (document.getElementById("cc_value_currency")?.value || (toCountry === "CA" ? "CAD" : "USD"));
  const lines         = collectCcLineItems();
  const totalViaUnits = lines.reduce((s, li) => s + (Number(li.unit_value||0) * Number(li.quantity||0)), 0);
  const grandInput    = Number(document.getElementById("cc_grand_total")?.value || 0);
  const grandTotal    = (Number.isFinite(grandInput) && grandInput > 0) ? grandInput : totalViaUnits;

  // customs line items (currency uppercased)
  const line_items = lines.map(li => ({
    description    : li.description,
    quantity       : Number(li.quantity) || 1,
    value_amount   : toMoney(li.unit_value),
    currency_code  : valueCurrency.toUpperCase(),
    hs_tariff_code : li.hs_tariff_code || undefined,
    sku_code       : li.sku || undefined,
    origin_country : (li.origin_country || "").toUpperCase() || undefined
  }));

  // assemble refresh payload
  const payload = {
    package_type: "thick_envelope",
    // ensure API always knows the destination on refresh
    country_code: detectDestCountryCode(),
    ship_date           : normalizeShipDate(document.getElementById("cc_ship_date").value),
    insurance_requested : document.getElementById("cc_insurance_requested").value === "true",
    media_mail_requested: document.getElementById("cc_media_mail_requested").value === "true",
    signature_requested : document.getElementById("cc_signature_requested").value === "true",

    // nest customs for refresh
    customs: {
      package_contents: document.getElementById("cc_package_contents").value,
      description     : undefined,
      value           : toMoney(grandTotal),
      value_currency  : (valueCurrency || "").toUpperCase(),
      line_items
    }
  };

  const vatRef = sanitizeVatRef(document.getElementById("cc_customs_tax_reference_number")?.value);
  if (vatRef) payload.vat_reference = vatRef;

  // weight & dims (only if provided)
  if (Number.isFinite(weight) && weight > 0) {
    payload.weight = weight;
    payload.weight_unit = wUnit;
  }
  const anyDim = (sx > 0) || (sy > 0) || (sz > 0);
  if (anyDim) {
    payload.size_unit = sUnit;
    if (sx > 0) payload.size_x = sx;
    if (sy > 0) payload.size_y = sy;
    if (sz > 0) payload.size_z = sz;
  }

      return payload;
    }
function renderRates(s){
  // Accept a variety of API shapes: { shipment:{...} }, { rates:[...] }, { postage_types:[...] }, etc.
  const raw =
    (s && (s.rates ||
           s.postage_types ||
           s.available_rates ||
           s.postageTypes ||
           s.availableRates)) || [];

  // Normalize each rate into a single shape the UI expects
  const rates = raw.map(r => ({
    postage_type:  r.postage_type || r.code || r.postageType,
    service_name:  r.service_name || r.name || r.serviceName || r.postage_type || r.code,
    amount_num:    Number(r.payment_amount ?? r.rate ?? r.price ?? 0),
    days:          r.estimated_delivery_days ?? r.delivery_days ?? r.days ?? ""
  })).filter(r => r.postage_type);

  // Reset UI
  ratesList.innerHTML = "";
  selectedPostageType = null;
  btnBuy.disabled = true;

  // Helpful empty-state so it‚Äôs obvious something returned but had no options
  if (!rates.length){
    const li = document.createElement("li");
    li.innerHTML = `<div style="opacity:.8">No rates returned. Check destination, weight, ship date, and customs total.</div>`;
    ratesList.appendChild(li);
    return;
  }

  // Render options
  rates.forEach(r => {
    const li = document.createElement("li");
    li.dataset.postageType = r.postage_type;

    const left = document.createElement("div");
    left.innerHTML = `<div style="font-weight:600">${r.service_name}</div>
                      <div style="font-size:12px;opacity:.8">${r.days ? `${r.days} business days` : ""}</div>`;

    const right = document.createElement("div");
    right.innerHTML = `<div style="font-weight:700">$${r.amount_num.toFixed(2)}</div>`;

    li.appendChild(left);
    li.appendChild(right);

    li.addEventListener("click", () => {
      Array.from(ratesList.children).forEach(n => n.classList.remove("selected"));
      li.classList.add("selected");
      selectedPostageType = li.dataset.postageType;
      btnBuy.disabled = !selectedPostageType;
    });

    ratesList.appendChild(li);
  });
}

      async function refreshRates(){
        // Hard guard: never price while in Step 0/1
        if (window.ccBlockRatesUntilStep2 || (typeof currentStep === "number" && currentStep < 2)) {
          return;
        }
        // Defensive: never price before package step
        if (typeof currentStep === "number" && currentStep < 2) {
          return; // silently ignore any accidental early calls
        }

        let id = (idInput.value || "").trim();
        if (!id) {
          const created = await ensureShipment();
          id = (created?.id || idInput.value || "").trim();
          if (!id) { M.toast?.({ html: "Create the shipment first" }); return; }
        }
        const payload = buildRefreshPayload();
        // hard guard: weight must be present and > 0 for rates
        if (!(Number.isFinite(payload.weight) && payload.weight > 0)) {
          M.toast?.({ html: "Weight must be greater than 0 to refresh rates." });
          markMissing(2, ["cc_weight"]);
          return;
        }
        const out = await callCc("PATCH", { action: "refresh", shipment_id: id, payload });
        renderRates(out.shipment || out);
      }

      async function buySelected(){
        const id = (idInput.value || "").trim();
        if (!id || !selectedPostageType) return;
        btnBuy.disabled = true;
        try{
        // üîí Freeze any ccShipmentId-driven auto lookups after Buy
        window.ccPostBuyFrozen = true;
        window.ccMuteIdInput   = true;
         // 0) Open a print tab *now* to avoid popup blocking
         const printWin = openPrintStub();

         // 1) Buy the label
          await callCc("PATCH", { action:"buy", shipment_id:id, postage_type:selectedPostageType });

         // 2) Wait for Chit Chats to finish generating the label URL
          const url = await waitForLabelUrl(id, 30, 2000); // ~60s patience

          // 3) Auto-print (PDF or PNG) with robust fallback
          if (url) {
            await openAndAutoPrintLabel(url, printWin);
            M.toast?.({ html:"Label opened for printing." });
          } else {
          if (printWin && !printWin.closed) {
          try {
            printWin.document.body.innerHTML +=
              `<p style="font:14px/1.4 system-ui,Arial;margin-top:10px">
                 Still generating‚Ä¶ open from your Chit Chats dashboard if this doesn‚Äôt auto-print.
               </p>`;
          } catch {}
        }
        M.toast?.({ html:"Label purchased; still generating at Chit Chats." });
          }

         // 4) Populate Etsy "Complete Order" inputs (tracking + carrier) from the shipment we just bought
          try {
            const endpoint = (typeof getCcEndpoint === "function" ? getCcEndpoint() : "/.netlify/functions/testChitChats");
            const latest   = await fetch(`${endpoint}?resource=shipment&id=${encodeURIComponent(id)}`).then(r => r.json());
            const s        = latest.shipment || latest || {};
            const tn       = s.carrier_tracking_code || "";
            if (tn) {
              const tEl = document.getElementById("trackingNumberInput");
              if (tEl) tEl.value = tn;
            }
            // Carrier: USPS if destination is US; otherwise ChitChats
            const cs = document.getElementById("carrierSelect");
            if (cs) {
              const ccode  = String(s.to_country_code || s.country_code || s.country || "").toUpperCase();
              const target = (ccode === "US" || ccode.includes("UNITED STATES")) ? "usps" : "chitchats";
              cs.value = target;
              cs.dispatchEvent(new Event("change", { bubbles: true }));
              try {
                let inst = M.FormSelect.getInstance(cs);
                if (inst) inst.destroy();
                inst = M.FormSelect.init(cs);
                if (inst && inst.input) inst.input.value = (target === "usps" ? "USPS" : "ChitChats");
              } catch {}
            }
          } catch (e) {
            console.warn("post-buy autopopulate failed", e);
          }

        } catch(err){
          handleCcApiError?.(err);
        } finally {
          btnBuy.disabled = false;
        }
      }

      if (editBtn) editBtn.addEventListener("click", async () => {
        // Ensure Step-0 inputs are hydrated so the verify modal isn't blank
        try { window.collectRecipientAddress?.(); } catch {}

        // Keep the editor hidden until explicitly requested
        if (modal) modal.style.display = "none";

        const verifyEl = document.getElementById("ccVerifyModal");

        // Run Smarty + render RedOrange diffs in the Verify modal
        await verifyAddressAndShowModal();

        // Fallback: if verify didn't open (e.g., no country or API error), open editor wizard
        if (verifyEl && verifyEl.style.display !== "block") {
          modalOpen();
        }
      });

      btnClose.addEventListener("click", () => modalClose());
      btnBack .addEventListener("click", () => showStep(currentStep-1));

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       *  JS HELPERS (validation + toasts + address compare)
       * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

      // map API field names ‚Üí DOM ids
      const FIELD_MAP = {
        // step 0 - recipient
        to_name: "cc_to_name",
        value_currency          : "cc_value_currency",
        customs_tax_reference_number: "cc_customs_tax_reference_number",
        to_address_1: "cc_to_address_1",
        to_address_2: "cc_to_address_2",
        to_city: "cc_to_city",
        to_province_code: "cc_to_province_code",
        to_postal_code: "cc_to_postal_code",
        to_country_code: "cc_to_country_code",
        to_phone: "cc_to_phone",
        to_email: "cc_to_email",
        // step 1 - description
        description: "cc_item_description",
        quantity: "cc_item_qty",
        unit_value: "cc_item_unit_value",
        hs_tariff_code: "cc_item_hs_tariff_code",
        origin_country: "cc_item_origin_country",
        manufacture_country: "cc_item_manufacture_country",
        // step 2 - package
        package_type: "cc_package_type",
        size_unit: "cc_size_unit",
        weight_unit: "cc_weight_unit",
        size_x: "cc_size_x",
        size_y: "cc_size_y",
        size_z: "cc_size_z",
        weight: "cc_weight",
        ship_date: "cc_ship_date",
        insurance_requested: "cc_insurance_requested",
        signature_requested: "cc_signature_requested",
        media_mail_requested: "cc_media_mail_requested"
      };

       // Fallback selectors for the multi-tranche UI
       const CLASS_MAP = {
          description       : ".cc_item_description",
          quantity          : ".cc_item_qty",
          unit_value        : ".cc_item_unit_value",
          hs_tariff_code    : ".cc_item_hs_tariff_code",
          origin_country    : ".cc_item_origin_country",
          manufacture_country: ".cc_item_manufacture_country"
       };

      function getStepRoot(step){ return document.getElementById(`ccStep${step}`); }

      function clearMissing(step){
        const stepEl = document.getElementById("ccStep" + step);
        stepEl.querySelectorAll(".cc-field.cc-missing").forEach(f => {
          f.classList.remove("cc-missing");
        });
      }

      function markMissing(step, ids){
        const stepEl = document.getElementById("ccStep" + step);
        const seen = new Set();
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const field = el.closest(".cc-field");
          if (!field || seen.has(field)) return;
          field.classList.add("cc-missing");
          seen.add(field);
        });
        const first = stepEl.querySelector(".cc-field.cc-missing input, .cc-field.cc-missing select, .cc-field.cc-missing textarea");
        first?.focus();
      }

      async function validateStep(step){
        clearMissing(step);

        // üîí Steps 0‚Äì1 may talk to server (verify/create/replace). Steps ‚â•2: NO rate calls here.
        if (step <= 1) {
          const apiMissing = await ccValidateAgainstApi(step);
          if (apiMissing.length) return false;
        }

        // 2) Fallback to local minimal checks (keeps UX snappy offline)
        let req = [];
        if (step === 0) {
          req = ["cc_to_name","cc_to_address_1","cc_to_city","cc_to_province_code","cc_to_postal_code","cc_to_country_code"];
        } else if (step === 1) {
          // ‚úÖ New multi-line-item validation
          // 1) Gather items from the UI
          const lines = collectCcLineItems();
          // 2) Require at least one tranche
          if (!lines.length) {
            const cont  = document.getElementById("cc_line_items_container");
            const first = cont?.querySelector(".cc-line-item");
            if (first){
              first.querySelectorAll(".cc_item_description,.cc_item_qty,.cc_item_unit_value")
                   .forEach(el => el.closest(".cc-field")?.classList.add("cc-missing"));
              first.querySelector(".cc_item_description")?.focus();
            }
            return false;
          }
          // 3) Per-tranche minimal checks
          for (const node of document.querySelectorAll("#cc_line_items_container .cc-line-item")){
            const desc = node.querySelector(".cc_item_description")?.value.trim();
            const qty  = Number(node.querySelector(".cc_item_qty")?.value);
            const unit = Number(node.querySelector(".cc_item_unit_value")?.value);
            const ok = !!desc && isFinite(qty) && qty > 0 && isFinite(unit) && unit >= 0;
            if (!ok){
              node.querySelectorAll(".cc_item_description,.cc_item_qty,.cc_item_unit_value")
                  .forEach(el => el.closest(".cc-field")?.classList.add("cc-missing"));
              node.querySelector(".cc_item_description")?.focus();
              return false;
            }
          }
          // All good for Step 1
        } else if (step === 2) {

          // If we're about to create (no shipment id yet), require Step 0 fields first
          const hasValidId = /^[A-Za-z0-9_-]{8,}$/.test(
            (document.getElementById("ccShipmentId")?.value || "").trim()
          );
          if (!hasValidId) {
            const req0 = [
              "cc_to_name","cc_to_address_1","cc_to_city",
              "cc_to_province_code","cc_to_postal_code","cc_to_country_code"
            ];
            const miss0 = req0.filter(id => !String(document.getElementById(id)?.value || "").trim());
            if (miss0.length) {
              markMissing(0, miss0);
              M.toast?.({ html: "Recipient is incomplete ‚Äî please finish Step 0." });
              showStep(0);
              return false;
            }
          }

        // Require positive weight; dimensions optional but, if present, must be > 0
        const wEl  = document.getElementById("cc_weight");
        const wVal = Number(wEl?.value);
        if (!Number.isFinite(wVal) || wVal <= 0) {
          markMissing(step, ["cc_weight"]);
          return false;
        }
        const dimIds = ["cc_size_x","cc_size_y","cc_size_z"];
        const badDims = dimIds.filter(id => {
          const v = String(document.getElementById(id)?.value || "").trim();
          return v && !(Number(v) > 0);
        });
        if (badDims.length) { markMissing(step, badDims); return false; }
        // Keep currency required
        req = ["cc_value_currency"];
        }
        const missing = req.filter(id => !String(document.getElementById(id)?.value || "").trim());
        if (missing.length) {
          markMissing(step, missing);
          return false;
        }
        return true;
      }

      // Accepts handleCcApiError(err) or handleCcApiError(step, err)
      function handleCcApiError(stepOrErr, maybeErr){
        const err = (maybeErr && typeof maybeErr === "object") ? maybeErr : stepOrErr;
        const raw = err?.raw || {};
        const details = [];
        const fieldsObj = raw?.error?.fields || raw?.errors;
        if (fieldsObj && typeof fieldsObj === "object"){
          for (const k of Object.keys(fieldsObj)){
            const id = FIELD_MAP[k] || k;
            details.push(k);
            let el = document.getElementById(id);
            if (!el && CLASS_MAP[k]) {
              el = document.querySelector("#cc_line_items_container " + CLASS_MAP[k]);
            }
            if (el){ (el.closest(".cc-field") || el).style.border = "2px solid orangered"; }
          }
        } else if (Array.isArray(raw?.missing)){
          raw.missing.forEach(k=>{
            const id = FIELD_MAP[k] || k;
            details.push(k);
           let el = document.getElementById(id);
            if (!el && CLASS_MAP[k]) {
              el = document.querySelector("#cc_line_items_container " + CLASS_MAP[k]);
            }
            if (el){ (el.closest(".cc-field") || el).style.border = "2px solid orangered"; }
          });
        }
        const extra = details.length ? ` ‚Äî missing/invalid: ${details.join(", ")}` : "";
        // Fallback: message-only errors (e.g., "country_code required")
        if (!details.length) {
          const msg = String(err.message || "").toLowerCase();
          if (msg.includes("country_code") && msg.includes("required")) {
            details.push("to_country_code");
            markMissing(0, ["cc_to_country_code"]);
            showStep(0);
          }
        }
        M.toast?.({ html:`Chit Chats error: ${err.message}${extra}` });
      }

      function addressFromInputs(){
        return {
          to_name: document.getElementById("cc_to_name").value.trim(),
          to_address_1: document.getElementById("cc_to_address_1").value.trim(),
          to_address_2: document.getElementById("cc_to_address_2").value.trim(),
          to_city: document.getElementById("cc_to_city").value.trim(),
          to_province_code: document.getElementById("cc_to_province_code").value.trim(),
          to_postal_code: document.getElementById("cc_to_postal_code").value.trim(),
          to_country_code: document.getElementById("cc_to_country_code").value.trim().toUpperCase()
        };
      }
      // Normalize various API shapes ‚Üí our "to_*" keys
         function normalizeToAddressShape(raw){
  // Accept Chit Chats shapes: { to:{‚Ä¶} }, { address:{‚Ä¶} }, or flat
  const src = raw && typeof raw === "object" ? (raw.to || raw.address || raw) : {};
           const get = (...keys) => {
             for (const k of keys) {
               const v = src?.[k];
               if (v != null && String(v).trim() !== "") return String(v).trim();
             }
             return "";
           };
           const cc = (get("to_country_code","country_code","country","country_iso2") || "").toUpperCase();
           return {
             to_name          : get("to_name","name","recipient_name","full_name"),
             to_address_1     : get("to_address_1","address_1","address1","street1","line1","street"),
             to_address_2     : get("to_address_2","address_2","address2","street2","line2","unit","suite","apt","apartment","unit_number"),
             to_city          : get("to_city","city","locality","town"),
             to_province_code : get("to_province_code","province_code","state_code","state","province","region","administrative_area"),
             to_postal_code   : get("to_postal_code","postal_code","zip","zip_code","postcode"),
             to_country_code  : cc
           };
         }
      
      // Safe formatter (never prints "undefined")
      function fmtAddress(a){
        if (!a) return "";
        const name = a.to_name || "";
        const l1   = a.to_address_1 || "";
        const l2   = a.to_address_2 || "";
        const city = a.to_city || "";
        const prov = a.to_province_code || "";
        const pc   = a.to_postal_code || "";
        const cc   = (a.to_country_code || "").toUpperCase();
        const country = cc === "US" ? "United States" : cc === "CA" ? "Canada" : cc;
        const street   = [l1, l2].filter(Boolean).join("\n");
        const cityLine = city && prov ? `${city}, ${prov} ${pc}` : [city, prov, pc].filter(Boolean).join(" ");
        return [name, street, cityLine, country].filter(Boolean).join("\n");
      }
      function renderAddressDiff(orig, sugg){
        const oEl = document.getElementById("ccVerifyOriginal");
        const sEl = document.getElementById("ccVerifySuggested");
        if (!oEl || !sEl) return; // if overlay not present, silently skip
        function hi(base, compare){
          const bt = base.split(/(\s+)/), ct = compare.split(/(\s+)/);
          const out = [];
          for (let i=0;i<Math.max(bt.length,ct.length);i++){
            const b = bt[i] ?? "", c = ct[i] ?? "";
            out.push(b===c ? c : `<span class="cc-diff-add">${c}</span>`);
          }
          return out.join("");
        }
        oEl.innerHTML = fmtAddress(orig);
        sEl.innerHTML = hi(fmtAddress(orig), fmtAddress(sugg));
      }

     // helper to show the verify modal (normalize first)
     function openVerifyModal(orig, rawSugg){
      // make available across script blocks
      window.openVerifyModal = openVerifyModal;
       const sugg = normalizeToAddressShape(rawSugg);
       renderAddressDiff(orig, sugg);
      const modal = document.getElementById("ccVerifyModal");
      if (!modal) { M.toast?.({ html:"Address suggestion available ‚Äî verify modal not found." }); return false; }

      modal.style.display = "block";

      // kick off autofill immediately upon opening the verify modal
      try { autofillFromVerifyModal(); } catch (_) {}

      // buttons
      document.getElementById("ccVerifyClose").onclick = () => { modal.style.display = "none"; };
      document.getElementById("ccAddrEdit").onclick    = () => { modal.style.display = "none"; showStep(0); };

      // Keep Original ‚Üí still ensure Step 1 is ready-populated
      document.getElementById("ccKeepOriginal").onclick = () => {
        try { autofillFromVerifyModal(); } catch (_) {}
        modal.style.display = "none";
        showStep(1);
      };

      // Use Suggested ‚Üí populate recipient fields + ensure Step 1 prefilled
      document.getElementById("ccUseSuggested").onclick = () => {
        try { autofillFromVerifyModal(); } catch (_) {}

        const map = {
          to_name:"cc_to_name", to_address_1:"cc_to_address_1", to_address_2:"cc_to_address_2",
          to_city:"cc_to_city", to_province_code:"cc_to_province_code",
          to_postal_code:"cc_to_postal_code", to_country_code:"cc_to_country_code"
        };
        Object.keys(map).forEach(k => {
          const v = sugg && sugg[k];
          if (v != null) document.getElementById(map[k]).value = v;
        });
        modal.style.display = "none";
        showStep(1);
      };

      return true;
    }

    // expose globally for other script blocks
    window.openVerifyModal = openVerifyModal;

    /* === Helper: pull "Title:" line from the Order Details box === */
    function extractOrderTitle() {
      try {
        const ta = document.getElementById("orderDetails");
        const raw = (ta?.value || ta?.innerText || "");
        const line = raw.split("\n").find(l => /^ *Title:\s*/i.test(l));
        if (line) return line.replace(/^ *Title:\s*/i, "").trim();
        // fallback to first item title if needed
        if (Array.isArray(window.cachedOrderItems) && window.cachedOrderItems.length) {
          const t = String(window.cachedOrderItems[0]?.title || "");
          return t.split(" ").slice(0, 12).join(" ").trim();
        }
      } catch {}
      return "";
    }

    async function autofillFromVerifyModal() {
    const set = (id, v) => {
      const el = document.getElementById(id);
      if (el) el.value = String(v);
    };

    // (A) Description from Order Details ‚Üí Title:
    const title = (typeof extractOrderTitle === "function") ? extractOrderTitle() : "";
    if (title) set("cc_item_description", title.slice(0, 95));  // safe length for CC field

    // (B) Static defaults (API prefers ISO codes where applicable)
    set("cc_item_origin_country",             "CA");            // Canada
    set("cc_item_hs_tariff_code",             "7113.19.5091");
    set("cc_item_manufacture_country",        "CA");            // Canada
    set("cc_item_manufacturer_contact",       "Brites Jewelry Inc.");
    set("cc_item_manufacturer_street",        "450 Matheson Blvd, East");
    set("cc_item_manufacturer_city",          "Mississauga");
    set("cc_item_manufacturer_province_code", "ON");            // Ontario
    set("cc_item_manufacturer_postal_code",   "L4Z-1R5");
    set("cc_item_manufacturer_phone",         "416-606-2476");
    set("cc_item_manufacturer_email",         "michelle@custombrites.com");

    // (C) Qty + Unit Value from Chit Chats API (shipment ‚Üí first customs line)
    try {
      const sid = (document.getElementById("ccShipmentId")?.value || "").trim();
      let detail = null;

      if (sid) {
        const r = await fetch("/.netlify/functions/testChitChats?resource=shipment&id=" + encodeURIComponent(sid));
        if (r.ok) detail = await r.json();
      } else {
        // fallback: try by visible order number (fast mode)
        const orderNo = (document.getElementById("titleOrderNumber")?.innerText || "").trim();
        if (orderNo) {
          const r = await fetch("/.netlify/functions/testChitChats?resource=search&orderId=" + encodeURIComponent(orderNo) + "&fast=1&pendingOnly=0");
          if (r.ok) {
            const js = await r.json();
            detail = (js.shipments && js.shipments[0]) || null;
          }
        }
      }

      if (detail) {
        const customs = detail?.customs || detail?.line_items || detail?.items || detail?.customs_items;
        const first =
          (Array.isArray(customs?.items) ? customs.items[0] :
           Array.isArray(customs)         ? customs[0] :
           customs) || null;

        const qty  = Number(first?.quantity ?? first?.qty ?? detail?.items_count ?? 1);
        const uval = Number(first?.unit_value ?? first?.value ?? 0);

        if (!Number.isNaN(qty))  fillOnce("cc_item_qty", qty);
        if (!Number.isNaN(uval)) fillOnce("cc_item_unit_value", uval);
      }

       // D) Customs tax reference number (IOSS / VAT / EORI) if API provides it
          const taxRef =
            detail?.customs_tax_reference_number ??
            detail?.tax_reference_number ??
            detail?.ioss_number ?? detail?.ioss ??
            detail?.vat_number  ?? detail?.vat  ??
            detail?.eori_number ?? detail?.eori ?? null;
          if (taxRef) set("cc_customs_tax_reference_number", String(taxRef));

    } catch (_) {}
  }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Smarty: client proxy caller ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function verifyWithSmarty(to){
        try{
          const r = await fetch("/.netlify/functions/smartyVerify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ to })
          });
          const out = await r.json();
          // Normalize shape: { suggested: {to_*}, raw: {...} }
          return out && out.suggested ? out.suggested : null;
        }catch(err){
          console.warn("[Smarty]", err);
          return null;
        }
      }

     // Choose the correct "orig" address source: prefer Chit Chats shipment ‚Üí fallback to inputs
      async function pickOrigAddress(){
        const id = (document.getElementById("ccShipmentId")?.value || "").trim();
        // Start from whatever is currently in the inputs (seeded from Ship To)
        let orig = (window.collectRecipientAddress || collectRecipientAddress || gatherRecipientFromInputs)();
        if (id) {
          try {
            const det = await callCc("GET", null, `?resource=shipment&id=${encodeURIComponent(id)}`);
            const fromCc = normalizeToAddressShape(det?.to || det?.recipient || det?.ship_to || det?.address || det);
            if (fromCc && (fromCc.to_address_1 || fromCc.to_city || fromCc.to_postal_code)) {
              // Reflect CC address into the form so everything stays in sync
              const map = {
                to_name:"cc_to_name", to_address_1:"cc_to_address_1", to_address_2:"cc_to_address_2",
                to_city:"cc_to_city", to_province_code:"cc_to_province_code",
                to_postal_code:"cc_to_postal_code", to_country_code:"cc_to_country_code"
              };
              Object.keys(map).forEach(k => {
                const v = fromCc[k]; if (v != null) document.getElementById(map[k]).value = v;
              });
              orig = fromCc;
            }
          } catch(e){ try{ console.debug("[Verify] CC shipment fetch failed", e);}catch{} }
        }
        return orig;
      }

     async function maybeVerifyAddressBeforeStep1(force = false){
       const log  = (...a)=>{ try{ console.debug("[Verify]", ...a);}catch{} };
       const orig = await pickOrigAddress(); // prefer CC's own shipment address

       // Try Smarty (US only); otherwise fall back to carrier verify.
       let sugg = null;
       const cc = (orig.to_country_code || "").toUpperCase();
       try{
         if (cc === "US") {
           M.toast?.({ html: "Verifying address with Smarty‚Ä¶" });
           log("Smarty request", orig);
           const smartySugg = await verifyWithSmarty(orig);
           log("Smarty suggested", smartySugg);
           sugg = smartySugg ? normalizeToAddressShape(smartySugg) : null;
         }
       } catch(e) { log("Smarty verify failed", e); }

       // Always try Chit Chats normalization as a secondary signal
       if (!sugg){
         try{
           M.toast?.({ html: "Checking carrier verification‚Ä¶" });
           const toForApi = {
            name:           orig.to_name,
            address_1:      orig.to_address_1,
            address_2:      orig.to_address_2,
            city:           orig.to_city,
            province_code:  orig.to_province_code,
            postal_code:    orig.to_postal_code,
            country_code:   (orig.to_country_code || "").toUpperCase(),
            email:          orig.to_email,
            phone:          orig.to_phone
          };
          const out = await callCc("POST", { action: "verify_to", to: toForApi });
           const raw = (out?.suggested ?? out?.normalized ?? out?.address ?? null);
           sugg = raw ? normalizeToAddressShape(raw) : null;
         }catch(e){ log("Carrier verify failed", e); }
       }

       // Always show the compare modal (even if verified / no changes / no suggestion)
       const finalSugg = sugg || orig;
       log("opening compare modal", { orig, finalSugg });
       openVerifyModal(orig, finalSugg);
       return true;
     }

     /* ===== Customs Tax Reference Auto-Fill ================================
     Rules:
     - GB / UK ‚Üí "UK VAT 370600428"
     - Any EU destination (27 members) except GB ‚Üí "IM3720000224"
     - Else ‚Üí empty
     ------------------------------------------------------------------- */
    (function(){
      const EU_CODES = new Set([
        "AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR",
        "HU","IE","IT","LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE"
      ]);

      // Common country name ‚Üí ISO2 mappings (helps when parsing freeform address lines)
      const NAME_TO_CODE = {
        // UK / GB
        "united kingdom":"GB","great britain":"GB","england":"GB","scotland":"GB",
        "wales":"GB","northern ireland":"GB","uk":"GB",

        // EU (27)
        "austria":"AT","belgium":"BE","bulgaria":"BG","croatia":"HR","cyprus":"CY",
        "czech republic":"CZ","czechia":"CZ","denmark":"DK","estonia":"EE","finland":"FI",
        "france":"FR","germany":"DE","deutschland":"DE","greece":"GR","hellenic republic":"GR",
        "hungary":"HU","ireland":"IE","republic of ireland":"IE","italy":"IT","latvia":"LV",
        "lithuania":"LT","luxembourg":"LU","malta":"MT","netherlands":"NL","the netherlands":"NL",
        "nederland":"NL","poland":"PL","portugal":"PT","romania":"RO","slovakia":"SK",
        "slovenia":"SI","spain":"ES","espa√±a":"ES","sweden":"SE"
      };

      function countryFromFreeform(text){
        if (!text) return "";
        const lower = text.toLowerCase();

        // Name contains (robust)
        for (const [name, code] of Object.entries(NAME_TO_CODE)) {
          if (lower.includes(name)) return code;
        }

        // Scan from last non-empty line for 2-letter tokens that look like ISO codes
        const lines = lower.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        for (let i = lines.length - 1; i >= 0; i--) {
          const tokens = lines[i].toUpperCase().match(/\b[A-Z]{2}\b/g);
          if (tokens) {
            for (let t of tokens) {
              if (t === "UK") t = "GB";          // normalize
              if (/^[A-Z]{2}$/.test(t)) return t;
            }
          }
        }
        return "";
      }

      function detectDestCountryCode(){
        const codeField = document.getElementById("cc_to_country_code");
        let code = (codeField?.value || "").trim().toUpperCase();
        if (code === "UK") code = "GB";
        if (/^[A-Z]{2}$/.test(code)) return code;

        const addr = document.getElementById("shipAddressBox")?.value || "";
        return countryFromFreeform(addr);
      }

      function isEU(code){ return EU_CODES.has(code); }

      function autoFillCustomsTaxRef(){
        const input = document.getElementById("cc_customs_tax_reference_number");
          const dest   = detectDestCountryCode();           // ‚Üê fixes "dest is not defined"
          const isUS   = (dest === "US" || dest === "USA" || dest === "UNITED STATES");
          const euLike = isEU(dest);
          const el = (id) => document.getElementById(id);
        if (!input) return;

        if (dest === "GB") {
          // Use GB-prefixed value; sanitizeVatRef will keep only A‚ÄìZ0‚Äì9 ‚Üí "GB370600428"
          input.value = "GB370600428";
        } else if (isEU(dest)) {
          // IOSS (EU): sanitizeVatRef keeps "IM3720000224"
          input.value = "IM3720000224";
        } else {
          input.value = "";
        }
      }

// ISO2 lookup for common names ‚Üí code (minimal; expand as needed)
const COUNTRY_TO_ISO2 = {
  "italy":"IT","italia":"IT","united states":"US","usa":"US","canada":"CA","france":"FR","germany":"DE","spain":"ES"
};

 // UK + EU country codes (plus crown deps aliases)
 const EU_UK_CODES = new Set([
   "AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IE","IT","LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE",
   "GB","UK","IM","JE","GG"
 ]);

  // Accept only real region codes/names; drop 1‚Äì2 letter junk like "As" unless whitelisted.
  function sanitizeProvinceForCountry(raw, country){
    const s = String(raw || "").trim();
    if (!s) return "";

   const cc = String(country || "").toUpperCase();
   // üîí For all UK + EU orders, we never keep a province/state
   if (EU_UK_CODES.has(cc)) return "";

  const US = new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC","PR"]);
  const CA = new Set(["AB","BC","MB","NB","NL","NS","NT","NU","ON","PE","QC","SK","YT"]);
  const AU = new Set(["ACT","NSW","NT","QLD","SA","TAS","VIC","WA"]);

  const up = s.toUpperCase();
  if (country === "US") return US.has(up) ? up : "";
  if (country === "CA") return CA.has(up) ? up : "";
  if (country === "AU") return AU.has(up) ? up : (s.length >= 3 ? s : "");

  // Everyone else: require ‚â•3 letters to look like a real region name
  return /[A-Za-z]{3,}/.test(s) ? s : "";
}

// Robust, locale-agnostic parser for pasted multi-line addresses
function parseIntlAddressBlock(blockText = "", fallbackCountryCode = "") {
  const lines = String(blockText)
    .replace(/\r/g,"")
    .split("\n")
    // strip NBSPs, trim, then remove a leading "SHIP TO:" label if present on any line
    .map(s => s.replace(/\u00A0/g," ").trim().replace(/^ship\s*to\s*:\s*/i, ""))
    // drop any leftover empty lines or a line that was just "SHIP TO:"
    .filter(s => s && !/^\s*ship\s*to\s*:?\s*$/i.test(s));

  if (!lines.length) return {};

  // 1) COUNTRY: prefer last non-empty line
  let rawCountry = (lines[lines.length - 1] || "").trim();
  let to_country_code = "";

  if (/^[A-Za-z]{2}$/.test(rawCountry)) {
    to_country_code = rawCountry.toUpperCase();
  } else {
    const key = rawCountry.toLowerCase();
    to_country_code = COUNTRY_TO_ISO2[key] || "";
  }
  if (!to_country_code && fallbackCountryCode) {
    to_country_code = String(fallbackCountryCode).trim().toUpperCase();
  }

  // 2) NAME: if first line has no digits & ‚â•2 words, treat as name
  const first = lines[0] || "";
  const to_name = (/\S+\s+\S+/.test(first) && !/\d/.test(first)) ? first : "";

  // Maintain a cursor after name
  let idx = (to_name ? 1 : 0);

  // 3) STREET: next line is almost always the street
  let to_address_1 = lines[idx++] || "";
  let to_address_2 = "";

  // 4) CITY / PROVINCE: try to split a comma line e.g. "Cesenatico, FORL√å-CESENA"
  let to_city = "", to_province_code = "";
  let to_postal_code = ""; // moved up to avoid TDZ (assigned earlier if found on same line)
  if (idx < lines.length) {
    const cityProv = lines[idx] || "";
    const m = cityProv.match(/^(.+?)[,\s]+(.+)$/u);
    if (m) {
       to_city = m[1].trim();
       const right = m[2].trim();
       // pull ZIP if it trails after province/region on the same line
       // Only match real ZIPs: 4‚Äì6 digits OR UK/CA formats (AB1 2CD, A1A1A1, etc.)
       const mZipOnRight = right.match(/\b\d{4,6}\b|\b(?:[A-Z]\d[A-Z]\s?\d[A-Z]\d|[A-Z]{1,3}\d[A-Z\d]?\s?\d[A-Z]{2})\b/i);
       if (mZipOnRight) {
         to_postal_code = mZipOnRight[0].toUpperCase();
         to_province_code = right.replace(mZipOnRight[0], "").replace(/[, ]+$/,"").trim();
       } else {
         to_province_code = right;
       }
       idx++;
     } else {
      // If no comma, assume it's the city line
      to_city = cityProv.trim();
      idx++;
    }
  }

  // 5) POSTAL (+ province if they share a line, e.g. "VIZCAYA 48007" or "48007 VIZCAYA")
  for (let j = idx; j < lines.length; j++) {
    const raw = (lines[j] || "").trim().replace(/[.,;]+$/,"");
    // A) numeric 4‚Äì6 digits ‚Üí postal; leftover letters ‚Üí province
    const mNum = raw.match(/\b\d{4,6}\b/);
    if (mNum) {
      to_postal_code = mNum[0].toUpperCase();
      if (!to_province_code) {
        const prov = raw.replace(mNum[0], "").replace(/[-,]/g," ").replace(/\s{2,}/g," ").trim();
        if (/[A-Za-z]{3,}/.test(prov)) to_province_code = prov.toUpperCase();
      }
      break;
    }
    // B) UK/CA alphanumeric formats
    const mAlpha = raw.match(/\b(?:[A-Z]\d[A-Z]\s?\d[A-Z]\d|[A-Z]{1,3}\d[A-Z\d]?\s?\d[A-Z]{2})\b/i);
    if (mAlpha) {
      to_postal_code = mAlpha[0].toUpperCase();
      if (!to_province_code) {
        const prov = raw.replace(mAlpha[0], "").replace(/[-,]/g," ").replace(/\s{2,}/g," ").trim();
        if (/[A-Za-z]{3,}/.test(prov)) to_province_code = prov.toUpperCase();
      }
      break;
    }
  }

  // 5b) Repair case: if Postal looks like "<Province> <12345>" or "<12345> <Province>", split it.
  if (!to_province_code && to_postal_code && /\d/.test(to_postal_code) && /[A-Za-z]/.test(to_postal_code)) {
    let m = to_postal_code.match(/^([A-Za-z][A-Za-z\s\-]{2,})\s+(\d{4,6})$/);
    if (m) { to_province_code = m[1].trim().toUpperCase(); to_postal_code = m[2]; }
    else {
      m = to_postal_code.match(/^(\d{4,6})\s+([A-Za-z][A-Za-z\s\-]{2,})$/);
      if (m) { to_province_code = m[2].trim().toUpperCase(); to_postal_code = m[1]; }
    }
  }

  // Cleanups: collapse double spaces, tolerate diacritics
  const clean = (s)=>s.replace(/\s{2,}/g," ").trim();
  // ‚úÖ Final guard: zero province for UK/EU, and sanitize everywhere else
  to_province_code = sanitizeProvinceForCountry(to_province_code, to_country_code);

  return {
    to_name: clean(to_name),
    to_address_1: clean(to_address_1),
    to_address_2: clean(to_address_2),
    to_city: clean(to_city),
    to_province_code: EU_UK_CODES.has(to_country_code) ? "" : clean(to_province_code),
    to_postal_code: clean(to_postal_code),
    to_country_code: to_country_code || ""
  };
}

  // Choose block vs inputs; always pass a fallback country from the field
  function gatherRecipientFromInputs(){
    const v = id => (document.getElementById(id)?.value || "").trim();
    return {
      to_name         : v("cc_to_name"),
      to_address_1    : v("cc_to_address_1"),
      to_address_2    : v("cc_to_address_2"),
      to_city         : v("cc_to_city"),
      to_province_code: v("cc_to_province_code"),
      to_postal_code  : v("cc_to_postal_code"),
      to_country_code : v("cc_to_country_code").toUpperCase()
    };
  }

  // ‚ñº Define the missing helper (global scope)
  function collectRecipientAddress(){
    const block   = (document.getElementById("shipAddressBox")?.value || "").trim();
    const country = (document.getElementById("cc_to_country_code")?.value || "").trim();

    // Prefer a real multi-line block; otherwise just use the inputs
    if (block.split("\n").length >= 2) {
      const parsed = parseIntlAddressBlock(block, country);   // already in your file
      const fields = gatherRecipientFromInputs();

      // Merge parsed with field fallbacks + normalize country
      const to = {
        to_name         : parsed.to_name          || fields.to_name,
        to_address_1    : parsed.to_address_1     || fields.to_address_1,
        to_address_2    : parsed.to_address_2     || fields.to_address_2,
        to_city         : parsed.to_city          || fields.to_city,
        to_province_code: parsed.to_province_code || fields.to_province_code,
        to_postal_code  : parsed.to_postal_code   || fields.to_postal_code,
        to_country_code : (parsed.to_country_code || fields.to_country_code || "").toUpperCase()
      };

     // Belt & suspenders: if UK/EU, force province empty before using anywhere else
     if (EU_UK_CODES.has(to.to_country_code)) to.to_province_code = "";

      // Hydrate Step-0 inputs so the compare modal never shows blanks
      const set = (id, v)=>{ const el=document.getElementById(id); if(el && v) el.value=v; };
      set("cc_to_name", to.to_name);
      set("cc_to_address_1", to.to_address_1);
      set("cc_to_address_2", to.to_address_2);
      set("cc_to_city", to.to_city);
      set("cc_to_province_code", to.to_province_code);
      set("cc_to_postal_code", to.to_postal_code);
      set("cc_to_country_code", to.to_country_code);

      return to;
    }

    // Fallback: just the inputs
    return gatherRecipientFromInputs();
  }

      // expose globally for handlers defined in other scopes/blocks
      window.collectRecipientAddress = collectRecipientAddress;

      async function verifyAddressAndShowModal(){
        const to = collectRecipientAddress();
        if (!to.to_country_code) return; // nothing to do without country

        const resp = await fetch("/.netlify/functions/smartyVerify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ to })
        });
        if (!resp.ok) {
          console.warn("Smarty verify failed:", resp.status);
          return;
        }
        const { suggested } = await resp.json();

      // Use the same diff-rendering flow as the newer path
      openVerifyModal(to, suggested || to);

      }

      // make available across script blocks
      window.verifyAddressAndShowModal = verifyAddressAndShowModal;

      // Wire the Step-0 "Next" button to run verification once before moving on
      document.getElementById("ccNext")?.addEventListener("click", async (e)=>{
        // Only trigger while on the Recipient step (Step 0)
        const onRecipient = document.getElementById("ccStep0")?.classList.contains("active");
        if (onRecipient) {
          e.preventDefault();
          await window.verifyAddressAndShowModal();
        }
      });

      // Modal action buttons keep your original vs suggested choice
      document.getElementById("ccKeepOriginal")?.addEventListener("click", ()=>{
        document.getElementById("ccVerifyModal").style.display = "none";
      });

      document.getElementById("ccUseSuggested")?.addEventListener("click", ()=>{
        const s = window.__lastVerifySuggested;
        if (s) {
          // Push suggestion back into Step-0 inputs
          const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ""; };
          set("cc_to_name",           s.to_name);
          set("cc_to_address_1",      s.to_address_1);
          set("cc_to_address_2",      s.to_address_2);
          set("cc_to_city",           s.to_city);
          set("cc_to_province_code",  s.to_province_code);
          set("cc_to_postal_code",    s.to_postal_code);
          set("cc_to_country_code",   s.to_country_code);
        }
        document.getElementById("ccVerifyModal").style.display = "none";
      });



      // --- Wiring: react to user edits and modal use, plus light polling for programmatic updates
      // Guard so one failure never blocks other listeners
      const safeAutoFill = () => {
        try { autoFillCustomsTaxRef(); }
        catch (e) { console.warn("autoFillCustomsTaxRef failed:", e); }
      };
        function wireCustomsAutoFill(){
        // Fire on country edits and when opening the Edit Shipment modal
        document.getElementById("cc_to_country_code")?.addEventListener("input",  safeAutoFill);
        document.getElementById("cc_to_country_code")?.addEventListener("change", safeAutoFill);
        document.getElementById("shipAddressBox")    ?.addEventListener("input",  safeAutoFill);
        document.getElementById("ccEditBtn")         ?.addEventListener("click",  () => setTimeout(safeAutoFill, 0));

        // In case values are set programmatically (no input/change fired), do a cheap snapshot poll.
        let lastSig = "";
        setInterval(() => {
          const a = document.getElementById("shipAddressBox")?.value || "";
          const c = document.getElementById("cc_to_country_code")?.value || "";
          const sig = a + " | " + c;
          if (sig !== lastSig) {
            lastSig = sig;
            safeAutoFill();
          }
        }, 1200);

        // Initial attempt on page ready
        safeAutoFill();
      }

      document.addEventListener('DOMContentLoaded', wireCustomsAutoFill);
      // Expose helpers used by Step 2 refresh/build payload
      window.detectDestCountryCode = detectDestCountryCode;
      window.isEU = isEU; // (optional, keeps parity)
        })();

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

      // Helper: inline button spinner toggler
      function setBtnLoading(btn, on){
        if (!btn) return;
        btn.disabled = !!on;
        let sp = btn.querySelector(".cc-spinner");
        if (!sp){
          sp = document.createElement("span");
          sp.className = "cc-spinner";
          sp.setAttribute("aria-hidden","true");
          btn.appendChild(sp);
        }
        sp.style.display = on ? "inline-block" : "none";
      }

      btnNext.addEventListener("click", async () => {
        try {
          if (currentStep === 0){
            setBtnLoading(btnNext, true);
            if (!(await validateStep(0))) { setBtnLoading(btnNext, false); return; }
            const shown = await maybeVerifyAddressBeforeStep1();
            setBtnLoading(btnNext, false);
            if (shown) return;
            showStep(1);
            return;
          }

          // ‚úÖ Step 1: validate only ‚Äî NO pricing
              if (currentStep === 1){
                setBtnLoading(btnNext, true);
                try {
                  if (!(await validateStep(1))) return;
                  showStep(2);
                } finally { setBtnLoading(btnNext, false); }
                return;
              }

              // ‚úÖ Step 2: price, then move to Step 3
              if (currentStep === 2){
                setBtnLoading(btnNext, true);
                try {
                  if (!(await validateStep(2))) return;
                  await ensureShipment();
                  const idInput = document.getElementById("ccShipmentId");
                  const id = (idInput?.value || "").trim();
                  if (!id) { M.toast?.({ html: "Could not create shipment ‚Äî check Recipient & Description." }); return; }
                  await refreshRates();    // ‚Üê pricing happens here only
                  showStep(3);
                } finally { setBtnLoading(btnNext, false); }
                return;
              }
            } catch (err) {
              setBtnLoading(btnNext, false);
              handleCcApiError(err);
            }
          });

      btnRefresh.addEventListener("click", async () => {
        try{
          if (!(await validateStep(2))) return;
          await ensureShipment();
          await refreshRates();
        }catch(err){
          handleCcApiError(err);
        }
      });
     // Wrap Buy with spinner while purchasing + fetching label via proxy
      document.getElementById("ccBuy")?.addEventListener("click", async (e) => {
        const btn = e.currentTarget;
        try {
          setBtnLoading(btn, true);
          await buyCcThenPrint();
        } catch (err) {
          handleCcApiError(err);
        } finally {
          setBtnLoading(btn, false);
        }
      });

    })();

  </script>

  <!-- helper: force every upload to use resumable PUT -->
  <script type="module">
    /* modular imports */
    import {
      initializeApp,
      getApp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getStorage,
      ref,
      uploadBytesResumable
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import { getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import {
      getAuth,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    /* reuse the compat-initialised config */
    let modApp;
    try {
      modApp = getApp();                       // already exists? (unlikely)
    } catch {
      // pull the options off the compat app & spin a modular twin
      const compatOpts = firebase.app().options;
      modApp = initializeApp(compatOpts);
    }

    const storage = getStorage(modApp);        // OK ‚Äì default app now present
    const auth   = getAuth(modApp);
    signInAnonymously(auth).catch(console.error);

    /* expose a single resumable uploader */
    window.uploadViaResumable = async (path, file) => {
      const storageRef = ref(storage, path);
      const task       = uploadBytesResumable(
        storageRef,
        file,
        { contentType: file.type }
      );

      await new Promise((res, rej) =>
        task.on("state_changed", null, rej, res)
      );
      return await getDownloadURL(storageRef);
    };
  </script>

  
  <!-- üÜï hard-hide unused fields -->
  <style id="hideUnusedFields">
  #labelCreationDate,
  #completedByEmployee { display:none !important; }
  </style>

<!-- FINAL chat-bubble override: placed last so nothing beats it -->
<style id="chatSpacingOverride">
  /* base bubble */
  .msg{
    display:flex !important;
    flex-direction:column !important;
    row-gap:0 !important;               /* no extra flex gap             */
    padding:2px 12px 4px !important;    /* top 2 ‚Ä¢ lr 12 ‚Ä¢ bottom 4       */
    margin:5px 0   !important;          /* bubble-to-bubble spacing       */
    max-width:75%;
    border-radius:7px !important;
    color:#fff !important;
    font-size:0.85em;
  }

  /* tighten date-stamp ‚Üî text, keep within bubble */
  .msg .meta{
    margin:4px 0 1px 0 !important;        /* bottom 1 px only               */
    line-height:1   !important;         /* compact line box               */
  }

  /* wrap long text nicely */
  .msg > span:not(.meta){
    white-space:pre-wrap !important;
    word-break:break-word !important;
    overflow-wrap:anywhere !important;
  }

  /* RIGHT-justified (staff) bubble */
  .msg.sent{
    background:#797d7f !important;
    margin-left:auto  !important;       /* push to right edge             */
    text-align:right  !important;
    align-items:flex-end !important;    /* children follow right edge     */
  }
  .msg.sent .meta{
    font-size:0.65em !important;
    color:rgba(255,255,255,0.6) !important;
  }

  /* LEFT-justified (customer) bubble */
  .msg.received{
    background:#5dade2 !important;
    margin-right:auto !important;       /* push to left edge              */
    text-align:left   !important;
    align-items:flex-start !important;  /* children follow left edge      */
  }
  .msg.received .meta{
    font-size:0.65em !important;
    color:rgba(255,255,255,0.8) !important;
  }

  /* disable live controls */
  body.configOpen #screenOne select{ pointer-events:none !important; }
  body.configOpen #screenOne select,
  body.configOpen #screenOne button{ pointer-events:none !important;
  }

  /* re-enable inside modal */
  body.configOpen #configModal select{ pointer-events:auto !important; }
  body.configOpen #configModal select,
  body.configOpen #configModal button{
    pointer-events:auto !important;
  }

  /* allow dragging the Carrier dropdown while Config is open */
  body.configOpen #carrierSelect{ pointer-events:auto !important; }

</style>
<!-- QZ Tray client for direct printing -->
<script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.5/qz-tray.js"></script>

</body>
</html>