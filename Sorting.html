<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sorting Grid of 35</title>

  <!-- Materialize CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  />

  <style>
    body {
      background-color: #fff;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0; /* for a fade-in effect */
      transition: opacity 0s;
    }

    /* Buttons */
    #testEtsyBtn,
    #testOpenAIBtn,
    #openConfigBtn {
      position: absolute;
      left: 20px;
      width: 140px;
      height: 36px;
    }
    #testEtsyBtn {
      top: 20px;
    }
    #testOpenAIBtn {
      top: 70px;
    }
    #openConfigBtn {
      top: 120px;
    }

    /* Etsy Order Number input */
    #etsyOrderNumber {
      position: absolute;
      left: 20px;
      top: 170px;
      width: 200px;
      height: 30px;
      border: 1px solid #999;
      padding: 4px;
      outline: none;
      font-size: 0.9em;
    }

    /* The 35-box grid */
    #photoGridContainer {
      position: absolute;
      left: 250px;
      top: 20px;

      /* 5 columns x 7 rows = 35 boxes */
      display: grid;
      grid-template-columns: repeat(5, 66px);
      grid-template-rows: repeat(7, auto);
      gap: 10px;
    }

    .grid-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .preview-box {
      width: 66px;
      height: 66px;
      border: 1px solid #000;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      user-select: none;
      position: relative;
      font-size: 0.7em;
      text-align: center;
    }

    .preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform-origin: center center;
      transition: transform 0.2s ease;
    }

    .quantity-label,
    .title-label {
      font-size: 0.7em;
      margin-top: 3px;
      text-align: center;
      width: 66px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    /* Configuration Modal styling */
    #configModal.modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      height: auto !important;
      max-height: 70vh !important;
      width: auto !important;
      max-width: 650px !important;
      overflow-y: auto !important;
    }

    #configTable thead tr th {
      font-size: 0.9em;
    }
    #configTable tbody tr td {
      font-size: 0.8em;
    }
  </style>
</head>

<body>
  <!-- Buttons to test connectivity and open the position-config modal -->
  <button id="testEtsyBtn" class="btn waves-effect waves-light">Test Etsy</button>
  <button id="testOpenAIBtn" class="btn waves-effect waves-light">Test OpenAI</button>
  <button id="openConfigBtn" class="btn waves-effect waves-light">Open Config</button>

  <!-- Etsy Order Number input -->
  <input type="text" id="etsyOrderNumber" placeholder="Etsy Order Number" />

  <!-- 35-Image Grid -->
  <div id="photoGridContainer">
    <!-- We'll create 35 .grid-cell elements. 
         Each cell has: 
         - A .preview-box for the image
         - A .quantity-label for the quantity
         - A .title-label for the first 4 words. 
    -->
    <!-- For i=0 to 34 -->
    <div class="grid-cell">
      <div class="preview-box" id="previewCell0">Empty</div>
      <div class="quantity-label" id="quantityCell0"></div>
      <div class="title-label" id="titleCell0"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell1">Empty</div>
      <div class="quantity-label" id="quantityCell1"></div>
      <div class="title-label" id="titleCell1"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell2">Empty</div>
      <div class="quantity-label" id="quantityCell2"></div>
      <div class="title-label" id="titleCell2"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell3">Empty</div>
      <div class="quantity-label" id="quantityCell3"></div>
      <div class="title-label" id="titleCell3"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell4">Empty</div>
      <div class="quantity-label" id="quantityCell4"></div>
      <div class="title-label" id="titleCell4"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell5">Empty</div>
      <div class="quantity-label" id="quantityCell5"></div>
      <div class="title-label" id="titleCell5"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell6">Empty</div>
      <div class="quantity-label" id="quantityCell6"></div>
      <div class="title-label" id="titleCell6"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell7">Empty</div>
      <div class="quantity-label" id="quantityCell7"></div>
      <div class="title-label" id="titleCell7"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell8">Empty</div>
      <div class="quantity-label" id="quantityCell8"></div>
      <div class="title-label" id="titleCell8"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell9">Empty</div>
      <div class="quantity-label" id="quantityCell9"></div>
      <div class="title-label" id="titleCell9"></div>
    </div>
    
    <div class="grid-cell">
      <div class="preview-box" id="previewCell10">Empty</div>
      <div class="quantity-label" id="quantityCell10"></div>
      <div class="title-label" id="titleCell10"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell11">Empty</div>
      <div class="quantity-label" id="quantityCell11"></div>
      <div class="title-label" id="titleCell11"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell12">Empty</div>
      <div class="quantity-label" id="quantityCell12"></div>
      <div class="title-label" id="titleCell12"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell13">Empty</div>
      <div class="quantity-label" id="quantityCell13"></div>
      <div class="title-label" id="titleCell13"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell14">Empty</div>
      <div class="quantity-label" id="quantityCell14"></div>
      <div class="title-label" id="titleCell14"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell15">Empty</div>
      <div class="quantity-label" id="quantityCell15"></div>
      <div class="title-label" id="titleCell15"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell16">Empty</div>
      <div class="quantity-label" id="quantityCell16"></div>
      <div class="title-label" id="titleCell16"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell17">Empty</div>
      <div class="quantity-label" id="quantityCell17"></div>
      <div class="title-label" id="titleCell17"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell18">Empty</div>
      <div class="quantity-label" id="quantityCell18"></div>
      <div class="title-label" id="titleCell18"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell19">Empty</div>
      <div class="quantity-label" id="quantityCell19"></div>
      <div class="title-label" id="titleCell19"></div>
    </div>

    <div class="grid-cell">
      <div class="preview-box" id="previewCell20">Empty</div>
      <div class="quantity-label" id="quantityCell20"></div>
      <div class="title-label" id="titleCell20"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell21">Empty</div>
      <div class="quantity-label" id="quantityCell21"></div>
      <div class="title-label" id="titleCell21"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell22">Empty</div>
      <div class="quantity-label" id="quantityCell22"></div>
      <div class="title-label" id="titleCell22"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell23">Empty</div>
      <div class="quantity-label" id="quantityCell23"></div>
      <div class="title-label" id="titleCell23"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell24">Empty</div>
      <div class="quantity-label" id="quantityCell24"></div>
      <div class="title-label" id="titleCell24"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell25">Empty</div>
      <div class="quantity-label" id="quantityCell25"></div>
      <div class="title-label" id="titleCell25"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell26">Empty</div>
      <div class="quantity-label" id="quantityCell26"></div>
      <div class="title-label" id="titleCell26"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell27">Empty</div>
      <div class="quantity-label" id="quantityCell27"></div>
      <div class="title-label" id="titleCell27"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell28">Empty</div>
      <div class="quantity-label" id="quantityCell28"></div>
      <div class="title-label" id="titleCell28"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell29">Empty</div>
      <div class="quantity-label" id="quantityCell29"></div>
      <div class="title-label" id="titleCell29"></div>
    </div>

    <div class="grid-cell">
      <div class="preview-box" id="previewCell30">Empty</div>
      <div class="quantity-label" id="quantityCell30"></div>
      <div class="title-label" id="titleCell30"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell31">Empty</div>
      <div class="quantity-label" id="quantityCell31"></div>
      <div class="title-label" id="titleCell31"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell32">Empty</div>
      <div class="quantity-label" id="quantityCell32"></div>
      <div class="title-label" id="titleCell32"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell33">Empty</div>
      <div class="quantity-label" id="quantityCell33"></div>
      <div class="title-label" id="titleCell33"></div>
    </div>
    <div class="grid-cell">
      <div class="preview-box" id="previewCell34">Empty</div>
      <div class="quantity-label" id="quantityCell34"></div>
      <div class="title-label" id="titleCell34"></div>
    </div>
  </div>

  <!-- The configuration modal for adjusting element positions -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <table class="striped" id="configTable">
        <thead>
          <tr>
            <th>Element</th>
            <th>Left (px)</th>
            <th>Top (px)</th>
            <th>Width (px)</th>
            <th>Height (px)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <a href="#!" id="saveConfigBtn" class="modal-close waves-effect waves-green btn">
        Save Config
      </a>
    </div>
  </div>

  <!-- jQuery & Materialize JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"
  ></script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      M.AutoInit();

      // Fade in body
      setTimeout(() => {
        document.body.style.opacity = 1;
      }, 200);

      // Attempt to load saved positions from localStorage
      loadPositions();

      // “Open Config” button
      document.getElementById("openConfigBtn").addEventListener("click", () => {
        populateConfigTable();
        const modalElem = document.getElementById("configModal");
        const modalInst = M.Modal.getInstance(modalElem);
        modalInst.open();
      });
      document.getElementById("saveConfigBtn").addEventListener("click", () => {
        saveConfiguration();
      });

      // Etsy Order input => load transactions
      const etsyOrderInput = document.getElementById("etsyOrderNumber");
      etsyOrderInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
          const orderNum = etsyOrderInput.value.trim();
          if (orderNum) {
            await loadEtsyOrderItems(orderNum);
          }
        }
      });

      // “Test Etsy” button
      document.getElementById("testEtsyBtn").addEventListener("click", async () => {
        try {
          const testListingId = "123456"; // any valid listing
          const resp = await fetch(`/.netlify/functions/etsyProxy?listingId=${testListingId}`, {
            headers: { "access-token": localStorage.getItem("access_token") || "" }
          });
          if (!resp.ok) throw new Error("Etsy test call failed!");
          M.toast({ html: "Etsy connectivity OK!" });
        } catch (err) {
          M.toast({ html: "Etsy test failed: " + err.message });
        }
      });

      // “Test OpenAI” button
      document.getElementById("testOpenAIBtn").addEventListener("click", async () => {
        try {
          const testBody = {
            model: "gpt-3.5-turbo",
            messages: [{ role: "user", content: "Hello from the new Sorting page!" }]
          };
          const resp = await fetch("/.netlify/functions/openaiProxy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testBody)
          });
          if (!resp.ok) throw new Error("OpenAI test call failed!");
          const data = await resp.json();
          if (data.choices && data.choices[0] && data.choices[0].message) {
            M.toast({ html: "OpenAI responded successfully." });
          } else {
            throw new Error("No valid response from OpenAI!");
          }
        } catch (err) {
          M.toast({ html: "OpenAI test failed: " + err.message });
        }
      });

      // Enable zoom & drag inside each preview-box
      [...document.querySelectorAll(".preview-box")].forEach((box) => {
        let isDragging = false, lastX = 0, lastY = 0;
        box.addEventListener("wheel", (ev) => {
          const img = box.querySelector("img");
          if (!img) return;
          ev.preventDefault();
          let currentScale = parseFloat(img.dataset.scale) || 1;
          let offX = parseFloat(img.dataset.offsetX) || 0;
          let offY = parseFloat(img.dataset.offsetY) || 0;
          if (ev.deltaY < 0) {
            currentScale *= 1.1;
          } else {
            currentScale /= 1.1;
            if (currentScale <= 1) {
              currentScale = 1; offX = 0; offY = 0;
            }
          }
          currentScale = Math.min(currentScale, 4);
          img.dataset.scale = currentScale;
          img.dataset.offsetX = offX;
          img.dataset.offsetY = offY;
          img.style.transform = `translate(${offX}px, ${offY}px) scale(${currentScale})`;
        });
        box.addEventListener("mousedown", (ev) => {
          const img = box.querySelector("img");
          if (!img) return;
          let scaleNow = parseFloat(img.dataset.scale) || 1;
          if (scaleNow <= 1) return;
          ev.preventDefault();
          isDragging = true; lastX = ev.clientX; lastY = ev.clientY;
        });
        box.addEventListener("mousemove", (ev) => {
          if (!isDragging) return;
          ev.preventDefault();
          const img = box.querySelector("img");
          if (!img) return;
          let scaleNow = parseFloat(img.dataset.scale) || 1;
          let offX = parseFloat(img.dataset.offsetX) || 0;
          let offY = parseFloat(img.dataset.offsetY) || 0;
          const dx = ev.clientX - lastX;
          const dy = ev.clientY - lastY;
          offX += dx; offY += dy;
          img.dataset.offsetX = offX;
          img.dataset.offsetY = offY;
          img.style.transform = `translate(${offX}px, ${offY}px) scale(${scaleNow})`;
          lastX = ev.clientX; lastY = ev.clientY;
        });
        box.addEventListener("mouseup", () => { isDragging = false; });
        box.addEventListener("mouseleave", () => { isDragging = false; });
      });
    });

    /*******************************************************
     *  Load Etsy order => fetch transactions => fill boxes
     *******************************************************/
    async function loadEtsyOrderItems(orderNumber) {
      try {
        const token = localStorage.getItem("access_token") || "";
        const url = `/.netlify/functions/etsyOrderProxy?orderId=${encodeURIComponent(orderNumber)}`;
        const resp = await fetch(url, { headers: { "access-token": token } });
        if (!resp.ok) {
          throw new Error("Etsy order fetch failed");
        }
        const data = await resp.json();
        if (!data.transactions || !Array.isArray(data.transactions) || data.transactions.length === 0) {
          M.toast({ html: "No transactions found for this order!" });
          clearGrid();
          return;
        }
        const items = data.transactions;
        // Fill up to 35
        for (let i = 0; i < 35; i++) {
          const cell = document.getElementById(`previewCell${i}`);
          const qtyLabel = document.getElementById(`quantityCell${i}`);
          const titleLabel = document.getElementById(`titleCell${i}`);
          if (i < items.length) {
            const { listing_id, quantity, title } = items[i];
            cell.innerHTML = "Loading...";
            qtyLabel.textContent = "Qty: " + (quantity || 0);

            const firstFourWords = (title || "").split(" ").slice(0, 4).join(" ");
            titleLabel.textContent = firstFourWords;

            // Grab the first image from your existing serverless function
            const imageData = await fetchListingImages(listing_id);
            if (imageData && imageData.length > 0) {
              cell.innerHTML = `<img src="${imageData[0].url_fullxfull}" 
                                  alt="Listing ${listing_id}" 
                                  data-scale="1" 
                                  data-offsetX="0" 
                                  data-offsetY="0" />`;
            } else {
              cell.innerHTML = "No Img";
            }
          } else {
            // Clear leftover
            cell.innerHTML = "Empty";
            qtyLabel.textContent = "";
            titleLabel.textContent = "";
          }
        }
      } catch (error) {
        console.error("Error loading Etsy order:", error);
        M.toast({ html: "Error: " + error.message });
        clearGrid();
      }
    }

    function clearGrid() {
      for (let i = 0; i < 35; i++) {
        document.getElementById(`previewCell${i}`).innerHTML = "Empty";
        document.getElementById(`quantityCell${i}`).textContent = "";
        document.getElementById(`titleCell${i}`).textContent = "";
      }
    }

    async function fetchListingImages(listingId) {
      const token = localStorage.getItem("access_token") || "";
      const resp = await fetch(`/.netlify/functions/etsyImages?listingId=${listingId}`, {
        headers: { "access-token": token }
      });
      if (!resp.ok) {
        return [];
      }
      const data = await resp.json();
      return data.results || [];
    }

    /*******************************************************
     *           Positioning Config (like in index.html)
     *******************************************************/
    const configIDs = [
      "testEtsyBtn","testOpenAIBtn","openConfigBtn","etsyOrderNumber",
      "photoGridContainer","configModal","configTable","saveConfigBtn",
      /* 35 sets of 3 IDs each */
      ...[...Array(35).keys()].flatMap(i => [
        `previewCell${i}`, `quantityCell${i}`, `titleCell${i}`
      ])
    ];

    const defaults = {}; // if you want to specify any default positions

    function loadPositions() {
      configIDs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const def = defaults[id] || { left: 0, top: 0, width: 0, height: 0 };
        let left = localStorage.getItem(`pos-${id}-left`);
        let top  = localStorage.getItem(`pos-${id}-top`);
        let w    = localStorage.getItem(`pos-${id}-width`);
        let h    = localStorage.getItem(`pos-${id}-height`);

        if (left === null) left = def.left;
        if (top === null)  top  = def.top;
        if (w === null)    w    = def.width;
        if (h === null)    h    = def.height;

        el.style.position = "absolute";
        if (+left)  el.style.left   = left + "px";
        if (+top)   el.style.top    = top  + "px";
        if (+w)     el.style.width  = w    + "px";
        if (+h)     el.style.height = h    + "px";
      });
    }

    function populateConfigTable() {
      const tbody = document.querySelector("#configTable tbody");
      tbody.innerHTML = "";
      configIDs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const cs = window.getComputedStyle(el);
        const leftVal = parseInt(cs.left) || 0;
        const topVal = parseInt(cs.top) || 0;
        const widthVal = parseInt(cs.width) || 0;
        const heightVal = parseInt(cs.height) || 0;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${id}</td>
          <td><input type="number" value="${leftVal}" data-id="${id}" class="left-input" /></td>
          <td><input type="number" value="${topVal}" data-id="${id}" class="top-input" /></td>
          <td><input type="number" value="${widthVal}" data-id="${id}" class="width-input" /></td>
          <td><input type="number" value="${heightVal}" data-id="${id}" class="height-input" /></td>
        `;
        tbody.appendChild(row);

        row.querySelector(".left-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.left = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".top-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.top = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".width-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.width = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".height-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.height = parseInt(this.value, 10) + "px";
        });
      });
    }

    function saveConfiguration() {
      configIDs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const cs = window.getComputedStyle(el);
        localStorage.setItem(`pos-${id}-left`, parseInt(cs.left) || 0);
        localStorage.setItem(`pos-${id}-top`, parseInt(cs.top) || 0);
        localStorage.setItem(`pos-${id}-width`, parseInt(cs.width) || 0);
        localStorage.setItem(`pos-${id}-height`, parseInt(cs.height) || 0);
      });
      M.toast({ html: "Positions saved!" });
    }
  </script>
</body>
</html>