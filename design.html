<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sorting - Single-Click Zoom</title>
  <!-- Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
  <style>
    body {
      background-color: #fff;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0;
      transition: opacity 0s;
    }
    /* Main Buttons */
    #connectEtsyBtn, 
    #openConfigBtn {
      position: absolute;
      left: 20px;
      width: 140px;
      height: 36px;
    }
    #connectEtsyBtn {
      top: 20px;
    }
    #openConfigBtn {
      top: 120px;
    }

    /* Etsy Order Number input */
    #etsyOrderNumber {
      position: absolute;
      left: 20px;
      top: 270px;
      width: 300px;
      height: 30px;
      border: 1px solid #999;
      padding: 4px;
      outline: none;
      font-size: 0.9em;
    }

    .loadingTxt{
      color:#2196F3;          /* same blue as spinner + hover outline */
    }

    /* wrapper holds spinner + text and centres them */
    .loadingWrap{
      display:inline-flex;
      align-items:center;      /* vertical centring */
      gap:6px;                 /* keeps the space you had */
    }

    .metal-counter{
      position:absolute;
      font-size:0.8em;             /* ‚Üê 0 .8 em */
      background:#fff9c4;
      padding:4px 8px;
      border:1px solid #999;
    }

    /* spinner keeps its blue look & spin */
    @keyframes btnSpin{100%{transform:rotate(360deg)}}
    .spinner{
      width:18px;height:18px;
      border:3px solid transparent;border-top-color:#2196F3;border-radius:50%;
      animation:btnSpin .7s linear infinite;
    }
    .loadingTxt{color:#2196F3;}

    /* Image Comparison UI */
    #imageComparisonContainer {
      position: absolute;
      left: 20px;
      top: 310px;
    }

    /* --- Update-Order-List button --- */
    #updateOrderListBtn {
      position: absolute;
      left: 20px;
      top: 170px;           /* 50 px below ‚ÄúOpen Config‚Äù */
      width: 160px;
      height: 36px;
    }

    /* --- Next-Page button --- */
    #nextPageBtn {
      position: absolute;
      left: 190px;     /* to the right of Update button */
      top: 170px;      /* same vertical line */
      width: 120px;
      height: 36px;
    }

    /* ‚îÄ‚îÄ‚îÄ Header-bar chevrons ‚îÄ‚îÄ‚îÄ */
    #orderHeaderBar .chev{
      font-size:66%;          /* 33 % smaller */
      line-height:0.85em;
      display:inline-block;
      vertical-align:middle;
    }

    /* listing-detail modal layout */
    .modal-flex-row{
      display:flex;
      align-items:flex-start;
    }

    /* fixed thumbnail size, border stays */
    #modalListingImg{
      width:200px;
      height:200px;
      object-fit:cover;
      border:1px solid #ccc;
    }

    /* message box sits 20 px to the right, grows with content */
    #modalListingNotes{
      white-space:pre-wrap;
      margin:0 0 0 20px;     /* ‚Üë left margin = 20 px */
      background:#f5f5f5;
      padding:8px;
      border-radius:4px;
      flex:1;
    }

    /* --- Container that holds the stacked ‚ÄúnewOrder‚Äù boxes --- */
    #newOrderContainer {
      position: absolute;
      left: 20px;
      top: 236px;          /* 30 px below the 206 px bottom of Update-Order button */
      width: 318px;
      height: 800px;       /* scrollable window */
      overflow-y: auto;
      border: 1px dashed #bbb;
      padding: 4px;
      background: #fafafa;
    }

    /* active metal counter = blue 3 px outline */
    .metal-counter.active{ outline:3px solid #2196f3; }

    /* 3-px orangered flag for personalization / buyer-message */
     .preview-attn{
      outline:4px solid orangered !important;
      outline-offset:-1px;
    }

    .new-order-box {
      position: relative;

      /* 1 ‚ñ∏ make it a grid, not flex */
      display: grid;                 /* üî∏ REPLACES display:flex */

      /* 2 ‚ñ∏ give each column its exact width */
      grid-template-columns: 103px 67px 25px 25px 25px 25px;

      /* optional overall breathing room between columns */
      column-gap: 5px;              /* tweak this to taste */

      /* 3 ‚ñ∏ let the row size itself, or set an explicit width that
             matches your columns + gaps (80+90+30*4 + 10*5 = 320 px).   */
      width: 290px;                  /* or simply remove width:‚Ä¶ */

      height: 35px;
      margin-bottom: 10px;
      align-items: center;
      font-size: 0.9em;
      border: 1px solid #999;
      padding-left: 4px;
      background: #f5f5f5;
    }
    .new-order-box input[type="checkbox"] {
      position: absolute;
      right: 6px;
      top: 6px;
    }

    /* put right after your .new-order-box rule */
    .new-order-box.selected{
      background:#FFE2B5 !important;   /* force-override any other bg */
    }

    /* ‚îÄ‚îÄ‚îÄ Hover outline for each order row ‚îÄ‚îÄ‚îÄ */
    .new-order-box:hover{
      outline:3px solid #2196F3;   /* vivid blue circumference */
      outline-offset:-1px;         /* keeps outline snug inside row */
    }

    /* highlight around matching preview boxes */
    .preview-highlight{
      outline:3px solid #2196F3;      /* same blue as row hover */
      outline-offset:-1px;
    }

    /* Container for dynamically generated preview boxes and detail boxes */
    #photoGridContainer {
      position: relative;
      width: 1200px;
      max-height: 700px;
      overflow-y: auto;
      border-left: 1px dashed #ccc;
      border-right: 1px dashed #ccc;
      left: 350px;
      top: 20px;
    }

    /* === keep images square & clipped inside preview boxes === */
    .preview-box {
      width: 110px;          /* box itself */
      height: 110px;
      overflow: hidden;      /* clip anything that spills */
    }

    .preview-box img {
      width: 110%;
      height: 110%;
      object-fit: cover;     /* center-crop to square */
    }  

    /* ‚îÄ‚îÄ‚îÄ circular 15-px page buttons ‚îÄ‚îÄ‚îÄ */
    .page-btn{
      width:15px;height:15px;
      border-radius:50%;
      background:#eeeeee;color:#000;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:9px;margin:2px;cursor:pointer;border:1px solid #999;
    }
    .page-btn.active{
      background:#2196F3;color:#fff;
    }

    /* Detail text boxes: 55px x 7px */
    .detail-box {
      position: absolute;
      width: 55px;
      height: 7px;
      font-size: 0.6em !important;
      border: none !important;
      outline: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
      background: #f0f0f0;
      color: #333;
      padding: 0;
      margin: 0;
      box-shadow: none !important;
    }

    /* container for the three read-only boxes */
    .modal-detail-row{
      margin-top:7px;
      display:block;               /* stack vertically */
    }

    /* individual read-only box */
    .modal-detail-row input{
      display:block !important;    /* one per line */
      width:200px !important;
      height:20px !important;                 /* ‚Üê fixed height 20 px */
      line-height:20px !important;            /* keep text vertically centered */

      font-size:0.9em !important;

      /* remove Materialize underline & glow */
      border:none !important;
      border-bottom:none !important;
      box-shadow:none !important;

      background:transparent;
      padding:0 2px;               /* small left/right inset */

      margin:0 0 2px 0 !important; /* 2 px gap below each box */
    }

    /* prevent focus style from re-adding underline */
    .modal-detail-row input:focus{
      border-bottom:none !important;
      box-shadow:none !important;
    }

    /* pointer-events enabled on read-only inputs */
    .detail-box:read-only {
      pointer-events: auto !important;
      cursor: pointer !important;
    }

    /* finished orders in the side list */
    .new-order-box.completed{
      background:#4caf50 !important;   /* Materialize green-500 */
      color:#fff;
    }

    /* Config Modal */
    #configModal.modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 250px !important;
      height: 450px !important;
      max-height: none !important;
      overflow-y: auto !important;
    }
    #configTable thead tr th {
      font-size: 0.9em;
    }
    #configTable tbody tr td {
      font-size: 0.8em;
    }
    #configTable .left-input,
    #configTable .top-input,
    #configTable .width-input,
    #configTable .height-input {
      width: 80px !important;
    }
    .modal {
      opacity: 0 !important;
      transform: translateY(20px) scale(0.95) !important;
      will-change: opacity, transform;
      transition: opacity 300ms ease, transform 300ms ease;
    }
    .modal.open {
      opacity: 1 !important;
      transform: translateY(0) scale(1) !important;
    }
    .modal-overlay {
      opacity: 0;
      will-change: opacity;
      transition: opacity 300ms ease;
    }
    .modal-overlay.show {
      opacity: 1;
    }

  </style>
</head>
<body>
  <!-- Main Buttons -->
<button id="connectEtsyBtn"    class="btn waves-effect waves-light">Connect</button>
<button id="openConfigBtn"     class="btn waves-effect waves-light">Open Config</button>
<button id="updateOrderListBtn"class="btn waves-effect waves-light">Update</button>
<button id="clearBtn"          class="btn red lighten-1">Clear</button>
<button id="clearCompletedBtn" class="btn orange lighten-1">Clear Completed</button>

<!-- NEW green ‚ÄúComplete !‚Äù button (drag-positionable inside the modal) -->
<button id="completeBtn"
    class="btn green"
    style="position:absolute;left:20px;top:220px;width:140px;height:36px;">
  Complete&nbsp;!
</button>

<!-- Etsy Order Number input -->
<input id="etsyOrderNumber" type="text" />

<!-- NEW container that will hold the stacked boxes -->
<div id="newOrderContainer"></div>

<!-- Page-jump buttons will appear here -->
<div id="pageButtonsContainer"></div>

<!-- Live metal counters (draggable via Config modal) -->
<div id="goldCounter"   class="metal-counter active" data-metal="gold">Gold: 0          <!-- ‚Üê renamed label -->
</div>

<div id="silverCounter" class="metal-counter active" data-metal="silver">Silver: 0        <!-- ‚Üê renamed label -->
</div>

<div id="roseCounter"   class="metal-counter active" data-metal="rose">Rose: 0
</div>

<div id="completedCounter" class="metal-counter" data-metal="completed">Completed
</div>

<div id="solidCounter"  class="metal-counter active" data-metal="14k">14K: 0
</div>

<!-- Container for dynamically generated preview boxes and detail boxes -->
<div id="photoGridContainer">
  <!-- Preview boxes and detail boxes will be created dynamically -->
</div>

<!-- Config Modal -->
<div id="configModal" class="modal">
  <div class="modal-content">
    <table class="striped" id="configTable">
      <thead>
        <tr>
          <th>Element</th>
          <th>Left&nbsp;(px)</th>
          <th>Top&nbsp;(px)</th>
          <th>Width&nbsp;(px)</th>
          <th>Height</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="modal-footer">
    <a href="#!" id="saveConfigBtn"
       class="modal-close waves-effect waves-green btn">
      Save Config
    </a>
  </div>
</div>

<!-- 1) Firebase (compat mode) ‚Äì must be above your main sorting code -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- jQuery & Materialize JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<!-- Everything is in this single <script> block -->
<script>
/********************************************************
 * Base URL & Global Variables
 ********************************************************/
const functionsBaseUrl = window.location.origin + "/.netlify/functions";
const selectedOrders = new Set();      // receipt_id strings
const orderCache     = {};             // receipt_id ‚Üí transactions[]
const gridElements   = new Map();      // transaction_id ‚Üí wrapper DOM
/* storage keys */
const COMPLETED_KEY = "completedOrders";   // green-list
const LAST_PURGE_KEY = "completed_last_purge"; // ISO month stamp
const completedOrders = new Set();   // IDs that are already green

/* ===== revive completed set from localStorage (runs immediately) ===== */
(() => {
  const raw = localStorage.getItem("completedOrders");
  if (!raw) return;
  try {
    const obj = JSON.parse(raw);
    Object.values(obj).flat().forEach(id => completedOrders.add(String(id).trim()));
  } catch (err) {
    console.warn("Couldn‚Äôt parse saved completed list:", err);
  }
})();

/* ------------------------------------------------------------------
 *  INIT - make sure completedOrders is filled BEFORE any UI action
 * ------------------------------------------------------------------*/
(function initCompletedSet(){
  const raw = localStorage.getItem(COMPLETED_KEY);
  if (!raw) return;
  try{
    const obj = JSON.parse(raw);                 // { "YYYY-MM":[‚Ä¶] ‚Ä¶ }
    Object.values(obj).flat()
      .forEach(id => completedOrders.add(String(id)));
  }catch(e){
    console.warn("Completed-list parse error:", e);
  }
})();

let croppedImagesArray = [];
let userImagesArray = [];
let cellMatches = {};
let matchPrintFlowInProgress = false;
let pendingFetchControllers = [];
let globalRunId = 0;
let currentSaveHandler = null;      // tracks active ‚ÄúSave‚Äù listener
let skipMatches = {};   // { cellIndex: true }  
let earringCells  = {};            // { cellIdx : true }
let earringState  = {};            // { cellIdx : { firstImg:null } }
let orderListOffset = 0;      // 0, 100, 200‚Ä¶

/********************************************************
 * Firebase Initialization (REQUIRED)
 ********************************************************/
const firebaseConfig = {
  apiKey: "YourApiKeyHere",
  authDomain: "YourAuthDomainHere",
  projectId: "gokudatabase",
  storageBucket: "gokudatabase.firebasestorage.app",
  messagingSenderId: "1078662308113",
  appId: "1:1078662308113:web:41df0e5d229ff2af7a6cb0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/********************************************************
 * Etsy Auth, Code Challenge, configIDs
 ********************************************************/
(function () {
  const urlParams = new URLSearchParams(window.location.search);
  const accessToken = urlParams.get("access_token");
  if (accessToken) {
    localStorage.setItem("access_token", accessToken);
    window.history.replaceState({}, document.title, window.location.pathname);
    M.toast({ html: "Connection Successful!" });
    console.log("Access token received:", accessToken);
  } else {
    const authCode = urlParams.get("code");
    if (authCode) {
      const storedCodeVerifier = localStorage.getItem("etsy_code_verifier");
      if (storedCodeVerifier) {
        window.location.href =
          "/.netlify/functions/exchangeToken?code=" +
          encodeURIComponent(authCode) +
          "&code_verifier=" +
          encodeURIComponent(storedCodeVerifier);
      } else {
        console.error("No code verifier found in localStorage.");
      }
    }
  }
})();

function generateRandomString(length) {
  const chars =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let text = "";
  for (let i = 0; i < length; i++) {
    text += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return text;
}

async function generateCodeChallenge(codeVerifier) {
  const encoder = new TextEncoder();
  const data = encoder.encode(codeVerifier);
  const digest = await crypto.subtle.digest("SHA-256", data);
  let base64String = btoa(String.fromCharCode(...new Uint8Array(digest)));
  return base64String.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

// ADDED these two lines so you can reposition/resize them in the Config modal
const configIDs = [
  "connectEtsyBtn",
  "openConfigBtn",
  "updateOrderListBtn",
  "nextPageBtn",            // ‚Üê NEW
  "clearBtn",
  "etsyOrderNumber",
  "photoGridContainer",
  "orderHeaderBar",
  "configModal",
  "configTable",
  "saveConfigBtn",
  "newOrderContainer",
  "pageButtonsContainer",
  "completeBtn",          // ‚Üê NEW
  "goldCounter",
  "silverCounter",
  "roseCounter",
  "solidCounter"

];

/********************************************************
 * DOMContentLoaded: Disable buttons & attach logic
 ********************************************************/
let listingModal;                     // ‚Üê NEW ‚ûä  (declare up-top)

document.addEventListener("DOMContentLoaded", () => {
  M.AutoInit();

  const completeBtn = document.getElementById("completeBtn");
  if (completeBtn) {
    completeBtn.addEventListener("click", handleCompleteClick);
  }

  /* ‚ù∂  wire "Complete !" button */
  document.getElementById("completeBtn").addEventListener("click", handleCompleteClick);

  /* ‚ù∑  load completed list and colour rows */
  restoreCompleted();

  /* ‚ù∏  run monthly purge */
  purgeOldCompleted();

  /* NEW ‚ûã: cache the listing-detail modal so helpers can open it */
  listingModal = M.Modal.init(document.getElementById("listingModal"));

  setTimeout(function () {
    loadPositions();
    document.body.style.opacity = 1;
  }, 200);

  // Connect Etsy
  document.getElementById("connectEtsyBtn").addEventListener("click", async function () {
    try {
      const codeVerifier = generateRandomString(64);
      localStorage.setItem("etsy_code_verifier", codeVerifier);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const CLIENT_ID = "k75zdspz4r99txpqdji7i2em";
      const redirectUri = "https://design.goldenspike.app";
      const state = "randomState123";
      const scope = "listings_w listings_r transactions_r transactions_w";
      const etsyAuthUrl =
        "https://www.etsy.com/oauth/connect?response_type=code" +
        "&client_id=" + CLIENT_ID +
        "&redirect_uri=" + encodeURIComponent(redirectUri) +
        "&scope=" + encodeURIComponent(scope) +
        "&state=" + state +
        "&code_challenge=" + encodeURIComponent(codeChallenge) +
        "&code_challenge_method=S256";
      window.location.href = etsyAuthUrl;
    } catch (err) {
      console.error("OAuth start error:", err);
      M.toast({ html: "OAuth error: " + err.message });
    }
  });

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Update-Order-List button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("updateOrderListBtn").addEventListener("click", async function () {
        try {
          this.disabled = true;
          this.innerHTML = '<span class="loadingWrap">' +
         '  <span class="spinner"></span>' +
         '  <span class="loadingTxt">Loading‚Ä¶</span>' +
         '</span>';

          orderListOffset = 0;                 // reset to first page
          const gotRows = await buildNewOrderList(orderListOffset);


          /* ‚Äî‚Äî FORCE a second green-pass after new rows exist ‚Äî‚Äî */
          highlightCompletedRows();                  // <-- NEW LINE

          /* NEW ‚Üí log visible order count */
          const displayedCount = document.getElementById("newOrderContainer").children.length;
          console.log(`Orders displayed (offset ${orderListOffset}):`, displayedCount);

          /* enable ‚ÄúNext Page‚Äù if we got a full 100-row slice */
          document.getElementById("nextPageBtn").disabled = (gotRows < 100);

          this.disabled = false;
          this.innerHTML = "Update Order List";
        } catch (err) {
          console.error("Order-list fetch error:", err);
          M.toast({ html: "Order-list error: " + err.message });
          this.disabled = false;
          this.innerHTML = "Update Order List";
        }
      });

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Next-Page button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("nextPageBtn").addEventListener("click", async function () {
        try {
          this.disabled = true;
          this.innerText = "Loading‚Ä¶";

          orderListOffset += 100;              // simple offset jump
          const gotRows = await buildNewOrderList(orderListOffset);

          /* NEW ‚Üí log visible order count */
          const displayedCount = document.getElementById("newOrderContainer").children.length;
          console.log(`Orders displayed (offset ${orderListOffset}):`, displayedCount);

          /* stay enabled only if another full slice came back */
          this.disabled = (gotRows < 100);
          this.innerText = "Next Page";
        } catch (err) {
          console.error("Next-page error:", err);
          M.toast({ html: "Next-page error: " + err.message });
          this.disabled = false;
          this.innerText = "Next Page";
        }
      });

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Clear button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("clearBtn").addEventListener("click", () => {
        /* 1. wipe localStorage record */
        localStorage.removeItem(STORAGE_KEY);

        /* 2. clear in-memory sets & cache */
        selectedOrders.clear();
        Object.keys(orderCache).forEach(k => delete orderCache[k]);

        /* 3. remove orange rows + highlights */
        document.querySelectorAll(".new-order-box.selected")
                .forEach(row => row.classList.remove("selected"));

        /* 4. purge the photo grid */
        gridElements.clear();
        document.getElementById("photoGridContainer").innerHTML = "";

        /* 5. reset counters */
        updateCounters();

        M.toast({ html: "Selection cleared" });
      });

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Clear Completed (green) button  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      const clrCompBtn = document.getElementById("clearCompletedBtn");
      if (clrCompBtn) {
        clrCompBtn.addEventListener("click", clearCompleted);   // ‚Üê NEW
      }

  // Load multiple orders on Enter (partial snippet)
  const etsyOrderInput = document.getElementById("etsyOrderNumber");
  etsyOrderInput.addEventListener("keydown", async function (e) {
    if (e.key === "Enter") {

      // NEW: cancel *all* outstanding fetches / work from a previous run
      pendingFetchControllers.forEach(ctrl => ctrl.abort());
      pendingFetchControllers = [];     // fresh list for this run

      globalRunId++;                    // ‚Üê bump run ID so old tasks quit

      // Reset arrays & state
      croppedImagesArray = [];
      userImagesArray = [];
      cellMatches = {};
      window.cachedOrderItems = [];
      matchPrintFlowInProgress = false;

      // Clear UI
      document.getElementById("photoGridContainer").innerHTML = "";
      document.getElementById("unmatchedContainer").innerHTML = "";

      disableSendMatch();
      disableMatchPrintFlow();
      removeAllBlueHighlights();

      const inputVal = etsyOrderInput.value.trim();
      if (!inputVal) return;

      let orderNumbers = inputVal
        .split(",")
        .map((x) => x.trim())
        .filter((x) => x);
      orderNumbers = orderNumbers.slice(0, 50);

      await loadBatchEtsyOrders(orderNumbers);
    }
  });

  /* =====================================================================
   *  LOCAL-STORAGE PERSISTENCE  ‚Äî  selected orders + their transactions
   * ===================================================================== */
  const idStr = id => String(id);             // ‚Üê helper: always use string ids
  const STORAGE_KEY = "savedSelection";

  /* write current orange receipts ONLY (no transactions) */
  function persistSelection(){
    try{
      const data = {
        selected: [ ...selectedOrders ]   // simple string/number array
    };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }catch(err){
      console.warn("localStorage quota hit ‚Äî selection not saved:", err.message);
    }
  }

  /* read the saved receipt-ID list and rebuild from scratch */
  function restoreSelections(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;

    let data;  try{ data = JSON.parse(raw); } catch(e){ return; }

    /* 1Ô∏è‚É£  revive the set of selected order IDs ------------------ */
    selectedOrders.clear();
    (data.selected || []).forEach(id => selectedOrders.add(id));

    /* 2Ô∏è‚É£  wipe existing cache + grid ---------------------------- */
    Object.keys(orderCache).forEach(k => delete orderCache[k]);
    gridElements.clear();
    document.getElementById("photoGridContainer").innerHTML = "";

    /* 3Ô∏è‚É£  fetch each order again and rebuild previews ----------- */
    selectedOrders.forEach(async id => {
      const ord = await pullEtsyOrderDetails(id);   // fresh call to Etsy
      if (!ord) return;

      orderCache[id] = ord.transactions || [];
      orderCache[id].forEach(tx => addPreviewBox(tx));
    });

    /* 4Ô∏è‚É£  after boxes exist, colour the corresponding rows orange */
    setTimeout(() => {
    selectedOrders.forEach(id => {
      if (completedOrders.has(id)) return;        // ‚Üê NEW: skip green rows
      const row = document.querySelector(`.new-order-box[data-receipt='${id}']`);
      if (row) row.classList.add("selected");
    });
    }, 0);

    updateCounters();                    // refresh metal totals
  }

    /* remove all preview wrappers + grid bookkeeping for a receipt */
    function removePreviewBoxesForOrder(receiptID){
      document.querySelectorAll(
        `#photoGridContainer .wrap-preview[data-receipt='${receiptID}']`
      ).forEach(wrap => {
        wrap.remove();

        /* also delete the entry from gridElements map */
        for (const [k,v] of gridElements.entries()){
          if (v === wrap){ gridElements.delete(k); break; }
        }
      });

      updateCounters();          // refresh metal totals
    }

    /* remove every preview row that belongs to one receipt
   (hoisted ‚Äì available before handleCompleteClick executes) */
    function removePreviewBoxesForOrder(receiptId){
      const txs = orderCache[receiptId] || [];
      txs.forEach(tx => {
        if (tx._wrapEl){
          tx._wrapEl.remove();                    // yank from DOM

          /* drop from gridElements map */
          for (const [k,v] of gridElements.entries()){
            if (v === tx._wrapEl){ gridElements.delete(k); break; }
          }

          tx._inGrid = false;
          tx._wrapEl = null;
        }
      });

      updateCounters();                           // counters stay accurate
      realignGrid();                              // close visual gaps
    }

    /* ‚îÄ‚îÄ click handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function handleCompleteClick(){
    const activeMetals = Array.from(
          document.querySelectorAll(".metal-counter.active"))
          .map(b => b.dataset.metal);

    if (activeMetals.length !== 1){
      M.toast({ html:"Please choose only 1 metal filter at a time" });
      return;
    }
    const metalKey = activeMetals[0];

    /* 1Ô∏è‚É£  receipts that are VISIBLE and match the active metal */
    const greenIDs = [];
    document.querySelectorAll("#photoGridContainer .wrap-preview")
            .forEach(wrap => {
              if (wrap.style.display === "none") return;        // filtered out
              if (wrap.dataset.metal !== metalKey) return;      // wrong metal
              greenIDs.push(wrap.dataset.receipt);
            });

    if (!greenIDs.length){
      M.toast({ html:"No orders matched that metal." });
      return;
    }

    /* 2Ô∏è‚É£  colour rows & update memory */
    greenIDs.forEach(id => {
      completedOrders.add(id);               // track as finished
      selectedOrders.delete(id);             // remove from orange set

      const row = document.querySelector(
                  `.new-order-box[data-receipt='${id}']`);
      if (row){
        row.classList.remove("selected");
        row.classList.add("completed");
      }
    });

    /* 3Ô∏è‚É£  remove previews that belong to these receipts */
    greenIDs.forEach(id => removePreviewBoxesForOrder(id));
    realignGrid();                           // close any gaps

    /* 4Ô∏è‚É£  reset the chosen metal counter to 0 */
    const counterEl = document.querySelector(
          `.metal-counter[data-metal='${metalKey}']`);
    if (counterEl){
      const label = counterEl.textContent.split(":")[0];  // ‚ÄúGold‚Äù, ‚Ä¶
      counterEl.textContent = `${label}: 0`;
    }

    /* 5Ô∏è‚É£  persist new state & refresh totals */
    persistCompleted();        // green list
    updateCounters();          // counter now shows 0
    persistSelection();        // orange list (already trimmed) üî∏ moved
  }

  /* ‚îÄ‚îÄ save completed list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function persistCompleted(){
    const nowMonth = new Date().toISOString().slice(0,7);      // "YYYY-MM"
    const raw = localStorage.getItem(COMPLETED_KEY) || "{}";
    const obj = JSON.parse(raw);

    obj[nowMonth] = [ ...completedOrders ];                    // overwrite bucket
    localStorage.setItem(COMPLETED_KEY, JSON.stringify(obj));
  }

  /* -------------------------------------------------------------
   Clear all completed-order memory & remove green highlights
  ------------------------------------------------------------- */
  function clearCompleted(){
    /* 1. purge localStorage */
    localStorage.removeItem(COMPLETED_KEY);
    localStorage.removeItem(LAST_PURGE_KEY);

    /* 2. reset in-memory set */
    completedOrders.clear();

    /* 3. strip green class from sidebar rows */
    document.querySelectorAll(".new-order-box.completed")
            .forEach(box => box.classList.remove("completed"));

    /* 4. toast confirmation */
    M.toast({ html:"Completed orders cleared" });
  }

  /* ‚îÄ‚îÄ restore completed list on load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function restoreCompleted(){
    const raw = localStorage.getItem(COMPLETED_KEY);
    if (!raw) return;
    const obj = JSON.parse(raw);

    /* convert every ID to string before adding to the Set */
    Object.values(obj).flat().forEach(id => completedOrders.add(String(id)));

    /* the rest of the function is unchanged */
    completedOrders.forEach(id=>{
      const box = document.querySelector(`.new-order-box[data-receipt="${id}"]`);
      if (box){
        box.classList.remove("selected");
        box.classList.add("completed");
      }
      removePreviewBoxesForOrder(id);
    });

    realignGrid();
  }

  /* ‚îÄ‚îÄ purge buckets older than 2 months (run once per load) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function purgeOldCompleted(){
    const now = new Date();
    const last   = localStorage.getItem(LAST_PURGE_KEY) || "";
    const nowKey = now.toISOString().slice(0,7);               // "YYYY-MM"

    /* if we already purged this month, skip */
    if (last === nowKey) return;

    const raw = localStorage.getItem(COMPLETED_KEY) || "{}";
    const obj = JSON.parse(raw);

    /* drop buckets older than 2 months */
    Object.keys(obj).forEach(ym=>{
      const [y,m] = ym.split("-").map(n=>parseInt(n,10));
      const dt = new Date(y, m-1);                   // first of that month
      const diff = (now.getFullYear()-dt.getFullYear())*12 + (now.getMonth()-dt.getMonth());
      if (diff > 1) delete obj[ym];                 // keep 0 or 1 months ago
    });

    localStorage.setItem(COMPLETED_KEY, JSON.stringify(obj));
    localStorage.setItem(LAST_PURGE_KEY, nowKey);
  }

  /* -----------------------------------------------------------------
     Paint orange rows, but NEVER repaint something that is already
     marked completed (green).  This guarantees green always wins,
     even if an ID-type mismatch exists between the two Sets.
  ------------------------------------------------------------------*/
  function highlightSavedRows(){
    selectedOrders.forEach(id => {
      const row = document.querySelector(
            `.new-order-box[data-receipt='${id}']`);

      if (!row) return;                      // row not on this page
      if (row.classList.contains("completed")) return;  // already green

      row.classList.add("selected");         // paint orange only once
    });
  }

  /* colour every row whose receipt_id is in completedOrders */
  function highlightCompletedRows() {
    document.querySelectorAll(".new-order-box").forEach(box => {
      const rid = box.dataset.receipt;
      if (completedOrders.has(rid)) {
        box.classList.remove("selected");  // make sure orange never sticks
        box.classList.add("completed");    // paint (or re-paint) green
      } else {
        box.classList.remove("completed"); // remove green if no longer done
      }
    });
  }

  /* =========================================================
  *  LIVE COUNTER updater   (GLOBAL)
  *   ‚Ä¢ counts EVERY preview, even hidden ones,
  *     so totals stay correct when a metal is toggled off
  * ========================================================= */
 function updateCounters(){
   let g = 0, s = 0, r = 0, k = 0;
 
   gridElements.forEach(wrap => {
     const qty = Number(wrap.dataset.qty) || 1;
     switch (wrap.dataset.metal){
       case "gold":   g += qty; break;
       case "silver": s += qty; break;
       case "rose":   r += qty; break;
       case "14k":    k += qty; break;
     }
   });
 
   document.getElementById("goldCounter").innerText   = "Gold: "      + g;
   document.getElementById("silverCounter").innerText = "Silver: "    + s;
   document.getElementById("roseCounter").innerText   = "Rose Gold: " + r;
   document.getElementById("solidCounter").innerText  = "14K Solid: " + k;
 }

  /* ===================================================================
   * GLOBAL PREVIEW HELPERS  ‚Äì accessible from any click-handler
   * =================================================================== */

  /* append ONE preview without rebuilding the entire grid */
  function addPreviewBox(item){
    if (completedOrders.has(String(item.receipt_id))) return;   // skip finished

    const wrap = makePreviewNode(item);          // build + auto-append
    gridElements.set(gridElements.size, wrap);   // bookkeeping

    /* keep cachedOrderItems in the same order as gridElements */
    if (!Array.isArray(window.cachedOrderItems)) window.cachedOrderItems = [];
    window.cachedOrderItems.push(item);
    wrap.dataset.idx = window.cachedOrderItems.length - 1;      // sync idx

    item._inGrid  = true;
    item._wrapEl  = wrap;

    if (wrap.classList.contains("preview-attn")){
      console.log("ATTN:", item.listing_id,
                  item.personalization, item.message_from_buyer);
    }

    updateCounters();                              // refresh top counters

     /* 1Ô∏è‚É£ check if ‚ÄúCompleted‚Äù is the only active filter -------- */
     const completedOn = document
           .getElementById("completedCounter")
           .classList.contains("active");
   
     if (completedOn) {
       gridElements.forEach(wrap => {
         const rid = wrap.dataset.receipt;
         wrap.style.display = completedOrders.has(rid) ? "" : "none";
       });
       return;          // done ‚Äî no metal logic when Completed is on
     }
   
     /* 2Ô∏è‚É£ otherwise use the active-metal list just like before ---- */
     const activeMetals = new Set(
       Array.from(document.querySelectorAll(".metal-counter.active"))
            .map(btn => btn.dataset.metal)
     );
   
     gridElements.forEach(wrap => {
       wrap.style.display =
         activeMetals.has(wrap.dataset.metal) ? "" : "none";
     });
     return wrap;
   }

  /* build a preview row (image + 4 tiny detail inputs) */
  function makePreviewNode(item){
    const idx = gridElements.size;
    const row = Math.floor(idx / 9);
    const col = idx % 9;

    /* wrapper keeps receipt ID for easy lookup */
    const wrap = document.createElement("div");
    wrap.className = "wrap-preview";                 // <‚Äî NEW class
    wrap.dataset.receipt = item.receipt_id;          // <‚Äî NEW data-tag
    wrap.style.cssText = `position:absolute;left:${col*125}px;top:${row*165}px;`;

    /* preview image‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ */
    const box = document.createElement("div");
    box.className = "preview-box";
    box.innerHTML = "Loading‚Ä¶";
    wrap.appendChild(box);
    attachPreviewBoxListeners(box);

    /* 4 detail inputs ------------------------------------------------ */
    const addDetail = (id, y, val) => {
      const inp = document.createElement("input");
      inp.type       = "text";
      inp.readOnly   = true;
      inp.id         = id + idx;
      inp.className  = "detail-box";
      inp.dataset.idx= idx;               // ‚Üê NEW for modal lookup
      inp.style.cssText = `left:0px;top:${y}px;`;
      inp.value      = val;

      /* NEW ‚Äì open listing-detail modal when any detail box is clicked */
      inp.addEventListener("click", e => {
        e.stopPropagation();
        const parentWrap = e.currentTarget.closest(".wrap-preview");
        openListingModal(Number(parentWrap.dataset.idx));
      });

      wrap.appendChild(inp);
    };
    addDetail("orderCell"   ,  95, item.receipt_id || item.orderNumber || "No Order #");
    addDetail("quantityCell", 107, " Qty: " + (item.quantity ?? 0));

    /* ===== metal lookup, SKU, attention flag ========================== */
    let metalSel = "";
    if(Array.isArray(item.variations)){
      const ok=["metal","metal choice","metal - engraving","metal colour",
                "color","metal choice / engraving option"];
      const v=item.variations.find(v=>v.formatted_name &&
                ok.includes(v.formatted_name.trim().toLowerCase()));
      if(v?.formatted_value) metalSel = v.formatted_value;
    }

    /* simple metal key */
    let metalKey="";
    if (/14k/i.test(metalSel))         metalKey="14k";
    else if (/rose/i.test(metalSel))   metalKey="rose";
    else if (/silver/i.test(metalSel)) metalKey="silver";
    else if (/gold/i.test(metalSel))   metalKey="gold";

    item.metalLabel = metalSel || "No Metal";   // ‚Üê NEW

    /* does this listing need manual attention? */
    const hasPersonalization =
      // array version ‚Üí [ {...}, ... ]
      (Array.isArray(item.personalization) && item.personalization.length) ||

      // object version ‚Üí { text:"‚Ä¶" }
      (item.personalization &&
       typeof item.personalization === "object" &&
       !Array.isArray(item.personalization) &&
       Object.keys(item.personalization).length) ||

      // string version ‚Üí "Please engrave‚Ä¶"
      (typeof item.personalization === "string" &&
       item.personalization.trim().length) ||

      // boolean flag Etsy sometimes sends
      item.is_personalized === true;

    const needsAttn =
      hasPersonalization ||
      (item.message_from_buyer && item.message_from_buyer.trim().length);

    /* detail boxes */
    addDetail("metalCell",119," Metal: "+(metalSel||"No Metal"));
    addDetail("skuCell" ,131," SKU: "+(item.sku||"N/A"));
    addDetail("matchCell",143,"");

    wrap.dataset.metal = metalKey;
    wrap.dataset.qty   = item.quantity ?? 1;

    if (needsAttn) wrap.classList.add("preview-attn");   // ‚Üê ORANGERED!

    /* attach wrapper & load thumbnail‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ */
    document.getElementById("photoGridContainer").appendChild(wrap);
    fetchListingImages(item.listing_id)
      .then(imgs => getLocalImageData(imgs[0].url_fullxfull))
      .then(data => {
        /* set preview */
        box.innerHTML =
          `<img src="${data}" style="width:110%;height:110%;object-fit:cover;">`;

        /* NEW ‚Üí cache the image so the modal can show it */
        item.image = data;
      })
      .catch(()=>{ box.innerHTML = "Img Err"; });

    return wrap;
  }


(() => {


    /* =========================================================
     * DYNAMIC-REMOVE HELPERS
     * ========================================================= */

    /* remove every preview row that belongs to one receipt */
    function removePreviewBoxesForOrder(receiptId){
      const txs = orderCache[receiptId] || [];
      txs.forEach(tx => {
        if (tx._wrapEl) {
          tx._wrapEl.remove();                       // yank from DOM
          /* drop from gridElements map */
          for (const [k,v] of gridElements.entries()){
            if (v === tx._wrapEl){ gridElements.delete(k); break; }
          }
          tx._inGrid = false;
          tx._wrapEl = null;
        }
      });
    }

    /* close up the gaps: re-index & move every wrapper */
    function realignGrid(){
      let idx = 0;
      const wraps = Array.from(gridElements.values());  // current order
      gridElements.clear();                             // rebuild map
      wraps.forEach(wrap => {
        const row = Math.floor(idx / 9);
        const col = idx % 9;
        wrap.style.left = (col * 125) + "px";
        wrap.style.top  = (row * 165) + "px";
        gridElements.set(idx, wrap);                    // new key
        idx++;
      });
    }    


  /* 0.  GLOBAL HOOKS ----------------------------------------------------- */
  let currentReceipts = [];            // populated by buildNewOrderList()
  let sortKey   = null;                // "order", "ship", "gold", ...
  let sortDir   = 1;                   // 1 = asc, -1 = desc

  /** helper ‚Üí render the stacked boxes from `currentReceipts` array */
  function renderOrderBoxes(arr) {
    const container = document.getElementById("newOrderContainer");
    container.innerHTML = "";
    arr.forEach(async (r, idx) => {

      /* build the DOM node */
      const box = document.createElement("div");
      box.className = "new-order-box";
      box.id        = "newOrder" + idx;
      box.dataset.receipt = r.receipt_id;      // ‚Üê NEW data-tag

      /* click ‚Üí toggle highlight + (de)load images ---------------------- */
      box.addEventListener("click", async () => {
        const receiptId = idStr(r.receipt_id);      // ‚Üê always string

        /* ‚îÄ‚îÄ 1. toggle selected state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        if (selectedOrders.has(receiptId)) {
          /* ‚îÄ‚îÄ‚îÄ DESELECT ‚îÄ‚îÄ‚îÄ */
          selectedOrders.delete(receiptId);
          box.classList.remove("selected");
          removePreviewBoxesForOrder(receiptId);
          realignGrid();
          persistSelection();                       // üî∏ NEW
          updateCounters();                  // üî∏ NEW

        } else {
          /* ‚îÄ‚îÄ‚îÄ SELECT ‚îÄ‚îÄ‚îÄ */
          selectedOrders.add(receiptId);
          box.classList.add("selected");
          if (!orderCache[receiptId]) {
            const ord = await pullEtsyOrderDetails(receiptId);
            orderCache[receiptId] = ord?.transactions || [];
          }
          orderCache[receiptId].forEach(tx => { if (!tx._inGrid) addPreviewBox(tx); });
          persistSelection();                       // üî∏ NEW
        }

        /* ‚îÄ‚îÄ 2. build combined list from all active orders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        let combined = [];
        selectedOrders.forEach(id => {
          const tx = orderCache[id] || [];
          combined.push(...tx);
        });

        /* ‚îÄ‚îÄ 3. (de)render the grid ‚Äî incremental append version ‚îÄ */
        const grid = document.getElementById("photoGridContainer");

        if (combined.length === 0) {                 // nothing selected
          grid.innerHTML = "";
          gridElements.clear();
          earringCells  = {};
          earringState  = {};
        } else {
          combined.forEach(tx => {                   // only add new ones
            if (!tx._inGrid) addPreviewBox(tx);
          });
        }
      });   /* ‚Üê closes box.addEventListener("click", ‚Ä¶ ) */

      /* ‚îÄ‚îÄ HOVER ‚Üí outline matching preview boxes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      box.addEventListener("mouseenter", () => {
        if (!box.classList.contains("selected")) return;           // orange rows only
        const rec = r.receipt_id;
        document.querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt="${rec}"]`)
                .forEach(w => w.classList.add("preview-highlight"));
      });
      box.addEventListener("mouseleave", () => {
        const rec = r.receipt_id;
        document.querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt="${rec}"]`)
                .forEach(w => w.classList.remove("preview-highlight"));
      });

      /* order-row content ----------------------------------------------- */
      const orderNum = r.order_number || r.receipt_id || "‚Äî";
      const shipStr  = r._shipStr || "N/A";
      const g  = r._metalCounts.Gold     || 0;
      const s  = r._metalCounts.Silver   || 0;
      const rG = r._metalCounts["Rose G"]|| 0;
      const k  = r._metalCounts["14K"]   || 0;

      /* assign one metal key to the whole order for filtering */
      let rowMetal = "";
      if     (k)        rowMetal = "14k";
      else if(rG)       rowMetal = "rose";
      else if(s)        rowMetal = "silver";
      else if(g)        rowMetal = "gold";
      box.dataset.metal = rowMetal;            // ‚Üê moved here

      box.innerHTML = `
        <span class="col-order">${orderNum}</span>
        <span class="col-ship">${shipStr}</span>
        <span class="col-g">${g}</span>
        <span class="col-s">${s}</span>
        <span class="col-r">${rG}</span>
        <span class="col-k">${k}</span>
      `;
      container.appendChild(box);      // last line inside arr.forEach
    });                                // closes arr.forEach

    highlightSavedRows();              // ‚Üê NEW: paint saved rows
    requestAnimationFrame(highlightCompletedRows);   // green wins after paint

  }           

  /** 1.  HEADER BAR  +  EVENT LISTENERS ------------------------------- */
  const bar = document.createElement("div");
  bar.id = "orderHeaderBar";
  bar.style.cssText =
    "position:absolute;left:20px;top:206px;width:285px;height:23px;" +
    "display:flex;gap:2px;background:#626262;color:#fff;font-size:0.75em;" +
    "align-items:center;user-select:none;z-index:9999;";

  const COLS = [
    { key:"order",  label:"Order", flex:"1.55" },
    { key:"ship",   label:"Date",  flex:"1.25" },
    { key:"gold",   label:"G",     flex:"0.45" },
    { key:"silver", label:"S",     flex:"0.45" },
    { key:"rose",   label:"R",     flex:"0.45" },
    { key:"14k",    label:"14",    flex:"0.45" }
  ];

  COLS.forEach(col => {
    const div = document.createElement("div");
    div.className = "hdr";
    div.dataset.key = col.key;
    div.style.cssText = `flex:${col.flex};text-align:center;cursor:pointer;`;
    div.innerHTML =
      `${col.label}<span class="chev">` +
      `<span class="up">‚ñ≤</span><br><span class="down">‚ñº</span>` +
      `</span>`;
    bar.appendChild(div);
  });

  document.body.appendChild(bar);
  loadPositions();   // re-apply positions now that #orderHeaderBar exists

  /* 2.  SORT ROUTINE ---------------------------------------------------- */
  bar.addEventListener("click", ev => {
    const hdr = ev.target.closest(".hdr");
    if (!hdr) return;

    /* toggle dir / remember key */
    const key = hdr.dataset.key;
    sortDir = (sortKey === key) ? -sortDir : 1;
    sortKey = key;

    /* run the sort */
    currentReceipts.sort((a, b) => {
      switch (key) {
        case "order":  return sortDir * ((a.order_number || a.receipt_id) - (b.order_number || b.receipt_id));
        case "ship":   return sortDir * ((a._shipTS || 0) - (b._shipTS || 0));
        case "gold":   return sortDir * ((a._metalCounts.Gold || 0) - (b._metalCounts.Gold || 0));
        case "silver": return sortDir * ((a._metalCounts.Silver || 0) - (b._metalCounts.Silver || 0));
        case "rose":   return sortDir * ((a._metalCounts["Rose G"] || 0) - (b._metalCounts["Rose G"] || 0));
        case "14k":    return sortDir * ((a._metalCounts["14K"] || 0)   - (b._metalCounts["14K"] || 0));
      }
      return 0;
    });

    /* arrow colour logic ------------------------------------------- */
    bar.querySelectorAll(".chev .up, .chev .down")
       .forEach(el => (el.style.color = "#ffffff"));        // reset all

    if (sortDir === 1) {
      hdr.querySelector(".chev .up").style.color   = "#2196F3";  // ASC
    } else {
      hdr.querySelector(".chev .down").style.color = "#2196F3";  // DESC
    }

    renderOrderBoxes(currentReceipts);
  });

  /* 3.  HOOK INTO buildNewOrderList() ----------------------------------- */
  const originalBuild = buildNewOrderList;
  buildNewOrderList = async function(offset = 0) {
    const rawReceipts = await originalBuild.call(this, offset);   // returns count
    return rawReceipts;
  };

  /* Monkey-patch to expose display array for observer ------------------- */
  const origFuncTxt = buildNewOrderList.toString();
  if (!origFuncTxt.includes("window._lastDisplayReceipts")) {
    console.warn(
      "Patch buildNewOrderList manually to expose displayReceipts:\n" +
      "Inside buildNewOrderList(), after you define displayReceipts, add:\n" +
      "    window._lastDisplayReceipts = displayReceipts;"
    );
  }

  /** observer detects page changes and triggers initial render ---------- */
  const observer = new MutationObserver(() => {
    if (window._lastDisplayReceipts && window._lastDisplayReceipts !== currentReceipts) {
      currentReceipts = window._lastDisplayReceipts;

      /* helper fields for sorting ----------------------------- */
      currentReceipts.forEach(r => {
        /* ship timestamp + pretty string */
        if (!r._shipTS) {
          let ts = r.transactions?.[0]?.expected_ship_date || 0;
          r._shipTS  = ts;
          r._shipStr = ts
            ? new Date(ts * 1000).toLocaleDateString("en-US", { month:"short", day:"2-digit" })
            : "N/A";
        }

        /* metal counts */
        if (!r._metalCounts) {
          const mc = { Gold:0, Silver:0, "Rose G":0, "14K":0 };
          (r.transactions || []).forEach(t => {
            const m = (t.variations || [])
              .find(v => /metal/i.test(v.formatted_name || ""))?.formatted_value || "";
            if (/14k/i.test(m))         mc["14K"]   += t.quantity || 1;
            else if (/rose/i.test(m))   mc["Rose G"]+= t.quantity || 1;
            else if (/silver/i.test(m)) mc.Silver   += t.quantity || 1;
            else if (/gold/i.test(m))   mc.Gold     += t.quantity || 1;
          });
          r._metalCounts = mc;
        }


      });

      /* default sort (first load) ----------------------------- */
      if (!sortKey) { sortKey = "order"; sortDir = -1; }

      /* arrow colour on first load ---------------------------- */
      bar.querySelectorAll(".chev .up, .chev .down")
         .forEach(el => (el.style.color = "#ffffff"));
      const activeChev = bar.querySelector(`[data-key="${sortKey}"] .chev`);
      if (sortDir === 1) {
        activeChev.querySelector(".up").style.color   = "#2196F3";
      } else {
        activeChev.querySelector(".down").style.color = "#2196F3";
      }

      /* execute initial sort & render ------------------------- */
      currentReceipts.sort(
        (a, b) => (b.order_number || b.receipt_id) - (a.order_number || a.receipt_id)
      );
      renderOrderBoxes(currentReceipts);
    }
  });
  observer.observe(document.getElementById("newOrderContainer"), { childList: true });

})();   /* ‚îÄ‚îÄ‚îÄ END SORT HEADER MODULE ‚îÄ‚îÄ‚îÄ */

/********************************************************
 * helper: sleep(ms)
 ********************************************************/
const sleep = ms => new Promise(res => setTimeout(res, ms));


/********************************************************
 * updatePageButtons(totalPages, currentPage)
 *   ‚Ä¢ draws 1‚Ä¶N circular buttons under #newOrderContainer
 ********************************************************/
function updatePageButtons(totalPages, currentPage){
  const holder = document.getElementById("pageButtonsContainer");
  holder.innerHTML = "";                               // wipe + rebuild
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement("div");
    btn.className = "page-btn" + (i===currentPage ? " active": "");
    btn.textContent = i;
    btn.addEventListener("click", async () => {
      orderListOffset = (i-1)*100;                     // global var already exists
      await buildNewOrderList(orderListOffset);
      updatePageButtons(totalPages, i);                // refresh active state
    });
    holder.appendChild(btn);
  }
}


/********************************************************
 * fetchOpenOrdersSequential()   ‚Üê DROP-IN REPLACEMENT
 *    ‚Ä¢ grabs EVERY open receipt in 100-row pages
 *    ‚Ä¢ waits 250 ms between calls (safe for Etsy‚Äôs rate limits)
 *    ‚Ä¢ stops only when a page returns < 100 rows
 ********************************************************/
async function fetchOpenOrdersSequential() {
  const token  = localStorage.getItem("access_token") || "";
  const all    = [];
  let offset   = 0;

  while (true) {
    const resp = await fetch(
      `${functionsBaseUrl}/listOpenOrders?offset=${offset}`,
      { headers: { "access-token": token } }
    );
    if (!resp.ok) throw new Error("HTTP " + resp.status);

    const payload  = await resp.json();
    const receipts = payload.results || [];
    all.push(...receipts);

    /* ‚ô• Etsy gives max 100 rows; <100 means we‚Äôre done */
    if (receipts.length < 100) break;

    offset += 100;          // next slice
    await sleep(250);       // 250 ms pause
  }
  return all;
}

  /********************************************************
 * buildNewOrderList ‚Äì serves 100-row ‚Äúpages‚Äù from cache
 ********************************************************/
let allOpenReceipts = [];                 // ‚Üê master cache

async function buildNewOrderList(offset = 0) {
  /* ‚ù∂ first call ‚Üí fetch everything & sort once */
  if (allOpenReceipts.length === 0) {
    allOpenReceipts = await fetchOpenOrdersSequential();

    /* helper fields + oldest-ship-date sort */
    allOpenReceipts.forEach(r => {
      /* ship timestamp + pretty string */
      if (!r._shipTS) {
        let ts = null;
        if (Array.isArray(r.transactions) && r.transactions[0]?.expected_ship_date) {
          ts = r.transactions[0].expected_ship_date;
        }
        if (!ts) ts = r.dispatch_date || r.ship_by_date || 0;
        r._shipTS  = ts;
        r._shipStr = ts
          ? new Date(ts * 1000).toLocaleDateString("en-US", { month:"short", day:"2-digit" })
          : "N/A";
      }

      /* one-time metal counts */
      if (!r._metalCounts) {
        const mc = { Gold:0, Silver:0, "Rose G":0, "14K":0 };
        (r.transactions || []).forEach(t => {
          const m = (t.variations || []).find(v => /metal/i.test(v.formatted_name || ""))?.formatted_value || "";
          if (/14k/i.test(m))         mc["14K"]   += t.quantity || 1;
          else if (/rose/i.test(m))   mc["Rose G"]+= t.quantity || 1;
          else if (/silver/i.test(m)) mc.Silver   += t.quantity || 1;
          else if (/gold/i.test(m))   mc.Gold     += t.quantity || 1;
        });
        r._metalCounts = mc;
      }

      /* ‚îÄ‚îÄ NEW: attach buyer-message + keep personalization as array ‚îÄ‚îÄ */
      const buyerMsg = r.message_from_buyer || "";
      (r.transactions || []).forEach(t => {
        t.message_from_buyer = buyerMsg;

        t.personalization = (t.variations || []).find(v => /personalization/i.test(v.formatted_name || ""))?.formatted_value
          ? [ (t.variations.find(v => /personalization/i.test(v.formatted_name || ""))).formatted_value.trim() ]
          : [];

        // always make personalization an array
        if (t.personalization) {
          if (!Array.isArray(t.personalization)) {
            t.personalization = [ t.personalization ];
          }
        } else {
          t.personalization = [];
        }

        // dev-log any personalized transaction
        if (t.personalization.length) {
          console.log("‚üπ Personalization TX", t.transaction_id,
                      JSON.stringify(t.personalization));
        }
      });

    }); /* end forEach(r) */
  }

  /* ‚Ä¶ remainder of buildNewOrderList() unchanged ‚Ä¶ */

  allOpenReceipts.sort((a, b) => {
    if (a._shipTS === 0 && b._shipTS === 0) return 0;
    if (a._shipTS === 0) return  1;
    if (b._shipTS === 0) return -1;
    return a._shipTS - b._shipTS;            // oldest ‚Üí newest
  });

  /* ‚ù∑ slice requested page */
  const page = allOpenReceipts.slice(offset, offset + 100);
  window._lastDisplayReceipts = page;        // expose current page

  /* üî∏ NEW: build page buttons */
  const totalPages   = Math.ceil(allOpenReceipts.length / 100);
  const currentPage  = Math.floor(offset / 100) + 1;
  updatePageButtons(totalPages, currentPage);

  /******** render stacked boxes (unchanged widths) ********/
  const container = document.getElementById("newOrderContainer");
  container.innerHTML = "";
  page.forEach((r, idx) => {

    const box = document.createElement("div");
    box.className = "new-order-box";
    box.id        = "newOrder" + (offset + idx);

    const rid = idStr(r.receipt_id);         // ‚Üê use string everywhere
    box.dataset.receipt = rid;

    /* colour immediately if it was saved */
    if (completedOrders.has(rid)) {          // green first
      box.classList.add("completed");
    } else if (selectedOrders.has(rid)) {    // orange only if not green
      box.classList.add("selected");
    }

    const orderNum = r.order_number || r.receipt_id || "‚Äî";
    const shipStr  = r._shipStr || "N/A";
    const g  = r._metalCounts.Gold     || 0;
    const s  = r._metalCounts.Silver   || 0;
    const rG = r._metalCounts["Rose G"]|| 0;
    const k  = r._metalCounts["14K"]   || 0;

    /* NEW ‚ñ∏ decide the metal key for this entire order */
    let rowMetal = "";
    if     (k)   rowMetal = "14k";
    else if(rG)  rowMetal = "rose";
    else if(s)   rowMetal = "silver";
    else if(g)   rowMetal = "gold";
    box.dataset.metal = rowMetal;            // ‚Üê NEW

    box.innerHTML = `
      <span class="col-order">${orderNum}</span>
      <span class="col-ship">${shipStr}</span>
      <span class="col-g">${g}</span>
      <span class="col-s">${s}</span>
      <span class="col-r">${rG}</span>
      <span class="col-k">${k}</span>
    `;
    container.appendChild(box);
  });                                         // ‚Üê closes page.forEach

   highlightSavedRows();        // orange first‚Ä¶
 
   /* run the GREEN pass one frame later so nothing else can overwrite it */
   requestAnimationFrame(highlightCompletedRows);

   /* ‚îÄ‚îÄ refresh the four metal badges no matter what filters are set ‚îÄ‚îÄ */
   updateCounters();
 
  /* return page size (0-100) so buttons enable/disable correctly */
  return page.length;
}

/********************************************************
 * startScannedSortingListener (NEW partial snippet)
 ********************************************************/
async function startScannedSortingListener() {
  try {
    const docRef = db.collection("Brites_Orders").doc("ScannedSortingOrder");
    docRef.onSnapshot((docSnap) => {
      if (!docSnap.exists) {
        console.log("No 'ScannedSortingOrder' doc in Firestore yet.");
        return;
      }
      const docData = docSnap.data();
      if (!docData["Order Number"]) {
        console.log("No 'Order Number' in 'ScannedSortingOrder' doc.");
        return;
      }
      const scannedVal = docData["Order Number"];
      console.log("Scanned Sorting code =>", scannedVal);

      const input = document.getElementById("etsyOrderNumber");
      if (!input) return;
      input.value = scannedVal;

      // [NEW: reset states as if app just opened]
      disableSendMatch();
      disableMatchPrintFlow();
      removeAllBlueHighlights();

      // Programmatically fire an Enter key
      const enterEvent = new KeyboardEvent("keydown", { key: "Enter" });
      input.dispatchEvent(enterEvent);
    });
  } catch (err) {
    console.error("Error starting scannedSortingListener:", err);
  }
}

/* === Restore saved orange selections === */
  restoreSelections();            // ‚Üê add this line

});        /* ‚Üê‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì CLOSED DOMContentLoaded LISTENER */

/* ===== Hard-coded fallback positions & sizes (no calculations) ===== */
const defaultPos = {
  configModal:              { left:711, top:387, width:250, height:450 },
  configTable:              { left:27,  top:7,   width:525, height:1392 },
  connectEtsyBtn:           { left:1239,top:14,  width:170, height:35 },
  cropImagesBtn:            { left:20,  top:215, width:140, height:35 },
  etsyOrderNumber:          { left:20,  top:25,  width:200, height:30 },
  imageComparisonContainer: { left:0,   top:0,   width:0,   height:0 },
  matchPrintBtn:            { left:20,  top:315, width:210, height:35 },
  matchesModal:             { left:0,   top:0,   width:55,  height:0 },
  mpBackBtn:                { left:720, top:15,  width:100, height:35 },
  mpNextBtn:                { left:850, top:15,  width:100, height:35 },
  openConfigBtn:            { left:1270,top:729, width:140, height:35 },
  photoDragDrop:            { left:0,   top:-195,width:210, height:100 },
  photoGridContainer:       { left:270, top:68,  width:1140,height:650 },
  titleEtsyOrderNumber:     { left:20,  top:2,   width:145, height:20 },
  titleImageMatrixDrop:     { left:20,  top:91,  width:145, height:20 },
  titleUnmatchedImages:     { left:21,  top:437, width:145, height:20 },
  unmatchedContainer:       { left:0,   top:152, width:600, height:0 },
  userImage:                { left:0,   top:0,   width:100, height:100 },
  saveConfigBtn:            { left:10,  top:3,   width:85,  height:35 },
  sendMatchBtn:             { left:20,  top:255, width:210, height:35 },
  testOpenAIBtn:            { left:20,  top:65,  width:140, height:35 },
  newOrderContainer:        { left:20, top:236, width:318, height:800 },
  nextPageBtn:              { left:482, top:0, width:120, height:36 },
  orderHeaderBar:           { left:0, top:23, width:290, height:23 },
  pageButtonsContainer:     { left:20, top:20, width:270, height:25 },
  clearBtn:                 { left:820, top:0, width:120, height:35 },
  completeBtn:              { left:500, top:500, width:120, height:35 }
};

/********************************************************
 * loadPositions -- apply stored values or hard defaults
 ********************************************************/
function loadPositions() {
  configIDs.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;

    const def = defaultPos[id] || {};
    const left   = parseInt(localStorage.getItem(`pos-${id}-left`), 10)   || def.left   || 0;
    const top    = parseInt(localStorage.getItem(`pos-${id}-top`), 10)    || def.top    || 0;
    const width  = parseInt(localStorage.getItem(`pos-${id}-width`), 10)  || def.width  || 0;
    const height = parseInt(localStorage.getItem(`pos-${id}-height`), 10) || def.height || 0;

    el.style.position = "absolute";
    el.style.left   = left   + "px";
    el.style.top    = top    + "px";
    if (width  > 0) el.style.width  = width  + "px";
    if (height > 0) el.style.height = height + "px";
  });
}

// --------------- (Your code for config table, openConfigBtn, saveConfigBtn, etc.) --------------
document.getElementById("openConfigBtn").addEventListener("click", function () {
  populateConfigTable();
  M.Modal.getInstance(document.getElementById("configModal")).open();
});

document.getElementById("saveConfigBtn").addEventListener("click", function () {
  configIDs.forEach(function (id) {
    const el = document.getElementById(id);
    if (!el) return;
    const cs = window.getComputedStyle(el);
    localStorage.setItem("pos-" + id + "-left", parseInt(cs.left, 10) || 0);
    localStorage.setItem("pos-" + id + "-top", parseInt(cs.top, 10) || 0);
    localStorage.setItem("pos-" + id + "-width", parseInt(cs.width, 10) || 0);
    localStorage.setItem("pos-" + id + "-height", parseInt(cs.height, 10) || 0);
  });
  M.toast({ html: "Positions saved!" });
});

function populateConfigTable() {
  const tbody = document.querySelector("#configTable tbody");
  tbody.innerHTML = "";

  configIDs.forEach(function (id) {
    const el = document.getElementById(id);
    if (!el) return;
    const cs = window.getComputedStyle(el);
    const leftVal = parseInt(cs.left, 10) || 0;
    const topVal = parseInt(cs.top, 10) || 0;
    const widthVal = parseInt(cs.width, 10) || 0;
    const heightVal = parseInt(cs.height, 10) || 0;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${id}</td>
      <td><input type="number" value="${leftVal}" data-id="${id}" class="left-input"></td>
      <td><input type="number" value="${topVal}" data-id="${id}" class="top-input"></td>
      <td><input type="number" value="${widthVal}" data-id="${id}" class="width-input"></td>
      <td><input type="number" value="${heightVal}" data-id="${id}" class="height-input"></td>
    `;
    tbody.appendChild(row);

    row.querySelector(".left-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.left = parseInt(this.value, 10) + "px";
    });
    row.querySelector(".top-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.top = parseInt(this.value, 10) + "px";
    });
    row.querySelector(".width-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.width = parseInt(this.value, 10) + "px";
    });
    row.querySelector(".height-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.height = parseInt(this.value, 10) + "px";
    });
  });
}

/******************************************************************
 * fillPreviewBoxes(items)      ‚¨áÔ∏è  <------------- REPLACE THIS WHOLE FUNCTION
 ******************************************************************/
function fillPreviewBoxes(items){
  /* reset state ----------------------------------------------- */
  gridElements.clear();
  earringCells = {};
  earringState = {};
  const container = document.getElementById("photoGridContainer");
  container.innerHTML = "";

  window.cachedOrderItems = items;        // global cache

  /* helper phrase lists (unchanged) --------------------------- */
  const groupA = ["stud","studs","stud earrings","ring","rings","earrings"];
  const groupB = ["necklace","necklaces","huggie","huggies","huggie earrings",
                  "hoop","hoops","hoop earrings","bracelet","bracelets",
                  "extender","extenders","chain","chains"];
  const EARRING_PHRASES = [
    "stud","stud earrings","earring","earrings",
    "huggie","huggies","huggie earrings","hoop","hoops","hoop earrings"
  ];
  const containsPhrase = (str="",ph="")=>{
    const pat="\\b"+ph.trim().replace(/\s+/g,"[\\s\\W]+")+"\\b";
    return new RegExp(pat,"i").test(str.toLowerCase());
  };
  const isEarringString = str =>
    EARRING_PHRASES.some(ph=>new RegExp("\\b"+ph.replace(/\s+/g,"\\s+")+"\\b","i").test(str.toLowerCase()));

  /* main loop: one preview per transaction -------------------- */
  items.forEach(item=>{
    /* keyword tagging */
    item.keywords=[];
    if(item.title){
      groupA.forEach(p=>{if(containsPhrase(item.title,p)) item.keywords.push(p);});
      groupB.forEach(p=>{if(containsPhrase(item.title,p)) item.keywords.push(p);});
    }
    if(item.keywords.length===0) item.keywords.push("groupB");

    /* earring detector */
    item.isEarring = isEarringString(item.title||"") ||
                     (item.variations||[]).some(v=>v.formatted_value && isEarringString(v.formatted_value));
    if(item.isEarring){
      const idx = gridElements.size;
      earringCells[idx]=true;
      earringState[idx]={firstImg:null};
    }

    /* build + append preview row */
    addPreviewBox(item);
  });

    updateCounters();                  // ‚Üê NEW: recalc counters
    reflowGrid();

}  /* ---------------------------- END fillPreviewBoxes -------- */

function attachPreviewBoxListeners(box) {
  let isDragging = false;
  let isMouseDown = false;
  let dragStartX = 0,
      dragStartY = 0;
  let lastX = 0,
      lastY = 0;
  const dragThreshold = 3;

  box.addEventListener("wheel", function (ev) {
    const img = box.querySelector("img");
    if (!img) return;
    ev.preventDefault();
    let currentScale = parseFloat(img.dataset.scale) || 1;
    let offX = parseFloat(img.dataset.offsetX) || 0;
    let offY = parseFloat(img.dataset.offsetY) || 0;
    if (ev.deltaY < 0) {
      currentScale *= 1.1;
    } else {
      currentScale /= 1.1;
      if (currentScale <= 1) {
        currentScale = 1;
        offX = 0;
        offY = 0;
      }
    }
    if (currentScale > 7) currentScale = 7;
    img.dataset.scale = currentScale;
    img.dataset.offsetX = offX;
    img.dataset.offsetY = offY;
    img.style.transform = `translate(${offX}px, ${offY}px) scale(${currentScale})`;
  });

  box.addEventListener("mousedown", function (ev) {
    const img = box.querySelector("img");
    if (!img) return;
    const scaleNow = parseFloat(img.dataset.scale) || 1;
    if (scaleNow <= 1) return;
    ev.preventDefault();
    isMouseDown = true;
    isDragging = false;
    dragStartX = ev.clientX;
    dragStartY = ev.clientY;
    lastX = ev.clientX;
    lastY = ev.clientY;
  });

  box.addEventListener("mousemove", function (ev) {
    if (!isMouseDown) return;
    ev.preventDefault();
    const dxAll = Math.abs(ev.clientX - dragStartX);
    const dyAll = Math.abs(ev.clientY - dragStartY);
    if (dxAll > dragThreshold || dyAll > dragThreshold) isDragging = true;
    const img = box.querySelector("img");
    if (!img) return;
    const scaleNow = parseFloat(img.dataset.scale) || 1;
    let offX = parseFloat(img.dataset.offsetX) || 0;
    let offY = parseFloat(img.dataset.offsetY) || 0;
    const dx = ev.clientX - lastX;
    const dy = ev.clientY - lastY;
    offX += dx;
    offY += dy;
    img.dataset.offsetX = offX;
    img.dataset.offsetY = offY;
    img.style.transform = `translate(${offX}px, ${offY}px) scale(${scaleNow})`;
    lastX = ev.clientX;
    lastY = ev.clientY;
  });

  box.addEventListener("mouseup", function () {
    isMouseDown = false;
  });
  box.addEventListener("mouseleave", function () {
    isMouseDown = false;
  });

  box.addEventListener("click", function (ev) {
    if (isDragging) {
      isDragging = false;
      return;
    }
    const img = box.querySelector("img");
    if (!img) return;
    const rect = box.getBoundingClientRect();
    const boxCenterX = rect.left + box.clientWidth / 2;
    const boxCenterY = rect.top + box.clientHeight / 2;
    const dx = ev.clientX - boxCenterX;
    const dy = ev.clientY - boxCenterY;
    const scale = 5;
    const fudgeY = 10;
    const offsetX = -scale * dx;
    const offsetY = -scale * dy + fudgeY;
    img.dataset.scale = scale;
    img.dataset.offsetX = offsetX;
    img.dataset.offsetY = offsetY;
    img.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  });

}

/********************************************************
 * loadBatchEtsyOrders, fetchListingImages, getLocalImageData
 ********************************************************/
async function loadBatchEtsyOrders(orderNumbers) {
  try {
    M.toast({ html: "Loading " + orderNumbers.length + " order(s)..." });

    const token         = localStorage.getItem("access_token") || "";
    const combinedItems = [];

    /* ‚îÄ‚îÄ loop through each receiptId ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    for (let i = 0; i < orderNumbers.length; i++) {
      const ord  = orderNumbers[i];
      const url  = functionsBaseUrl + "/etsyOrderProxy?orderId=" + encodeURIComponent(ord);
      const resp = await fetch(url, { headers: { "access-token": token } });

      if (!resp.ok) {
        console.warn("Order fetch failed for " + ord + ", status=" + resp.status);
        continue;
      }

      const data = await resp.json();
      console.log("Etsy Order Data:", data);

      /* -----------------------------------------------------------
       * attach buyer-message & keep Etsy's transaction.personalization
       * ----------------------------------------------------------- */
      if (Array.isArray(data.transactions)) {
        const buyerMsg = data.receipt?.message_from_buyer || "";

        data.transactions.forEach(t => {
          t.typedOrderNumber   = ord;
          t.message_from_buyer = buyerMsg;

        /* normalize personalization ---------------------------------- */
        if (t.personalization) {
          if (!Array.isArray(t.personalization)) {
            t.personalization = [ t.personalization ];
          }
        } else {
          t.personalization = [];
        }

          /* DEBUG: log if any personalization exists */
          if (t.personalization.length) {
            console.log("‚üπ Personalization TX", t.transaction_id, t.personalization);
          }
        });

        /* -------- expected_ship_date ‚Üí dispatch_date ------------ */
        if (data.transactions.length > 0) {
          const firstTrans = data.transactions[0];
          if (firstTrans.expected_ship_date) {
            const sTS   = new Date(firstTrans.expected_ship_date * 1000);
            const sDay  = ("0" + sTS.getDate()).slice(-2);
            const sMon  = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug",
                           "Sep","Oct","Nov","Dec"][sTS.getMonth()];
            const sYr   = sTS.getFullYear();
            const formatted = `${sDay} ${sMon} ${sYr}`;

            data.transactions.forEach(t => { t.dispatch_date = formatted; });
          }
        }

        combinedItems.push(...data.transactions);   // merge
      } else {
        console.warn("No transactions for order", ord);
      }
    }  /* ‚Üê end for-loop */

    /* ‚îÄ‚îÄ render combined results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    await fillPreviewBoxes(combinedItems);
    attachMatchCellListeners();         // keep listener wiring
    updateCounters();                   // refresh metal tallies

  } catch (err) {
    console.error("Error loading batch orders:", err);
    M.toast({ html: "Error: " + err.message });
  }
}

async function fetchListingImages(listingId) {
  const token = localStorage.getItem("access_token") || "";
  const resp = await fetch(functionsBaseUrl + "/etsyImages?listingId=" + listingId, {
    headers: { "access-token": token },
  });
  if (!resp.ok) {
    console.warn("Image fetch HTTP error:", resp.status);
    return [];
  }
  const data = await resp.json();
  return data.results || [];
}

async function getLocalImageData(imageUrl) {
  try {
    const response = await fetch(
      functionsBaseUrl + "/imageProxy?url=" + encodeURIComponent(imageUrl)
    );
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  } catch (err) {
    console.error("Error in getLocalImageData:", err);
    throw err;
  }
}

// ---------------------------------------------------------
// Pull Etsy order details and update grid details
// ---------------------------------------------------------
function pullEtsyOrderDetails(orderNumber){
  console.log("Pulling Etsy order details for:", orderNumber);
  const token = localStorage.getItem("access_token") || "";

  return fetch(
    functionsBaseUrl + "/etsyOrderProxy?orderId=" + encodeURIComponent(orderNumber),
    { headers: { "access-token": token } }
  )
  .then(r => r.json())
  .then(data => {
    console.log("Etsy Order Data:", data);

    /* ‚îÄ‚îÄ attach buyer-message & guarantee personalization array ‚îÄ‚îÄ */
    const buyerMsg = data.receipt?.message_from_buyer || "";

    (data.transactions || []).forEach((t, idx) => {
      t.message_from_buyer = buyerMsg;

      /* NEW ‚Üí lift the ‚ÄúPersonalization‚Äù variation into its own field */
      const engrave = (t.variations||[])
                        .find(v=>/personalization/i.test(v.formatted_name||""))?.formatted_value || "";

      const clean = engrave.trim();
      if (clean && !/not requested/i.test(clean)) {
        t.personalization = [ clean ];
      } else {
        t.personalization = [];            // treat as ‚Äúno personalization‚Äù
      }

      console.log("PERSONALIZATION DEBUG:", t.transaction_id, t.personalization, typeof t.personalization);
      if (idx === 0) {                       // dump only the first transaction
        console.log("TX FIELDS:", Object.keys(t));
      }

      /* normalize personalization ---------------------------------- */
      if (t.personalization) {
        if (!Array.isArray(t.personalization)) {
          t.personalization = [ t.personalization ];
        }
      } else {
        t.personalization = [];
      }

      /* DEBUG: log any transaction that has personalization text */
      if (t.personalization.length) {
        console.log("‚üπ Personalization TX", t.transaction_id, t.personalization);
      }
    });

    return data;                       // hand the cleaned object upward
  })
  .catch(err => {
    console.error("Error fetching Etsy order details:", err);
    return null;
  });
}

// Example: update the grid details using pulled Etsy order details
async function updateImageGrid(data) {
  let items = [];
  if (data.transactions && Array.isArray(data.transactions)) {
    items = data.transactions;
  } else if (Array.isArray(data)) {          
    items = data;
  }
  window.cachedOrderItems = items;
  await fillPreviewBoxes(items);
}

/* ---- stubbed out empty functions ---- */
function disableSendMatch() {}
function disableMatchPrintFlow() {}
function removeAllBlueHighlights() {}
function attachMatchCellListeners() {}  


/* ‚îÄ‚îÄ‚îÄ grid reflow after filter ‚îÄ‚îÄ‚îÄ */
function reflowGrid(){
  const wraps = Array.from(document.querySelectorAll("#photoGridContainer .wrap-preview"))
                     .filter(w => w.style.display !== "none");

  wraps.forEach((wrap, idx) => {
    const row = Math.floor(idx / 9);      // 9 cols per row
    const col = idx % 9;
    wrap.style.left = (col * 125) + "px";
    wrap.style.top  = (row * 165) + "px";
  });

  /* optional: grow the container so you can scroll all rows */
  const grid = document.getElementById("photoGridContainer");
  const totalRows = Math.ceil(wraps.length / 9);
  grid.style.height = (totalRows * 165) + "px";
}

/* ‚îÄ‚îÄ‚îÄ METAL FILTER INITIALISER ‚îÄ‚îÄ‚îÄ */
(function () {
  /* click-toggle each counter */
  document.querySelectorAll('.metal-counter:not([data-metal="completed"])').forEach(box => {
    box.addEventListener("click", () => {
      box.classList.toggle("active");      // blue outline via CSS
      applyMetalFilter();
    });
  });

  /********************************************************
   * Completed filter ‚Äì exclusivity logic
   ********************************************************/
  document.getElementById("completedCounter").addEventListener("click", function () {
    const completedBtn = this;
    const isNowActive  = !completedBtn.classList.contains("active");

    /* toggle Completed */
    completedBtn.classList.toggle("active", isNowActive);

    /* all other metal buttons */
    const metalBtns = document.querySelectorAll(
          '.metal-counter[data-metal]:not([data-metal="completed"])');

    metalBtns.forEach(btn => btn.classList.toggle("active", !isNowActive));

    applyMetalFilter();         // refresh the grid with the new state
  });

  /* run once on load to honour the initial ‚Äúactive‚Äù class */
  applyMetalFilter();

  function applyMetalFilter() {
    /* 1. collect the metals that are ON */
    const active = new Set(
      Array.from(document.querySelectorAll(".metal-counter.active"))
           .map(b => b.dataset.metal)
    );

    /* 2. show / hide preview wrappers */
    document.querySelectorAll("#photoGridContainer .wrap-preview")
            .forEach(wrap => {
              wrap.style.display =
                active.has(wrap.dataset.metal) ? "" : "none";
            });

    reflowGrid();        // ‚Üê NEW
  }
})();

    function openListingModal(cellIdx){
      const item = window.cachedOrderItems[cellIdx];
      if(!item){ return; }

      /* 1. title & image */
      document.getElementById("modalListingTitle").textContent =
      "Order #" + (item.receipt_id || item.orderNumber || "N/A");

      document.getElementById("modalListingImg").src = item.image;

      /* 2. notes  */
      const lines = [];
      if(item.personalization && item.personalization.length){
        lines.push("Personalization:\n" + item.personalization.join("\n"));
      }
      if(item.message_from_buyer){
        lines.push("Buyer Message:\n" + item.message_from_buyer.trim());
      }
      document.getElementById("modalListingNotes").textContent =
          lines.length ? lines.join("\n\n") : "‚Äî No notes ‚Äî";

      /* ----- build the 4 read-only fields ----- */
      const detRow = document.getElementById("modalListingDetails");
      detRow.innerHTML = "";                            // reset

      const mkInput = (lbl,val) => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.readOnly = true;
        inp.value = `${lbl}: ${val}`;
        detRow.appendChild(inp);
      };

      mkInput("Qty"  , item.quantity  ?? "0");
      mkInput("Metal", item.metalLabel || "N/A");
      mkInput("SKU"  , item.sku       || "N/A");

      listingModal.open();
    }

    /* pack remaining previews after removals ------------------------ */
    function realignGrid(){
      const wraps = Array.from(document.querySelectorAll("#photoGridContainer .wrap-preview"));
      wraps.forEach((w, idx) => {
        const row = Math.floor(idx / 9);
        const col = idx % 9;
        w.style.left = (col * 125) + "px";
        w.style.top  = (row * 165) + "px";
      });
    }  

  </script>

    <!-- ‚îÄ‚îÄ‚îÄ Listing-detail modal ‚îÄ‚îÄ‚îÄ -->
  <div id="listingModal" class="modal">
    <div class="modal-content">
      <h5 id="modalListingTitle"></h5>
      <div class="modal-flex-row">
        <img id="modalListingImg"/>
        <pre id="modalListingNotes"></pre>
      </div>
      <div id="modalListingDetails" class="modal-detail-row"></div>
    <div class="modal-footer">
      <a href="#!" class="modal-close btn-flat">Close</a>
    </div>
  </div>

</body>
</html>