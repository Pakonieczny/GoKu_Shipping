<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sorting - Single-Click Zoom</title>
  <!-- Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
  <style>
    body {
      background-color: #fff;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0;
      transition: opacity 0s;
    }
    /* Main Buttons */
    #connectEtsyBtn, 
    #openConfigBtn {
      position: absolute;
      left: 20px;
      width: 140px;
      height: 36px;
    }
    #connectEtsyBtn {
      top: 20px;
    }
    #openConfigBtn {
      top: 120px;
    }

    /* Etsy Order Number input */
    #etsyOrderNumber {
      position: absolute;
      left: 20px;
      top: 270px;
      width: 300px;
      height: 30px;
      border: 1px solid #999;
      padding: 4px;
      outline: none;
      font-size: 0.9em;
    }

    /* Image Comparison UI */
    #imageComparisonContainer {
      position: absolute;
      left: 20px;
      top: 310px;
    }

    /* --- Update-Order-List button --- */
    #updateOrderListBtn {
      position: absolute;
      left: 20px;
      top: 170px;           /* 50 px below ‚ÄúOpen Config‚Äù */
      width: 160px;
      height: 36px;
    }

    /* --- Next-Page button --- */
    #nextPageBtn {
      position: absolute;
      left: 190px;     /* to the right of Update button */
      top: 170px;      /* same vertical line */
      width: 120px;
      height: 36px;
    }

    /* ‚îÄ‚îÄ‚îÄ Header-bar chevrons ‚îÄ‚îÄ‚îÄ */
    #orderHeaderBar .chev{
      font-size:66%;          /* 33 % smaller */
      line-height:0.85em;
      display:inline-block;
      vertical-align:middle;
    }

    /* --- Container that holds the stacked ‚ÄúnewOrder‚Äù boxes --- */
    #newOrderContainer {
      position: absolute;
      left: 20px;
      top: 236px;          /* 30 px below the 206 px bottom of Update-Order button */
      width: 318px;
      height: 800px;       /* scrollable window */
      overflow-y: auto;
      border: 1px dashed #bbb;
      padding: 4px;
      background: #fafafa;
    }

    .new-order-box {
      position: relative;

      /* 1 ‚ñ∏ make it a grid, not flex */
      display: grid;                 /* üî∏ REPLACES display:flex */

      /* 2 ‚ñ∏ give each column its exact width */
      grid-template-columns: 103px 67px 25px 25px 25px 25px;

      /* optional overall breathing room between columns */
      column-gap: 5px;              /* tweak this to taste */

      /* 3 ‚ñ∏ let the row size itself, or set an explicit width that
             matches your columns + gaps (80+90+30*4 + 10*5 = 320 px).   */
      width: 320px;                  /* or simply remove width:‚Ä¶ */

      height: 35px;
      margin-bottom: 10px;
      align-items: center;
      font-size: 0.9em;
      border: 1px solid #999;
      padding-left: 4px;
      background: #f5f5f5;
    }
    .new-order-box input[type="checkbox"] {
      position: absolute;
      right: 6px;
      top: 6px;
    }

    /* Container for dynamically generated preview boxes and detail boxes */
    #photoGridContainer {
      position: relative;
      width: 1200px;
      max-height: 700px;
      overflow-y: auto;
      border-left: 1px dashed #ccc;
      border-right: 1px dashed #ccc;
      left: 350px;
      top: 20px;
    }

    /* === keep images square & clipped inside preview boxes === */
    .preview-box {
      width: 110px;          /* box itself */
      height: 110px;
      overflow: hidden;      /* clip anything that spills */
    }

    .preview-box img {
      width: 110%;
      height: 110%;
      object-fit: cover;     /* center-crop to square */
    }  

    /* Detail text boxes: 55px x 7px */
    .detail-box {
      position: absolute;
      width: 55px;
      height: 7px;
      font-size: 0.6em !important;
      border: none !important;
      outline: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
      background: #f0f0f0;
      color: #333;
      padding: 0;
      margin: 0;
      box-shadow: none !important;
    }

    /* pointer-events enabled on read-only inputs */
    .detail-box:read-only {
      pointer-events: auto !important;
      cursor: pointer !important;
    }

    /* Config Modal */
    #configModal.modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 250px !important;
      height: 450px !important;
      max-height: none !important;
      overflow-y: auto !important;
    }
    #configTable thead tr th {
      font-size: 0.9em;
    }
    #configTable tbody tr td {
      font-size: 0.8em;
    }
    #configTable .left-input,
    #configTable .top-input,
    #configTable .width-input,
    #configTable .height-input {
      width: 80px !important;
    }
    .modal {
      opacity: 0 !important;
      transform: translateY(20px) scale(0.95) !important;
      will-change: opacity, transform;
      transition: opacity 300ms ease, transform 300ms ease;
    }
    .modal.open {
      opacity: 1 !important;
      transform: translateY(0) scale(1) !important;
    }
    .modal-overlay {
      opacity: 0;
      will-change: opacity;
      transition: opacity 300ms ease;
    }
    .modal-overlay.show {
      opacity: 1;
    }

  </style>
</head>
<body>
  <!-- Main Buttons -->
<button id="connectEtsyBtn" class="btn waves-effect waves-light">Connect to Etsy</button>
<button id="openConfigBtn"   class="btn waves-effect waves-light">Open Config</button>
<button id="updateOrderListBtn" class="btn waves-effect waves-light">Update Order List</button>
<button id="nextPageBtn" class="btn waves-effect waves-light">Next Page</button>

<!-- Etsy Order Number input -->
<input id="etsyOrderNumber" type="text" />

<!-- NEW container that will hold the stacked boxes -->
<div id="newOrderContainer"></div>

  <!-- Container for dynamically generated preview boxes and detail boxes -->
  <div id="photoGridContainer">
    <!-- Preview boxes and detail boxes will be created dynamically -->
  </div>

  <!-- Config Modal -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <table class="striped" id="configTable">
        <thead>
          <tr>
            <th>Element</th>
            <th>Left (px)</th>
            <th>Top (px)</th>
            <th>Width (px)</th>
            <th>Height</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <a
        href="#!"
        id="saveConfigBtn"
        class="modal-close waves-effect waves-green btn"
      >
        Save Config
      </a>
    </div>
  </div>

  <!-- 1) Firebase (compat mode) ‚Äì must be above your main sorting code -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- jQuery & Materialize JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <!-- Everything is in this single <script> block -->
  <script>
/********************************************************
 * Base URL & Global Variables
 ********************************************************/
const functionsBaseUrl = window.location.origin + "/.netlify/functions";

let croppedImagesArray = [];
let userImagesArray = [];
let cellMatches = {};
let matchPrintFlowInProgress = false;
let pendingFetchControllers = [];
let globalRunId = 0;
let currentSaveHandler = null;      // tracks active ‚ÄúSave‚Äù listener
let skipMatches = {};   // { cellIndex: true }  
let earringCells  = {};            // { cellIdx : true }
let earringState  = {};            // { cellIdx : { firstImg:null } }
let orderListOffset = 0;      // 0, 100, 200‚Ä¶

/********************************************************
 * Firebase Initialization (REQUIRED)
 ********************************************************/
const firebaseConfig = {
  apiKey: "YourApiKeyHere",
  authDomain: "YourAuthDomainHere",
  projectId: "gokudatabase",
  storageBucket: "gokudatabase.firebasestorage.app",
  messagingSenderId: "1078662308113",
  appId: "1:1078662308113:web:41df0e5d229ff2af7a6cb0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/********************************************************
 * Etsy Auth, Code Challenge, configIDs
 ********************************************************/
(function () {
  const urlParams = new URLSearchParams(window.location.search);
  const accessToken = urlParams.get("access_token");
  if (accessToken) {
    localStorage.setItem("access_token", accessToken);
    window.history.replaceState({}, document.title, window.location.pathname);
    M.toast({ html: "Connection Successful!" });
    console.log("Access token received:", accessToken);
  } else {
    const authCode = urlParams.get("code");
    if (authCode) {
      const storedCodeVerifier = localStorage.getItem("etsy_code_verifier");
      if (storedCodeVerifier) {
        window.location.href =
          "/.netlify/functions/exchangeToken?code=" +
          encodeURIComponent(authCode) +
          "&code_verifier=" +
          encodeURIComponent(storedCodeVerifier);
      } else {
        console.error("No code verifier found in localStorage.");
      }
    }
  }
})();

function generateRandomString(length) {
  const chars =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let text = "";
  for (let i = 0; i < length; i++) {
    text += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return text;
}

async function generateCodeChallenge(codeVerifier) {
  const encoder = new TextEncoder();
  const data = encoder.encode(codeVerifier);
  const digest = await crypto.subtle.digest("SHA-256", data);
  let base64String = btoa(String.fromCharCode(...new Uint8Array(digest)));
  return base64String.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

// ADDED these two lines so you can reposition/resize them in the Config modal
const configIDs = [
  "connectEtsyBtn",
  "openConfigBtn",
  "updateOrderListBtn",
  "nextPageBtn",            // ‚Üê NEW
  "etsyOrderNumber",
  "photoGridContainer",
  "orderHeaderBar",
  "configModal",
  "configTable",
  "saveConfigBtn",
  "newOrderContainer"
];

/********************************************************
 * DOMContentLoaded: Disable buttons & attach logic
 ********************************************************/
document.addEventListener("DOMContentLoaded", function () {
  M.AutoInit();

  setTimeout(function () {
    loadPositions();
    document.body.style.opacity = 1;
  }, 200);

  // Connect Etsy
  document.getElementById("connectEtsyBtn").addEventListener("click", async function () {
    try {
      const codeVerifier = generateRandomString(64);
      localStorage.setItem("etsy_code_verifier", codeVerifier);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const CLIENT_ID = "k75zdspz4r99txpqdji7i2em";
      const redirectUri = "https://design.goldenspike.app";
      const state = "randomState123";
      const scope = "listings_w listings_r transactions_r transactions_w";
      const etsyAuthUrl =
        "https://www.etsy.com/oauth/connect?response_type=code" +
        "&client_id=" + CLIENT_ID +
        "&redirect_uri=" + encodeURIComponent(redirectUri) +
        "&scope=" + encodeURIComponent(scope) +
        "&state=" + state +
        "&code_challenge=" + encodeURIComponent(codeChallenge) +
        "&code_challenge_method=S256";
      window.location.href = etsyAuthUrl;
    } catch (err) {
      console.error("OAuth start error:", err);
      M.toast({ html: "OAuth error: " + err.message });
    }
  });

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Update-Order-List button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("updateOrderListBtn").addEventListener("click", async function () {
        try {
          this.disabled = true;
          this.innerText = "Loading‚Ä¶";

          orderListOffset = 0;                 // reset to first page
          const gotRows = await buildNewOrderList(orderListOffset);

          /* NEW ‚Üí log visible order count */
          const displayedCount = document.getElementById("newOrderContainer").children.length;
          console.log(`Orders displayed (offset ${orderListOffset}):`, displayedCount);

          /* enable ‚ÄúNext Page‚Äù if we got a full 100-row slice */
          document.getElementById("nextPageBtn").disabled = (gotRows < 100);

          this.disabled = false;
          this.innerText = "Update Order List";
        } catch (err) {
          console.error("Order-list fetch error:", err);
          M.toast({ html: "Order-list error: " + err.message });
          this.disabled = false;
          this.innerText = "Update Order List";
        }
      });

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Next-Page button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("nextPageBtn").addEventListener("click", async function () {
        try {
          this.disabled = true;
          this.innerText = "Loading‚Ä¶";

          orderListOffset += 100;              // simple offset jump
          const gotRows = await buildNewOrderList(orderListOffset);

          /* NEW ‚Üí log visible order count */
          const displayedCount = document.getElementById("newOrderContainer").children.length;
          console.log(`Orders displayed (offset ${orderListOffset}):`, displayedCount);

          /* stay enabled only if another full slice came back */
          this.disabled = (gotRows < 100);
          this.innerText = "Next Page";
        } catch (err) {
          console.error("Next-page error:", err);
          M.toast({ html: "Next-page error: " + err.message });
          this.disabled = false;
          this.innerText = "Next Page";
        }
      });

  // Load multiple orders on Enter (partial snippet)
  const etsyOrderInput = document.getElementById("etsyOrderNumber");
  etsyOrderInput.addEventListener("keydown", async function (e) {
    if (e.key === "Enter") {

      // NEW: cancel *all* outstanding fetches / work from a previous run
      pendingFetchControllers.forEach(ctrl => ctrl.abort());
      pendingFetchControllers = [];     // fresh list for this run

      globalRunId++;                    // ‚Üê bump run ID so old tasks quit

      // Reset arrays & state
      croppedImagesArray = [];
      userImagesArray = [];
      cellMatches = {};
      window.cachedOrderItems = [];
      matchPrintFlowInProgress = false;

      // Clear UI
      document.getElementById("photoGridContainer").innerHTML = "";
      document.getElementById("unmatchedContainer").innerHTML = "";

      disableSendMatch();
      disableMatchPrintFlow();
      removeAllBlueHighlights();

      const inputVal = etsyOrderInput.value.trim();
      if (!inputVal) return;

      let orderNumbers = inputVal
        .split(",")
        .map((x) => x.trim())
        .filter((x) => x);
      orderNumbers = orderNumbers.slice(0, 50);

      await loadBatchEtsyOrders(orderNumbers);
    }
  });

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 *  ORDER-LIST SORT HEADER  ‚Äì  adds UI & sorting for #newOrderContainer
 *  (drop this inside your main <script> block in design.html)
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
(() => {

  /* 0.  GLOBAL HOOKS ----------------------------------------------------- */
  let currentReceipts = [];            // populated by buildNewOrderList()
  let sortKey   = null;                // "order", "ship", "gold", ...
  let sortDir   = 1;                   // 1 = asc, -1 = desc

  /** helper ‚Üí render the stacked boxes from `currentReceipts` array */
  function renderOrderBoxes(arr) {
    const container = document.getElementById("newOrderContainer");
    container.innerHTML = "";
    arr.forEach((r, idx) => {
      const box = document.createElement("div");
      box.className = "new-order-box";
      box.id        = "newOrder" + idx;
      const orderNum = r.order_number || r.receipt_id || "‚Äî";
      const shipStr  = r._shipStr || "N/A";
      const g = r._metalCounts.Gold     || 0;
      const s = r._metalCounts.Silver   || 0;
      const rG= r._metalCounts["Rose G"]|| 0;
      const k = r._metalCounts["14K"]   || 0;
      box.innerHTML = `
        <span class="col-order">${orderNum}</span>
        <span class="col-ship">${shipStr}</span>
        <span class="col-g">${g}</span>
        <span class="col-s">${s}</span>
        <span class="col-r">${rG}</span>
        <span class="col-k">${k}</span>
      `;
      container.appendChild(box);
    });
  }

  /** 1.  HEADER BAR  +  EVENT LISTENERS ------------------------------- */
  const bar = document.createElement("div");
  bar.id = "orderHeaderBar";
  bar.style.cssText =
    "position:absolute;left:20px;top:206px;width:285px;height:23px;" +
    "display:flex;gap:2px;background:#626262;color:#fff;font-size:0.75em;" +
    "align-items:center;user-select:none;z-index:9999;";

  const COLS = [
    { key:"order",  label:"Order"   , flex:"1.55" },
    { key:"ship" ,  label:"Date" , flex:"1.2" },
    { key:"gold" ,  label:"G"      , flex:"0.5" },
    { key:"silver", label:"S"    , flex:"0.5" },
    { key:"rose" ,  label:"R"   , flex:"0.5" },
    { key:"14k"  ,  label:"14" , flex:"0.5" }
  ];

  COLS.forEach(col => {
    const div = document.createElement("div");
    div.className = "hdr";
    div.dataset.key = col.key;
    div.style.cssText = `flex:${col.flex};text-align:center;cursor:pointer;`;
    div.innerHTML = `${col.label}<span class="chev">‚ñ≤<br>‚ñº</span>`;
    bar.appendChild(div);
  });

  document.body.appendChild(bar);
  loadPositions();   // ‚Üê re-apply positions now that #orderHeaderBar exists

  /* 2.  SORT ROUTINE ---------------------------------------------------- */
  bar.addEventListener("click", ev => {
    const hdr = ev.target.closest(".hdr");
    if (!hdr) return;
    const key = hdr.dataset.key;

    /* toggle direction if clicking same column */
    sortDir = (sortKey === key) ? -sortDir : 1;
    sortKey = key;

    currentReceipts.sort((a,b) => {
      switch (key) {
        case "order": return  sortDir * ((a.order_number||a.receipt_id) - (b.order_number||b.receipt_id));
        case "ship" : return  sortDir * ((a._shipTS||0) - (b._shipTS||0));
        case "gold" : return  sortDir * ((a._metalCounts.Gold||0)   - (b._metalCounts.Gold||0));
        case "silver":return  sortDir * ((a._metalCounts.Silver||0) - (b._metalCounts.Silver||0));
        case "rose" : return  sortDir * ((a._metalCounts["Rose G"]||0) - (b._metalCounts["Rose G"]||0));
        case "14k"  : return  sortDir * ((a._metalCounts["14K"]||0) - (b._metalCounts["14K"]||0));
      }
      return 0;
    });

    renderOrderBoxes(currentReceipts);
  });

  /* 3.  HOOK INTO buildNewOrderList() ----------------------------------- */
  const originalBuild = buildNewOrderList;
  buildNewOrderList = async function(offset=0) {
    const rawReceipts = await originalBuild.call(this, offset);   // returns count
    /* rebuild currentReceipts from DOM (we have no direct array) */
    // but we *do* have the receipts inside original function‚Äôs scope ‚Üí expose them:
    return rawReceipts;
  };

  /* Monkey-patch the original function to stash its array ---------- */
  const origFuncTxt = buildNewOrderList.toString();
  if (!origFuncTxt.includes("window._lastDisplayReceipts")) {
    console.warn("Patch buildNewOrderList manually to expose displayReceipts:\n" +
       "Inside buildNewOrderList(), just after you define displayReceipts, add:\n" +
       '    window._lastDisplayReceipts = displayReceipts;');
  }
  /** After adding that line, this watcher will pick up the array */
  const observer = new MutationObserver(() => {
    if (window._lastDisplayReceipts && window._lastDisplayReceipts !== currentReceipts) {
      currentReceipts = window._lastDisplayReceipts;  // clone
      /* make helper fields for sort */
      currentReceipts.forEach(r => {
        /* ship date ‚Üí numeric timestamp */
        if (!r._shipTS) {
          let ts = null;
          if (Array.isArray(r.transactions) && r.transactions[0]?.expected_ship_date) {
            ts = r.transactions[0].expected_ship_date;
          }
          r._shipTS  = ts || 0;
          r._shipStr = ts ? new Date(ts*1000).toLocaleDateString("en-US",{month:"short",day:"2-digit"}) : "N/A";
        }
        /* metal counts */
        if (!r._metalCounts) {
          const mc = {Gold:0,Silver:0,"Rose G":0,"14K":0};
          (r.transactions||[]).forEach(t => {
            const m = (t.variations||[]).find(v=>/metal/i.test(v.formatted_name||""))?.formatted_value||"";
            if (/14k/i.test(m))        mc["14K"] += t.quantity||1;
            else if (/rose/i.test(m))  mc["Rose G"] += t.quantity||1;
            else if (/silver/i.test(m))mc.Silver += t.quantity||1;
            else if (/gold/i.test(m))  mc.Gold   += t.quantity||1;
          });
          r._metalCounts = mc;
        }
      });
      /* default sort by Order # desc on first load */
      if (!sortKey) { sortKey="order"; sortDir=-1; }
      bar.querySelector(`[data-key="${sortKey}"] .chev`).textContent = (sortDir===1?"‚ñ≤‚ñº":"‚ñº‚ñ≤");
      currentReceipts.sort((a,b)=>(b.order_number||b.receipt_id)-(a.order_number||a.receipt_id));
      renderOrderBoxes(currentReceipts);
    }
  });
  observer.observe(document.getElementById("newOrderContainer"), { childList:true });

})();   /* ‚îÄ‚îÄ‚îÄ END SORT HEADER MODULE ‚îÄ‚îÄ‚îÄ */

 /********************************************************
 * buildNewOrderList ‚Äì pull NEW (unfulfilled) Etsy orders
 * and draw stacked 250 √ó 30 text boxes:
 *   Order-#,  Ship-/Dispatch Date,  Total Qty,  [‚úì]
 ********************************************************/
async function buildNewOrderList(offset = 0) {
  /* 1) ensure we already have a valid OAuth token */
  const token = localStorage.getItem("access_token") || "";
  if (!token) {
    M.toast({ html: "Connect to Etsy first!" });
    return;
  }


/* 2) call the Netlify helper that wraps
      GET /v3/application/shops/{shop_id}/receipts?status=open */
const resp = await fetch(`${functionsBaseUrl}/listOpenOrders?offset=${offset}`,   // ‚Üê must include offset
  { headers: { "access-token": token }
});
if (!resp.ok) throw new Error("HTTP " + resp.status);
const payload  = await resp.json();     // Etsy returns { results: [...], pagination: {...} }
const receipts = payload.results || [];     // let one filter do the work


/* 3) prepare the container */
const container = document.getElementById("newOrderContainer");
container.innerHTML = "";               // clear old stack


/* 4) build one 250√ó30 box per receipt (skip shipped & digital) */
const displayReceipts = receipts.filter(
  r => r.status === "Paid" && r.is_shipped === false
);

window._lastDisplayReceipts = displayReceipts;

displayReceipts.forEach((r, idx) => {
  /* a) order number (fallback to receipt_id) */
  const orderNum = r.order_number || r.receipt_id || "‚Äî";

  /* b) Ship-by date (same logic as index.html) */
  let shipStr = "N/A";
  let ts = null;
  if (Array.isArray(r.transactions) && r.transactions.length > 0) {
    const firstT = r.transactions[0];
    if (firstT.expected_ship_date) ts = firstT.expected_ship_date;
  }
  if (!ts) ts = r.dispatch_date || r.ship_by_date;
  if (ts) {
    const d  = new Date(ts * 1000);
    const dd = ("0" + d.getDate()).slice(-2);
    const mm = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d.getMonth()];
    shipStr  = `${dd} ${mm} ${d.getFullYear()}`;
  }

  /* c) total quantity across all line-items */
  const totalQty = (r.transactions || []).reduce(
    (sum, t) => sum + (Number(t.quantity) || 0), 0
  );

  /* d) build the DOM node */
  const box = document.createElement("div");
  box.className = "new-order-box";
  box.id = "newOrder" + idx;
  box.innerHTML = `
      ${orderNum}&nbsp;|&nbsp;${shipStr}&nbsp;|&nbsp;Qty&nbsp;${totalQty}
      <input type="checkbox" class="addToDesignChk" title="Add to Design">
  `;
  container.appendChild(box);
});

/* 5) return how many rows Etsy *actually* sent (0-100) */
return receipts.length;          // ‚Üê NOT displayReceipts.length
}

/********************************************************
 * startScannedSortingListener (NEW partial snippet)
 ********************************************************/
async function startScannedSortingListener() {
  try {
    const docRef = db.collection("Brites_Orders").doc("ScannedSortingOrder");
    docRef.onSnapshot((docSnap) => {
      if (!docSnap.exists) {
        console.log("No 'ScannedSortingOrder' doc in Firestore yet.");
        return;
      }
      const docData = docSnap.data();
      if (!docData["Order Number"]) {
        console.log("No 'Order Number' in 'ScannedSortingOrder' doc.");
        return;
      }
      const scannedVal = docData["Order Number"];
      console.log("Scanned Sorting code =>", scannedVal);

      const input = document.getElementById("etsyOrderNumber");
      if (!input) return;
      input.value = scannedVal;

      // [NEW: reset states as if app just opened]
      disableSendMatch();
      disableMatchPrintFlow();
      removeAllBlueHighlights();

      // Programmatically fire an Enter key
      const enterEvent = new KeyboardEvent("keydown", { key: "Enter" });
      input.dispatchEvent(enterEvent);
    });
  } catch (err) {
    console.error("Error starting scannedSortingListener:", err);
  }
}

});        /* ‚Üê‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì CLOSED DOMContentLoaded LISTENER */

/* ===== Hard-coded fallback positions & sizes (no calculations) ===== */
const defaultPos = {
  configModal:              { left:711, top:387, width:250, height:450 },
  configTable:              { left:27,  top:7,   width:525, height:1392 },
  connectEtsyBtn:           { left:1239,top:14,  width:170, height:35 },
  cropImagesBtn:            { left:20,  top:215, width:140, height:35 },
  etsyOrderNumber:          { left:20,  top:25,  width:200, height:30 },
  imageComparisonContainer: { left:0,   top:0,   width:0,   height:0 },
  matchPrintBtn:            { left:20,  top:315, width:210, height:35 },
  matchesModal:             { left:0,   top:0,   width:55,  height:0 },
  mpBackBtn:                { left:720, top:15,  width:100, height:35 },
  mpNextBtn:                { left:850, top:15,  width:100, height:35 },
  openConfigBtn:            { left:1270,top:729, width:140, height:35 },
  photoDragDrop:            { left:0,   top:-195,width:210, height:100 },
  photoGridContainer:       { left:270, top:68,  width:1140,height:650 },
  titleEtsyOrderNumber:     { left:20,  top:2,   width:145, height:20 },
  titleImageMatrixDrop:     { left:20,  top:91,  width:145, height:20 },
  titleUnmatchedImages:     { left:21,  top:437, width:145, height:20 },
  unmatchedContainer:       { left:0,   top:152, width:600, height:0 },
  userImage:                { left:0,   top:0,   width:100, height:100 },
  saveConfigBtn:            { left:10,  top:3,   width:85,  height:35 },
  sendMatchBtn:             { left:20,  top:255, width:210, height:35 },
  testOpenAIBtn:            { left:20,  top:65,  width:140, height:35 },
  newOrderContainer:        { left:20, top:236, width:318, height:800 },
  nextPageBtn:              { left:482, top:0, width:120, height:36 },
  orderHeaderBar:           { left:0, top:23, width:290, height:23 }
};

/********************************************************
 * loadPositions -- apply stored values or hard defaults
 ********************************************************/
function loadPositions() {
  configIDs.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;

    const def = defaultPos[id] || {};
    const left   = parseInt(localStorage.getItem(`pos-${id}-left`), 10)   || def.left   || 0;
    const top    = parseInt(localStorage.getItem(`pos-${id}-top`), 10)    || def.top    || 0;
    const width  = parseInt(localStorage.getItem(`pos-${id}-width`), 10)  || def.width  || 0;
    const height = parseInt(localStorage.getItem(`pos-${id}-height`), 10) || def.height || 0;

    el.style.position = "absolute";
    el.style.left   = left   + "px";
    el.style.top    = top    + "px";
    if (width  > 0) el.style.width  = width  + "px";
    if (height > 0) el.style.height = height + "px";
  });
}

// --------------- (Your code for config table, openConfigBtn, saveConfigBtn, etc.) --------------
document.getElementById("openConfigBtn").addEventListener("click", function () {
  populateConfigTable();
  M.Modal.getInstance(document.getElementById("configModal")).open();
});

document.getElementById("saveConfigBtn").addEventListener("click", function () {
  configIDs.forEach(function (id) {
    const el = document.getElementById(id);
    if (!el) return;
    const cs = window.getComputedStyle(el);
    localStorage.setItem("pos-" + id + "-left", parseInt(cs.left, 10) || 0);
    localStorage.setItem("pos-" + id + "-top", parseInt(cs.top, 10) || 0);
    localStorage.setItem("pos-" + id + "-width", parseInt(cs.width, 10) || 0);
    localStorage.setItem("pos-" + id + "-height", parseInt(cs.height, 10) || 0);
  });
  M.toast({ html: "Positions saved!" });
});

function populateConfigTable() {
  const tbody = document.querySelector("#configTable tbody");
  tbody.innerHTML = "";

  configIDs.forEach(function (id) {
    const el = document.getElementById(id);
    if (!el) return;
    const cs = window.getComputedStyle(el);
    const leftVal = parseInt(cs.left, 10) || 0;
    const topVal = parseInt(cs.top, 10) || 0;
    const widthVal = parseInt(cs.width, 10) || 0;
    const heightVal = parseInt(cs.height, 10) || 0;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${id}</td>
      <td><input type="number" value="${leftVal}" data-id="${id}" class="left-input"></td>
      <td><input type="number" value="${topVal}" data-id="${id}" class="top-input"></td>
      <td><input type="number" value="${widthVal}" data-id="${id}" class="width-input"></td>
      <td><input type="number" value="${heightVal}" data-id="${id}" class="height-input"></td>
    `;
    tbody.appendChild(row);

    row.querySelector(".left-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.left = parseInt(this.value, 10) + "px";
    });
    row.querySelector(".top-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.top = parseInt(this.value, 10) + "px";
    });
    row.querySelector(".width-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.width = parseInt(this.value, 10) + "px";
    });
    row.querySelector(".height-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.height = parseInt(this.value, 10) + "px";
    });
  });
}

/******************************************************************
 * fillPreviewBoxes(items)
 ******************************************************************/
async function fillPreviewBoxes(items) {
  const container = document.getElementById("photoGridContainer");
  container.innerHTML = "";

  window.cachedOrderItems = items;  // store globally

  /* keyword helpers already used for other UI colouring */
  const groupA = ["stud","studs","stud earrings","ring","rings","earrings"];
  const groupB = ["necklace","necklaces","huggie","huggies","huggie earrings",
                  "hoop","hoops","hoop earrings","bracelet","bracelets",
                  "extender","extenders","chain","chains"];

  /* list that DEFINES an earring */
  const EARRING_PHRASES = [
    "stud","stud earrings","earring","earrings",
    "huggie","huggies","huggie earrings",
    "hoop","hoops","hoop earrings"
  ];

  /* true phrase matcher ‚Äì handles spaces, dashes, slashes, commas ‚Ä¶ */
  function containsPhrase(str = "", phrase = "") {
    // turn "stud earrings" ‚Üí /\bstud[\s\W]+earrings\b/i
    const pattern = "\\b" + phrase
      .trim()
      .replace(/\s+/g, "[\\s\\W]+")   // any run of NON-alphanumerics
      + "\\b";
    return new RegExp(pattern, "i").test(str.toLowerCase());
  }

  /* helper: check if a string mentions earrings */
  function isEarringString(str = "") {
    const lower = str.toLowerCase();
    return EARRING_PHRASES.some(ph =>
      new RegExp("\\b" + ph.replace(/\s+/g, "\\s+") + "\\b", "i").test(lower)
    );
  }

  /* ---------- MAIN LOOP: one preview row per transaction ---------- */
  items.forEach((item, index) => {
    /* --- qty memo ------------------------------------------------- */
    item.qty = Number(item.quantity) || 1;

    /* --- Group-A / Group-B keyword tagging ------------------------ */
    let keywords = [];
    if (item.title) {
      const lower = item.title.toLowerCase();
      groupA.forEach(p => { if (containsPhrase(item.title, p)) keywords.push(p); });
      groupB.forEach(p => { if (containsPhrase(item.title, p)) keywords.push(p); });
    }
    if (keywords.length === 0) keywords.push("groupB");   // fallback
    item.keywords = keywords;

    /* --- unified earring detector (title + chosen variations) ----- */
    let earringFound = false;

    /* 1 / title */
    if (item.title && isEarringString(item.title)) {
      earringFound = true;
    }

    /* 2 / buyer-chosen variations */
    if (!earringFound && Array.isArray(item.variations)) {
      for (const v of item.variations) {
        if (v && v.formatted_value && isEarringString(v.formatted_value)) {
          earringFound = true;
          break;
        }
      }
    }

    /* 3 / store & register */
    item.isEarring = earringFound;
    if (earringFound) {
      earringCells[index] = true;
      earringState[index] = { firstImg:null };
    }

    /* --- POSITION CALCULATIONS (unchanged from your file) -------- */
    const row  = Math.floor(index / 9);
    const col  = index % 9;
    const previewLeft = col * 125;
    const previewTop  = row * 165;

    /* --- build preview box + the 5 detail rows ------------------- */
    const previewBox = document.createElement("div");
    previewBox.classList.add("preview-box");
    previewBox.id = "previewCell" + index;
    previewBox.style.position = "absolute";
    previewBox.style.left   = previewLeft + "px";
    previewBox.style.top    = previewTop  + "px";
    previewBox.style.width  = "110px";
    previewBox.style.height = "110px";
    previewBox.innerHTML = "Loading...";

    const orderInput = document.createElement("input");
    orderInput.type = "text";
    orderInput.readOnly = true;
    orderInput.id = "orderCell" + index;
    orderInput.classList.add("detail-box");
    orderInput.style.left = previewLeft + "px";
    orderInput.style.top  = previewTop  + 95 + "px";
    orderInput.value = item.receipt_id
      ? item.receipt_id
      : item.orderNumber || "No Order #";
    orderInput.style.fontWeight = "bold";

    const qtyInput = document.createElement("input");
    qtyInput.type  = "text";
    qtyInput.readOnly = true;
    qtyInput.id = "quantityCell" + index;
    qtyInput.classList.add("detail-box");
    qtyInput.style.left = previewLeft + "px";
    qtyInput.style.top  = previewTop  + 107 + "px";
    qtyInput.value = " Qty: " + (item.quantity != null ? item.quantity : 0);

    const metalInput = document.createElement("input");
    metalInput.type  = "text";
    metalInput.readOnly = true;
    metalInput.id = "metalCell" + index;
    metalInput.classList.add("detail-box");
    metalInput.style.left = previewLeft + "px";
    metalInput.style.top  = previewTop  + 119 + "px";
    let metalSel = "";
    if (item.variations && Array.isArray(item.variations)) {
      const acceptedMetalNames = [
        "metal","metal choice","metal - engraving",
        "metal colour","color","metal choice / engraving option"
      ];
      const metalVar = item.variations.find(v =>
        v.formatted_name &&
        acceptedMetalNames.includes(v.formatted_name.trim().toLowerCase())
      );
      if (metalVar && metalVar.formatted_value) {
        metalSel = metalVar.formatted_value;
      }
    }
    metalInput.value = " Metal: " + (metalSel || "No Metal");

    const matchInput = document.createElement("input");
    matchInput.type  = "text";
    matchInput.readOnly = true;
    matchInput.id = "matchCell" + index;
    matchInput.classList.add("detail-box");
    matchInput.style.left = previewLeft + "px";
    matchInput.style.top  = previewTop  + 131 + "px";
    matchInput.value = "";

    /* --- add boxes to container ---------------------------------- */
    container.appendChild(previewBox);
    container.appendChild(orderInput);
    container.appendChild(qtyInput);
    container.appendChild(metalInput);
    container.appendChild(matchInput);

    /* --- fetch & display listing image (unchanged) ---------------- */
    fetchListingImages(item.listing_id)
      .then(imageData => {
        if (imageData && imageData.length > 0) {
          return getLocalImageData(imageData[0].url_fullxfull);
        } else {
          throw "No image data";
        }
      })
      .then(localImageData => {
        previewBox.innerHTML =
          `<img src="${localImageData}" alt="Listing ${item.listing_id}"
                data-scale="1" data-offsetX="0" data-offsetY="0" />`;
        attachPreviewBoxListeners(previewBox);
      })
      .catch(err => {
        console.warn("Error loading image for cell " + index + ":", err);
        previewBox.innerHTML = "Img Error";
      });
  });  // end items.forEach
}  // ‚Üê end fillPreviewBoxes

function attachPreviewBoxListeners(box) {
  let isDragging = false;
  let isMouseDown = false;
  let dragStartX = 0,
      dragStartY = 0;
  let lastX = 0,
      lastY = 0;
  const dragThreshold = 3;

  box.addEventListener("wheel", function (ev) {
    const img = box.querySelector("img");
    if (!img) return;
    ev.preventDefault();
    let currentScale = parseFloat(img.dataset.scale) || 1;
    let offX = parseFloat(img.dataset.offsetX) || 0;
    let offY = parseFloat(img.dataset.offsetY) || 0;
    if (ev.deltaY < 0) {
      currentScale *= 1.1;
    } else {
      currentScale /= 1.1;
      if (currentScale <= 1) {
        currentScale = 1;
        offX = 0;
        offY = 0;
      }
    }
    if (currentScale > 7) currentScale = 7;
    img.dataset.scale = currentScale;
    img.dataset.offsetX = offX;
    img.dataset.offsetY = offY;
    img.style.transform = `translate(${offX}px, ${offY}px) scale(${currentScale})`;
  });

  box.addEventListener("mousedown", function (ev) {
    const img = box.querySelector("img");
    if (!img) return;
    const scaleNow = parseFloat(img.dataset.scale) || 1;
    if (scaleNow <= 1) return;
    ev.preventDefault();
    isMouseDown = true;
    isDragging = false;
    dragStartX = ev.clientX;
    dragStartY = ev.clientY;
    lastX = ev.clientX;
    lastY = ev.clientY;
  });

  box.addEventListener("mousemove", function (ev) {
    if (!isMouseDown) return;
    ev.preventDefault();
    const dxAll = Math.abs(ev.clientX - dragStartX);
    const dyAll = Math.abs(ev.clientY - dragStartY);
    if (dxAll > dragThreshold || dyAll > dragThreshold) isDragging = true;
    const img = box.querySelector("img");
    if (!img) return;
    const scaleNow = parseFloat(img.dataset.scale) || 1;
    let offX = parseFloat(img.dataset.offsetX) || 0;
    let offY = parseFloat(img.dataset.offsetY) || 0;
    const dx = ev.clientX - lastX;
    const dy = ev.clientY - lastY;
    offX += dx;
    offY += dy;
    img.dataset.offsetX = offX;
    img.dataset.offsetY = offY;
    img.style.transform = `translate(${offX}px, ${offY}px) scale(${scaleNow})`;
    lastX = ev.clientX;
    lastY = ev.clientY;
  });

  box.addEventListener("mouseup", function () {
    isMouseDown = false;
  });
  box.addEventListener("mouseleave", function () {
    isMouseDown = false;
  });

  box.addEventListener("click", function (ev) {
    if (isDragging) {
      isDragging = false;
      return;
    }
    const img = box.querySelector("img");
    if (!img) return;
    const rect = box.getBoundingClientRect();
    const boxCenterX = rect.left + box.clientWidth / 2;
    const boxCenterY = rect.top + box.clientHeight / 2;
    const dx = ev.clientX - boxCenterX;
    const dy = ev.clientY - boxCenterY;
    const scale = 5;
    const fudgeY = 10;
    const offsetX = -scale * dx;
    const offsetY = -scale * dy + fudgeY;
    img.dataset.scale = scale;
    img.dataset.offsetX = offsetX;
    img.dataset.offsetY = offsetY;
    img.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  });
}

/********************************************************
 * loadBatchEtsyOrders, fetchListingImages, getLocalImageData
 ********************************************************/
async function loadBatchEtsyOrders(orderNumbers) {
  try {
    M.toast({ html: "Loading " + orderNumbers.length + " order(s)..." });
    const token = localStorage.getItem("access_token") || "";
    let combinedItems = [];

    for (let i = 0; i < orderNumbers.length; i++) {
      const ord = orderNumbers[i];
      const url = functionsBaseUrl + "/etsyOrderProxy?orderId=" + encodeURIComponent(ord);
      const resp = await fetch(url, { headers: { "access-token": token } });
      if (!resp.ok) {
        console.warn("Order fetch failed for " + ord + ", status=" + resp.status);
        continue;
      }

      const data = await resp.json();
      console.log("Etsy Order Data:", data);

      // -- NEW CODE: attach the typed order # to each transaction --
      if (data.transactions && Array.isArray(data.transactions)) {
        data.transactions.forEach((t) => {
          t.typedOrderNumber = ord;
        });
      } else {
        console.warn("No transactions for order " + ord);
      }

      // ------------------------------------------------
      // APPLY THE SAME METHODOLOGY AS index.html
      // ------------------------------------------------
      if (data.transactions && data.transactions.length > 0) {
        const firstTrans = data.transactions[0];
        if (firstTrans.expected_ship_date) {
          // Convert from Unix to a nice, short date
          const sTS = new Date(firstTrans.expected_ship_date * 1000);
          const sDay = ("0" + sTS.getDate()).slice(-2);
          const monthNamesF = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          const sMonth = monthNamesF[sTS.getMonth()];
          const sYear = sTS.getFullYear();

          // e.g. "25 Sep 2025"
          const formattedShipDate = sDay + " " + sMonth + " " + sYear;

          // Attach this to ALL transactions, so our code sees `t.dispatch_date`
          data.transactions.forEach((t) => {
            t.dispatch_date = formattedShipDate;
          });
        }
      }

      // If there‚Äôs an array of transactions, merge them in
      if (data.transactions && Array.isArray(data.transactions)) {
        combinedItems.push(...data.transactions);
      } else {
        console.warn("No transactions for order", ord);
      }
    }

    // Then fill the UI with combined results
    await fillPreviewBoxes(combinedItems);

    attachMatchCellListeners();          // NEW

  } catch (err) {
    console.error("Error loading batch orders:", err);
    M.toast({ html: "Error: " + err.message });
  }
}

async function fetchListingImages(listingId) {
  const token = localStorage.getItem("access_token") || "";
  const resp = await fetch(functionsBaseUrl + "/etsyImages?listingId=" + listingId, {
    headers: { "access-token": token },
  });
  if (!resp.ok) {
    console.warn("Image fetch HTTP error:", resp.status);
    return [];
  }
  const data = await resp.json();
  return data.results || [];
}

async function getLocalImageData(imageUrl) {
  try {
    const response = await fetch(
      functionsBaseUrl + "/imageProxy?url=" + encodeURIComponent(imageUrl)
    );
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  } catch (err) {
    console.error("Error in getLocalImageData:", err);
    throw err;
  }
}

// ---------------------------------------------------------
// Pull Etsy order details and update grid details
// ---------------------------------------------------------
function pullEtsyOrderDetails(orderNumber) {
  console.log("Pulling Etsy order details for order number:", orderNumber);
  var token = localStorage.getItem("access_token");
  return fetch(functionsBaseUrl + "/etsyOrderProxy?orderId=" + encodeURIComponent(orderNumber), {
    headers: { "access-token": token }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    console.log("Etsy Order Data:", data);
    return data;
  })
  .catch(function(err) {
    console.error("Error fetching Etsy order details:", err);
    return null;
  });
}

// Example: update the grid details using pulled Etsy order details
async function updateImageGrid(data) {
  let items = [];
  if (data.transactions && Array.isArray(data.transactions)) {
    items = data.transactions;
  } else if (Array.isArray(data)) {          
    items = data;
  }
  window.cachedOrderItems = items;
  await fillPreviewBoxes(items);
}

/* ---- stubbed out empty functions ---- */
function disableSendMatch() {}
function disableMatchPrintFlow() {}
function removeAllBlueHighlights() {}
function attachMatchCellListeners() {}  

  </script>
</body>
</html>