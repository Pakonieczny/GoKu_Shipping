<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sorting - Single-Click Zoom</title>
  <!-- Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
  <style>
    body {
      background-color: #fff;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0;
      transition: opacity 0s;
    }
    /* Main Buttons */
    #connectEtsyBtn, 
    #openConfigBtn {
      position: absolute;
      left: 20px;
      width: 140px;
      height: 36px;
    }
    #connectEtsyBtn {
      top: 20px;
    }
    #openConfigBtn {
      top: 120px;
    }

    /* Etsy Order Number input */
    #etsyOrderNumber {
      position: absolute;
      left: 20px;
      top: 270px;
      width: 300px;
      height: 30px;
      border: 1px solid #999;
      padding: 4px;
      outline: none;
      font-size: 0.9em;
    }

    .loadingTxt{
      color:#2196F3;          /* same blue as spinner + hover outline */
    }

    /* wrapper holds spinner + text and centres them */
    .loadingWrap{
      display:inline-flex;
      align-items:center;      /* vertical centring */
      gap:6px;                 /* keeps the space you had */
    }

    .metal-counter{
      position:absolute;
      font-size:0.8em;             /* ‚Üê 0 .8 em */
      background:#fff9c4;
      padding:4px 8px;
      border:1px solid #999;
    }

    /* spinner keeps its blue look & spin */
    @keyframes btnSpin{100%{transform:rotate(360deg)}}
    .spinner{
      width:18px;height:18px;
      border:3px solid transparent;border-top-color:#2196F3;border-radius:50%;
      animation:btnSpin .7s linear infinite;
    }
    .loadingTxt{color:#2196F3;}

    /* Image Comparison UI */
    #imageComparisonContainer {
      position: absolute;
      left: 20px;
      top: 310px;
    }

    /* --- Update-Order-List button --- */
    #updateOrderListBtn {
      position: absolute;
      left: 20px;
      top: 170px;           /* 50 px below ‚ÄúOpen Config‚Äù */
      width: 160px;
      height: 36px;
    }


    /* ‚îÄ‚îÄ‚îÄ Header-bar chevrons ‚îÄ‚îÄ‚îÄ */
    #orderHeaderBar .chev{
      font-size:66%;          /* 33 % smaller */
      line-height:0.85em;
      display:inline-block;
      vertical-align:middle;
    }

    /* listing-detail modal layout */
    .modal-flex-row{
      display:flex;
      align-items:flex-start;
    }

/* column wrapper ‚Äì sits 20 px right of the image */
.modal-notes-col{
  margin-left:20px;
  display:flex;
  flex-direction:column;
}

/* remove old left-margin so notes align with input */
.modal-notes-col #modalListingNotes{ margin:0; }

/* staff-note field */
#modalStaffNote{
  width:300px;
  height:35px;
  margin-top:40px;
  padding:4px;
  border:1px solid #999;
}

    /* fixed thumbnail size, border stays */
    #modalListingImg{
      width:200px;
      height:200px;
      object-fit:cover;
      border:1px solid #ccc;
    }

    /* message box sits 20 px to the right, grows with content */
    #modalListingNotes{
      white-space:pre-wrap;
      margin:0 0 0 20px;     /* ‚Üë left margin = 20 px */
      background:#f5f5f5;
      padding:8px;
      border-radius:4px;
      flex:1;
    }

    /* --- Container that holds the stacked ‚ÄúnewOrder‚Äù boxes --- */
    #newOrderContainer {
      position: absolute;
      left: 20px;
      top: 236px;          /* 30 px below the 206 px bottom of Update-Order button */
      width: 318px;
      height: 800px;       /* scrollable window */
      overflow-y: auto;
      border: 1px dashed #bbb;
      padding: 4px;
      background: #fafafa;
    }

    /* active metal counter = blue 3 px outline */
    .metal-counter.active{ outline:3px solid #2196f3; }

    /* 3-px orangered flag for personalization / buyer-message */
    .preview-attn{
      outline:none;
      box-shadow:0 0 0 4px orangered;
    }

    .new-order-box {
      position: relative;

      /* 1 ‚ñ∏ make it a grid, not flex */
      display: grid;                 /* üî∏ REPLACES display:flex */

      /* 2 ‚ñ∏ give each column its exact width */
      grid-template-columns: 103px 67px 25px 25px 25px 25px;

      /* optional overall breathing room between columns */
      column-gap: 5px;              /* tweak this to taste */

      /* 3 ‚ñ∏ let the row size itself, or set an explicit width that
             matches your columns + gaps (80+90+30*4 + 10*5 = 320 px).   */
      width: 290px;                  /* or simply remove width:‚Ä¶ */

      height: 35px;
      margin-bottom: 10px;
      align-items: center;
      font-size: 0.9em;
      border: 1px solid #999;
      padding-left: 4px;
      background: #f5f5f5;
    }
    .new-order-box input[type="checkbox"] {
      position: absolute;
      right: 6px;
      top: 6px;
    }

    /* put right after your .new-order-box rule */
    .new-order-box.selected{
      background:#FFE2B5 !important;   /* force-override any other bg */
    }

    /* ‚îÄ‚îÄ‚îÄ Hover outline for each order row ‚îÄ‚îÄ‚îÄ */
    .new-order-box:hover{
      outline:3px solid #2196F3;   /* vivid blue circumference */
      outline-offset:-1px;         /* keeps outline snug inside row */
    }



    /* Container for dynamically generated preview boxes and detail boxes */
    #photoGridContainer {
      position: relative;
      width: 1500px;
      max-height: 830px;
      overflow-y: auto;
      border-left: 1px dashed #ccc;
      border-right: 1px dashed #ccc;
      left: 350px;
      top: 20px;
    }

    /* === keep images square & clipped inside preview boxes === */
    .preview-box {
      width: 110px;          /* box itself */
      height: 110px;
      overflow: hidden;      /* clip anything that spills */
    }

    .preview-box img {
      width: 110%;
      height: 110%;
      object-fit: cover;     /* center-crop to square */
    }  

    /* ‚îÄ‚îÄ‚îÄ circular 15-px page buttons ‚îÄ‚îÄ‚îÄ */
    .page-btn{
      width:15px;height:15px;
      border-radius:50%;
      background:#eeeeee;color:#000;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:9px;margin:2px;cursor:pointer;border:1px solid #999;
    }
    .page-btn.active{
      background:#2196F3;color:#fff;
    }

    /* Detail text boxes: 55px x 7px */
    .detail-box {
      position: absolute;
      width: 55px;
      height: 7px;
      font-size: 0.6em !important;
      border: none !important;
      outline: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
      background: #f0f0f0;
      color: #333;
      padding: 0;
      margin: 0;
      box-shadow: none !important;
    }

    /* container for the three read-only boxes */
    .modal-detail-row{
      margin-top:7px;
      display:block;               /* stack vertically */
    }

    /* individual read-only box */
    .modal-detail-row input{
      display:block !important;    /* one per line */
      width:200px !important;
      height:20px !important;                 /* ‚Üê fixed height 20 px */
      line-height:20px !important;            /* keep text vertically centered */

      font-size:0.9em !important;

      /* remove Materialize underline & glow */
      border:none !important;
      border-bottom:none !important;
      box-shadow:none !important;

      background:transparent;
      padding:0 2px;               /* small left/right inset */

      margin:0 0 2px 0 !important; /* 2 px gap below each box */
    }

    /* prevent focus style from re-adding underline */
    .modal-detail-row input:focus{
      border-bottom:none !important;
      box-shadow:none !important;
    }

    /* pointer-events enabled on read-only inputs */
    .detail-box:read-only {
      pointer-events: auto !important;
      cursor: pointer !important;
    }

    /* finished orders in the side list */
    .new-order-box.completed{
      background:#4caf50 !important;   /* Materialize green-500 */
      color:#fff;
    }

    .wrap-preview.preview-attn{
      outline:none;                     /* (no !important) so hover can override */
      box-shadow:0 0 0 4px orangered;   /* 4-px warning ring */
    }

    /* purple + bold when Staff Note exists */
    .new-order-box.has-staff-note{
      font-weight:700;
      color:purple;
    }

    /* ‚Äî‚Äî 3-px BLUE hover ring (outer) ‚Äî‚Äî */
    #photoGridContainer .wrap-preview:hover{
      box-shadow: 0 0 0 3px #2196F3 !important;  /* outer blue ring */
      outline:0;                                 /* never suppressed */
      z-index:10;
    }

    /* Config Modal */
    #configModal.modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 250px !important;
      height: 450px !important;
      max-height: none !important;
      overflow-y: auto !important;
    }
    #configTable thead tr th {
      font-size: 0.9em;
    }
    #configTable tbody tr td {
      font-size: 0.8em;
    }
    #configTable .left-input,
    #configTable .top-input,
    #configTable .width-input,
    #configTable .height-input {
      width: 80px !important;
    }
    .modal {
      opacity: 0 !important;
      transform: translateY(20px) scale(0.95) !important;
      will-change: opacity, transform;
      transition: opacity 300ms ease, transform 300ms ease;
    }
    .modal.open {
      opacity: 1 !important;
      transform: translateY(0) scale(1) !important;
    }
    .modal-overlay {
      opacity: 0;
      will-change: opacity;
      transition: opacity 300ms ease;
    }
    .modal-overlay.show {
      opacity: 1;
    }

    /* UI-only: hide the Completed metal counter */
    #completedCounter{display:none!important;}

    /* ‚Äî‚Äî‚Äî BLUE hover ring always sits INSIDE the 4-px orangered ring ‚Äî‚Äî‚Äî */
    #photoGridContainer .wrap-preview.preview-attn:hover{
      box-shadow: 0 0 0 4px orangered,      /* outer warning ring  */
                  inset 0 0 0 3px #2196F3;  /* inner blue ring     */
    }

    /* subtle grey placeholder, 40 % opacity */
    #etsyOrderNumber::placeholder {
      color: rgba(128,128,128,0.4);   /* grey at 40 % */
    }

    /* =========================================================
     * Hover helper ‚Äî 3-px BLUE ring for rows + previews
     * ========================================================*/
    .hover-blue.new-order-box{
      outline:3px solid #2196F3;
      outline-offset:-2px;           /* keeps it inside the row */
      z-index:10;
    }

    .hover-blue.wrap-preview{
      box-shadow:0 0 0 3px #2196F3;  /* blue ring (outside)     */
      z-index:10;
    }

    .hover-blue.preview-attn{
      box-shadow:0 0 0 4px orangered,   /* keep red/orange ring */
                 inset 0 0 0 3px #2196F3;
    }

    /* === Listing-modal COMPLETE checkbox === */
    .modal-complete-label{
      position:absolute;        /* pins to modal‚Äôs top-left corner */
      left:10px;
      top:10px;
      cursor:pointer;
      user-select:none;
    }
    .modal-complete-label input[type="checkbox"]+span{
      /* scale the visible square up a bit */
      transform:scale(1.3);
      margin:0;                 /* kill Materialize‚Äôs default margin */
    }

  </style>
</head>
<body>
  <!-- Main Buttons -->
<button id="connectEtsyBtn"    class="btn waves-effect waves-light">Connect</button>
<button id="openConfigBtn"     class="btn waves-effect waves-light">Open Config</button>
<button id="updateOrderListBtn"class="btn waves-effect waves-light">Update</button>
<button id="clearBtn"          class="btn red lighten-1">Clear</button>
<!-- <button id="clearCompletedBtn" class="btn orange lighten-1">Clear Completed</button>-->

<!-- NEW green ‚ÄúComplete !‚Äù button (drag-positionable inside the modal) -->
<button id="completeBtn"
    class="btn green"
    style="position:absolute;left:20px;top:220px;width:140px;height:36px;">
  Complete&nbsp;!
</button>

<!-- Etsy Order Number input -->
<input id="etsyOrderNumber"
       placeholder="Search Order Number" />

<!-- NEW container that will hold the stacked boxes -->
<div id="newOrderContainer"></div>

<!-- Page-jump buttons will appear here -->
<div id="pageButtonsContainer"></div>

<!-- Live metal counters (draggable via Config modal) -->
<div id="goldCounter"   class="metal-counter active" data-metal="gold">Gold: 0          <!-- ‚Üê renamed label -->
</div>

<div id="silverCounter" class="metal-counter active" data-metal="silver">Silver: 0        <!-- ‚Üê renamed label -->
</div>

<div id="roseCounter"   class="metal-counter active" data-metal="rose">Rose: 0
</div>

<div id="completedCounter" class="metal-counter" data-metal="completed">Completed
</div>

<div id="solidCounter"  class="metal-counter active" data-metal="14k">14K: 0
</div>

<!-- Container that will hold temporarily unmatched images -->
<div id="unmatchedContainer"></div>

<!-- Container for dynamically generated preview boxes and detail boxes -->
<div id="photoGridContainer">
  <!-- Preview boxes and detail boxes will be created dynamically -->
</div>

<!-- Config Modal -->
<div id="configModal" class="modal">
  <div class="modal-content">
    <table class="striped" id="configTable">
      <thead>
        <tr>
          <th>Element</th>
          <th>Left&nbsp;(px)</th>
          <th>Top&nbsp;(px)</th>
          <th>Width&nbsp;(px)</th>
          <th>Height</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="modal-footer">
    <a href="#!" id="saveConfigBtn"
       class="modal-close waves-effect waves-green btn">
      Save Config
    </a>
  </div>
</div>

<!-- 1) Firebase (compat mode) ‚Äì must be above your main sorting code -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- jQuery & Materialize JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<!-- Everything is in this single <script> block -->
<script>

let searchActive = false;     // true ‚á¢ we‚Äôre inside single-order search


/********************************************************
 * Base URL & Global Variables
 ********************************************************/
const functionsBaseUrl = window.location.origin + "/.netlify/functions";
const selectedOrders = new Set();      // receipt_id strings
const orderCache     = {};             // receipt_id ‚Üí transactions[]
const gridElements   = new Map();      // transaction_id ‚Üí wrapper DOM
let   lastCtrlIdx    = null;           // ‚¨ÖÔ∏è  anchor for Ctrl/‚åò range-select

/* =====  Staff-Note highlighting  =================================== */
let staffNoteIDs = new Set();

async function refreshStaffNoteIDs(){
  try{
    const res  = await fetch(`${functionsBaseUrl}/firebaseOrders?staffNotes=1`);
    const json = await res.json();
    if(json.success) staffNoteIDs = new Set(json.orderNumbers.map(String));
  }catch(e){ console.error(e); }
}

function markStaffNoteOrders(){
  document.querySelectorAll(".new-order-box").forEach(box=>{
    const id = box.dataset.receipt || box.dataset.orderNumber;
    if(staffNoteIDs.has(String(id))){
      box.classList.add("has-staff-note");
    }else{
      box.classList.remove("has-staff-note");
    }
  });
}

/* ==== SEARCH SNAPSHOT (for restoring UI) ==== */
let searchSnapshot = null;             // { orderHTML, gridHTML, gridMap }
const processedTxIds = new Set();      // guards against duplicate preview tiles

/* storage keys */
const COMPLETED_KEY = "completedOrders";   // green-list

/* ‚îÄ‚îÄ‚îÄ helper: recount items and update the little badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function refreshRowCount(receiptId){
  const box = document.querySelector(`.new-order-box[data-receipt='${receiptId}']`);
  if (!box) return;
  const cntEl = box.querySelector(".badge-count");
  if (!cntEl) return;
  cntEl.textContent = (orderCache[receiptId] || []).length;
}

/* ‚îÄ‚îÄ‚îÄ helper: recalc metal counts for one row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function refreshRowMetalCounts(receiptId){
  const row = document.querySelector(`.new-order-box[data-receipt='${receiptId}']`);
  if (!row) return;

  let g = 0, s = 0, rG = 0, k = 0;
  (orderCache[receiptId] || []).forEach(tx => {
    let m = tx._wrapEl?.dataset.metal || tx._metalKey || "";

    if (!m && Array.isArray(tx.variations)) {
      for (const v of tx.variations) {
        if (!v?.formatted_name || !v?.formatted_value) continue;
        if (/metal|color|colour/i.test(v.formatted_name.trim())) {
          m = v.formatted_value.toLowerCase();
          break;
        }
      }
    }

    const q = tx.quantity || 1;
    if (m === "14k" || /14\s*k\s*solid/i.test(m))  k += q;   // accept row key ‚Äú14k‚Äù too
    else if (/rose/.test(m))   rG += q;
    else if (/silv(?:er|r)/.test(m)) s  += q;
    else if (/gold/.test(m))   g  += q;
  });

  row.querySelector(".col-g").textContent = g;
  row.querySelector(".col-s").textContent = s;
  row.querySelector(".col-r").textContent = rG;
  row.querySelector(".col-k").textContent = k;

  const rowMetal = k ? "14k" : rG ? "rose" : s ? "silver" : g ? "gold" : "";
  if (rowMetal) row.dataset.metal = rowMetal;
}

const SELECTED_KEY   = "selectedOrders";         // orange-list
const LAST_PURGE_KEY = "completed_last_purge";   // ISO month stamp
const completedOrders = new Set();               // IDs that are already green

/* ===== revive completed set from localStorage (runs immediately) ===== */
(() => {
  const raw = localStorage.getItem(COMPLETED_KEY);
  if (!raw) return;
  try {
    const obj = JSON.parse(raw);
    Object.values(obj).flat().forEach(id => completedOrders.add(String(id).trim()));
  } catch (err) {
    console.warn("Couldn‚Äôt parse saved completed list:", err);
  }
})();

/* ------------------------------------------------------------------
 *  INIT - make sure completedOrders is filled BEFORE any UI action
 * ------------------------------------------------------------------*/
(function initCompletedSet(){
  const raw = localStorage.getItem(COMPLETED_KEY);
  if (!raw) return;
  try{
    const obj = JSON.parse(raw);                 // { "YYYY-MM":[‚Ä¶] ‚Ä¶ }
    Object.values(obj).flat()
      .forEach(id => completedOrders.add(String(id)));
  }catch(e){
    console.warn("Completed-list parse error:", e);
  }
})();

let croppedImagesArray = [];
let userImagesArray = [];
let cellMatches = {};
let matchPrintFlowInProgress = false;
let pendingFetchControllers = [];
let globalRunId = 0;
let currentSaveHandler = null;      // tracks active ‚ÄúSave‚Äù listener
let skipMatches = {};   // { cellIndex: true }  
let earringCells  = {};            // { cellIdx : true }
let earringState  = {};            // { cellIdx : { firstImg:null } }
let orderListOffset = 0;      // 0, 100, 200‚Ä¶

/********************************************************
 * Firebase Initialization (REQUIRED)
 ********************************************************/
const firebaseConfig = {
  apiKey: "YourApiKeyHere",
  authDomain: "YourAuthDomainHere",
  projectId: "gokudatabase",
  storageBucket: "gokudatabase.firebasestorage.app",
  messagingSenderId: "1078662308113",
  appId: "1:1078662308113:web:41df0e5d229ff2af7a6cb0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/********************************************************
 * Etsy Auth, Code Challenge, configIDs
 ********************************************************/
(function () {
  const urlParams = new URLSearchParams(window.location.search);
  const accessToken = urlParams.get("access_token");
  if (accessToken) {
    localStorage.setItem("access_token", accessToken);
    window.history.replaceState({}, document.title, window.location.pathname);
    M.toast({ html: "Connection Successful!" });
    console.log("Access token received:", accessToken);
  } else {
    const authCode = urlParams.get("code");
    if (authCode) {
      const storedCodeVerifier = localStorage.getItem("etsy_code_verifier");
      if (storedCodeVerifier) {
        window.location.href =
          "/.netlify/functions/exchangeToken?code=" +
          encodeURIComponent(authCode) +
          "&code_verifier=" +
          encodeURIComponent(storedCodeVerifier);
      } else {
        console.error("No code verifier found in localStorage.");
      }
    }
  }
})();

function generateRandomString(length) {
  const chars =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let text = "";
  for (let i = 0; i < length; i++) {
    text += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return text;
}

async function generateCodeChallenge(codeVerifier) {
  const encoder = new TextEncoder();
  const data = encoder.encode(codeVerifier);
  const digest = await crypto.subtle.digest("SHA-256", data);
  let base64String = btoa(String.fromCharCode(...new Uint8Array(digest)));
  return base64String.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

// ADDED these two lines so you can reposition/resize them in the Config modal
const configIDs = [
  "connectEtsyBtn",
  "openConfigBtn",
  "updateOrderListBtn",
  "nextPageBtn",            // ‚Üê NEW
  "clearBtn",
  "etsyOrderNumber",
  "photoGridContainer",
  "orderHeaderBar",
  "configModal",
  "configTable",
  "saveConfigBtn",
  "newOrderContainer",
  "pageButtonsContainer",
  "completeBtn",          // ‚Üê NEW
  "goldCounter",
  "silverCounter",
  "roseCounter",
  "solidCounter"

];

/********************************************************
 * DOMContentLoaded: Disable buttons & attach logic
 ********************************************************/
let listingModal;                     // ‚Üê NEW ‚ûä  (declare up-top)

document.addEventListener("DOMContentLoaded", () => {
  M.AutoInit();

  const completeBtn = document.getElementById("completeBtn");
  if (completeBtn) {
    completeBtn.addEventListener("click", handleCompleteClick);
  }

  /* ‚ù∂  wire "Complete !" button */
  document.getElementById("completeBtn").addEventListener("click", handleCompleteClick);

  /* ‚ù∑  load completed list and colour rows */
  restoreCompleted();

  /* ==============================================================
   *  Ctrl/‚åò-click  =  range-select between anchor ‚á¢ current
   * ============================================================*/
  const orderContainer = document.getElementById("newOrderContainer");
  if (!orderContainer.dataset.rangeWired){
    orderContainer.dataset.rangeWired = "1";

    orderContainer.addEventListener("click", async e => {
      if (!(e.ctrlKey || e.metaKey)) return;          // Ctrl (Win) or ‚åò (Mac)
      const box = e.target.closest(".new-order-box");
      if (!box) return;
      e.preventDefault();

      const rows = [...orderContainer.querySelectorAll(".new-order-box")];
      const curr = rows.indexOf(box);
      if (curr === -1) return;

      /* abort if no anchor has been set with a plain click */
      if (lastCtrlIdx === null) return;

      /* second Ctrl/‚åò-click ‚Üí select full range */
      const [from, to] = curr > lastCtrlIdx ? [lastCtrlIdx, curr] : [curr, lastCtrlIdx];
      for (let i = from; i <= to; i++){
        const row = rows[i];
        const rid = String(row.dataset.receipt);

        /* ‚¨áÔ∏è  pull order details if we‚Äôve never loaded this receipt */
        if (!orderCache[rid]){
          const ord = await pullEtsyOrderDetails(rid);
          orderCache[rid] = ord?.transactions || [];
          refreshRowCount(rid);
          refreshRowMetalCounts(rid);
        }

        /* mark row + Set */
        if (!selectedOrders.has(rid)){
          selectedOrders.add(rid);
          row.classList.add("selected");
        }

        /* ensure every transaction has a preview tile */
        orderCache[rid].forEach(tx => { if (!tx._inGrid) addPreviewBox(tx); });
      }

      realignGrid(); updateCounters(); persistSelection(); applyMetalFilter();

    });
  }

  /* ‚ù∏  run monthly purge */
  purgeOldCompleted();

  /* NEW ‚ûã: cache the listing-detail modal so helpers can open it */
  listingModal = M.Modal.init(document.getElementById("listingModal"));

  setTimeout(function () {
    loadPositions();
    document.body.style.opacity = 1;
  }, 200);

    const modalCompleteChk = document.getElementById("modalCompleteChk");
    modalCompleteChk.addEventListener("change", () => {
    const rid = modalCompleteChk.dataset.rid;
    if(!rid) return;                      // safety

    /* ‚Äî mark as completed ‚Äî */
    completedOrders.add(rid);             // global Set   [oai_citation:2‚Ä°design.html](file-service://file-UD87qPNcvFGdsBetdyBDoA)
    selectedOrders.delete(rid);

    /* remove/hide UI elements */
    document.querySelectorAll(
      `.new-order-box[data-receipt='${rid}']`
    ).forEach(el => el.remove());

    removePreviewBoxesForOrder(rid);      // existing helper
    persistCompleted();                   // commits bucket
    updateCounters();
    applyMetalFilter();

    listingModal.close();                 // done ‚Äì pop modal
  });

  // Connect Etsy
  document.getElementById("connectEtsyBtn").addEventListener("click", async function () {
    try {
      const codeVerifier = generateRandomString(64);
      localStorage.setItem("etsy_code_verifier", codeVerifier);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const CLIENT_ID = "k75zdspz4r99txpqdji7i2em";
      const redirectUri = "https://design.goldenspike.app";
      const state = "randomState123";
      const scope = "listings_w listings_r transactions_r transactions_w";
      const etsyAuthUrl =
        "https://www.etsy.com/oauth/connect?response_type=code" +
        "&client_id=" + CLIENT_ID +
        "&redirect_uri=" + encodeURIComponent(redirectUri) +
        "&scope=" + encodeURIComponent(scope) +
        "&state=" + state +
        "&code_challenge=" + encodeURIComponent(codeChallenge) +
        "&code_challenge_method=S256";
      window.location.href = etsyAuthUrl;
    } catch (err) {
      console.error("OAuth start error:", err);
      M.toast({ html: "OAuth error: " + err.message });
    }
  });

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Update-Order-List button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("updateOrderListBtn").addEventListener("click", async function () {
        try {
          this.disabled = true;
          this.innerHTML = '<span class="loadingWrap">' +
         '  <span class="spinner"></span>' +
         '  <span class="loadingTxt">Loading‚Ä¶</span>' +
         '</span>';

          orderListOffset = 0;                 // reset to first page
          const gotRows = await buildNewOrderList(orderListOffset);


          /* ‚Äî‚Äî FORCE a second green-pass after new rows exist ‚Äî‚Äî */
          highlightCompletedRows();                  // <-- NEW LINE
            window.applyMetalFilter();   // re-run filters immediately

          /* NEW ‚Üí log visible order count */
          const displayedCount = document.getElementById("newOrderContainer").children.length;
          console.log(`Orders displayed (offset ${orderListOffset}):`, displayedCount);

          this.disabled = false;
          this.innerHTML = "Update Order List";
        } catch (err) {
          console.error("Order-list fetch error:", err);
          M.toast({ html: "Order-list error: " + err.message });
          this.disabled = false;
          this.innerHTML = "Update Order List";
        }
      });


      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Clear button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      document.getElementById("clearBtn").addEventListener("click", () => {

        /* bail if nothing is selected */
        if (!selectedOrders.size) return;

        /* 1Ô∏è‚É£ remove browser persistence */
        localStorage.removeItem(SELECTED_KEY);          // legacy key
        localStorage.removeItem(STORAGE_KEY);           // current key "savedSelection"

        /* 2Ô∏è‚É£ loop through every receipt in the orange Set */
        selectedOrders.forEach(rid => {

          /* A. remove orange class from left-column row (if still in DOM) */
          const row = document.querySelector(
            `.new-order-box[data-receipt='${rid}']`);
          if (row) row.classList.remove("selected");

          /* B. nuke every preview wrap for that receipt (even if not orange) */
          document.querySelectorAll(
            `#photoGridContainer .wrap-preview[data-receipt='${rid}']`
          ).forEach(wrap => {
            /* drop from gridElements Map */
            for (const [k,v] of gridElements.entries()){
              if (v === wrap){ gridElements.delete(k); break; }
            }
            /* drop duplicate-guard */
            if (wrap.dataset.tx) processedTxIds.delete(wrap.dataset.tx);
            wrap.remove();                                 // remove from DOM
          });

          /* C. scrub caches */
          delete orderCache[rid];
          /* remove matching items from cachedOrderItems array */
          if (Array.isArray(window.cachedOrderItems)){
            window.cachedOrderItems =
              window.cachedOrderItems.filter(it => it.receipt_id !== rid);
          }
        });

        /* 3Ô∏è‚É£ finally clear the Set itself */
        selectedOrders.clear();

        /* 4Ô∏è‚É£ tidy UI */
        reflowGrid();            // closes photo-grid gaps
        updateCounters();        // top counters
        window.applyMetalFilter(); /* keeps current filter state */

        M.toast({ html: "Selection cleared" });
      });

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Clear Completed (green) button  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 
      const clrCompBtn = document.getElementById("clearCompletedBtn");
      if (clrCompBtn) {
        clrCompBtn.addEventListener("click", clearCompleted);   // ‚Üê NEW
      }*/

  // Load multiple orders on Enter (partial snippet)
  const etsyOrderInput = document.getElementById("etsyOrderNumber");
  etsyOrderInput.addEventListener("keydown", async function (e) {
    if (e.key === "Enter") {

      // NEW: cancel *all* outstanding fetches / work from a previous run
      pendingFetchControllers.forEach(ctrl => ctrl.abort());
      pendingFetchControllers = [];     // fresh list for this run

      globalRunId++;                    // ‚Üê bump run ID so old tasks quit

      // Reset arrays & state
      croppedImagesArray = [];
      userImagesArray = [];
      cellMatches = {};
      window.cachedOrderItems = [];
      matchPrintFlowInProgress = false;

  
      // Clear UI
      document.getElementById("photoGridContainer").innerHTML = "";
      const unmatchedEl = document.getElementById("unmatchedContainer");
      if (unmatchedEl) unmatchedEl.innerHTML = "";

      disableSendMatch();
      disableMatchPrintFlow();
      removeAllBlueHighlights();

      const inputVal = etsyOrderInput.value.trim();
      if (!inputVal) return;
      if (!inputVal.includes(",")) return;   // üëà skip bulk loader for single-order search

      let orderNumbers = inputVal
        .split(",")
        .map((x) => x.trim())
        .filter((x) => x);
      orderNumbers = orderNumbers.slice(0, 50);

      await loadBatchEtsyOrders(orderNumbers);
    }
  });

  /* ==============================================================
   *  Single-order SEARCH via #etsyOrderNumber
   * ============================================================*/
  (function attachSearch(){
    const input = document.getElementById("etsyOrderNumber");
    if (!input) return;

    /* ENTER ‚Üí run single-order search when no commas are present */
    input.addEventListener("keydown", async e => {
      searchActive = true;
      if (e.key !== "Enter") return;
      const raw = input.value.trim();
      if (!raw || raw.includes(",")) return;   // bulk loader handles lists
      e.preventDefault();
      e.stopImmediatePropagation();

      try {
        /* 1Ô∏è‚É£ snapshot UI (first time only) */
        const pg = document.getElementById("pageButtonsContainer");
        if (pg) pg.hidden = true;

        if (!searchSnapshot){
          searchSnapshot = {
            orderHTML : document.getElementById("newOrderContainer").innerHTML,
            gridHTML  : document.getElementById("photoGridContainer").innerHTML,
            gridMap   : new Map(gridElements)
          };
        }

        /* 2Ô∏è‚É£ clear current containers & map */
        document.getElementById("newOrderContainer").innerHTML  = "";
        document.getElementById("photoGridContainer").innerHTML = "";
        gridElements.clear();

        /* 3Ô∏è‚É£ fetch FULL order (includes personalization + buyer message) */
        M.toast({ html: `Searching ${raw}‚Ä¶` });
        const data    = await pullEtsyOrderDetails(raw);   // ‚Üê proxy call
        if (!data) throw new Error("Order not found");
        const txs     = data.transactions || [];
        const receipt = data.receipt     || {};
        const rid     = String(receipt.receipt_id || raw);

        /* ‚îÄ‚îÄ derive a readable ‚ÄúShip By‚Äù string ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        let shipDate = "N/A";
        const tsRaw =
                receipt.expected_ship_date ??
                receipt.dispatch_date      ??
                receipt.ship_by_date       ??
                txs[0]?.expected_ship_date ??
                txs[0]?.dispatch_date      ??
                txs[0]?.ship_by_date       ?? 0;

        if (typeof tsRaw === "number" && tsRaw > 86400) {
          const d = new Date(tsRaw * 1000);
          shipDate = d.toLocaleDateString("en-US", { month: "short", day: "2-digit" });
        } else if (typeof tsRaw === "string" && tsRaw.trim()) {
          shipDate = tsRaw;
        }

        /* 4Ô∏è‚É£ cache transactions so click-handlers work */
        orderCache[rid] = txs;

        /* 5Ô∏è‚É£ compute metal / qty counts */
        const cnt = { g:0, s:0, r:0, k:0 };
        txs.forEach(tx => {
          const q = tx.quantity || 1;
          switch (tx._metalKey) {
            case "gold":   cnt.g += q; break;
            case "silver": cnt.s += q; break;
            case "rose":   cnt.r += q; break;
            case "14k":    cnt.k += q; break;
          }
        });
        let rowMetal = "";
        if      (cnt.k) rowMetal = "14k";
        else if (cnt.r) rowMetal = "rose";
        else if (cnt.s) rowMetal = "silver";
        else if (cnt.g) rowMetal = "gold";

        /* 6Ô∏è‚É£ build sidebar row */
        const row = document.createElement("div");
        row.className       = "new-order-box";
        row.dataset.receipt = rid;
        row.dataset.metal   = rowMetal;
        row.innerHTML = `
          <span class="col-order">${receipt.order_number || raw}</span>
          <span class="col-ship">${shipDate}</span>
          <span class="col-g">${cnt.g}</span>
          <span class="col-s">${cnt.s}</span>
          <span class="col-r">${cnt.r}</span>
          <span class="col-k">${cnt.k}</span>`;
        document.getElementById("newOrderContainer").appendChild(row);

        /* colour row if it was already green/orange */
        if (completedOrders.has(rid))      row.classList.add("completed");
        else if (selectedOrders.has(rid))  row.classList.add("selected");

        /* 7Ô∏è‚É£ add preview tiles */
        txs.forEach(tx => { if (!tx._inGrid) addPreviewBox(tx); });

        /* 8Ô∏è‚É£ wire the row with normal click / hover listeners */
        (function wireRow(box){
          if (box.dataset.wired) return;
          box.dataset.wired = "1";

          /* CLICK ‚Üí toggle select */
          box.addEventListener("click", async e => {
          if (e.ctrlKey || e.metaKey) return;   // range-selector handles these
            const rid = String(box.dataset.receipt);

            if (selectedOrders.has(rid)) {          /* ‚Äî DESELECT ‚Äî */
              selectedOrders.delete(rid);
              box.classList.remove("selected");
              removePreviewBoxesForOrder(rid);
              realignGrid(); updateCounters(); persistSelection(); applyMetalFilter();
              return;
            }

            /* ‚Äî SELECT ‚Äî */
            selectedOrders.add(rid);
            box.classList.add("selected");
            /* set range-anchor on plain click */
            lastCtrlIdx = [...document.querySelectorAll("#newOrderContainer .new-order-box")]
                      .indexOf(box);
            orderCache[rid].forEach(tx => { if (!tx._inGrid) addPreviewBox(tx); });
            realignGrid(); updateCounters(); persistSelection(); applyMetalFilter();
          });

          /* HOVER ‚Üí outline concurrent previews */
          box.addEventListener("mouseenter", () => {
            if (!box.classList.contains("selected")) return;
            const rec = box.dataset.receipt;
            document.querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${rec}']`)
                    .forEach(w => w.classList.add("preview-highlight"));
          });
          box.addEventListener("mouseleave", () => {
            const rec = box.dataset.receipt;
            document.querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${rec}']`)
                    .forEach(w => w.classList.remove("preview-highlight"));
          });
        })(row);


        /* 9Ô∏è‚É£ final tidy-up */
        reflowGrid();
        updateCounters();
        applyMetalFilter();
        M.toast({ html:`Search complete (${txs.length} item${txs.length!==1?"s":""})` });

      } catch(err){
        console.error(err);
        M.toast({ html:"Order not found" });
      }
    });

    /* Empty box ‚Üí instant restore */
    input.addEventListener("input", async () => {
      if (input.value.trim() !== "") return;
      if (!searchSnapshot) return;
      searchActive = false;

      const pg = document.getElementById("pageButtonsContainer");
      if (pg) pg.hidden = false;

      /* 1Ô∏è‚É£ restore markup */
      document.getElementById("newOrderContainer").innerHTML  = searchSnapshot.orderHTML;
      document.getElementById("photoGridContainer").innerHTML = searchSnapshot.gridHTML;

      /* 2Ô∏è‚É£  Rebuild gridElements + re-hook preview listeners */
      gridElements.clear();
      document
        .querySelectorAll("#photoGridContainer .wrap-preview")
        .forEach((wrap, idx) => {
          const key = Number(wrap.dataset.idx) || idx;
          gridElements.set(key, wrap);

          /* preview zoom / pan / click */
          const boxEl = wrap.querySelector(".preview-box");
          if (boxEl) attachPreviewBoxListeners(boxEl);

          /* restore TX pointers if cachedOrderItems exists */
          const itemIdx = Number(wrap.dataset.idx);
          if (Array.isArray(window.cachedOrderItems) &&
              itemIdx >= 0 &&
              window.cachedOrderItems[itemIdx]) {
            window.cachedOrderItems[itemIdx]._inGrid  = true;
            window.cachedOrderItems[itemIdx]._wrapEl  = wrap;
          
          /* HOVER ‚Üí blue ring on preview + its row */
          wrap.addEventListener("mouseenter", () => {
            wrap.classList.add("hover-blue");
            const row = document.querySelector(`.new-order-box[data-receipt='${wrap.dataset.receipt}']`);
            if (row) row.classList.add("hover-blue");
          });
          wrap.addEventListener("mouseleave", () => {
            wrap.classList.remove("hover-blue");
            const row = document.querySelector(`.new-order-box[data-receipt='${wrap.dataset.receipt}']`);
            if (row) row.classList.remove("hover-blue");
          });

          }
        });

      /* ------- Ensure orange rows show their previews  (FULL REPLACE) ------- */
      selectedOrders.forEach(rid => {
        const list = orderCache[rid];
        if (!Array.isArray(list)) return;        // no cache for this receipt

        list.forEach(tx => {
          /* already have this TX wrap? */
          const wrapPresent = document.querySelector(
            `#photoGridContainer .wrap-preview[data-tx='${tx.transaction_id}']`
          );
          if (wrapPresent) return;

          /* flag reset & inject a fresh tile */
          tx._inGrid = false;                    // mark as absent
          addPreviewBox(tx);                     // re-adds + updates gridElements
        });
      });

      /* 3Ô∏è‚É£  Re-attach click / hover logic to every order row */
      document.querySelectorAll(".new-order-box").forEach(box => delete box.dataset.wired);  // reset flag
      document.querySelectorAll(".new-order-box").forEach(box => {
        if (box.dataset.wired) return;      // prevent duplicate wiring
        box.dataset.wired = "1";

        /* CLICK ‚Üí toggle orange selection & preview sync */
        box.addEventListener("click", async e => {
        if (e.ctrlKey || e.metaKey) return;   // range-selector handles these
          const rid = String(box.dataset.receipt);

          if (selectedOrders.has(rid)) {    /* ‚Äî DESELECT ‚Äî */
            selectedOrders.delete(rid);
            box.classList.remove("selected");
            removePreviewBoxesForOrder(rid);
            realignGrid();
            updateCounters();
            persistSelection();
            applyMetalFilter();
            return;
          }

          /* ‚Äî SELECT ‚Äî */
          selectedOrders.add(rid);
          box.classList.add("selected");

          if (!orderCache[rid]) {
            const ord = await pullEtsyOrderDetails(rid);
            orderCache[rid] = ord?.transactions || [];
            refreshRowCount(rid);
            refreshRowMetalCounts(rid);
          }
          orderCache[rid].forEach(tx => { if (!tx._inGrid) addPreviewBox(tx); });

          realignGrid();
          updateCounters();
          persistSelection();
          applyMetalFilter();
        });

        /* HOVER ‚Üí outline concurrent previews */
        box.addEventListener("mouseenter", () => {
          if (!box.classList.contains("selected")) return;
          const rec = box.dataset.receipt;
          document
            .querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${rec}']`)
            .forEach(w => w.classList.add("preview-highlight"));
        });
        box.addEventListener("mouseleave", () => {
          const rec = box.dataset.receipt;
          document
            .querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${rec}']`)
            .forEach(w => w.classList.remove("preview-highlight"));
        });

        /* HOVER ‚Üí blue ring on row + all its previews */
        box.addEventListener("mouseenter", () => {
          box.classList.add("hover-blue");
          document
            .querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${box.dataset.receipt}']`)
            .forEach(w => w.classList.add("hover-blue"));
        });
        box.addEventListener("mouseleave", () => {
          box.classList.remove("hover-blue");
          document
            .querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${box.dataset.receipt}']`)
            .forEach(w => w.classList.remove("hover-blue"));
        });

        /* ‚ñº‚ñº  PASTE THE NEW BLOCK RIGHT HERE  ‚ñº‚ñº */
        box.addEventListener("mouseenter", () => {
          box.classList.add("hover-blue");
          document
            .querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${box.dataset.receipt}']`)
            .forEach(w => w.classList.add("hover-blue"));
        });
        box.addEventListener("mouseleave", () => {
          box.classList.remove("hover-blue");
          document
            .querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${box.dataset.receipt}']`)
            .forEach(w => w.classList.remove("hover-blue"));
        });

      });

      /* 4Ô∏è‚É£ final tidy-up */
      reflowGrid();
      updateCounters();
      applyMetalFilter();
      highlightCompletedRows();
      highlightSavedRows();

      searchSnapshot = null;
      M.toast({ html:"Search cleared" });
    });

  })();   /* ‚Üê single, final close of attachSearch */

  /* =====================================================================
   *  LOCAL-STORAGE PERSISTENCE  ‚Äî  selected orders + their transactions
   * ===================================================================== */
  const idStr = id => String(id);             // ‚Üê helper: always use string ids
  const STORAGE_KEY = "savedSelection";

  /* write current orange receipts ONLY (no transactions) */
  function persistSelection(){
    try{
      const data = {
        selected: [ ...selectedOrders ]   // simple string/number array
    };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }catch(err){
      console.warn("localStorage quota hit ‚Äî selection not saved:", err.message);
    }
  }

  /* read the saved receipt-ID list and rebuild from scratch */
  function restoreSelections(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;

    let data;  try{ data = JSON.parse(raw); } catch(e){ return; }

    /* 1Ô∏è‚É£  revive the set of selected order IDs ------------------ */
    selectedOrders.clear();
    (data.selected || []).forEach(id => selectedOrders.add(id));

    /* 2Ô∏è‚É£  wipe existing cache + grid ---------------------------- */
    Object.keys(orderCache).forEach(k => delete orderCache[k]);
    gridElements.clear();
    document.getElementById("photoGridContainer").innerHTML = "";

    /* 3Ô∏è‚É£  fetch each order again and rebuild previews ----------- */
    selectedOrders.forEach(async id => {
      const ord = await pullEtsyOrderDetails(id);   // fresh call to Etsy
      if (!ord) return;

      orderCache[id] = ord.transactions || [];
      orderCache[id].forEach(tx => addPreviewBox(tx));
    });

    /* 4Ô∏è‚É£  after boxes exist, colour the corresponding rows orange */
    setTimeout(() => {
    selectedOrders.forEach(id => {
      if (completedOrders.has(id)) return;        // ‚Üê NEW: skip green rows
      const row = document.querySelector(`.new-order-box[data-receipt='${id}']`);
      if (row) row.classList.add("selected");
    });
    }, 0);

    updateCounters();                    // refresh metal totals
  }



  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ handleCompleteClick ‚Äî URL-SAFE VERSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  async function handleCompleteClick() {
    /* 1Ô∏è‚É£  require ALL four metal filters (unchanged) */
    const REQUIRED = ["gold", "silver", "rose", "14k"];
    const active = Array.from(
      document.querySelectorAll('.metal-counter.active:not([data-metal="completed"])')
    ).map(b => b.dataset.metal);

    if (active.length !== 4 || !REQUIRED.every(m => active.includes(m))) {
      M.toast({ html: "Turn ON Gold Silver Rose 14K before completing" });
      return;
    }

    /* 2Ô∏è‚É£  collect every visible preview that matches those metals */
    const listsByMetal = { gold: [], silver: [], rose: [], "14k": [] };
    const greenIDs = new Set();

    document.querySelectorAll("#photoGridContainer .wrap-preview").forEach(w => {
      if (w.style.display === "none")          return;               // hidden
      const metal = w.dataset.metal;
      if (!REQUIRED.includes(metal))           return;               // wrong metal

      const rid = w.dataset.receipt;
      greenIDs.add(rid);
      if (!listsByMetal[metal].includes(rid)) listsByMetal[metal].push(rid);
    });

    if (!greenIDs.size) {
      M.toast({ html: "No matching orders" });
      return;
    }

    /* 3Ô∏è‚É£  mark completed + purge DOM & master cache (unchanged) */
    greenIDs.forEach(id => {
      completedOrders.add(id);
      selectedOrders.delete(id);

      /* sidebar rows */
      document.querySelectorAll(`.new-order-box[data-receipt='${id}']`)
              .forEach(r => r.remove());

      /* preview tiles */
      removePreviewBoxesForOrder(id);
    });
    allOpenReceipts = allOpenReceipts.filter(r => !greenIDs.has(String(r.receipt_id)));

    /* 4Ô∏è‚É£  recompute paging (unchanged) */
    if (typeof orderListOffset === "undefined") window.orderListOffset = 0;
    const totalPages = Math.ceil(allOpenReceipts.length / 100) || 1;
    if (orderListOffset >= allOpenReceipts.length) {
      orderListOffset = (totalPages - 1) * 100;
    }

    await buildNewOrderList(orderListOffset);     // redraw rows + buttons
    realignGrid();                                // tighten grid gaps

    /* 5Ô∏è‚É£  reset on-screen metal counters (unchanged) */
    REQUIRED.forEach(m => {
      const el = document.querySelector(`.metal-counter[data-metal='${m}']`);
      if (el) el.textContent = `${m.charAt(0).toUpperCase() + m.slice(1)}: 0`;
    });

    /* 6Ô∏è‚É£  persist + refresh (unchanged) */
    persistCompleted();
    persistSelection();
    updateCounters();
    applyMetalFilter();

    /* 7Ô∏è‚É£  hand off to design-print.html via HIDDEN iframe (no URL change) */
    const hasBundles = Object.values(listsByMetal).some(arr => arr.length);
    if (hasBundles) {
      localStorage.setItem("metalOrderLists", JSON.stringify(listsByMetal));

      const printFrame = document.createElement("iframe");
      printFrame.style.position   = "fixed";
      printFrame.style.visibility = "hidden";
      printFrame.style.right      = "9999px";
      printFrame.style.width      = "1px";
      printFrame.style.height     = "1px";
      printFrame.src = "design-print.html";      // loads silently, prints inside
      document.body.appendChild(printFrame);
    }

    M.toast({ html: "Completed orders removed ‚Äî pages recalculated" });
  }


  /* ‚îÄ‚îÄ save completed list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function persistCompleted(){
    const nowMonth = new Date().toISOString().slice(0,7);      // "YYYY-MM"
    const raw = localStorage.getItem(COMPLETED_KEY) || "{}";
    const obj = JSON.parse(raw);

    obj[nowMonth] = [ ...completedOrders ];                    // overwrite bucket
    localStorage.setItem(COMPLETED_KEY, JSON.stringify(obj));
  }

  /* -------------------------------------------------------------
     Clear all completed-order memory & remove green highlights
  ------------------------------------------------------------- */
  function clearCompleted(){

    /* snapshot IDs before we wipe the Set */
    const greens = [ ...completedOrders ];

    /* 1 ‚ñ∏ purge localStorage buckets */
    localStorage.removeItem(COMPLETED_KEY);    // ID buckets
    localStorage.removeItem(LAST_PURGE_KEY);   // last-purge stamp

    /* 2 ‚ñ∏ reset in-memory tracking */
    completedOrders.clear();

    /* 3 ‚ñ∏ remove every green row & its previews */
    greens.forEach(rid => {

      /* A. sidebar row */
      document.querySelectorAll(
        `.new-order-box[data-receipt='${rid}']`
      ).forEach(row => row.classList.remove("completed"));

      /* B. photo-grid wraps */
      document.querySelectorAll(
        `#photoGridContainer .wrap-preview[data-receipt='${rid}']`
      ).forEach(wrap => {
        for (const [k,v] of gridElements.entries()){
          if (v === wrap){ gridElements.delete(k); break; }
        }
        wrap.remove();
      });

      /* C. caches */
      delete orderCache[rid];
      processedTxIds.forEach(txid=>{
        if (txid.startsWith(rid)) processedTxIds.delete(txid);
      });
    });

    /* D. trim the global item cache (if it exists) */
    if (Array.isArray(window.cachedOrderItems)){
      window.cachedOrderItems =
        window.cachedOrderItems.filter(it =>
          !greens.includes(String(it.receipt_id)));
    }

    /* 4 ‚ñ∏ UI tidy */
    reflowGrid();
    updateCounters();
    window.applyMetalFilter();

    M.toast({ html:"Completed orders cleared" });
  }

  /* ‚îÄ‚îÄ restore completed list on load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function restoreCompleted(){
    const raw = localStorage.getItem(COMPLETED_KEY);
    if (!raw) return;
    const obj = JSON.parse(raw);

    /* convert every ID to string before adding to the Set */
    Object.values(obj).flat().forEach(id => completedOrders.add(String(id)));

    /* the rest of the function is unchanged */
    completedOrders.forEach(id=>{
      const box = document.querySelector(`.new-order-box[data-receipt="${id}"]`);
      if (box){
        box.classList.remove("selected");
        box.classList.add("completed");
      }
      removePreviewBoxesForOrder(id);
    });

    realignGrid();
  }

  /* ‚îÄ‚îÄ purge buckets older than 2 months (run once per load) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function purgeOldCompleted(){
    const now = new Date();
    const last   = localStorage.getItem(LAST_PURGE_KEY) || "";
    const nowKey = now.toISOString().slice(0,7);               // "YYYY-MM"

    /* if we already purged this month, skip */
    if (last === nowKey) return;

    const raw = localStorage.getItem(COMPLETED_KEY) || "{}";
    const obj = JSON.parse(raw);

    /* drop buckets older than 2 months */
    Object.keys(obj).forEach(ym=>{
      const [y,m] = ym.split("-").map(n=>parseInt(n,10));
      const dt = new Date(y, m-1);                   // first of that month
      const diff = (now.getFullYear()-dt.getFullYear())*12 + (now.getMonth()-dt.getMonth());
      if (diff > 1) delete obj[ym];                 // keep 0 or 1 months ago
    });

    localStorage.setItem(COMPLETED_KEY, JSON.stringify(obj));
    localStorage.setItem(LAST_PURGE_KEY, nowKey);
  }

  /* -----------------------------------------------------------------
     Paint orange rows, but NEVER repaint something that is already
     marked completed (green).  This guarantees green always wins,
     even if an ID-type mismatch exists between the two Sets.
  ------------------------------------------------------------------*/
  function highlightSavedRows(){
    selectedOrders.forEach(id => {
      const row = document.querySelector(
            `.new-order-box[data-receipt='${id}']`);

      if (!row) return;                      // row not on this page
      if (row.classList.contains("completed")) return;  // already green

      row.classList.add("selected");         // paint orange only once
    });
  }

  /* colour every row whose receipt_id is in completedOrders */
  function highlightCompletedRows() {
    document.querySelectorAll(".new-order-box").forEach(box => {
      const rid = box.dataset.receipt;
      if (completedOrders.has(rid)) {
        box.classList.remove("selected");  // make sure orange never sticks
        box.classList.add("completed");    // paint (or re-paint) green
      } else {
        box.classList.remove("completed"); // remove green if no longer done
      }
    });
  }

  /* =========================================================
  *  LIVE COUNTER updater   (GLOBAL)
  *   ‚Ä¢ counts EVERY preview, even hidden ones,
  *     so totals stay correct when a metal is toggled off
  * ========================================================= */
 function updateCounters(){
   let g = 0, s = 0, r = 0, k = 0;
 
   gridElements.forEach(wrap => {
    if (completedOrders.has(wrap.dataset.receipt)) return;
     const qty = Number(wrap.dataset.qty) || 1;
     switch (wrap.dataset.metal){
       case "gold":   g += qty; break;
       case "silver": s += qty; break;
       case "rose":   r += qty; break;
       case "14k":    k += qty; break;
     }
   });
 
   document.getElementById("goldCounter").innerText   = "Gold: "      + g;
   document.getElementById("silverCounter").innerText = "Silver: "    + s;
   document.getElementById("roseCounter").innerText   = "Rose: " + r;
   document.getElementById("solidCounter").innerText  = "14K: " + k;
 }

   // expose the helper so fillPreviewBoxes() can call it
   window.updateCounters = updateCounters;

    /* =======================================================
     * GLOBAL PREVIEW HELPERS ‚Äì accessible from any click-handler
     * ======================================================= */

      /* ===== removePreviewBoxesForOrder ‚Äî GLOBAL VERSION ===== */
      function removePreviewBoxesForOrder(receiptId){

        console.log("%cREMOVE", "color:#d500f9",
            "receipt:", receiptId,
            "wraps in grid before:", document.querySelectorAll(
              `.wrap-preview[data-receipt='${receiptId}']`).length);

        /* skip removals for completed (green) orders */
        if (completedOrders.has(receiptId)) return;

        /* PATCH ‚ñ∏ allow this order to be re-added next time */
     (orderCache[receiptId] || []).forEach(tx => {
       tx._inGrid = false;        // flip the guard-flag
       delete tx._wrapEl;         // drop stale DOM ref
     });
 
      /* ‚îÄ‚îÄ‚îÄ helper: recount items and update the little badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      function refreshRowCount(receiptId){
        const box = document.querySelector(`.new-order-box[data-receipt='${receiptId}']`);
        if (!box) return;
        const cntEl = box.querySelector(".badge-count");     // ‚Üê your badge span
        if (!cntEl) return;
        cntEl.textContent = (orderCache[receiptId] || []).length;
      }

      /* 1 ‚ñ∏ delete every wrap belonging to this receipt */
      document.querySelectorAll(
        `#photoGridContainer .wrap-preview[data-receipt='${receiptId}']`
      ).forEach(wrap => {
        wrap.remove();
        /* drop from gridElements map */
        for (const [k,v] of gridElements.entries()){
          if (v === wrap){ gridElements.delete(k); break; }
        }
      });

      /* 2 ‚ñ∏ scrub caches */
      delete orderCache[receiptId];
      processedTxIds.forEach(txid=>{
        if (txid.startsWith(receiptId)) processedTxIds.delete(txid);
      });

      /* 3 ‚ñ∏ UI tidy */
      reflowGrid();
      updateCounters();
    }
    window.removePreviewBoxesForOrder = removePreviewBoxesForOrder;   // expose

    /* append ONE preview without rebuilding the entire grid */
    function addPreviewBox(item){

        console.log(
        "%cADD-PREVIEW start",
        "color:#29b6f6",
        "TX:", item.transaction_id,
        "receipt:", item.receipt_id,
        "_inGrid:", !!item._inGrid,
        "pers:", item.personalization?.length,
        "buyerMsg:", !!item.message_from_buyer
      );

        /* already have this TX? ‚Äî skip duplicate */
        if (document.querySelector(
                `.wrap-preview[data-tx='${item.transaction_id}']`)) {
            console.log("%cDUP-CHECK","color:#ef5350",
            "tx", item.transaction_id, "wrapped ‚Üí SKIPPED");
          return;
        }

      /* build DOM node + auto-append */
      const wrap = makePreviewNode(item);
      gridElements.set(gridElements.size, wrap);   // bookkeeping

      /* outline if order already orange-selected */
      if (selectedOrders.has(String(item.receipt_id))) {
        wrap.classList.add("selected");
      }

      /* maintain cache & indices */
      if (!Array.isArray(window.cachedOrderItems)) window.cachedOrderItems = [];
      window.cachedOrderItems.push(item);
      wrap.dataset.idx = window.cachedOrderItems.length - 1;

      /* back-references on the item itself */
      item._inGrid = true;
      item._wrapEl = wrap;

      /* log attention-flagged listings */
      if (wrap.classList.contains("preview-attn")){
        console.log("ATTN:", item.listing_id,
                    item.personalization, item.message_from_buyer);
      }

      updateCounters();          // refresh metal counters
      window.applyMetalFilter(); // honour current filter state
      return wrap;
    }

    window.addPreviewBox = addPreviewBox;   // keep global handle

  /* build a preview row (image + 4 tiny detail inputs) */
  function makePreviewNode(item){
    const idx = gridElements.size;
    const row = Math.floor(idx / 12);
    const col = idx % 12;

    /* wrapper keeps receipt ID for easy lookup */
    const wrap = document.createElement("div");
    wrap.className = "wrap-preview";                 // <‚Äî NEW class
    wrap.dataset.receipt = item.receipt_id;          // <‚Äî NEW data-tag
    wrap.dataset.tx = item.transaction_id;   // NEW ‚Äî enables duplicate guard
    wrap.style.cssText = `position:absolute;left:${col*125}px;top:${row*165}px;`;

    /* preview image‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ */
    const box = document.createElement("div");
    box.className = "preview-box";
    box.innerHTML = "Loading‚Ä¶";
    wrap.appendChild(box);
    attachPreviewBoxListeners(box);

    /* 4 detail inputs ------------------------------------------------ */
    const addDetail = (id, y, val) => {
      const inp = document.createElement("input");
      inp.type       = "text";
      inp.readOnly   = true;
      inp.id         = id + idx;
      inp.className  = "detail-box";
      inp.dataset.idx= idx;               // ‚Üê NEW for modal lookup
      inp.style.cssText = `left:0px;top:${y}px;`;
      inp.value      = val;

      /* NEW ‚Äì open listing-detail modal when any detail box is clicked */
      inp.addEventListener("click", e => {
        e.stopPropagation();
        const parentWrap = e.currentTarget.closest(".wrap-preview");
        openListingModal(Number(parentWrap.dataset.idx));
      });

      wrap.appendChild(inp);
    };
    addDetail("orderCell"   ,  95, item.receipt_id || item.orderNumber || "No Order #");
    addDetail("quantityCell", 107, " Qty: " + (item.quantity ?? 0));

    /* ===== metal lookup, SKU, attention flag ========================== */
    let metalSel = "";
    let metalKey = "";
    let otherSel  = "";                    // NEW ‚Äì first non-metal variation

    if (Array.isArray(item.variations)) {
      const ok = [
        "metal",
        "metal choice",
        "metal - engraving",
        "metal colour",
        "color",
        "metal choice / engraving option"
      ];

      /* scan every variation */
      item.variations.forEach(v => {
        if (!v?.formatted_value) return;                 // need a value
        const name = (v.formatted_name  || "").replace(/&quot;/g, '"');
        const val  = (v.formatted_value || "").replace(/&quot;/g, '"');

        /* grab the first METAL match for row-colouring */
        if (!metalKey) {
          const low = val.toLowerCase();
          if (/14\s*k\s*solid/i.test(low))         metalKey = "14k";
          else if (/rose/.test(low))               metalKey = "rose";
          else if (/silv(?:er|r)/.test(low))       metalKey = "silver";
          else if (/gold/.test(low))               metalKey = "gold";
        }

        /* grab the first NON-metal, NON-personalization variation */
        if (
          !otherSel &&
          !/(metal|colour|color)/i.test(name) &&
          !/personalization/i.test(name) &&
          val.trim()
        ){
          otherSel = val.trim();
        }

        /* remember the very first label for completeness */
        if (!metalSel) metalSel = val;
      });
    }

    /* NEW ‚Äì if missing, borrow the key we just detected for the row */
    item.metalLabel = metalSel || item._metalKey || metalKey || "No Metal";
    item.otherLabel = otherSel || "N/A";         // NEW

    /* does this listing need manual attention? */
    const hasPersonalization =
      (Array.isArray(item.personalization) && item.personalization.length) ||
      (item.personalization &&
       typeof item.personalization === "object" &&
       !Array.isArray(item.personalization) &&
       Object.keys(item.personalization).length) ||
      (typeof item.personalization === "string" &&
       item.personalization.trim().length) ||
      item.is_personalized === true;

    const needsAttn =
      hasPersonalization ||
      (item.message_from_buyer && item.message_from_buyer.trim().length);

    /* detail boxes */
    addDetail("metalCell", 119, " Metal: " + (item.metalLabel || "No Metal"));
    addDetail("skuCell" ,131," SKU: "+(item.sku||"N/A"));
    addDetail("matchCell",143,"");

    /* ‚òÖ FIX-C: trim + lower metal key, then log */
    metalKey = (metalKey || item._metalKey || "").trim().toLowerCase();
    wrap.dataset.metal = metalKey;
    item._metalKey     = metalKey;          // remember final tag
    console.log("%cMETAL-TAG","color:#29b6f6","assigned ‚Üí", `[${wrap.dataset.metal}]`);
    wrap.dataset.qty   = item.quantity ?? 1;

    if (needsAttn) wrap.classList.add("preview-attn");   // ORANGERED!

    /* attach wrapper & load thumbnail‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ */
    document.getElementById("photoGridContainer").appendChild(wrap);

    /* keep the parent row‚Äôs counts in sync */
    refreshRowMetalCounts(String(item.receipt_id));

    fetchListingImages(item.listing_id)
      .then(imgs => getLocalImageData(imgs[0].url_fullxfull))
      .then(data => {
        box.innerHTML =
          `<img src="${data}" style="width:110%;height:110%;object-fit:cover;">`;
        item.image = data;                 // cache for modal
      })
      .catch(()=>{ box.innerHTML = "Img Err"; });

    return wrap;
  }


(() => {


    /* =========================================================
     * DYNAMIC-REMOVE HELPERS
     * ========================================================= */



  /* 0.  GLOBAL HOOKS ----------------------------------------------------- */
  let currentReceipts = [];            // populated by buildNewOrderList()
  let sortKey   = null;                // "order", "ship", "gold", ...
  let sortDir   = 1;                   // 1 = asc, -1 = desc

  /** helper ‚Üí render the stacked boxes from `currentReceipts` array */
  function renderOrderBoxes(arr) {
    const container = document.getElementById("newOrderContainer");
    container.innerHTML = "";
    arr.forEach(async (r, idx) => {

      /* build the DOM node */
      const box = document.createElement("div");
      box.className = "new-order-box";
      box.id        = "newOrder" + idx;
      box.dataset.receipt = r.receipt_id;      // ‚Üê NEW data-tag

      /* click ‚Üí toggle highlight + (de)load images ---------------------- */
      box.addEventListener("click", async e => {
      if (e.ctrlKey || e.metaKey) return;   // range-selector handles these

                /* LOG #2 ‚Äì detected metal colour */
        console.log("%cMETAL","color:#ff9100;font-weight:bold",
              "metal:", box.dataset.metal || "N/A");

        const receiptId = idStr(r.receipt_id);      // ‚Üê always string

        /* ‚îÄ‚îÄ 1. toggle selected state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    if (selectedOrders.has(receiptId)) {
      /* ‚îÄ‚îÄ‚îÄ DESELECT ‚îÄ‚îÄ‚îÄ */
      selectedOrders.delete(receiptId);
      box.classList.remove("selected");

      /* clean up previews & bookkeeping */
      removePreviewBoxesForOrder(receiptId);  // drop every wrap
      realignGrid();                          // close gaps
      updateCounters();                       // badge totals
      persistSelection();                     // save smaller Set

      /* re-evaluate visibility after the removals */
      window.applyMetalFilter();

    } else {
      /* ‚îÄ‚îÄ‚îÄ SELECT ‚îÄ‚îÄ‚îÄ */
      selectedOrders.add(receiptId);
      box.classList.add("selected");

      /* set range-anchor on plain click */
      lastCtrlIdx = [...document.querySelectorAll("#newOrderContainer .new-order-box")]
                      .indexOf(box);

      /* pull + cache if first time */
      if (!orderCache[receiptId]) {
        const ord = await pullEtsyOrderDetails(receiptId);
        orderCache[receiptId] = ord?.transactions || [];

        refreshRowCount(receiptId);          // ‚Üê NEW: badge updates instantly
        refreshRowMetalCounts(receiptId); // ‚Üê NEW: per-metal numbers
      }

      /* ‚Äî check transactions array before we try to add previews ‚Äî */
      console.log("%cTX-ARRAY","color:#ff1744;font-weight:bold",
            "order:", receiptId,
            "tx count:", orderCache[receiptId]?.length,
            orderCache[receiptId]);

      /* iterate each transaction exactly once */
      let firstTxMetal = "";
      orderCache[receiptId].forEach(tx => {

        /* pass the row‚Äôs metal value to the transaction */
        tx._metalKey = box.dataset.metal;
        if (!firstTxMetal && tx._metalKey) firstTxMetal = tx._metalKey;

        if (!tx._inGrid) addPreviewBox(tx);
      });

      /* if the row tag is still missing, adopt the preview‚Äôs tag */
      if ((!box.dataset.metal || box.dataset.metal === "N/A") && firstTxMetal) {
        box.dataset.metal = firstTxMetal;
        console.log("%cROW-METAL-FIX","color:#8e24aa;font-weight:bold",
              "receipt:", receiptId, "now ‚Üí", box.dataset.metal);
      }

      persistSelection();                     // üî∏ keep after caching
    }

        //* ‚îÄ‚îÄ 2. build combined list from all active orders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    let combined = [];
    selectedOrders.forEach(id => {
      const txs = orderCache[id] || [];
      combined.push(...txs);
    });

    /* ‚îÄ‚îÄ 3. (de)render the grid ‚Äî incremental append version ‚îÄ */
    const grid = document.getElementById("photoGridContainer");

    if (combined.length === 0) {               // nothing selected
      grid.innerHTML = "";
      gridElements.clear();
      earringCells  = {};
      earringState  = {};
    } else {
      combined.forEach(tx => {                 // only add new ones
        if (!tx._inGrid) addPreviewBox(tx);
      });
    }

    /* ‚îÄ‚îÄ 4. housekeeping after grid changes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    realignGrid();
    updateCounters();
    window.applyMetalFilter();

    });   /* ‚Üê closes box.addEventListener("click", ‚Ä¶ ) */

    /* ‚îÄ‚îÄ HOVER ‚Üí outline matching preview boxes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    box.addEventListener("mouseenter", () => {
      if (!box.classList.contains("selected")) return;    // orange rows only
      const rec = r.receipt_id;
      document.querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt="${rec}"]`)
              .forEach(w => w.classList.add("preview-highlight"));
    });
    box.addEventListener("mouseleave", () => {
      const rec = r.receipt_id;
      document.querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt="${rec}"]`)
              .forEach(w => w.classList.remove("preview-highlight"));
    });

    /* ‚ñº‚ñº  PASTE THE SAME NEW BLOCK HERE  ‚ñº‚ñº */
    box.addEventListener("mouseenter", () => {
      box.classList.add("hover-blue");
      document
        .querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${box.dataset.receipt}']`)
        .forEach(w => w.classList.add("hover-blue"));
    });
    box.addEventListener("mouseleave", () => {
      box.classList.remove("hover-blue");
      document
        .querySelectorAll(`#photoGridContainer .wrap-preview[data-receipt='${box.dataset.receipt}']`)
        .forEach(w => w.classList.remove("hover-blue"));
    });

    /* order-row content ----------------------------------------------- */
    const orderNum = r.order_number || r.receipt_id || "‚Äî";
    const shipStr  = r._shipStr || "N/A";
    const g  = r._metalCounts.Gold     || 0;
    const s  = r._metalCounts.Silver   || 0;
    const rG = r._metalCounts["Rose G"]|| 0;
    const k  = r._metalCounts["14K"]   || 0;

    /* assign one metal key to the whole order for filtering */
    let rowMetal = "";
    if     (k)        rowMetal = "14k";
    else if(rG)       rowMetal = "rose";
    else if(s)        rowMetal = "silver";
    else if(g)        rowMetal = "gold";
    box.dataset.metal = rowMetal;          // ‚Üê moved here

    box.innerHTML = `
      <span class="col-order">${orderNum}</span>
      <span class="col-ship">${shipStr}</span>
      <span class="col-g">${g}</span>
      <span class="col-s">${s}</span>
      <span class="col-r">${rG}</span>
      <span class="col-k">${k}</span>
    `;
    container.appendChild(box);            // last line inside arr.forEach
    });                                // closes arr.forEach

    highlightSavedRows();              // ‚Üê NEW: paint saved rows
    requestAnimationFrame(highlightCompletedRows);   // green wins after paint

     /* keep greens hidden unless Completed filter is on */
     requestAnimationFrame(window.applyMetalFilter);

     requestAnimationFrame(markStaffNoteOrders);      // üîÑ restore Staff-Note purple/bold

  }           

  /** 1.  HEADER BAR  +  EVENT LISTENERS ------------------------------- */
  const bar = document.createElement("div");
  bar.id = "orderHeaderBar";
  bar.style.cssText =
    "position:absolute;left:20px;top:206px;width:285px;height:23px;" +
    "display:flex;gap:2px;background:#626262;color:#fff;font-size:0.75em;" +
    "align-items:center;user-select:none;z-index:9999;";

  const COLS = [
    { key:"order",  label:"Order", flex:"1.55" },
    { key:"ship",   label:"Date",  flex:"1.25" },
    { key:"gold",   label:"G",     flex:"0.45" },
    { key:"silver", label:"S",     flex:"0.45" },
    { key:"rose",   label:"R",     flex:"0.45" },
    { key:"14k",    label:"14",    flex:"0.45" }
  ];

  COLS.forEach(col => {
    const div = document.createElement("div");
    div.className = "hdr";
    div.dataset.key = col.key;
    div.style.cssText = `flex:${col.flex};text-align:center;cursor:pointer;`;
    div.innerHTML =
      `${col.label}<span class="chev">` +
      `<span class="up">‚ñ≤</span><br><span class="down">‚ñº</span>` +
      `</span>`;
    bar.appendChild(div);
  });

  document.body.appendChild(bar);
  loadPositions();   // re-apply positions now that #orderHeaderBar exists

  /* 2.  SORT ROUTINE ---------------------------------------------------- */
  bar.addEventListener("click", ev => {
    const hdr = ev.target.closest(".hdr");
    if (!hdr) return;

    /* toggle dir / remember key */
    const key = hdr.dataset.key;
    sortDir = (sortKey === key) ? -sortDir : 1;
    sortKey = key;

    /* run the sort */
    currentReceipts.sort((a, b) => {
      switch (key) {
        case "order":  return sortDir * ((a.order_number || a.receipt_id) - (b.order_number || b.receipt_id));
        case "ship":   return sortDir * ((a._shipTS || 0) - (b._shipTS || 0));
        case "gold":   return sortDir * ((a._metalCounts.Gold || 0) - (b._metalCounts.Gold || 0));
        case "silver": return sortDir * ((a._metalCounts.Silver || 0) - (b._metalCounts.Silver || 0));
        case "rose":   return sortDir * ((a._metalCounts["Rose G"] || 0) - (b._metalCounts["Rose G"] || 0));
        case "14k":    return sortDir * ((a._metalCounts["14K"] || 0)   - (b._metalCounts["14K"] || 0));
      }
      return 0;
    });

    /* arrow colour logic ------------------------------------------- */
    bar.querySelectorAll(".chev .up, .chev .down")
       .forEach(el => (el.style.color = "#ffffff"));        // reset all

    if (sortDir === 1) {
      hdr.querySelector(".chev .up").style.color   = "#2196F3";  // ASC
    } else {
      hdr.querySelector(".chev .down").style.color = "#2196F3";  // DESC
    }

    renderOrderBoxes(currentReceipts);
  });

/* 3. HOOK INTO buildNewOrderList() ‚Äî pass-through only -------------- */
const originalBuild = buildNewOrderList;
buildNewOrderList = async function (offset = 0) {
  /* do NOT hydrate here; just forward the call */
  return await originalBuild.call(this, offset);
};

/* Monkey-patch to expose display array for observer ------------------ */
const origFuncTxt = buildNewOrderList.toString();
if (!origFuncTxt.includes("window._lastDisplayReceipts")) {
  console.warn(
    "Patch buildNewOrderList manually to expose displayReceipts:\n" +
    "Inside buildNewOrderList(), after you define displayReceipts, add:\n" +
    "    window._lastDisplayReceipts = displayReceipts;"
  );
}

/** observer detects page changes and triggers initial render --------- */
const observer = new MutationObserver(async () => {
  if (window._lastDisplayReceipts && window._lastDisplayReceipts !== currentReceipts) {
    /* lightweight receipts landed ‚Äî hydrate them BEFORE we draw rows */
    currentReceipts = window._lastDisplayReceipts;

    /* FULL HYDRATE: pull transactions for EVERY receipt -------------- */
    await Promise.all(
      currentReceipts.map(async r => {
        const id = String(r.receipt_id);
        if (!orderCache[id]) {
          try {
            const ord = await pullEtsyOrderDetails(id);   // heavy call
            orderCache[id] = ord?.transactions || [];
          } catch (err) {
            console.warn("Detail pull failed for", id, err);
            orderCache[id] = [];
          }
        }
        r.transactions = orderCache[id];                  // attach full data
      })
    );

    /* helper fields for sorting + metal counts ----------------------- */
    currentReceipts.forEach(r => {
      /* ship timestamp + pretty string */
      if (!r._shipTS) {
        const ts = r.transactions?.[0]?.expected_ship_date || 0;
        r._shipTS  = ts;
        r._shipStr = ts
          ? new Date(ts * 1000).toLocaleDateString("en-US", { month:"short", day:"2-digit" })
          : "N/A";
      }

      /* metal counts (check EVERY variation value + fallback tag) */
      const mc = { Gold:0, Silver:0, "Rose G":0, "14K":0 };

      (r.transactions || []).forEach(t => {
        const q = t.quantity || 1;

        /* add counts from every variation value */
        if (Array.isArray(t.variations)) {
          t.variations.forEach(v => {
            const val = (v?.formatted_value || "").toLowerCase();
            if (/14\s*k\s*solid/i.test(val))         mc["14K"]    += q;
            else if (/rose/.test(val))   mc["Rose G"] += q;
            else if (/silv(?:er|r)/.test(val)) mc.Silver    += q;
            else if (/gold/.test(val))   mc.Gold      += q;
          });
        }

        /* fallback to propagated _metalKey if all counts still zero */
        if (!mc.Gold && !mc.Silver && !mc["Rose G"] && !mc["14K"] && t._metalKey) {
          switch (t._metalKey) {
            case "14k":    mc["14K"]    += q; break;
            case "rose":   mc["Rose G"] += q; break;
            case "silver": mc.Silver    += q; break;
            case "gold":   mc.Gold      += q; break;
          }
        }
      });
      r._metalCounts = mc;

      /* derive a single row-level metal tag (may stay blank) */
      if      (mc["14K"])    r._rowMetal = "14k";
      else if (mc["Rose G"]) r._rowMetal = "rose";
      else if (mc.Silver)    r._rowMetal = "silver";
      else if (mc.Gold)      r._rowMetal = "gold";
      else                   r._rowMetal = "";         // no metal detected
    });

    /* initial sort direction ---------------------------------------- */
    if (!sortKey) { sortKey = "order"; sortDir = -1; }

    /* arrow colours ------------------------------------------------- */
    bar.querySelectorAll(".chev .up, .chev .down")
       .forEach(el => (el.style.color = "#ffffff"));
    const activeChev = bar.querySelector(`[data-key="${sortKey}"] .chev`);
    (sortDir === 1
      ? activeChev.querySelector(".up")
      : activeChev.querySelector(".down")
    ).style.color = "#2196F3";

    /* render fully-hydrated rows ------------------------------------ */
    currentReceipts.sort(
      (a, b) => (b.order_number || b.receipt_id) - (a.order_number || a.receipt_id)
    );
    renderOrderBoxes(currentReceipts);

    /* ‚îÄ‚îÄ‚îÄ INSERT ‚Üì‚Üì‚Üì  (exactly here) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    await refreshStaffNoteIDs();
    markStaffNoteOrders();

  }
});
observer.observe(document.getElementById("newOrderContainer"), { childList: true });

})();   /* ‚îÄ‚îÄ‚îÄ END SORT HEADER MODULE ‚îÄ‚îÄ‚îÄ */

/********************************************************
 * helper: sleep(ms)
 ********************************************************/
const sleep = ms => new Promise(res => setTimeout(res, ms));


/********************************************************
 * updatePageButtons(totalPages, currentPage)
 *   ‚Ä¢ draws 1‚Ä¶N circular buttons under #newOrderContainer
 ********************************************************/
function updatePageButtons(totalPages, currentPage){
  const holder = document.getElementById("pageButtonsContainer");
  holder.innerHTML = "";                               // wipe + rebuild
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement("div");
    btn.className = "page-btn" + (i===currentPage ? " active": "");
    btn.textContent = i;
    btn.addEventListener("click", async () => {
      orderListOffset = (i-1)*100;                     // global var already exists
      await buildNewOrderList(orderListOffset);
      updatePageButtons(totalPages, i);                // refresh active state
    });
    holder.appendChild(btn);
  }
}


/********************************************************
 * fetchOpenOrdersSequential()   ‚Üê DROP-IN REPLACEMENT
 *    ‚Ä¢ grabs EVERY open receipt in 100-row pages
 *    ‚Ä¢ waits 250 ms between calls (safe for Etsy‚Äôs rate limits)
 *    ‚Ä¢ stops only when a page returns < 100 rows
 ********************************************************/
async function fetchOpenOrdersSequential() {
  const token  = localStorage.getItem("access_token") || "";
  const all    = [];
  let offset   = 0;

  while (true) {
    const resp = await fetch(
      `${functionsBaseUrl}/listOpenOrders?offset=${offset}`,
      { headers: { "access-token": token } }
    );
    if (!resp.ok) throw new Error("HTTP " + resp.status);

    const payload  = await resp.json();
    const receipts = payload.results || [];
    all.push(...receipts);

    /* ‚ô• Etsy gives max 100 rows; <100 means we‚Äôre done */
    if (receipts.length < 100) break;

    offset += 100;          // next slice
    await sleep(250);       // 250 ms pause
  }
  return all;
}

  /********************************************************
 * buildNewOrderList ‚Äì serves 100-row ‚Äúpages‚Äù from cache
 ********************************************************/
let allOpenReceipts = [];                 // ‚Üê master cache

async function buildNewOrderList(offset = 0) {
  /* ‚ù∂ first call ‚Üí fetch everything & sort once */
  if (allOpenReceipts.length === 0) {
    allOpenReceipts = await fetchOpenOrdersSequential();

    /* helper fields + oldest-ship-date sort */
    allOpenReceipts.forEach(r => {
      /* ship timestamp + pretty string */
      if (!r._shipTS) {
        let ts = null;
        if (Array.isArray(r.transactions) && r.transactions[0]?.expected_ship_date) {
          ts = r.transactions[0].expected_ship_date;
        }
        if (!ts) ts = r.dispatch_date || r.ship_by_date || 0;
        r._shipTS  = ts;
        r._shipStr = ts
          ? new Date(ts * 1000).toLocaleDateString("en-US", { month:"short", day:"2-digit" })
          : "N/A";
      }

      /* one-time metal counts ‚Äî scan EVERY variation value + fallback tag */
      if (!r._metalCounts) {
        const mc = { Gold:0, Silver:0, "Rose G":0, "14K":0 };

        (r.transactions || []).forEach(t => {
          const q = t.quantity || 1;

          /* add counts from every variation value */
          if (Array.isArray(t.variations)) {
            t.variations.forEach(v => {
              const val = (v?.formatted_value || "").toLowerCase();
              if (/14\s*k\s*solid/i.test(val))         mc["14K"]    += q;
              else if (/rose/.test(val))   mc["Rose G"] += q;
              else if (/silv(?:er|r)/.test(val)) mc.Silver    += q;
              else if (/gold/.test(val))   mc.Gold      += q;
            });
          }

          /* if still zero, use the propagated _metalKey */
          if (!mc.Gold && !mc.Silver && !mc["Rose G"] && !mc["14K"] && t._metalKey) {
            switch (t._metalKey) {
              case "14k":    mc["14K"]    += q; break;
              case "rose":   mc["Rose G"] += q; break;
              case "silver": mc.Silver    += q; break;
              case "gold":   mc.Gold      += q; break;
            }
          }
        });
        r._metalCounts = mc;
      }

      /* ‚îÄ‚îÄ NEW: attach buyer-message + keep personalization as array ‚îÄ‚îÄ */
      const buyerMsg = r.message_from_buyer || "";
      (r.transactions || []).forEach(t => {
        t.message_from_buyer = buyerMsg;

        t.personalization = (t.variations || []).find(v => /personalization/i.test(v.formatted_name || ""))?.formatted_value
          ? [ (t.variations.find(v => /personalization/i.test(v.formatted_name || ""))).formatted_value.trim() ]
          : [];

        // always make personalization an array
        if (t.personalization) {
          if (!Array.isArray(t.personalization)) {
            t.personalization = [ t.personalization ];
          }
        } else {
          t.personalization = [];
        }

        // dev-log any personalized transaction
        if (t.personalization.length) {
          console.log("‚üπ Personalization TX", t.transaction_id,
                      JSON.stringify(t.personalization));
        }
      });

    }); /* end forEach(r) */
  }

  /* ‚Ä¶ remainder of buildNewOrderList() unchanged ‚Ä¶ */

  allOpenReceipts.sort((a, b) => {
    if (a._shipTS === 0 && b._shipTS === 0) return 0;
    if (a._shipTS === 0) return  1;
    if (b._shipTS === 0) return -1;
    return a._shipTS - b._shipTS;            // oldest ‚Üí newest
  });

  /* ‚ù∑ slice requested page ‚Äì skip receipts already completed */
  const filtered     = allOpenReceipts.filter(r => !completedOrders.has(String(r.receipt_id)));
  const page         = filtered.slice(offset, offset + 100);
  window._lastDisplayReceipts = page;            // expose current page

  const totalPages   = Math.ceil(filtered.length / 100);
  const currentPage  = Math.floor(offset / 100) + 1;
  updatePageButtons(totalPages, currentPage);

  /******** render stacked boxes (unchanged widths) ********/
  const container = document.getElementById("newOrderContainer");
  container.innerHTML = "";
  page.forEach((r, idx) => {

    const box = document.createElement("div");
    box.className = "new-order-box";
    box.id        = "newOrder" + (offset + idx);

    const rid = idStr(r.receipt_id);         // ‚Üê use string everywhere
    box.dataset.receipt = rid;

    /* colour immediately if it was saved */
    if (completedOrders.has(rid)) {          // green first
      box.classList.add("completed");
    } else if (selectedOrders.has(rid)) {    // orange only if not green
      box.classList.add("selected");
    }

    const orderNum = r.order_number || r.receipt_id || "‚Äî";
    const shipStr  = r._shipStr || "N/A";
    const g  = r._metalCounts.Gold     || 0;
    const s  = r._metalCounts.Silver   || 0;
    const rG = r._metalCounts["Rose G"]|| 0;
    const k  = r._metalCounts["14K"]   || 0;

    /* NEW ‚ñ∏ decide the metal key for this entire order */
    let rowMetal = "";
    if     (k)   rowMetal = "14k";
    else if(rG)  rowMetal = "rose";
    else if(s)   rowMetal = "silver";
    else if(g)   rowMetal = "gold";
    box.dataset.metal = rowMetal;            // ‚Üê NEW

    box.innerHTML = `
      <span class="col-order">${orderNum}</span>
      <span class="col-ship">${shipStr}</span>
      <span class="col-g">${g}</span>
      <span class="col-s">${s}</span>
      <span class="col-r">${rG}</span>
      <span class="col-k">${k}</span>
    `;
    container.appendChild(box);
  });                                         // ‚Üê closes page.forEach

   highlightSavedRows();        // orange first‚Ä¶
 
   /* run the GREEN pass one frame later so nothing else can overwrite it */
   requestAnimationFrame(highlightCompletedRows);

  /* ‚îÄ‚îÄ refresh the four metal badges no matter what filters are set ‚îÄ‚îÄ */
  updateCounters();

  /* üÜï highlight any rows that own a Staff Note */
  await refreshStaffNoteIDs();     // pulls latest note IDs
  markStaffNoteOrders();           // adds .has-staff-note class

  /* return page size (0-100) so buttons enable/disable correctly */
  return page.length;
}

/********************************************************
 * startScannedSortingListener (NEW partial snippet)
 ********************************************************/
async function startScannedSortingListener() {
  try {
    const docRef = db.collection("Brites_Orders").doc("ScannedSortingOrder");
    docRef.onSnapshot((docSnap) => {
      if (!docSnap.exists) {
        console.log("No 'ScannedSortingOrder' doc in Firestore yet.");
        return;
      }
      const docData = docSnap.data();
      if (!docData["Order Number"]) {
        console.log("No 'Order Number' in 'ScannedSortingOrder' doc.");
        return;
      }
      const scannedVal = docData["Order Number"];
      console.log("Scanned Sorting code =>", scannedVal);

      const input = document.getElementById("etsyOrderNumber");
      if (!input) return;
      input.value = scannedVal;

      // [NEW: reset states as if app just opened]
      disableSendMatch();
      disableMatchPrintFlow();
      removeAllBlueHighlights();

      // Programmatically fire an Enter key
      const enterEvent = new KeyboardEvent("keydown", { key: "Enter" });
      input.dispatchEvent(enterEvent);
    });
  } catch (err) {
    console.error("Error starting scannedSortingListener:", err);
  }
}



/* === Restore saved orange selections === */
  restoreSelections();            // ‚Üê add this line

});        /* ‚Üê‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì CLOSED DOMContentLoaded LISTENER */

/* ===== Hard-coded fallback positions & sizes (no calculations) ===== */
const defaultPos = {
  connectEtsyBtn:           { left:1123, top:803, width:126, height:35 },
  openConfigBtn:            { left:1270,  top:803, width:133, height:35 },
  updateOrderListBtn:       { left:1189,top:5,  width:120, height:35 },
  clearBtn:               { left:1324,  top:5, width:120, height:35 },
  etsyOrderNumber:          { left:765,  top:5,  width:200, height:25 },
  photoGridContainer:     { left:318,   top:45,   width:1513, height:850 },
  orderHeaderBar:       { left:6,   top:19,   width:290,   height:27 },
  configModal:              { left:50,  top:50, width:250, height:450 },
  configTable:              { left:27,   top:7,   width:525,  height:1562 },
  saveConfigBtn:            { left:10, top:3,  width:85, height:35 },
  newOrderContainer:        { left:1, top:45,  width:318, height:800 },
  pageButtonsContainer:     { left:71,top:-4, width:325, height:25 },
  completeBtn:              { left:1054,   top:5, width:120, height:35 },
  goldCounter:          { left:319, top:9,  width:72,height:27 },
  silverCounter:        { left:402,  top:9,   width:72, height:27 },
  roseCounter:          { left:485,  top:9,  width:72, height:27 },
  solidCounter:         { left:568,  top:9, width:72, height:27 }
};

/********************************************************
 * loadPositions -- apply stored values or hard defaults
 ********************************************************/
function loadPositions() {
  configIDs.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;

    const def = defaultPos[id] || {};
    const left   = parseInt(localStorage.getItem(`pos-${id}-left`), 10)   || def.left   || 0;
    const top    = parseInt(localStorage.getItem(`pos-${id}-top`), 10)    || def.top    || 0;
    const width  = parseInt(localStorage.getItem(`pos-${id}-width`), 10)  || def.width  || 0;
    const height = parseInt(localStorage.getItem(`pos-${id}-height`), 10) || def.height || 0;

    el.style.position = "absolute";
    el.style.left   = left   + "px";
    el.style.top    = top    + "px";
    if (width  > 0) el.style.width  = width  + "px";
    if (height > 0) el.style.height = height + "px";
  });
}

// --------------- (Your code for config table, openConfigBtn, saveConfigBtn, etc.) --------------
document.getElementById("openConfigBtn").addEventListener("click", function () {
  populateConfigTable();
  M.Modal.getInstance(document.getElementById("configModal")).open();
});

document.getElementById("saveConfigBtn").addEventListener("click", function () {
  configIDs.forEach(function (id) {
    const el = document.getElementById(id);
    if (!el) return;
    const cs = window.getComputedStyle(el);
    localStorage.setItem("pos-" + id + "-left", parseInt(cs.left, 10) || 0);
    localStorage.setItem("pos-" + id + "-top", parseInt(cs.top, 10) || 0);
    localStorage.setItem("pos-" + id + "-width", parseInt(cs.width, 10) || 0);
    localStorage.setItem("pos-" + id + "-height", parseInt(cs.height, 10) || 0);
  });
  M.toast({ html: "Positions saved!" });
});

function populateConfigTable() {
  const tbody = document.querySelector("#configTable tbody");
  tbody.innerHTML = "";

  configIDs.forEach(function (id) {
    const el = document.getElementById(id);
    if (!el) return;
    const cs = window.getComputedStyle(el);
    const leftVal = parseInt(cs.left, 10) || 0;
    const topVal = parseInt(cs.top, 10) || 0;
    const widthVal = parseInt(cs.width, 10) || 0;
    const heightVal = parseInt(cs.height, 10) || 0;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${id}</td>
      <td><input type="number" value="${leftVal}" data-id="${id}" class="left-input"></td>
      <td><input type="number" value="${topVal}" data-id="${id}" class="top-input"></td>
      <td><input type="number" value="${widthVal}" data-id="${id}" class="width-input"></td>
      <td><input type="number" value="${heightVal}" data-id="${id}" class="height-input"></td>
    `;
    tbody.appendChild(row);

    row.querySelector(".left-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.left = parseInt(this.value, 10) + "px";
    });
    row.querySelector(".top-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.top = parseInt(this.value, 10) + "px";
    });
    row.querySelector(".width-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.width = parseInt(this.value, 10) + "px";
    });
    row.querySelector(".height-input").addEventListener("input", function () {
      const target = document.getElementById(this.dataset.id);
      if (target) target.style.height = parseInt(this.value, 10) + "px";
    });
  });
}

/******************************************************************
 * fillPreviewBoxes(items)      ‚¨áÔ∏è  <------------- REPLACE THIS WHOLE FUNCTION
 ******************************************************************/
function fillPreviewBoxes(items){
  /* reset state ----------------------------------------------- */
  gridElements.clear();
  earringCells = {};
  earringState = {};
  const container = document.getElementById("photoGridContainer");
  container.innerHTML = "";

  window.cachedOrderItems = items;        // global cache

  /* helper phrase lists (unchanged) --------------------------- */
  const groupA = ["stud","studs","stud earrings","ring","rings","earrings"];
  const groupB = ["necklace","necklaces","huggie","huggies","huggie earrings",
                  "hoop","hoops","hoop earrings","bracelet","bracelets",
                  "extender","extenders","chain","chains"];
  const EARRING_PHRASES = [
    "stud","stud earrings","earring","earrings",
    "huggie","huggies","huggie earrings","hoop","hoops","hoop earrings"
  ];
  const containsPhrase = (str="",ph="")=>{
    const pat="\\b"+ph.trim().replace(/\s+/g,"[\\s\\W]+")+"\\b";
    return new RegExp(pat,"i").test(str.toLowerCase());
  };
  const isEarringString = str =>
    EARRING_PHRASES.some(ph=>new RegExp("\\b"+ph.replace(/\s+/g,"\\s+")+"\\b","i").test(str.toLowerCase()));

  /* main loop: one preview per transaction -------------------- */
  items.forEach(item=>{
    /* keyword tagging */
    item.keywords=[];
    if(item.title){
      groupA.forEach(p=>{if(containsPhrase(item.title,p)) item.keywords.push(p);});
      groupB.forEach(p=>{if(containsPhrase(item.title,p)) item.keywords.push(p);});
    }
    if(item.keywords.length===0) item.keywords.push("groupB");

    /* earring detector */
    item.isEarring = isEarringString(item.title||"") ||
                     (item.variations||[]).some(v=>v.formatted_value && isEarringString(v.formatted_value));
    if(item.isEarring){
      const idx = gridElements.size;
      earringCells[idx]=true;
      earringState[idx]={firstImg:null};
    }

    /* build + append preview row */
    addPreviewBox(item);
  });

    updateCounters();                  // ‚Üê NEW: recalc counters
    reflowGrid();

}  /* ---------------------------- END fillPreviewBoxes -------- */

function attachPreviewBoxListeners(box) {
  let isDragging = false;
  let isMouseDown = false;
  let dragStartX = 0,
      dragStartY = 0;
  let lastX = 0,
      lastY = 0;
  const dragThreshold = 3;

  box.addEventListener("wheel", function (ev) {
    const img = box.querySelector("img");
    if (!img) return;
    ev.preventDefault();
    let currentScale = parseFloat(img.dataset.scale) || 1;
    let offX = parseFloat(img.dataset.offsetX) || 0;
    let offY = parseFloat(img.dataset.offsetY) || 0;
    if (ev.deltaY < 0) {
      currentScale *= 1.1;
    } else {
      currentScale /= 1.1;
      if (currentScale <= 1) {
        currentScale = 1;
        offX = 0;
        offY = 0;
      }
    }
    if (currentScale > 7) currentScale = 7;
    img.dataset.scale = currentScale;
    img.dataset.offsetX = offX;
    img.dataset.offsetY = offY;
    img.style.transform = `translate(${offX}px, ${offY}px) scale(${currentScale})`;
  });

  box.addEventListener("mousedown", function (ev) {
    const img = box.querySelector("img");
    if (!img) return;
    const scaleNow = parseFloat(img.dataset.scale) || 1;
    if (scaleNow <= 1) return;
    ev.preventDefault();
    isMouseDown = true;
    isDragging = false;
    dragStartX = ev.clientX;
    dragStartY = ev.clientY;
    lastX = ev.clientX;
    lastY = ev.clientY;
  });

  box.addEventListener("mousemove", function (ev) {
    if (!isMouseDown) return;
    ev.preventDefault();
    const dxAll = Math.abs(ev.clientX - dragStartX);
    const dyAll = Math.abs(ev.clientY - dragStartY);
    if (dxAll > dragThreshold || dyAll > dragThreshold) isDragging = true;
    const img = box.querySelector("img");
    if (!img) return;
    const scaleNow = parseFloat(img.dataset.scale) || 1;
    let offX = parseFloat(img.dataset.offsetX) || 0;
    let offY = parseFloat(img.dataset.offsetY) || 0;
    const dx = ev.clientX - lastX;
    const dy = ev.clientY - lastY;
    offX += dx;
    offY += dy;
    img.dataset.offsetX = offX;
    img.dataset.offsetY = offY;
    img.style.transform = `translate(${offX}px, ${offY}px) scale(${scaleNow})`;
    lastX = ev.clientX;
    lastY = ev.clientY;
  });

  box.addEventListener("mouseup", function () {
    isMouseDown = false;
  });
  box.addEventListener("mouseleave", function () {
    isMouseDown = false;
  });

  box.addEventListener("click", function (ev) {
    if (isDragging) {
      isDragging = false;
      return;
    }
    const img = box.querySelector("img");
    if (!img) return;
    const rect = box.getBoundingClientRect();
    const boxCenterX = rect.left + box.clientWidth / 2;
    const boxCenterY = rect.top + box.clientHeight / 2;
    const dx = ev.clientX - boxCenterX;
    const dy = ev.clientY - boxCenterY;
    const scale = 5;
    const fudgeY = 10;
    const offsetX = -scale * dx;
    const offsetY = -scale * dy + fudgeY;
    img.dataset.scale = scale;
    img.dataset.offsetX = offsetX;
    img.dataset.offsetY = offsetY;
    img.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  });

}

/* ------------------------------------------------------------------
 * fetchEtsyOrder(orderNum) ‚Üí full Etsy payload for ONE order
 * -----------------------------------------------------------------*/
async function fetchEtsyOrder(orderNum){
  const token = localStorage.getItem("access_token") || "";
  const url   = functionsBaseUrl +
                "/etsyOrderProxy?orderId=" + encodeURIComponent(orderNum);
  const resp  = await fetch(url,{ headers:{ "access-token": token }});
  if(!resp.ok) throw new Error("HTTP "+resp.status);
  return await resp.json();            // { receipt, transactions, ‚Ä¶ }
}

/********************************************************
 * loadBatchEtsyOrders, fetchListingImages, getLocalImageData
 ********************************************************/
async function loadBatchEtsyOrders(orderNumbers) {
  try {
    M.toast({ html: "Loading " + orderNumbers.length + " order(s)..." });

    const token         = localStorage.getItem("access_token") || "";
    const combinedItems = [];

    /* ‚îÄ‚îÄ loop through each receiptId ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    for (let i = 0; i < orderNumbers.length; i++) {
      const ord  = orderNumbers[i];
      const url  = functionsBaseUrl + "/etsyOrderProxy?orderId=" + encodeURIComponent(ord);
      const resp = await fetch(url, { headers: { "access-token": token } });

      /* DEBUG ‚¨áÔ∏é record every payload */
      console.log("%cFETCH ‚úì", "color:#00c853",
            "receipt:", ord,
            "status:", resp.status);

      if (!resp.ok) {
        console.warn("Order fetch failed for " + ord + ", status=" + resp.status);
        continue;
      }

      const data = await resp.json();

      console.log("%cCACHE", "color:#ff9100",
            "receipt:", ord,
            "TX ids:", data.transactions.map(t => t.transaction_id));

      console.log("Etsy Order Data:", data);

      /* -----------------------------------------------------------
       * attach buyer-message & keep Etsy's transaction.personalization
       * ----------------------------------------------------------- */
      if (Array.isArray(data.transactions)) {
        const buyerMsg    = data.receipt?.message_from_buyer || "";
        const receiptPers = data.receipt?.personalization    || "";

        data.transactions.forEach(t => {
          t.typedOrderNumber   = ord;
          t.message_from_buyer = buyerMsg;

          /* inherit receipt-level personalization if tx lacks its own */
          if (
              receiptPers &&
              (
                !t.personalization ||
                (Array.isArray(t.personalization) && !t.personalization.length)
              )
          ){
            t.personalization = receiptPers;
          }

          /* normalize + trim blanks */
          if (!Array.isArray(t.personalization)) {
            t.personalization = [ t.personalization ];
          }
          t.personalization = t.personalization.filter(txt => txt && txt.trim());

          if (t.personalization.length) {
            console.log("‚üπ Personalization TX", t.transaction_id, t.personalization);
          }
        });

        /* -------- expected_ship_date ‚Üí dispatch_date ------------ */
        if (data.transactions.length > 0) {
          const firstTrans = data.transactions[0];
          if (firstTrans.expected_ship_date) {
            const sTS   = new Date(firstTrans.expected_ship_date * 1000);
            const sDay  = ("0" + sTS.getDate()).slice(-2);
            const sMon  = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug",
                           "Sep","Oct","Nov","Dec"][sTS.getMonth()];
            const sYr   = sTS.getFullYear();
            const formatted = `${sDay} ${sMon} ${sYr}`;

            data.transactions.forEach(t => { t.dispatch_date = formatted; });
          }
        }

        combinedItems.push(...data.transactions);   // merge
      } else {
        console.warn("No transactions for order", ord);
      }
    }  /* ‚Üê end for-loop */

    /* ‚îÄ‚îÄ render combined results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    await fillPreviewBoxes(combinedItems);
    attachMatchCellListeners();         // keep listener wiring
    updateCounters();                   // refresh metal tallies

  } catch (err) {
    console.error("Error loading batch orders:", err);
    M.toast({ html: "Error: " + err.message });
  }
}

async function fetchListingImages(listingId) {
  const token = localStorage.getItem("access_token") || "";
  const resp = await fetch(functionsBaseUrl + "/etsyImages?listingId=" + listingId, {
    headers: { "access-token": token },
  });
  if (!resp.ok) {
    console.warn("Image fetch HTTP error:", resp.status);
    return [];
  }
  const data = await resp.json();
  return data.results || [];
}

async function getLocalImageData(imageUrl) {
  try {
    const response = await fetch(
      functionsBaseUrl + "/imageProxy?url=" + encodeURIComponent(imageUrl)
    );
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  } catch (err) {
    console.error("Error in getLocalImageData:", err);
    throw err;
  }
}

// ---------------------------------------------------------
// Pull Etsy order details and update grid details
// ---------------------------------------------------------
function pullEtsyOrderDetails(orderNumber){
  console.log("Pulling Etsy order details for:", orderNumber);
  const token = localStorage.getItem("access_token") || "";

  return fetch(
    functionsBaseUrl + "/etsyOrderProxy?orderId=" + encodeURIComponent(orderNumber),
    { headers: { "access-token": token } }
  )
  .then(r => r.json())
  .then(data => {
    console.log("Etsy Order Data:", data);

    /* ‚îÄ‚îÄ attach buyer-message & guarantee personalization array ‚îÄ‚îÄ */
    const buyerMsg = data.receipt?.message_from_buyer || "";

    (data.transactions || []).forEach((t, idx) => {
      t.message_from_buyer = buyerMsg;

      /* NEW ‚Üí lift the ‚ÄúPersonalization‚Äù variation into its own field */
      const engrave = (t.variations||[])
                        .find(v=>/personalization/i.test(v.formatted_name||""))?.formatted_value || "";

      const clean = engrave.trim();
      if (clean && !/not requested/i.test(clean)) {
        t.personalization = [ clean ];
      } else {
        t.personalization = [];            // treat as ‚Äúno personalization‚Äù
      }

      console.log("PERSONALIZATION DEBUG:", t.transaction_id, t.personalization, typeof t.personalization);
      if (idx === 0) {                       // dump only the first transaction
        console.log("TX FIELDS:", Object.keys(t));
      }

      /* normalize personalization ---------------------------------- */
      if (t.personalization) {
        if (!Array.isArray(t.personalization)) {
          t.personalization = [ t.personalization ];
        }
      } else {
        t.personalization = [];
      }

      /* DEBUG: log any transaction that has personalization text */
      if (t.personalization.length) {
        console.log("‚üπ Personalization TX", t.transaction_id, t.personalization);
      }
    });

    return data;                       // hand the cleaned object upward
  })
  .catch(err => {
    console.error("Error fetching Etsy order details:", err);
    return null;
  });
}

// Example: update the grid details using pulled Etsy order details
async function updateImageGrid(data) {
  let items = [];
  if (data.transactions && Array.isArray(data.transactions)) {
    items = data.transactions;
  } else if (Array.isArray(data)) {          
    items = data;
  }
  window.cachedOrderItems = items;
  await fillPreviewBoxes(items);
}

/* ---- stubbed out empty functions ---- */
function disableSendMatch() {}
function disableMatchPrintFlow() {}
function removeAllBlueHighlights() {}
function attachMatchCellListeners() {}  


/* ‚îÄ‚îÄ‚îÄ grid reflow after filter ‚îÄ‚îÄ‚îÄ */
function reflowGrid(){
  const wraps = Array.from(document.querySelectorAll("#photoGridContainer .wrap-preview"))
                     .filter(w => w.style.display !== "none");

  wraps.forEach((wrap, idx) => {
    const row = Math.floor(idx / 12);      // 9 cols per row
    const col = idx % 12;
    wrap.style.left = (col * 125) + "px";
    wrap.style.top  = (row * 165) + "px";
  });

  /* optional: grow the container so you can scroll all rows */
  const grid = document.getElementById("photoGridContainer");
  const totalRows = Math.ceil(wraps.length / 9);
  grid.style.height = (totalRows * 165) + "px";
}

  /* ‚îÄ‚îÄ‚îÄ METAL FILTER INITIALISER ‚îÄ‚îÄ‚îÄ */
  document.addEventListener("DOMContentLoaded", () => {

    const completedBtn = document.getElementById("completedCounter");

    /* click-toggle for the FOUR metal buttons (skip Completed) */
    document
      .querySelectorAll('.metal-counter:not([data-metal="completed"])')
      .forEach(btn => {
        btn.addEventListener("click", () => {
          btn.classList.toggle("active");          // blue outline
          completedBtn.classList.remove("active"); // Completed must turn off
          applyMetalFilter();
        });
      });

    /* exclusivity toggle for Completed */
    completedBtn.addEventListener("click", async () => {
      const isNowActive = completedBtn.classList.toggle("active");

      /* flip the four metal buttons */
      document
        .querySelectorAll(
          '.metal-counter[data-metal]:not([data-metal="completed"])'
        )
        .forEach(btn => btn.classList.toggle("active", !isNowActive));

       if (isNowActive) {
         await ensureCompletedPreviews();     // when turning Completed ON
       } else {
         await ensureOrangeIntegrity();      // brings orange back cleanly
       }

      applyMetalFilter();                 // refresh grid
    });

    /* -------------------------------------------------------------
     * ensureCompletedPreviews ‚Äì make sure every completed receipt
     *                           has at least one wrap in the grid
     * -------------------------------------------------------------*/
    function ensureCompletedPreviews(){
      const needReceipts = [];

      /* reveal existing wraps + collect truly-missing ones */
      completedOrders.forEach(id => {
        const wrap = document.querySelector(`.wrap-preview[data-receipt='${id}']`);
        if (wrap){
          wrap.style.display = "";
        }else{
          needReceipts.push(id);
        }
      });

      /* fetch only the missing ones */
      if (needReceipts.length){
        loadBatchEtsyOrders(needReceipts)
          .then(()=>{ reflowGrid(); updateCounters(); })
          .catch(err => console.error("Completed sync error:", err));
      }else{
        reflowGrid();
        updateCounters();
      }
    }

    /* -------------------------------------------------------------
     * ensureSelectedPreviews ‚Äì make sure every orange (selected)
     *   receipt that is NOT completed has a preview in the grid
     * -------------------------------------------------------------*/
    async function ensureSelectedPreviews() {
      const need = [];
      selectedOrders.forEach(rid => {
        if (completedOrders.has(rid)) return;                // skip greens
        const found = document.querySelector(
          `.wrap-preview[data-receipt="${rid}"]`
        );
        if (!found) need.push(rid);
      });
      if (need.length) {
        console.log("Loading previews for selected orders:", need);
        await loadBatchEtsyOrders(need);
      }
    }

    /* =================================================================
     * ensureOrangeIntegrity
     * ‚îÄ Re-syncs the orange (selected) state across rows, previews,
     *   Sets, maps, and duplicate guards.
     *   - creates any missing preview wraps
     *   - restores .selected class on rows & wraps
     *   - guarantees only one wrap per transaction
     * =================================================================*/
    async function ensureOrangeIntegrity() {
      const needReceipts = [];

      selectedOrders.forEach(rid => {
        /* A. make sure row carries the orange class */
        const row = document.querySelector(
          `.new-order-box[data-receipt='${rid}']`);
        if (row) row.classList.add("selected");

        /* B. make sure at least one preview exists */
        const anyWrap = document.querySelector(
          `#photoGridContainer .wrap-preview[data-receipt='${rid}']`);
        if (!anyWrap) needReceipts.push(rid);
      });

      /* C. load missing previews (if any) */
      if (needReceipts.length) {
        await loadBatchEtsyOrders(needReceipts);     // uses addPreviewBox
          reflowGrid();            // üÜï pack the grid tightly
          updateCounters();        // üÜï keep the badges honest
      }

      /* D. mark every visible wrap for a selected receipt */
      selectedOrders.forEach(rid => {
        document.querySelectorAll(
          `#photoGridContainer .wrap-preview[data-receipt='${rid}']`
        ).forEach(w => w.classList.add("selected"));
      });
    }

    /* filter helper --------------------------------------------------- */
    function applyMetalFilter() {

      const completedOn = completedBtn.classList.contains("active");

      /* 0Ô∏è‚É£  Handle left-column order rows ---------------------------- */
      document.querySelectorAll(".new-order-box").forEach(row => {
        const isGreen = row.classList.contains("completed");
        const hideGreens = !searchActive && !completedOn;
        row.style.display = hideGreens && isGreen ? "none" : "";
      });

      /* 1Ô∏è‚É£  Completed ON ‚Üí show only green previews ------------------ */
      if (completedOn) {
        gridElements.forEach(wrap => {
          wrap.style.display =
            completedOrders.has(wrap.dataset.receipt) ? "" : "none";
        });
        reflowGrid();
        updateCounters();           // counters stay metal-only
        return;
      }

      /* 2Ô∏è‚É£  Completed OFF ‚Üí normal metal filtering ------------------- */
      const activeMetals = new Set(
        Array.from(document.querySelectorAll(".metal-counter.active"))
             .map(btn => btn.dataset.metal)
      );

      gridElements.forEach(wrap => {
      const hideGreens = !searchActive && !completedOn;
      const show =
        ( !wrap.dataset.metal || activeMetals.has(wrap.dataset.metal) ) &&
        !(hideGreens && completedOrders.has(wrap.dataset.receipt));
              wrap.style.display = show ? "" : "none";

        /* ‚òÖ PROBE-B: is this wrap ghost-completed? */
            console.log("%cCOMPLETED?","color:#ff9100;font-weight:bold",
            wrap.dataset.receipt, completedOrders.has(wrap.dataset.receipt));

      });

      /* ‚îÄ‚îÄ restore 3-px orangered outline and orange rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
      selectedOrders.forEach(rid => {
        /* preview boxes */
        document.querySelectorAll(
          `#photoGridContainer .wrap-preview[data-receipt='${rid}']`
        ).forEach(wrap => wrap.classList.add("selected"));

        /* left-column rows */
        const row = document.querySelector(
          `.new-order-box[data-receipt='${rid}']`
        );
        if (row) row.classList.add("selected");
      });

      reflowGrid();
      updateCounters();             // keep top counters in sync

       /* one more pass in the next frame ‚Äî guarantees nothing strips the outline */
       requestAnimationFrame(() => {
         selectedOrders.forEach(rid => {
           document.querySelectorAll(
             `#photoGridContainer .wrap-preview[data-receipt='${rid}']`
           ).forEach(w => w.classList.add("selected"));
         });
       });

    }   /* ‚Üê end applyMetalFilter */

    /* make it callable from addPreviewBox and other helpers */
    window.applyMetalFilter = applyMetalFilter;

    /* first run honours the initial .active states */
    applyMetalFilter();

    });  /* ‚îÄ‚îÄ‚îÄ END METAL FILTER INITIALISER ‚îÄ‚îÄ‚îÄ */

    function openListingModal(cellIdx){
      const item = window.cachedOrderItems[cellIdx];
      if(!item){ return; }

      /* 1. title & image */
      document.getElementById("modalListingTitle").textContent =
      "Order #" + (item.receipt_id || item.orderNumber || "N/A");

      document.getElementById("modalListingImg").src = item.image;

      /* 2. notes  */
      const lines = [];
      if(item.personalization && item.personalization.length){
        lines.push("Personalization:\n" + item.personalization.join("\n"));
      }
      if(item.message_from_buyer){
        lines.push("Buyer Message:\n" + item.message_from_buyer.trim());
      }
      document.getElementById("modalListingNotes").textContent =
          lines.length ? lines.join("\n\n") : "‚Äî No notes ‚Äî";

      /* ----- build the 4 read-only fields ----- */
      const detRow = document.getElementById("modalListingDetails");
      detRow.innerHTML = "";                            // reset

      const mkInput = (lbl,val) => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.readOnly = true;
        inp.value = `${lbl}: ${val}`;
        detRow.appendChild(inp);
      };

      /* ensure we have otherLabel even if makePreviewNode missed it */
      if (!item.otherLabel && Array.isArray(item.variations)) {
        const v = item.variations.find(x =>
          !/(metal|colour|color)/i.test(x.formatted_name || "") &&
          !/personalization/i.test(x.formatted_name || "")
        );
        item.otherLabel = v ? v.formatted_value : "N/A";
      }

      mkInput("Qty"  , item.quantity   ?? "0");
      mkInput("Metal", item.metalLabel || "N/A");
      mkInput("SKU"  , item.sku        || "N/A");
      mkInput("Other", item.otherLabel || "N/A");   // NEW line

      /* ‚ñº‚ñº  STAFF NOTE sync  (deduped) ‚ñº‚ñº */
      const staffInp = document.getElementById("modalStaffNote");
      const orderId  = String(item.receipt_id || item.orderNumber);

      staffInp.value = "";   // reset before fetch

      fetch(`${functionsBaseUrl}/firebaseOrders?orderId=${encodeURIComponent(orderId)}`)
        .then(r => r.json())
        .then(res => {
          if (res.success && res.data && res.data["Staff Note"]) {
            staffInp.value = res.data["Staff Note"];
          }
        })
        .catch(console.error);

      /* overwrite any previous handlers */
        staffInp.onchange = staffInp.onblur = async () => {
        const note = staffInp.value.trim();

        /* write to Firestore */
        fetch(`${functionsBaseUrl}/firebaseOrders`,{
          method : "POST",
          headers: { "Content-Type":"application/json" },
          body   : JSON.stringify({ orderNumber: orderId, staffNote: note })
        }).catch(console.error);

        /* instant UI feedback */
        if(note){
          staffNoteIDs.add(orderId);
        }else{
          staffNoteIDs.delete(orderId);
        }
        markStaffNoteOrders();
      };
      /* ‚ñ≤‚ñ≤  end STAFF NOTE sync ‚ñ≤‚ñ≤ */

      /* sync checkbox with this order */
      modalCompleteChk.checked   = completedOrders.has(orderId);
      modalCompleteChk.dataset.rid = orderId;    // pass receipt ID

      listingModal.open();
    }

    /* pack remaining previews after removals ------------------------ */
    function realignGrid(){
      const wraps = Array.from(document.querySelectorAll("#photoGridContainer .wrap-preview"));
      wraps.forEach((w, idx) => {
        const row = Math.floor(idx / 12);
        const col = idx % 12;
        w.style.left = (col * 125) + "px";
        w.style.top  = (row * 165) + "px";
      });
    }  

  </script>

<!-- ‚îÄ‚îÄ‚îÄ Listing-detail modal ‚îÄ‚îÄ‚îÄ -->
<div id="listingModal" class="modal">
  <div class="modal-content">
    <!-- ‚ñº‚ñº NEW COMPLETE-CHECKBOX ‚ñº‚ñº -->
    <label id="modalCompleteWrap" class="modal-complete-label">
      <input id="modalCompleteChk" type="checkbox" class="filled-in" />
      <span></span>
    </label>
    <!-- ‚ñ≤‚ñ≤ NEW COMPLETE-CHECKBOX ‚ñ≤‚ñ≤ -->

    <h5 id="modalListingTitle"></h5>

    <div class="modal-flex-row">
      <img id="modalListingImg" />

      <!-- notes + staff input stacked -->
      <div class="modal-notes-col">
        <pre id="modalListingNotes"></pre>

        <input id="modalStaffNote"
               type="text"
               placeholder="Staff Note">
      </div>
    </div>

    <div id="modalListingDetails" class="modal-detail-row"></div>
  </div><!-- /modal-content -->

  <div class="modal-footer">
    <a href="#!" class="modal-close btn-flat">Close</a>
  </div>
</div><!-- /listingModal -->

</body>
</html>