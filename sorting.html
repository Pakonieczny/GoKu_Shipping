<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sorting - Single-Click Zoom</title>
  <!-- Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
  <style>
    body {
      background-color: #fff;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0;
      transition: opacity 0s;
    }
    /* Main Buttons */
    #connectEtsyBtn,
    #testOpenAIBtn,
    #openConfigBtn,
    #cropImagesBtn,
    #sendMatchBtn {
      position: absolute;
      left: 20px;
      width: 140px;
      height: 36px;
    }
    #connectEtsyBtn { top: 20px; }
    #testOpenAIBtn { top: 70px; }
    #openConfigBtn { top: 120px; }
    #cropImagesBtn { top: 170px; }
    #sendMatchBtn { top: 220px; }
    
    /* Etsy Order Number input */
    #etsyOrderNumber {
      position: absolute;
      left: 20px;
      top: 270px;
      width: 300px;
      height: 30px;
      border: 1px solid #999;
      padding: 4px;
      outline: none;
      font-size: 0.9em;
    }
    
    /* Image Comparison UI */
    #imageComparisonContainer {
      position: absolute;
      left: 20px;
      top: 310px;
    }
    #photoDragDrop {
      width: 100px;
      height: 100px;
      border: 2px dashed #ccc;
      text-align: center;
      line-height: 100px;
      display: inline-block;
      margin-right: 10px;
    }
    #userImage {
      width: 100px;
      height: 100px;
      border: 1px solid #000;
      display: none;
      vertical-align: top;
    }
    
    /* Container for dynamically generated preview boxes and detail boxes */
    #photoGridContainer {
      position: relative;
      width: 1200px;
      max-height: 700px;
      overflow-y: auto;
      border-left: 1px dashed #ccc;
      border-right: 1px dashed #ccc;
      left: 350px;
      top: 20px;
    }
    /* Preview box styling (110x110) */
    .preview-box {
      position: absolute;
      width: 110px;
      height: 110px;
      border: 1px solid #000;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      user-select: none;
      font-size: 0.7em;
      text-align: center;
    }
    .preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform-origin: center center;
      transition: transform 0.3s ease;
    }
    /* Detail text boxes: 55px x 7px, left-justified relative to preview box */
    .detail-box {
      position: absolute;
      width: 55px;
      height: 7px;
      font-size: 0.6em !important;
      border: none !important;
      outline: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
      background: #f0f0f0;
      color: #333;
      padding: 0;
      margin: 0;
      box-shadow: none !important;
    }
    .detail-box:read-only {
      pointer-events: none;
    }
    /* Config Modal */
    #configModal.modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 250px !important;
      height: 450px !important;
      max-height: none !important;
      overflow-y: auto !important;
    }
    #configTable thead tr th { font-size: 0.9em; }
    #configTable tbody tr td { font-size: 0.8em; }
    #configTable .left-input,
    #configTable .top-input,
    #configTable .width-input,
    #configTable .height-input { width: 80px !important; }
  </style>
</head>
<body>
  <!-- Main Buttons -->
  <button id="connectEtsyBtn" class="btn waves-effect waves-light">Connect to Etsy</button>
  <button id="testOpenAIBtn" class="btn waves-effect waves-light">Test OpenAI</button>
  <button id="openConfigBtn" class="btn waves-effect waves-light">Open Config</button>
  <button id="cropImagesBtn" class="btn waves-effect waves-light">Crop Images</button>
  <button id="sendMatchBtn" class="btn waves-effect waves-light">Send & Match</button>
  
  <!-- Etsy Order Number input -->
  <input type="text" id="etsyOrderNumber" placeholder="Comma-delimited Etsy Order Numbers" />
  
  <!-- Image Comparison UI -->
  <div id="imageComparisonContainer">
    <div id="photoDragDrop">Drag & Drop Photo(s)</div>
    <img id="userImage" src="" alt="User Image" />
  </div>
  
  <!-- Container for dynamically generated preview boxes and detail boxes -->
  <div id="photoGridContainer">
    <!-- Preview boxes and detail boxes will be created dynamically -->
  </div>
  
  <!-- Config Modal -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <table class="striped" id="configTable">
        <thead>
          <tr>
            <th>Element</th>
            <th>Left (px)</th>
            <th>Top (px)</th>
            <th>Width (px)</th>
            <th>Height</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <a href="#!" id="saveConfigBtn" class="modal-close waves-effect waves-green btn">Save Config</a>
    </div>
  </div>
  
  <!-- Matches Modal (Shared, but will be populated with cell-specific matches) -->
  <div id="matchesModal" class="modal">
    <div class="modal-content">
      <h5>Successful Image Matches</h5>
      <div id="matchesGridContainer" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn">Close</a>
    </div>
  </div>
  
  <!-- jQuery & Materialize JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    // We'll store the base URL for Netlify functions
    const functionsBaseUrl = window.location.origin + "/.netlify/functions";

    // Global arrays to store images
    let croppedImagesArray = [];
    let userImagesArray = [];
    let cellMatches = {};
    let partialMatches = {};
    let currentProductSetId = null; // For Vision Product Search

    (function(){
      const urlParams = new URLSearchParams(window.location.search);
      const accessToken = urlParams.get("access_token");
      if(accessToken){
        localStorage.setItem("access_token", accessToken);
        window.history.replaceState({}, document.title, window.location.pathname);
        M.toast({html:"Connection Successful!"});
        console.log("Access token received:", accessToken);
      } else {
        const authCode = urlParams.get("code");
        if(authCode){
          const storedCodeVerifier = localStorage.getItem("etsy_code_verifier");
          if(storedCodeVerifier){
            window.location.href =
              "/.netlify/functions/exchangeToken?code=" +
              encodeURIComponent(authCode) +
              "&code_verifier=" +
              encodeURIComponent(storedCodeVerifier);
          } else {
            console.error("No code verifier found in localStorage.");
          }
        }
      }
    })();

    function generateRandomString(length) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let text = "";
      for (let i = 0; i < length; i++){
        text += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return text;
    }

    document.addEventListener("DOMContentLoaded", function() {
      M.AutoInit();
      setTimeout(() => {
        loadPositions();
        document.body.style.opacity = 1;
      }, 200);

      // Connect to Etsy
      document.getElementById("connectEtsyBtn").addEventListener("click", async function() {
        try {
          const codeVerifier = generateRandomString(64);
          localStorage.setItem("etsy_code_verifier", codeVerifier);
          // ... your existing Etsy OAuth approach
        } catch (err) {
          console.error("OAuth start error:", err);
          M.toast({ html: "OAuth error: " + err.message });
        }
      });

      // Test OpenAI
      document.getElementById("testOpenAIBtn").addEventListener("click", async function() {
        try {
          const testBody = {
            model: "gpt-3.5-turbo",
            messages: [{ role: "user", content: "Hello from the Sorting page!" }]
          };
          const resp = await fetch(functionsBaseUrl + "/openaiProxy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testBody)
          });
          if (!resp.ok) {
            throw new Error("OpenAI test call failed with " + resp.status);
          }
          const data = await resp.json();
          if (data.choices && data.choices[0] && data.choices[0].message) {
            M.toast({ html: "OpenAI responded successfully." });
          } else {
            throw new Error("No valid response from OpenAI!");
          }
        } catch (err) {
          M.toast({ html: "OpenAI test failed: " + err.message });
        }
      });

      // Etsy Order Number "Enter" => load orders
      const etsyOrderInput = document.getElementById("etsyOrderNumber");
      etsyOrderInput.addEventListener("keydown", async function(e) {
        if (e.key === "Enter") {
          const inputVal = etsyOrderInput.value.trim();
          if (!inputVal) return;
          const orderNumbers = inputVal.split(",").map(x => x.trim()).filter(x => x);
          await loadBatchEtsyOrders(orderNumbers);
        }
      });

      // Crop Images
      document.getElementById("cropImagesBtn").addEventListener("click", async function() {
        croppedImagesArray = [];
        await cropAllImages();
      });

      // Send & Match
      document.getElementById("sendMatchBtn").addEventListener("click", async function() {
        try {
          // 1) Initialize the ProductSet with user images
          await initGoogleProductSearchSession();

          // 2) Run sendAndMatch
          await sendAndMatch();

          // 3) Cleanup
          await cleanupGoogleProductSearchSession();
        } catch (err) {
          console.error("Send & Match error:", err);
          M.toast({ html: "Error: " + err.message });
        }
      });
    });

    // ============================
    // Netlify Function Calls
    // ============================
    async function initGoogleProductSearchSession() {
      currentProductSetId = "temp_" + Date.now();
      const body = {
        action: "init",
        productSetId: currentProductSetId,
        location: "us-east1",
        base64Images: userImagesArray.map(u => ({
          name: u.name,
          base64: u.data
        }))
      };
      const resp = await fetch(`${functionsBaseUrl}/googleVisionProductSearch`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await resp.json();
      if (!data.success) {
        throw new Error("Failed to init ProductSet: " + JSON.stringify(data));
      }
      console.log("ProductSet created:", data.productSetId);
    }

    async function googleProductSearchForEtsyImage(base64) {
      // In reality, we'd need to upload this 'base64' to a GCS or HTTPS link. 
      // For demonstration, the server uses placekitten. 
      const body = {
        action: "search",
        productSetId: currentProductSetId,
        location: "us-east1",
        singleEtsyImage: { name: "etsy", base64 }
      };
      const resp = await fetch(`${functionsBaseUrl}/googleVisionProductSearch`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await resp.json();
      return {
        score: data.matchScore || 0,
        productName: data.productName || null
      };
    }

    async function cleanupGoogleProductSearchSession() {
      if (!currentProductSetId) return;
      const body = {
        action: "cleanup",
        productSetId: currentProductSetId,
        location: "us-east1"
      };
      await fetch(`${functionsBaseUrl}/googleVisionProductSearch`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      console.log("Cleaned up ProductSet " + currentProductSetId);
      currentProductSetId = null;
    }

    // ============================
    // The main "sendAndMatch"
    // ============================
    async function sendAndMatch() {
      if (userImagesArray.length === 0) {
        M.toast({ html: "No user images available! Please drop user images first." });
        return;
      }
      if (!croppedImagesArray || croppedImagesArray.length === 0) {
        M.toast({ html: "No cropped grid images available! Please crop images first." });
        return;
      }

      let unmatchedCells = [];
      for (let i = 0; i < croppedImagesArray.length; i++) {
        if (croppedImagesArray[i]) unmatchedCells.push(i);
      }

      for (const i of unmatchedCells) {
        const matchBox = document.getElementById("matchCell" + i);
        const etsyCroppedBase64 = croppedImagesArray[i];

        // Query Vision Product Search
        const { score, productName } = await googleProductSearchForEtsyImage(etsyCroppedBase64);
        if (score === 0) {
          M.toast({ html: "Cell " + i + ": No valid matches found (score=0)." });
          continue;
        }
        const topScore = score;
        const topScorePerc = (topScore * 100).toFixed(2);

        M.toast({ html: `Cell ${i}: Best candidate => ${productName} (${topScorePerc}%)` });

        if (topScore >= 1.0) {
          // Perfect
          matchBox.value = productName;
          matchBox.style.fontWeight = (1.0 < 0.95) ? "bold" : "";
          matchBox.style.color = (1.0 < 0.95) ? "orangered" : "";
          if (!cellMatches[i]) cellMatches[i] = [];
          cellMatches[i].push({ userName: productName, userImage: "", score: 1.0 });
          userImagesArray = userImagesArray.filter(u => u.name !== productName);
          croppedImagesArray[i] = null;
          continue;
        }

        if (topScore < 0.90) {
          M.toast({ html: `Cell ${i}: Score ${topScorePerc}% < 90% => no match.` });
          continue;
        }

        if (topScore >= 0.90 && topScore < 0.95) {
          // partial
          matchBox.value = productName;
          matchBox.style.fontWeight = "bold";
          matchBox.style.color = "orangered";
          if (!cellMatches[i]) cellMatches[i] = [];
          cellMatches[i].push({ userName: productName, userImage: "", score: topScore });
          croppedImagesArray[i] = null;

          // keep user image in userImagesArray
          partialMatches[productName] = { cellIndex: i, score: topScore };
          continue;
        }

        if (topScore >= 0.95) {
          // strong
          // if partial matched before, undo it
          if (partialMatches[productName]) {
            const oldCellIndex = partialMatches[productName].cellIndex;
            const oldMatchBox = document.getElementById("matchCell" + oldCellIndex);
            if (oldMatchBox) {
              oldMatchBox.value = "";
              oldMatchBox.style.fontWeight = "";
              oldMatchBox.style.color = "";
            }
            if (cellMatches[oldCellIndex]) {
              cellMatches[oldCellIndex] = cellMatches[oldCellIndex].filter(m => m.userName !== productName);
            }
            delete partialMatches[productName];
          }

          matchBox.value = productName;
          matchBox.style.fontWeight = "";
          matchBox.style.color = "";
          if (!cellMatches[i]) cellMatches[i] = [];
          cellMatches[i].push({ userName: productName, userImage: "", score: topScore });
          userImagesArray = userImagesArray.filter(u => u.name !== productName);
          croppedImagesArray[i] = null;
        }
      }
    }

    // ============================
    // Drag & Drop
    // ============================
    const photoDragDropElem = document.getElementById("photoDragDrop");
    photoDragDropElem.addEventListener("dragover", function(e) {
      e.preventDefault();
    });
    photoDragDropElem.addEventListener("drop", function(e) {
      e.preventDefault();
      const files = e.dataTransfer.files;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        reader.onload = async function(e) {
          const imageData = e.target.result;
          try {
            const resizedData = await resizeUserImage(imageData);
            userImagesArray.push({ name: file.name, data: resizedData });
            M.toast({ html: `User image ${userImagesArray.length} captured.` });
            if (userImagesArray.length === 1) {
              const userImageElem = document.getElementById("userImage");
              userImageElem.src = resizedData;
              userImageElem.style.display = "inline-block";
            }
          } catch(err) {
            console.error("Error resizing user image:", err);
            M.toast({ html: "Error processing user image." });
          }
        };
        reader.readAsDataURL(file);
      }
    });

    function resizeUserImage(dataUrl) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = function() {
          const canvas = document.createElement("canvas");
          canvas.width = 512;
          canvas.height = 512;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, 512, 512);
          resolve(canvas.toDataURL());
        };
        img.onerror = reject;
        img.src = dataUrl;
      });
    }

    // ============================
    // fillPreviewBoxes, loadBatchEtsyOrders, etc. remain the same
    // ============================
    async function loadBatchEtsyOrders(orderNumbers) {
      try {
        M.toast({ html: "Loading " + orderNumbers.length + " order(s)..." });
        const token = localStorage.getItem("access_token") || "";
        let combinedItems = [];
        for (let ord of orderNumbers) {
          const url = `${functionsBaseUrl}/etsyOrderProxy?orderId=${encodeURIComponent(ord)}`;
          const resp = await fetch(url, { headers: { "access-token": token } });
          if (!resp.ok) {
            console.warn("Order fetch failed for " + ord + ", status=" + resp.status);
            continue;
          }
          const data = await resp.json();
          if (data.transactions && Array.isArray(data.transactions)) {
            combinedItems.push(...data.transactions);
          } else {
            console.warn("No transactions for order " + ord);
          }
        }
        await fillPreviewBoxes(combinedItems);
      } catch (err) {
        console.error("Error loading batch orders:", err);
        M.toast({ html: "Error: " + err.message });
      }
    }

    async function fillPreviewBoxes(items) {
      const container = document.getElementById("photoGridContainer");
      container.innerHTML = "";
      window.cachedOrderItems = items;
      items.forEach((item, index) => {
        const row = Math.floor(index / 9);
        const col = index % 9;
        const previewLeft = col * 125;
        const previewTop = row * 165;

        const previewBox = document.createElement("div");
        previewBox.classList.add("preview-box");
        previewBox.id = "previewCell" + index;
        previewBox.style.position = "absolute";
        previewBox.style.left = previewLeft + "px";
        previewBox.style.top = previewTop + "px";
        previewBox.style.width = "110px";
        previewBox.style.height = "110px";
        previewBox.innerHTML = "Loading...";

        const orderInput = document.createElement("input");
        orderInput.type = "text";
        orderInput.readOnly = true;
        orderInput.id = "orderCell" + index;
        orderInput.classList.add("detail-box");
        orderInput.style.left = previewLeft + "px";
        orderInput.style.top = (previewTop + 95) + "px";
        orderInput.value = item.receipt_id ? item.receipt_id : (item.orderNumber || "No Order #");
        orderInput.style.fontWeight = "bold";

        const qtyInput = document.createElement("input");
        qtyInput.type = "text";
        qtyInput.readOnly = true;
        qtyInput.id = "quantityCell" + index;
        qtyInput.classList.add("detail-box");
        qtyInput.style.left = previewLeft + "px";
        qtyInput.style.top = (previewTop + 107) + "px";
        qtyInput.value = " Qty: " + (item.quantity != null ? item.quantity : 0);

        const metalInput = document.createElement("input");
        metalInput.type = "text";
        metalInput.readOnly = true;
        metalInput.id = "metalCell" + index;
        metalInput.classList.add("detail-box");
        metalInput.style.left = previewLeft + "px";
        metalInput.style.top = (previewTop + 119) + "px";
        let metalSel = "";
        if (item.variations && Array.isArray(item.variations)) {
          const acceptedMetalNames = ["metal", "metal choice", "metal - engraving", "metal colour", "color", "metal choice / engraving option"];
          const metalVar = item.variations.find(v => v.formatted_name && acceptedMetalNames.includes(v.formatted_name.trim().toLowerCase()));
          if (metalVar && metalVar.formatted_value) {
            metalSel = metalVar.formatted_value;
          }
        }
        metalInput.value = " Metal: " + (metalSel || "No Metal");

        const matchInput = document.createElement("input");
        matchInput.type = "text";
        matchInput.readOnly = true;
        matchInput.id = "matchCell" + index;
        matchInput.classList.add("detail-box");
        matchInput.style.left = previewLeft + "px";
        matchInput.style.top = (previewTop + 131) + "px";
        matchInput.value = "";
        matchInput.addEventListener("click", function() {
          showMatchesModal(index);
        });

        container.appendChild(previewBox);
        container.appendChild(orderInput);
        container.appendChild(qtyInput);
        container.appendChild(metalInput);
        container.appendChild(matchInput);

        // Load listing image
        fetchListingImages(item.listing_id)
          .then(imageData => {
            if (imageData && imageData.length > 0) {
              return getLocalImageData(imageData[0].url_fullxfull);
            } else {
              throw "No image data";
            }
          })
          .then(localImageData => {
            previewBox.innerHTML = `<img src="${localImageData}" alt="Listing ${item.listing_id}" data-scale="1" data-offsetX="0" data-offsetY="0" />`;
            attachPreviewBoxListeners(previewBox);
          })
          .catch(err => {
            console.warn("Error loading image for cell " + index + ":", err);
            previewBox.innerHTML = "Img Error";
          });
      });
    }

    async function fetchListingImages(listingId) {
      const token = localStorage.getItem("access_token") || "";
      const resp = await fetch(`${functionsBaseUrl}/etsyImages?listingId=${listingId}`, {
        headers: { "access-token": token }
      });
      if (!resp.ok) {
        console.warn("Image fetch HTTP error:", resp.status);
        return [];
      }
      const data = await resp.json();
      return data.results || [];
    }

    async function getLocalImageData(imageUrl) {
      try {
        const resp = await fetch(`${functionsBaseUrl}/imageProxy?url=${encodeURIComponent(imageUrl)}`);
        const blob = await resp.blob();
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      } catch (err) {
        console.error("Error in getLocalImageData:", err);
        throw err;
      }
    }

    function attachPreviewBoxListeners(box) {
      let isDragging = false;
      let isMouseDown = false;
      let dragStartX = 0, dragStartY = 0;
      let lastX = 0, lastY = 0;
      const dragThreshold = 3;

      box.addEventListener("wheel", function(ev) {
        const img = box.querySelector("img");
        if (!img) return;
        ev.preventDefault();
        let currentScale = parseFloat(img.dataset.scale) || 1;
        let offX = parseFloat(img.dataset.offsetX) || 0;
        let offY = parseFloat(img.dataset.offsetY) || 0;
        if (ev.deltaY < 0) {
          currentScale *= 1.1;
        } else {
          currentScale /= 1.1;
          if (currentScale <= 1) {
            currentScale = 1;
            offX = 0;
            offY = 0;
          }
        }
        if (currentScale > 8) currentScale = 8;
        img.dataset.scale = currentScale;
        img.dataset.offsetX = offX;
        img.dataset.offsetY = offY;
        img.style.transform = `translate(${offX}px, ${offY}px) scale(${currentScale})`;
      });

      box.addEventListener("mousedown", function(ev) {
        const img = box.querySelector("img");
        if (!img) return;
        const scaleNow = parseFloat(img.dataset.scale) || 1;
        if (scaleNow <= 1) return;
        ev.preventDefault();
        isMouseDown = true;
        isDragging = false;
        dragStartX = ev.clientX;
        dragStartY = ev.clientY;
        lastX = ev.clientX;
        lastY = ev.clientY;
      });

      box.addEventListener("mousemove", function(ev) {
        if (!isMouseDown) return;
        ev.preventDefault();
        const dxAll = Math.abs(ev.clientX - dragStartX);
        const dyAll = Math.abs(ev.clientY - dragStartY);
        if (dxAll > dragThreshold || dyAll > dragThreshold) isDragging = true;
        const img = box.querySelector("img");
        if (!img) return;
        const scaleNow = parseFloat(img.dataset.scale) || 1;
        let offX = parseFloat(img.dataset.offsetX) || 0;
        let offY = parseFloat(img.dataset.offsetY) || 0;
        const dx = ev.clientX - lastX;
        const dy = ev.clientY - lastY;
        offX += dx;
        offY += dy;
        img.dataset.offsetX = offX;
        img.dataset.offsetY = offY;
        img.style.transform = `translate(${offX}px, ${offY}px) scale(${scaleNow})`;
        lastX = ev.clientX;
        lastY = ev.clientY;
      });

      box.addEventListener("mouseup", function() { isMouseDown = false; });
      box.addEventListener("mouseleave", function() { isMouseDown = false; });

      box.addEventListener("click", function(ev) {
        if (isDragging) { isDragging = false; return; }
        const img = box.querySelector("img");
        if (!img) return;
        const rect = box.getBoundingClientRect();
        const boxCenterX = rect.left + box.clientWidth / 2;
        const boxCenterY = rect.top + box.clientHeight / 2;
        const dx = ev.clientX - boxCenterX;
        const dy = ev.clientY - boxCenterY;
        const scale = 5;
        const fudgeY = 10;
        const offsetX = -scale * dx;
        const offsetY = -scale * dy + fudgeY;
        img.dataset.scale = scale;
        img.dataset.offsetX = offsetX;
        img.dataset.offsetY = offsetY;
        img.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
      });
    }

    function loadPositions() {
      const configIDs = [
        "connectEtsyBtn", "testOpenAIBtn", "openConfigBtn", "etsyOrderNumber",
        "photoGridContainer", "configModal", "configTable", "saveConfigBtn"
      ];
      configIDs.forEach(function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const def = {};
        const left = localStorage.getItem(`pos-${id}-left`) || def.left || 0;
        const top  = localStorage.getItem(`pos-${id}-top`) || def.top || 0;
        const w    = localStorage.getItem(`pos-${id}-width`) || def.width || 0;
        const h    = localStorage.getItem(`pos-${id}-height`) || def.height || 0;
        el.style.position = "absolute";
        el.style.left = left + "px";
        el.style.top = top + "px";
        el.style.width = w + "px";
        el.style.height = h + "px";
      });
    }

    function populateConfigTable() {
      const configIDs = [
        "connectEtsyBtn", "testOpenAIBtn", "openConfigBtn", "etsyOrderNumber",
        "photoGridContainer", "configModal", "configTable", "saveConfigBtn"
      ];
      const tbody = document.querySelector("#configTable tbody");
      tbody.innerHTML = "";
      configIDs.forEach(function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const cs = window.getComputedStyle(el);
        const leftVal = parseInt(cs.left, 10) || 0;
        const topVal = parseInt(cs.top, 10) || 0;
        const widthVal = parseInt(cs.width, 10) || 0;
        const heightVal = parseInt(cs.height, 10) || 0;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${id}</td>
          <td><input type="number" value="${leftVal}" data-id="${id}" class="left-input"></td>
          <td><input type="number" value="${topVal}" data-id="${id}" class="top-input"></td>
          <td><input type="number" value="${widthVal}" data-id="${id}" class="width-input"></td>
          <td><input type="number" value="${heightVal}" data-id="${id}" class="height-input"></td>
        `;
        tbody.appendChild(row);
        row.querySelector(".left-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.left = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".top-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.top = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".width-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.width = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".height-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.height = parseInt(this.value, 10) + "px";
        });
      });
    }

    document.getElementById("openConfigBtn").addEventListener("click", function() {
      populateConfigTable();
      M.Modal.getInstance(document.getElementById("configModal")).open();
    });

    document.getElementById("saveConfigBtn").addEventListener("click", function() {
      const configIDs = [
        "connectEtsyBtn", "testOpenAIBtn", "openConfigBtn", "etsyOrderNumber",
        "photoGridContainer", "configModal", "configTable", "saveConfigBtn"
      ];
      configIDs.forEach(function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const cs = window.getComputedStyle(el);
        localStorage.setItem(`pos-${id}-left`, parseInt(cs.left, 10) || 0);
        localStorage.setItem(`pos-${id}-top`, parseInt(cs.top, 10) || 0);
        localStorage.setItem(`pos-${id}-width`, parseInt(cs.width, 10) || 0);
        localStorage.setItem(`pos-${id}-height`, parseInt(cs.height, 10) || 0);
      });
      M.toast({ html: "Positions saved!" });
    });

    function showMatchesModal(cellIndex) {
      const modalElem = document.getElementById("matchesModal");
      const container = document.getElementById("matchesGridContainer");
      container.innerHTML = "";
      
      const matches = cellMatches[cellIndex] || [];
      if (matches.length === 0) {
        container.innerHTML = "<p>No matches found for this photo.</p>";
      } else {
        matches.forEach((match) => {
          const box = document.createElement("div");
          box.classList.add("preview-box");
          box.style.width = "110px";
          box.style.height = "110px";
          box.style.border = "1px solid #000";
          box.style.background = "#fafafa";
          box.style.display = "flex";
          box.style.alignItems = "center";
          box.style.justifyContent = "center";
          box.style.overflow = "hidden";
          
          const img = document.createElement("img");
          img.src = match.userImage;
          img.alt = "Match for cell " + cellIndex;
          img.style.width = "100%";
          img.style.height = "100%";
          img.style.objectFit = "cover";
          
          box.appendChild(img);
          container.appendChild(box);
        });
      }
      
      const instance = M.Modal.getInstance(modalElem);
      if (instance) {
        instance.open();
      } else {
        M.Modal.init(modalElem);
        M.Modal.getInstance(modalElem).open();
      }
    }
  </script>
</body>
</html>