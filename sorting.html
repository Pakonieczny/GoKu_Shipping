<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sorting - Batch Etsy Orders</title>

  <!-- Materialize CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  />

  <style>
    body {
      background-color: #fff;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0;
      transition: opacity 0s;
    }

    /* Buttons */
    #connectEtsyBtn,
    #testOpenAIBtn,
    #openConfigBtn {
      position: absolute;
      left: 20px;
      width: 140px;
      height: 36px;
    }
    #connectEtsyBtn {
      top: 20px;
    }
    #testOpenAIBtn {
      top: 70px;
    }
    #openConfigBtn {
      top: 120px;
    }

    /* The "Etsy Order Number" text can hold up to 50 comma-delimited numbers now */
    #etsyOrderNumber {
      position: absolute;
      left: 20px;
      top: 170px;
      width: 300px; /* maybe a bit wider, since user might type multiple numbers */
      height: 30px;
      border: 1px solid #999;
      padding: 4px;
      outline: none;
      font-size: 0.9em;
    }

    /* Container for the 35 boxes */
    #photoGridContainer {
      position: relative;
      width: 1200px; 
      height: 700px; 
      border: 1px dashed #ccc; 
      left: 350px; /* shift a bit, since we made the input wider */
      top: 20px;
    }

    .preview-box {
      position: absolute;
      width: 66px;
      height: 66px;
      border: 1px solid #000;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      user-select: none;
      font-size: 0.7em;
      text-align: center;
    }
    .preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform-origin: center center;
      transition: transform 0.2s ease;
    }

    .quantity-label,
    .title-label {
      position: absolute;
      font-size: 0.7em;
      text-align: center;
      width: 66px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      margin-top: 3px;
    }

    /* Config Modal => 250×450, same as prior version */
    #configModal.modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 250px !important;
      height: 450px !important;
      max-height: none !important;
      overflow-y: auto !important;
    }
    #configTable thead tr th {
      font-size: 0.9em;
    }
    #configTable tbody tr td {
      font-size: 0.8em;
    }
    /* 2× wide text boxes for Left/Top/Width/Height */
    #configTable .left-input,
    #configTable .top-input,
    #configTable .width-input,
    #configTable .height-input {
      width: 80px !important;
    }
  </style>
</head>

<body>
  <!-- Buttons: Connect Etsy, Test OpenAI, Open Config -->
  <button id="connectEtsyBtn" class="btn waves-effect waves-light">Connect to Etsy</button>
  <button id="testOpenAIBtn" class="btn waves-effect waves-light">Test OpenAI</button>
  <button id="openConfigBtn" class="btn waves-effect waves-light">Open Config</button>

  <!-- "Etsy Order Number" => now can hold up to 50 comma-delimited order IDs -->
  <input type="text" id="etsyOrderNumber" placeholder="Comma-delimited Etsy Order Numbers" />

  <div id="photoGridContainer">
    <!-- 35 sets of preview, quantity, and title elements -->
    <div class="preview-box" id="previewCell0">Empty</div>
    <div class="quantity-label" id="quantityCell0"></div>
    <div class="title-label" id="titleCell0"></div>

    <div class="preview-box" id="previewCell1">Empty</div>
    <div class="quantity-label" id="quantityCell1"></div>
    <div class="title-label" id="titleCell1"></div>

    <div class="preview-box" id="previewCell2">Empty</div>
    <div class="quantity-label" id="quantityCell2"></div>
    <div class="title-label" id="titleCell2"></div>

    <div class="preview-box" id="previewCell3">Empty</div>
    <div class="quantity-label" id="quantityCell3"></div>
    <div class="title-label" id="titleCell3"></div>

    <div class="preview-box" id="previewCell4">Empty</div>
    <div class="quantity-label" id="quantityCell4"></div>
    <div class="title-label" id="titleCell4"></div>

    <div class="preview-box" id="previewCell5">Empty</div>
    <div class="quantity-label" id="quantityCell5"></div>
    <div class="title-label" id="titleCell5"></div>

    <div class="preview-box" id="previewCell6">Empty</div>
    <div class="quantity-label" id="quantityCell6"></div>
    <div class="title-label" id="titleCell6"></div>

    <div class="preview-box" id="previewCell7">Empty</div>
    <div class="quantity-label" id="quantityCell7"></div>
    <div class="title-label" id="titleCell7"></div>

    <div class="preview-box" id="previewCell8">Empty</div>
    <div class="quantity-label" id="quantityCell8"></div>
    <div class="title-label" id="titleCell8"></div>

    <div class="preview-box" id="previewCell9">Empty</div>
    <div class="quantity-label" id="quantityCell9"></div>
    <div class="title-label" id="titleCell9"></div>

    <div class="preview-box" id="previewCell10">Empty</div>
    <div class="quantity-label" id="quantityCell10"></div>
    <div class="title-label" id="titleCell10"></div>

    <div class="preview-box" id="previewCell11">Empty</div>
    <div class="quantity-label" id="quantityCell11"></div>
    <div class="title-label" id="titleCell11"></div>

    <div class="preview-box" id="previewCell12">Empty</div>
    <div class="quantity-label" id="quantityCell12"></div>
    <div class="title-label" id="titleCell12"></div>

    <div class="preview-box" id="previewCell13">Empty</div>
    <div class="quantity-label" id="quantityCell13"></div>
    <div class="title-label" id="titleCell13"></div>

    <div class="preview-box" id="previewCell14">Empty</div>
    <div class="quantity-label" id="quantityCell14"></div>
    <div class="title-label" id="titleCell14"></div>

    <div class="preview-box" id="previewCell15">Empty</div>
    <div class="quantity-label" id="quantityCell15"></div>
    <div class="title-label" id="titleCell15"></div>

    <div class="preview-box" id="previewCell16">Empty</div>
    <div class="quantity-label" id="quantityCell16"></div>
    <div class="title-label" id="titleCell16"></div>

    <div class="preview-box" id="previewCell17">Empty</div>
    <div class="quantity-label" id="quantityCell17"></div>
    <div class="title-label" id="titleCell17"></div>

    <div class="preview-box" id="previewCell18">Empty</div>
    <div class="quantity-label" id="quantityCell18"></div>
    <div class="title-label" id="titleCell18"></div>

    <div class="preview-box" id="previewCell19">Empty</div>
    <div class="quantity-label" id="quantityCell19"></div>
    <div class="title-label" id="titleCell19"></div>

    <div class="preview-box" id="previewCell20">Empty</div>
    <div class="quantity-label" id="quantityCell20"></div>
    <div class="title-label" id="titleCell20"></div>

    <div class="preview-box" id="previewCell21">Empty</div>
    <div class="quantity-label" id="quantityCell21"></div>
    <div class="title-label" id="titleCell21"></div>

    <div class="preview-box" id="previewCell22">Empty</div>
    <div class="quantity-label" id="quantityCell22"></div>
    <div class="title-label" id="titleCell22"></div>

    <div class="preview-box" id="previewCell23">Empty</div>
    <div class="quantity-label" id="quantityCell23"></div>
    <div class="title-label" id="titleCell23"></div>

    <div class="preview-box" id="previewCell24">Empty</div>
    <div class="quantity-label" id="quantityCell24"></div>
    <div class="title-label" id="titleCell24"></div>

    <div class="preview-box" id="previewCell25">Empty</div>
    <div class="quantity-label" id="quantityCell25"></div>
    <div class="title-label" id="titleCell25"></div>

    <div class="preview-box" id="previewCell26">Empty</div>
    <div class="quantity-label" id="quantityCell26"></div>
    <div class="title-label" id="titleCell26"></div>

    <div class="preview-box" id="previewCell27">Empty</div>
    <div class="quantity-label" id="quantityCell27"></div>
    <div class="title-label" id="titleCell27"></div>

    <div class="preview-box" id="previewCell28">Empty</div>
    <div class="quantity-label" id="quantityCell28"></div>
    <div class="title-label" id="titleCell28"></div>

    <div class="preview-box" id="previewCell29">Empty</div>
    <div class="quantity-label" id="quantityCell29"></div>
    <div class="title-label" id="titleCell29"></div>

    <div class="preview-box" id="previewCell30">Empty</div>
    <div class="quantity-label" id="quantityCell30"></div>
    <div class="title-label" id="titleCell30"></div>

    <div class="preview-box" id="previewCell31">Empty</div>
    <div class="quantity-label" id="quantityCell31"></div>
    <div class="title-label" id="titleCell31"></div>

    <div class="preview-box" id="previewCell32">Empty</div>
    <div class="quantity-label" id="quantityCell32"></div>
    <div class="title-label" id="titleCell32"></div>

    <div class="preview-box" id="previewCell33">Empty</div>
    <div class="quantity-label" id="quantityCell33"></div>
    <div class="title-label" id="titleCell33"></div>

    <div class="preview-box" id="previewCell34">Empty</div>
    <div class="quantity-label" id="quantityCell34"></div>
    <div class="title-label" id="titleCell34"></div>
  </div>

  <div id="configModal" class="modal">
    <div class="modal-content">
      <table class="striped" id="configTable">
        <thead>
          <tr>
            <th>Element</th>
            <th>Left (px)</th>
            <th>Top (px)</th>
            <th>Width (px)</th>
            <th>Height</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <a href="#!" id="saveConfigBtn" class="modal-close waves-effect waves-green btn">
        Save Config
      </a>
    </div>
  </div>

  <!-- jQuery & Materialize JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"
  ></script>

  <script>
    /******************************************************
     * PKCE + Overall logic, same as before
     ******************************************************/
    (function(){
      const urlParams = new URLSearchParams(window.location.search);
      const accessToken = urlParams.get("access_token");
      if(accessToken){
        localStorage.setItem("access_token", accessToken);
        window.history.replaceState({}, document.title, window.location.pathname);
        M.toast({html:"Connection Successful!"});
        console.log("Access token received:", accessToken);
      } else {
        const authCode = urlParams.get("code");
        if(authCode){
          const storedCodeVerifier = localStorage.getItem("etsy_code_verifier");
          if(storedCodeVerifier){
            window.location.href =
              "/.netlify/functions/exchangeToken?code=" +
              encodeURIComponent(authCode) +
              "&code_verifier=" +
              encodeURIComponent(storedCodeVerifier);
          } else {
            console.error("No code verifier found in localStorage.");
          }
        }
      }
    })();

    function generateRandomString(length) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let text = "";
      for (let i = 0; i < length; i++){
        text += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return text;
    }

    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      let base64String = btoa(String.fromCharCode(...new Uint8Array(digest)));
      return base64String.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    document.addEventListener("DOMContentLoaded", function() {
      M.AutoInit();

      // Fade in body
      setTimeout(() => {
        loadPositions();
        document.body.style.opacity = 1;
      }, 200);

      // Connect to Etsy
      document.getElementById("connectEtsyBtn").addEventListener("click", async () => {
        try {
          const codeVerifier = generateRandomString(64);
          localStorage.setItem("etsy_code_verifier", codeVerifier);

          const codeChallenge = await generateCodeChallenge(codeVerifier);
          const state = "randomState123"; 
          const scope = "listings_w listings_r transactions_r transactions_w";

          const CLIENT_ID = "k75zdspz4r99txpqdji7i2em";
          const redirectUri = "https://sorting.goldenspike.app";

          const etsyAuthUrl =
            "https://www.etsy.com/oauth/connect?response_type=code" +
            "&client_id=" + CLIENT_ID +
            "&redirect_uri=" + encodeURIComponent(redirectUri) +
            "&scope=" + encodeURIComponent(scope) +
            "&state=" + state +
            "&code_challenge=" + encodeURIComponent(codeChallenge) +
            "&code_challenge_method=S256";

          console.log("Redirecting to Etsy OAuth URL:", etsyAuthUrl);
          window.location.href = etsyAuthUrl;
        } catch (err) {
          console.error("Error starting OAuth:", err);
          M.toast({ html: "OAuth error: " + err.message });
        }
      });

      // Test OpenAI
      document.getElementById("testOpenAIBtn").addEventListener("click", async () => {
        try {
          const testBody = {
            model: "gpt-3.5-turbo",
            messages: [{ role: "user", content: "Hello from the Sorting page!" }]
          };
          const resp = await fetch("/.netlify/functions/openaiProxy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testBody)
          });
          if (!resp.ok) throw new Error("OpenAI test call failed with status " + resp.status);
          const data = await resp.json();
          if (data.choices && data.choices[0] && data.choices[0].message) {
            M.toast({ html: "OpenAI responded successfully." });
          } else {
            throw new Error("No valid response from OpenAI!");
          }
        } catch (err) {
          M.toast({ html: "OpenAI test failed: " + err.message });
        }
      });

      // "Enter" on the Etsy Order Number => parse multiple comma-delimited orders
      const etsyOrderInput = document.getElementById("etsyOrderNumber");
      etsyOrderInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
          let inputVal = etsyOrderInput.value.trim();
          if (!inputVal) return; // empty => do nothing
          
          // split by comma => array of up to 50
          let orderNumbers = inputVal.split(",").map(x => x.trim()).filter(x => x);
          // optional: limit to 50
          orderNumbers = orderNumbers.slice(0, 50);

          // fetch them in batch, combine all items
          await loadBatchEtsyOrders(orderNumbers);
        }
      });

      //  Zoom & drag for each preview-box
      [...document.querySelectorAll(".preview-box")].forEach((box) => {
        let isDragging = false, lastX = 0, lastY = 0;
        box.addEventListener("wheel", (ev) => {
          const img = box.querySelector("img");
          if (!img) return;
          ev.preventDefault();
          let currentScale = parseFloat(img.dataset.scale) || 1;
          let offX = parseFloat(img.dataset.offsetX) || 0;
          let offY = parseFloat(img.dataset.offsetY) || 0;
          if (ev.deltaY < 0) {
            currentScale *= 1.1;
          } else {
            currentScale /= 1.1;
            if (currentScale <= 1) {
              currentScale = 1; offX = 0; offY = 0;
            }
          }
          currentScale = Math.min(currentScale, 4);
          img.dataset.scale = currentScale;
          img.dataset.offsetX = offX;
          img.dataset.offsetY = offY;
          img.style.transform = `translate(${offX}px, ${offY}px) scale(${currentScale})`;
        });
        box.addEventListener("mousedown", (ev) => {
          const img = box.querySelector("img");
          if (!img) return;
          let scaleNow = parseFloat(img.dataset.scale) || 1;
          if (scaleNow <= 1) return;
          ev.preventDefault();
          isDragging = true; lastX = ev.clientX; lastY = ev.clientY;
        });
        box.addEventListener("mousemove", (ev) => {
          if (!isDragging) return;
          ev.preventDefault();
          const img = box.querySelector("img");
          if (!img) return;
          let scaleNow = parseFloat(img.dataset.scale) || 1;
          let offX = parseFloat(img.dataset.offsetX) || 0;
          let offY = parseFloat(img.dataset.offsetY) || 0;
          const dx = ev.clientX - lastX;
          const dy = ev.clientY - lastY;
          offX += dx; offY += dy;
          img.dataset.offsetX = offX;
          img.dataset.offsetY = offY;
          img.style.transform = `translate(${offX}px, ${offY}px) scale(${scaleNow})`;
          lastX = ev.clientX; lastY = ev.clientY;
        });
        box.addEventListener("mouseup", () => { isDragging = false; });
        box.addEventListener("mouseleave", () => { isDragging = false; });
      });

    });

    // 1) For multiple order numbers => combine their transactions
    async function loadBatchEtsyOrders(orderNumbers) {
      try {
        M.toast({ html: "Loading " + orderNumbers.length + " order(s)..." });
        const token = localStorage.getItem("access_token") || "";
        let combinedItems = [];

        // We'll fetch each order in sequence (you can do Promise.all if you prefer concurrency)
        for (let ord of orderNumbers) {
          const url = `/.netlify/functions/etsyOrderProxy?orderId=${encodeURIComponent(ord)}`;
          const resp = await fetch(url, { headers: { "access-token": token } });
          if (!resp.ok) {
            console.warn("Order fetch failed for " + ord + ", status=" + resp.status);
            continue; // skip this order if error
          }
          const data = await resp.json();
          if (data.transactions && Array.isArray(data.transactions)) {
            // push them all in
            combinedItems.push(...data.transactions);
          } else {
            console.warn("No transactions for order " + ord);
          }
        }

        // Now fill the first 35 boxes
        fillPreviewBoxes(combinedItems);

      } catch (err) {
        console.error("Error in loadBatchEtsyOrders:", err);
        M.toast({ html: "Error: " + err.message });
      }
    }

    // 2) Fill up to 35 boxes from the combined array
    async function fillPreviewBoxes(items) {
      // Clear existing boxes
      for (let i = 0; i < 35; i++) {
        document.getElementById(`previewCell${i}`).innerHTML = "Empty";
        document.getElementById(`quantityCell${i}`).textContent = "";
        document.getElementById(`titleCell${i}`).textContent = "";
      }

      // If there are more than 35 combined items, we only show first 35
      const limitedItems = items.slice(0, 35);
      for (let i = 0; i < limitedItems.length; i++) {
        const { listing_id, quantity, title } = limitedItems[i];
        const cell = document.getElementById(`previewCell${i}`);
        const qtyBox = document.getElementById(`quantityCell${i}`);
        const titleBox = document.getElementById(`titleCell${i}`);

        cell.innerHTML = "Loading...";
        qtyBox.textContent = "Qty: " + (quantity || 0);

        const firstFour = (title || "").split(" ").slice(0, 4).join(" ");
        titleBox.textContent = firstFour;

        // fetch images
        try {
          const imageData = await fetchListingImages(listing_id);
          if (imageData && imageData.length > 0) {
            cell.innerHTML = `<img src="${imageData[0].url_fullxfull}"
                                  alt="Listing ${listing_id}"
                                  data-scale="1"
                                  data-offsetX="0"
                                  data-offsetY="0" />`;
          } else {
            cell.innerHTML = "No Img";
          }
        } catch (imageErr) {
          console.warn("Image fetch failed for listing", listing_id, imageErr);
          cell.innerHTML = "Img Error";
        }
      }
    }

    // Reusable function to fetch listing images from your serverless function
    async function fetchListingImages(listingId) {
      const token = localStorage.getItem("access_token") || "";
      const resp = await fetch(`/.netlify/functions/etsyImages?listingId=${listingId}`, {
        headers: { "access-token": token }
      });
      if (!resp.ok) {
        console.warn("Image fetch failed. HTTP", resp.status);
        return [];
      }
      const data = await resp.json();
      return data.results || [];
    }

    /*******************************************************
     *  Config modal for positioning
     *******************************************************/
    const configIDs = [
      "connectEtsyBtn","testOpenAIBtn","openConfigBtn","etsyOrderNumber",
      "photoGridContainer","configModal","configTable","saveConfigBtn",
      ...[...Array(35).keys()].flatMap(i => [
        `previewCell${i}`, `quantityCell${i}`, `titleCell${i}`
      ])
    ];

    const defaults = {}; // if you have default positions

    function loadPositions() {
      configIDs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const def = defaults[id] || { left: 0, top: 0, width: 0, height: 0 };
        let left = localStorage.getItem(`pos-${id}-left`);
        let top  = localStorage.getItem(`pos-${id}-top`);
        let w    = localStorage.getItem(`pos-${id}-width`);
        let h    = localStorage.getItem(`pos-${id}-height`);

        if (left === null) left = def.left;
        if (top === null)  top  = def.top;
        if (w === null)    w    = def.width;
        if (h === null)    h    = def.height;

        el.style.position = "absolute";
        if (+left)  el.style.left   = left + "px";
        if (+top)   el.style.top    = top  + "px";
        if (+w)     el.style.width  = w    + "px";
        if (+h)     el.style.height = h    + "px";
      });
    }

    function populateConfigTable() {
      const tbody = document.querySelector("#configTable tbody");
      tbody.innerHTML = "";
      configIDs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const cs = window.getComputedStyle(el);
        const leftVal = parseInt(cs.left) || 0;
        const topVal = parseInt(cs.top) || 0;
        const widthVal = parseInt(cs.width) || 0;
        const heightVal = parseInt(cs.height) || 0;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${id}</td>
          <td><input type="number" value="${leftVal}" data-id="${id}" class="left-input" /></td>
          <td><input type="number" value="${topVal}" data-id="${id}" class="top-input" /></td>
          <td><input type="number" value="${widthVal}" data-id="${id}" class="width-input" /></td>
          <td><input type="number" value="${heightVal}" data-id="${id}" class="height-input" /></td>
        `;
        tbody.appendChild(row);

        row.querySelector(".left-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.left = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".top-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.top = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".width-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.width = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".height-input").addEventListener("input", function() {
          const target = document.getElementById(this.dataset.id);
          if (target) target.style.height = parseInt(this.value, 10) + "px";
        });
      });
    }

    function saveConfiguration() {
      configIDs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const cs = window.getComputedStyle(el);
        localStorage.setItem(`pos-${id}-left`, parseInt(cs.left) || 0);
        localStorage.setItem(`pos-${id}-top`, parseInt(cs.top) || 0);
        localStorage.setItem(`pos-${id}-width`, parseInt(cs.width) || 0);
        localStorage.setItem(`pos-${id}-height`, parseInt(cs.height) || 0);
      });
      M.toast({ html: "Positions saved!" });
    }
  </script>
</body>
</html>