<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sorting - Single-Click Zoom</title>
  <!-- Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
  <style>
    body {
      background-color: #fff;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0;
      transition: opacity 0s;
    }
    /* Main Buttons */
    #connectEtsyBtn,
    #testOpenAIBtn,
    #openConfigBtn,
    #cropImagesBtn,
    #sendMatchBtn {
      position: absolute;
      left: 20px;
      width: 140px;
      height: 36px;
    }
    #connectEtsyBtn { top: 20px; }
    #testOpenAIBtn { top: 70px; }
    #openConfigBtn { top: 120px; }
    #cropImagesBtn { top: 170px; }
    #sendMatchBtn { top: 220px; }
    
    /* Etsy Order Number input */
    #etsyOrderNumber {
      position: absolute;
      left: 20px;
      top: 270px;
      width: 300px;
      height: 30px;
      border: 1px solid #999;
      padding: 4px;
      outline: none;
      font-size: 0.9em;
    }
    
    /* Image Comparison UI */
    #imageComparisonContainer {
      position: absolute;
      left: 20px;
      top: 310px;
    }
    #photoDragDrop {
      width: 100px;
      height: 100px;
      border: 2px dashed #ccc;
      text-align: center;
      line-height: 100px;
      display: inline-block;
      margin-right: 10px;
    }
    #userImage {
      width: 100px;
      height: 100px;
      border: 1px solid #000;
      display: none;
      vertical-align: top;
    }
    /* New Cropped Image Preview */
    #croppedImageContainer {
      position: absolute;
      left: 20px;
      top: 420px;
    }
    #croppedImagePreview {
      width: 100px;
      height: 100px;
      border: 1px solid #000;
      background: #eee;
    }
    
    /* Container for the 35 preview boxes */
    #photoGridContainer {
      position: relative;
      width: 1200px;
      height: 700px;
      border: 1px dashed #ccc;
      left: 350px;
      top: 20px;
    }
    .preview-box {
      position: absolute;
      width: 66px;
      height: 66px;
      border: 1px solid #000;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      user-select: none;
      font-size: 0.7em;
      text-align: center;
    }
    .preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform-origin: center center;
      transition: transform 0.2s ease;
    }
    .quantity-label,
    .title-label {
      position: absolute;
      font-size: 0.7em;
      text-align: center;
      width: 66px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      margin-top: 3px;
    }
    /* Config Modal */
    #configModal.modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 250px !important;
      height: 450px !important;
      max-height: none !important;
      overflow-y: auto !important;
    }
    #configTable thead tr th { font-size: 0.9em; }
    #configTable tbody tr td { font-size: 0.8em; }
    #configTable .left-input,
    #configTable .top-input,
    #configTable .width-input,
    #configTable .height-input { width: 80px !important; }
  </style>
</head>
<body>
  <!-- Main Buttons -->
  <button id="connectEtsyBtn" class="btn waves-effect waves-light">Connect to Etsy</button>
  <button id="testOpenAIBtn" class="btn waves-effect waves-light">Test OpenAI</button>
  <button id="openConfigBtn" class="btn waves-effect waves-light">Open Config</button>
  <button id="cropImagesBtn" class="btn waves-effect waves-light">Crop Images</button>
  <button id="sendMatchBtn" class="btn waves-effect waves-light">Send & Match</button>
  
  <!-- Etsy Order Number input -->
  <input type="text" id="etsyOrderNumber" placeholder="Comma-delimited Etsy Order Numbers" />
  
  <!-- Image Comparison UI -->
  <div id="imageComparisonContainer">
    <div id="photoDragDrop">Drag & Drop Photo</div>
    <img id="userImage" src="" alt="User Image" />
  </div>
  
  <!-- Cropped Image Preview -->
  <div id="croppedImageContainer">
    <p>First Cropped Image:</p>
    <img id="croppedImagePreview" src="" alt="Cropped Preview" />
  </div>
  
  <!-- 35 Boxes -->
  <div id="photoGridContainer">
    <!-- 35 preview boxes (each with associated quantity and title labels) -->
    <div class="preview-box" id="previewCell0">Empty</div>
    <div class="quantity-label" id="quantityCell0"></div>
    <div class="title-label" id="titleCell0"></div>

    <div class="preview-box" id="previewCell1">Empty</div>
    <div class="quantity-label" id="quantityCell1"></div>
    <div class="title-label" id="titleCell1"></div>

    <div class="preview-box" id="previewCell2">Empty</div>
    <div class="quantity-label" id="quantityCell2"></div>
    <div class="title-label" id="titleCell2"></div>

    <div class="preview-box" id="previewCell3">Empty</div>
    <div class="quantity-label" id="quantityCell3"></div>
    <div class="title-label" id="titleCell3"></div>

    <div class="preview-box" id="previewCell4">Empty</div>
    <div class="quantity-label" id="quantityCell4"></div>
    <div class="title-label" id="titleCell4"></div>

    <div class="preview-box" id="previewCell5">Empty</div>
    <div class="quantity-label" id="quantityCell5"></div>
    <div class="title-label" id="titleCell5"></div>

    <div class="preview-box" id="previewCell6">Empty</div>
    <div class="quantity-label" id="quantityCell6"></div>
    <div class="title-label" id="titleCell6"></div>

    <div class="preview-box" id="previewCell7">Empty</div>
    <div class="quantity-label" id="quantityCell7"></div>
    <div class="title-label" id="titleCell7"></div>

    <div class="preview-box" id="previewCell8">Empty</div>
    <div class="quantity-label" id="quantityCell8"></div>
    <div class="title-label" id="titleCell8"></div>

    <div class="preview-box" id="previewCell9">Empty</div>
    <div class="quantity-label" id="quantityCell9"></div>
    <div class="title-label" id="titleCell9"></div>

    <div class="preview-box" id="previewCell10">Empty</div>
    <div class="quantity-label" id="quantityCell10"></div>
    <div class="title-label" id="titleCell10"></div>

    <div class="preview-box" id="previewCell11">Empty</div>
    <div class="quantity-label" id="quantityCell11"></div>
    <div class="title-label" id="titleCell11"></div>

    <div class="preview-box" id="previewCell12">Empty</div>
    <div class="quantity-label" id="quantityCell12"></div>
    <div class="title-label" id="titleCell12"></div>

    <div class="preview-box" id="previewCell13">Empty</div>
    <div class="quantity-label" id="quantityCell13"></div>
    <div class="title-label" id="titleCell13"></div>

    <div class="preview-box" id="previewCell14">Empty</div>
    <div class="quantity-label" id="quantityCell14"></div>
    <div class="title-label" id="titleCell14"></div>

    <div class="preview-box" id="previewCell15">Empty</div>
    <div class="quantity-label" id="quantityCell15"></div>
    <div class="title-label" id="titleCell15"></div>

    <div class="preview-box" id="previewCell16">Empty</div>
    <div class="quantity-label" id="quantityCell16"></div>
    <div class="title-label" id="titleCell16"></div>

    <div class="preview-box" id="previewCell17">Empty</div>
    <div class="quantity-label" id="quantityCell17"></div>
    <div class="title-label" id="titleCell17"></div>

    <div class="preview-box" id="previewCell18">Empty</div>
    <div class="quantity-label" id="quantityCell18"></div>
    <div class="title-label" id="titleCell18"></div>

    <div class="preview-box" id="previewCell19">Empty</div>
    <div class="quantity-label" id="quantityCell19"></div>
    <div class="title-label" id="titleCell19"></div>

    <div class="preview-box" id="previewCell20">Empty</div>
    <div class="quantity-label" id="quantityCell20"></div>
    <div class="title-label" id="titleCell20"></div>

    <div class="preview-box" id="previewCell21">Empty</div>
    <div class="quantity-label" id="quantityCell21"></div>
    <div class="title-label" id="titleCell21"></div>

    <div class="preview-box" id="previewCell22">Empty</div>
    <div class="quantity-label" id="quantityCell22"></div>
    <div class="title-label" id="titleCell22"></div>

    <div class="preview-box" id="previewCell23">Empty</div>
    <div class="quantity-label" id="quantityCell23"></div>
    <div class="title-label" id="titleCell23"></div>

    <div class="preview-box" id="previewCell24">Empty</div>
    <div class="quantity-label" id="quantityCell24"></div>
    <div class="title-label" id="titleCell24"></div>

    <div class="preview-box" id="previewCell25">Empty</div>
    <div class="quantity-label" id="quantityCell25"></div>
    <div class="title-label" id="titleCell25"></div>

    <div class="preview-box" id="previewCell26">Empty</div>
    <div class="quantity-label" id="quantityCell26"></div>
    <div class="title-label" id="titleCell26"></div>

    <div class="preview-box" id="previewCell27">Empty</div>
    <div class="quantity-label" id="quantityCell27"></div>
    <div class="title-label" id="titleCell27"></div>

    <div class="preview-box" id="previewCell28">Empty</div>
    <div class="quantity-label" id="quantityCell28"></div>
    <div class="title-label" id="titleCell28"></div>

    <div class="preview-box" id="previewCell29">Empty</div>
    <div class="quantity-label" id="quantityCell29"></div>
    <div class="title-label" id="titleCell29"></div>

    <div class="preview-box" id="previewCell30">Empty</div>
    <div class="quantity-label" id="quantityCell30"></div>
    <div class="title-label" id="titleCell30"></div>

    <div class="preview-box" id="previewCell31">Empty</div>
    <div class="quantity-label" id="quantityCell31"></div>
    <div class="title-label" id="titleCell31"></div>

    <div class="preview-box" id="previewCell32">Empty</div>
    <div class="quantity-label" id="quantityCell32"></div>
    <div class="title-label" id="titleCell32"></div>

    <div class="preview-box" id="previewCell33">Empty</div>
    <div class="quantity-label" id="quantityCell33"></div>
    <div class="title-label" id="titleCell33"></div>

    <div class="preview-box" id="previewCell34">Empty</div>
    <div class="quantity-label" id="quantityCell34"></div>
    <div class="title-label" id="titleCell34"></div>
  </div>
  
  <!-- Config Modal -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <table class="striped" id="configTable">
        <thead>
          <tr>
            <th>Element</th>
            <th>Left (px)</th>
            <th>Top (px)</th>
            <th>Width (px)</th>
            <th>Height</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <a href="#!" id="saveConfigBtn" class="modal-close waves-effect waves-green btn">Save Config</a>
    </div>
  </div>
  
  <!-- jQuery & Materialize JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    // Base URL for Netlify functions
    const functionsBaseUrl = window.location.origin + "/.netlify/functions";
    
    // Global array to store cropped images (256x256)
    let croppedImagesArray = [];
    
    (function(){
      const urlParams = new URLSearchParams(window.location.search);
      const accessToken = urlParams.get("access_token");
      if(accessToken){
        localStorage.setItem("access_token", accessToken);
        window.history.replaceState({}, document.title, window.location.pathname);
        M.toast({html:"Connection Successful!"});
        console.log("Access token received:", accessToken);
      } else {
        const authCode = urlParams.get("code");
        if(authCode){
          const storedCodeVerifier = localStorage.getItem("etsy_code_verifier");
          if(storedCodeVerifier){
            window.location.href =
              "/.netlify/functions/exchangeToken?code=" +
              encodeURIComponent(authCode) +
              "&code_verifier=" +
              encodeURIComponent(storedCodeVerifier);
          } else {
            console.error("No code verifier found in localStorage.");
          }
        }
      }
    })();
    
    function generateRandomString(length) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let text = "";
      for (let i = 0; i < length; i++){
        text += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return text;
    }
    
    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      let base64String = btoa(String.fromCharCode(...new Uint8Array(digest)));
      return base64String.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }
    
    // ---------------------------------------------------------------------
    // HARD-CODED DEFAULT OFFSETS
    // (Insert your full default offsets here if needed)
    // ---------------------------------------------------------------------
    
    const configIDs = [
      "connectEtsyBtn", "testOpenAIBtn", "openConfigBtn", "etsyOrderNumber",
      "photoGridContainer", "configModal", "configTable", "saveConfigBtn",
      ...[...Array(35).keys()].flatMap(i => ["previewCell" + i, "quantityCell" + i, "titleCell" + i])
    ];
    
    document.addEventListener("DOMContentLoaded", function() {
      M.AutoInit();
      setTimeout(function() {
        loadPositions();
        document.body.style.opacity = 1;
      }, 200);
    
      // Connect to Etsy
      document.getElementById("connectEtsyBtn").addEventListener("click", async function() {
        try {
          const codeVerifier = generateRandomString(64);
          localStorage.setItem("etsy_code_verifier", codeVerifier);
          const codeChallenge = await generateCodeChallenge(codeVerifier);
          const CLIENT_ID = "k75zdspz4r99txpqdji7i2em";
          const redirectUri = "https://sorting.goldenspike.app";
          const state = "randomState123";
          const scope = "listings_w listings_r transactions_r transactions_w";
          const etsyAuthUrl =
            "https://www.etsy.com/oauth/connect?response_type=code" +
            "&client_id=" + CLIENT_ID +
            "&redirect_uri=" + encodeURIComponent(redirectUri) +
            "&scope=" + encodeURIComponent(scope) +
            "&state=" + state +
            "&code_challenge=" + encodeURIComponent(codeChallenge) +
            "&code_challenge_method=S256";
          window.location.href = etsyAuthUrl;
        } catch (err) {
          console.error("OAuth start error:", err);
          M.toast({ html: "OAuth error: " + err.message });
        }
      });
    
      // Test OpenAI
      document.getElementById("testOpenAIBtn").addEventListener("click", async function() {
        try {
          const testBody = {
            model: "gpt-3.5-turbo",
            messages: [{ role: "user", content: "Hello from the Sorting page!" }]
          };
          const resp = await fetch(functionsBaseUrl + "/openaiProxy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testBody)
          });
          if (!resp.ok) {
            throw new Error("OpenAI test call failed with " + resp.status);
          }
          const data = await resp.json();
          if (data.choices && data.choices[0] && data.choices[0].message) {
            M.toast({ html: "OpenAI responded successfully." });
          } else {
            throw new Error("No valid response from OpenAI!");
          }
        } catch (err) {
          M.toast({ html: "OpenAI test failed: " + err.message });
        }
      });
    
      // Load multiple orders
      var etsyOrderInput = document.getElementById("etsyOrderNumber");
      etsyOrderInput.addEventListener("keydown", async function(e) {
        if (e.key === "Enter") {
          var inputVal = etsyOrderInput.value.trim();
          if (!inputVal) return;
          var orderNumbers = inputVal.split(",").map(x => x.trim()).filter(x => x);
          orderNumbers = orderNumbers.slice(0, 50);
          await loadBatchEtsyOrders(orderNumbers);
        }
      });
    
      // Crop Images Button
      document.getElementById("cropImagesBtn").addEventListener("click", async function() {
        // Clear the global array
        croppedImagesArray = [];
        await cropAllImages();
      });
    
      // Send & Match Button
      document.getElementById("sendMatchBtn").addEventListener("click", async function() {
        await sendAndMatch();
      });
    
      // ============ Wheel zoom, drag & single-click for preview boxes ============
      var previewBoxes = document.querySelectorAll(".preview-box");
      previewBoxes.forEach(function(box) {
        var isDragging = false;
        var isMouseDown = false;
        var dragStartX = 0, dragStartY = 0;
        var lastX = 0, lastY = 0;
        var dragThreshold = 3;
        // Wheel zoom
        box.addEventListener("wheel", function(ev) {
          var img = box.querySelector("img");
          if (!img) return;
          ev.preventDefault();
          var currentScale = parseFloat(img.dataset.scale) || 1;
          var offX = parseFloat(img.dataset.offsetX) || 0;
          var offY = parseFloat(img.dataset.offsetY) || 0;
          if (ev.deltaY < 0) {
            currentScale *= 1.1;
          } else {
            currentScale /= 1.1;
            if (currentScale <= 1) {
              currentScale = 1;
              offX = 0;
              offY = 0;
            }
          }
          if (currentScale > 4) currentScale = 4;
          img.dataset.scale = currentScale;
          img.dataset.offsetX = offX;
          img.dataset.offsetY = offY;
          img.style.transform = "translate(" + offX + "px, " + offY + "px) scale(" + currentScale + ")";
        });
        // Mouse down => start drag
        box.addEventListener("mousedown", function(ev) {
          var img = box.querySelector("img");
          if (!img) return;
          var scaleNow = parseFloat(img.dataset.scale) || 1;
          if (scaleNow <= 1) return;
          ev.preventDefault();
          isMouseDown = true;
          isDragging = false;
          dragStartX = ev.clientX;
          dragStartY = ev.clientY;
          lastX = ev.clientX;
          lastY = ev.clientY;
        });
        // Mouse move => panning if dragging
        box.addEventListener("mousemove", function(ev) {
          if (!isMouseDown) return;
          ev.preventDefault();
          var dxAll = Math.abs(ev.clientX - dragStartX);
          var dyAll = Math.abs(ev.clientY - dragStartY);
          if (dxAll > dragThreshold || dyAll > dragThreshold) isDragging = true;
          var img = box.querySelector("img");
          if (!img) return;
          var scaleNow = parseFloat(img.dataset.scale) || 1;
          var offX = parseFloat(img.dataset.offsetX) || 0;
          var offY = parseFloat(img.dataset.offsetY) || 0;
          var dx = ev.clientX - lastX;
          var dy = ev.clientY - lastY;
          offX += dx;
          offY += dy;
          img.dataset.offsetX = offX;
          img.dataset.offsetY = offY;
          img.style.transform = "translate(" + offX + "px, " + offY + "px) scale(" + scaleNow + ")";
          lastX = ev.clientX;
          lastY = ev.clientY;
        });
        // Mouse up/leave => end drag
        box.addEventListener("mouseup", function() { isMouseDown = false; });
        box.addEventListener("mouseleave", function() { isMouseDown = false; });
        // Single-click => Zoom if not dragging
        box.addEventListener("click", function(ev) {
          if (isDragging) { isDragging = false; return; }
          var img = box.querySelector("img");
          if (!img) return;
          var rect = box.getBoundingClientRect();
          var boxCenterX = rect.left + box.clientWidth / 2;
          var boxCenterY = rect.top + box.clientHeight / 2;
          var dx = ev.clientX - boxCenterX;
          var dy = ev.clientY - boxCenterY;
          var scale = 4;
          var fudgeY = 10;
          var offsetX = -scale * dx;
          var offsetY = -scale * dy + fudgeY;
          img.dataset.scale = scale;
          img.dataset.offsetX = offsetX;
          img.dataset.offsetY = offsetY;
          img.style.transform = "translate(" + offsetX + "px, " + offsetY + "px) scale(" + scale + ")";
        });
      });
    });
    
    async function loadBatchEtsyOrders(orderNumbers) {
      try {
        M.toast({ html: "Loading " + orderNumbers.length + " order(s)..." });
        var token = localStorage.getItem("access_token") || "";
        var combinedItems = [];
        for (var i = 0; i < orderNumbers.length; i++) {
          var ord = orderNumbers[i];
          var url = functionsBaseUrl + "/etsyOrderProxy?orderId=" + encodeURIComponent(ord);
          var resp = await fetch(url, { headers: { "access-token": token } });
          if (!resp.ok) {
            console.warn("Order fetch failed for " + ord + ", status=" + resp.status);
            continue;
          }
          var data = await resp.json();
          if (data.transactions && Array.isArray(data.transactions)) {
            combinedItems.push.apply(combinedItems, data.transactions);
          } else {
            console.warn("No transactions for order " + ord);
          }
        }
        fillPreviewBoxes(combinedItems);
      } catch (err) {
        console.error("Error loading batch orders:", err);
        M.toast({ html: "Error: " + err.message });
      }
    }
    
    async function fillPreviewBoxes(items) {
      for (var i = 0; i < 35; i++) {
        document.getElementById("previewCell" + i).innerHTML = "Empty";
        document.getElementById("quantityCell" + i).textContent = "";
        document.getElementById("titleCell" + i).textContent = "";
      }
      var limitedItems = items.slice(0, 35);
      for (var j = 0; j < limitedItems.length; j++) {
        var listingId = limitedItems[j].listing_id;
        var quantity = limitedItems[j].quantity;
        var title = limitedItems[j].title || "";
        var cell = document.getElementById("previewCell" + j);
        var qtyBox = document.getElementById("quantityCell" + j);
        var titleBox = document.getElementById("titleCell" + j);
        cell.innerHTML = "Loading...";
        qtyBox.textContent = "Qty: " + (quantity || 0);
        titleBox.textContent = title.split(" ").slice(0, 4).join(" ");
        try {
          var imageData = await fetchListingImages(listingId);
          if (imageData && imageData.length > 0) {
            const localImageData = await getLocalImageData(imageData[0].url_fullxfull);
            cell.innerHTML = "<img src=\"" + localImageData + "\" alt=\"Listing " + listingId + "\" data-scale=\"1\" data-offsetX=\"0\" data-offsetY=\"0\" />";
          } else {
            cell.innerHTML = "No Img";
          }
        } catch (err) {
          console.warn("Image fetch error for listing", listingId, err);
          cell.innerHTML = "Img Error";
        }
      }
    }
    
    async function fetchListingImages(listingId) {
      var token = localStorage.getItem("access_token") || "";
      var resp = await fetch(functionsBaseUrl + "/etsyImages?listingId=" + listingId, {
        headers: { "access-token": token }
      });
      if (!resp.ok) {
        console.warn("Image fetch HTTP error:", resp.status);
        return [];
      }
      var data = await resp.json();
      return data.results || [];
    }
    
    async function getLocalImageData(imageUrl) {
      try {
        const response = await fetch(functionsBaseUrl + "/imageProxy?url=" + encodeURIComponent(imageUrl));
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      } catch (err) {
        console.error("Error in getLocalImageData:", err);
        throw err;
      }
    }
    
    function loadPositions() {
      configIDs.forEach(function(id) {
        var el = document.getElementById(id);
        if (!el) return;
        var def = {}; // Replace with your default values if needed
        var left = localStorage.getItem("pos-" + id + "-left") || def.left || 0;
        var top  = localStorage.getItem("pos-" + id + "-top") || def.top || 0;
        var w    = localStorage.getItem("pos-" + id + "-width") || def.width || 0;
        var h    = localStorage.getItem("pos-" + id + "-height") || def.height || 0;
        el.style.position = "absolute";
        el.style.left = left + "px";
        el.style.top = top + "px";
        el.style.width = w + "px";
        el.style.height = h + "px";
      });
    }
    loadPositions();
    
    function populateConfigTable() {
      var tbody = document.querySelector("#configTable tbody");
      tbody.innerHTML = "";
      configIDs.forEach(function(id) {
        var el = document.getElementById(id);
        if (!el) return;
        var cs = window.getComputedStyle(el);
        var leftVal = parseInt(cs.left, 10) || 0;
        var topVal = parseInt(cs.top, 10) || 0;
        var widthVal = parseInt(cs.width, 10) || 0;
        var heightVal = parseInt(cs.height, 10) || 0;
        var row = document.createElement("tr");
        row.innerHTML =
          "<td>" + id + "</td>" +
          "<td><input type=\"number\" value=\"" + leftVal + "\" data-id=\"" + id + "\" class=\"left-input\" /></td>" +
          "<td><input type=\"number\" value=\"" + topVal + "\" data-id=\"" + id + "\" class=\"top-input\" /></td>" +
          "<td><input type=\"number\" value=\"" + widthVal + "\" data-id=\"" + id + "\" class=\"width-input\" /></td>" +
          "<td><input type=\"number\" value=\"" + heightVal + "\" data-id=\"" + id + "\" class=\"height-input\" /></td>";
        tbody.appendChild(row);
        row.querySelector(".left-input").addEventListener("input", function() {
          var target = document.getElementById(this.dataset.id);
          if (target) target.style.left = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".top-input").addEventListener("input", function() {
          var target = document.getElementById(this.dataset.id);
          if (target) target.style.top = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".width-input").addEventListener("input", function() {
          var target = document.getElementById(this.dataset.id);
          if (target) target.style.width = parseInt(this.value, 10) + "px";
        });
        row.querySelector(".height-input").addEventListener("input", function() {
          var target = document.getElementById(this.dataset.id);
          if (target) target.style.height = parseInt(this.value, 10) + "px";
        });
      });
    }
    
    document.getElementById("openConfigBtn").addEventListener("click", function() {
      populateConfigTable();
      M.Modal.getInstance(document.getElementById("configModal")).open();
    });
    
    function saveConfiguration() {
      configIDs.forEach(function(id) {
        var el = document.getElementById(id);
        if (!el) return;
        var cs = window.getComputedStyle(el);
        localStorage.setItem("pos-" + id + "-left", parseInt(cs.left, 10) || 0);
        localStorage.setItem("pos-" + id + "-top", parseInt(cs.top, 10) || 0);
        localStorage.setItem("pos-" + id + "-width", parseInt(cs.width, 10) || 0);
        localStorage.setItem("pos-" + id + "-height", parseInt(cs.height, 10) || 0);
      });
      M.toast({ html: "Positions saved!" });
    }
    
    // =====================================================
    // NEW CODE FOR IMAGE COMPARISON, CROPPING, & SEND/MATCH
    // =====================================================
    
    // Drag & Drop for photoDragDrop
    const photoDragDrop = document.getElementById("photoDragDrop");
    photoDragDrop.addEventListener("dragover", function(e) { e.preventDefault(); });
    photoDragDrop.addEventListener("drop", function(e) {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      const reader = new FileReader();
      reader.onload = async function(e) {
        const imageData = e.target.result;
        const userImageElem = document.getElementById("userImage");
        userImageElem.src = imageData;
        userImageElem.style.display = "inline-block";
        M.toast({ html: "User Image captured." });
      };
      reader.readAsDataURL(file);
    });
    
    // Crop all preview images and save them (256x256) in global array
    async function cropAllImages() {
      croppedImagesArray = [];
      for (let i = 0; i < 35; i++) {
        const cell = document.getElementById("previewCell" + i);
        const img = cell.querySelector("img");
        if (img && img.src && img.src !== "") {
          try {
            const cropped = await cropImageFromPreview(cell, 256, 256);
            croppedImagesArray[i] = cropped;
            M.toast({ html: "Cell " + i + ": Cropped successfully." });
          } catch (err) {
            console.error("Cropping failed for cell", i, err);
            M.toast({ html: "Cell " + i + ": Cropping error" });
          }
        }
      }
      if (croppedImagesArray.length > 0 && croppedImagesArray[0]) {
        document.getElementById("croppedImagePreview").src = croppedImagesArray[0];
      }
    }
    
    // Updated cropImageFromPreview using bounding rectangles to determine visible area
    function cropImageFromPreview(cell, canvasWidth, canvasHeight) {
      return new Promise((resolve, reject) => {
        const imgElem = cell.querySelector("img");
        if (!imgElem) {
          reject("No image element found");
          return;
        }
        // Get bounding rectangles of cell and image
        const cellRect = cell.getBoundingClientRect();
        const imgRect = imgElem.getBoundingClientRect();
        // Determine intersection (visible area)
        const visibleLeft = Math.max(cellRect.left, imgRect.left);
        const visibleTop = Math.max(cellRect.top, imgRect.top);
        const visibleRight = Math.min(cellRect.right, imgRect.right);
        const visibleBottom = Math.min(cellRect.bottom, imgRect.bottom);
        if (visibleRight <= visibleLeft || visibleBottom <= visibleTop) {
          reject("No visible intersection");
          return;
        }
        const visibleWidth = visibleRight - visibleLeft;
        const visibleHeight = visibleBottom - visibleTop;
        const sourceImage = new Image();
        sourceImage.crossOrigin = "Anonymous";
        sourceImage.onload = function() {
          // The image element is rendered with width imgRect.width and height imgRect.height
          // Calculate ratio from natural image size to rendered size
          const ratioX = sourceImage.naturalWidth / imgRect.width;
          const ratioY = sourceImage.naturalHeight / imgRect.height;
          // Map the visible portion from screen coordinates to source image coordinates
          const srcX = (visibleLeft - imgRect.left) * ratioX;
          const srcY = (visibleTop - imgRect.top) * ratioY;
          const srcWidth = visibleWidth * ratioX;
          const srcHeight = visibleHeight * ratioY;
          const canvas = document.createElement("canvas");
          canvas.width = canvasWidth;
          canvas.height = canvasHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(sourceImage, srcX, srcY, srcWidth, srcHeight, 0, 0, canvasWidth, canvasHeight);
          resolve(canvas.toDataURL());
        };
        sourceImage.onerror = function(e) {
          reject(e);
        };
        sourceImage.src = imgElem.src;
      });
    }
    
    // New function: Send & Match using cropped images
    async function sendAndMatch() {
      const userImageElem = document.getElementById("userImage");
      if (!userImageElem.src) {
        M.toast({ html: "User image not available!" });
        return;
      }
      if (!croppedImagesArray || croppedImagesArray.length === 0) {
        M.toast({ html: "No cropped images available! Please crop images first." });
        return;
      }
      let bestScore = -Infinity;
      let bestIndex = -1;
      for (let i = 0; i < croppedImagesArray.length; i++) {
        if (!croppedImagesArray[i]) continue;
        try {
          const score = await compareImages(userImageElem.src, croppedImagesArray[i], i);
          if (score > bestScore) {
            bestScore = score;
            bestIndex = i;
          }
        } catch (err) {
          console.error("Comparison failed for cell", i, err);
        }
      }
      if (bestIndex !== -1) {
        const bestCell = document.getElementById("previewCell" + bestIndex);
        bestCell.style.outline = "2px solid blue";
        M.toast({ html: "Best match: cell " + bestIndex + " (score: " + bestScore + ")" });
        setTimeout(() => { bestCell.style.outline = ""; }, 5000);
      } else {
        M.toast({ html: "No valid matches found." });
      }
    }
    
    async function compareImages(userImage, croppedGridImage, cellIndex) {
      const payload = {
        model: "gpt-4o-mini",
        messages: [
          {
            role: "user",
            content: [
              { type: "text", text: "Compare these two images and return ONLY a numeric similarity score between 0 and 1, with no additional text." },
              { type: "image_url", image_url: { url: userImage, detail: "low" } },
              { type: "image_url", image_url: { url: croppedGridImage, detail: "low" } }
            ]
          }
        ],
        max_tokens: 100
      };
      try {
        const response = await fetch(functionsBaseUrl + "/openaiProxy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        console.log("Response for cell " + cellIndex + ":", data);
        const scoreText = data.choices[0].message.content.trim();
        const score = parseFloat(scoreText);
        if (isNaN(score)) {
          M.toast({ html: "Cell " + cellIndex + ": Invalid score (" + scoreText + ")" });
          return 0;
        }
        M.toast({ html: "Cell " + cellIndex + ": Score " + score });
        return score;
      } catch (error) {
        console.error("Error comparing cell " + cellIndex + ":", error);
        M.toast({ html: "Cell " + cellIndex + ": Comparison error" });
        return 0;
      }
    }
  </script>
</body>
</html>