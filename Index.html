<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Etsy Order & OAuth Integration</title>
  <!-- Materialize CSS -->
  <link 
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  >
  <style>
    /* Hide the page initially */
    body {
      background-color: white;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0;
      transition: opacity 0s;
    }

    /* Main UI Buttons */
    #connectEtsyBtn {
      position: absolute;
      left: 50px;
      top: 20px;
    }
    #openConfigBtn {
      position: absolute;
      left: 50px;
      top: 80px;
    }

    /*
     * The new "Order Link" button (#orderLinkBtn)
     *  - smaller (50% of previous size)
     *  - uses an icon from assets/Globe.png
     *  - no text displayed
     */
    #orderLinkBtn {
      position: absolute;
      left: 120px;
      top: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      outline: none;
    }
    #orderLinkBtn img {
      width: 14px;   /* half the previous 28px */
      height: 14px;  /* half the previous 28px */
      display: block;
    }

    /*
     * Etsy Order Number text box:
     *   - remove extra vertical spacing so the underline is right beneath text
     *   - fully left-justified
     */
    #etsyOrderNumber {
      position: absolute;
      left: 50px;
      top: 140px;
      margin: 0;
      padding: 0;
      line-height: 1.0;
      border: none;
      border-bottom: 1px solid #000;
      background: transparent !important;
      text-align: left;
      width: 250px;
      font-size: 1em;
      outline: none;
    }

    /* #orderInformation => leading space in placeholder */
    #orderInformation {
      position: absolute;
      left: 50px;
      top: 190px;
      width: 300px;
      height: 300px;
      font-size: 1em;
      padding: 8px;
      resize: none;
    }

    /*
     * Scale the Photo Grid (#Photo_Grid) by 1.5 => 50% larger
     */
    #Photo_Grid {
      position: absolute;
      left: 400px;
      top: 140px;
      transform: scale(1.5);
      transform-origin: top left;
    }

    /*
     * 16 text-box-absolute for quantity & metal
     *  - 0.7em
     *  - borderless
     *  - leading space in JS
     */
    .text-box-absolute {
      position: absolute;
      border: none !important;
      outline: none !important;
      background: transparent !important;
      text-decoration: none !important;
      box-shadow: none !important;
      font-size: 0.7em !important;
      width: 60px;
      height: 20px;
      text-align: left;
      line-height: 1.0;
      padding: 0 2px 2px 2px;
      box-sizing: border-box;
    }

    /*
     * Order Details box => read-only, bigger font
     */
    #orderDetails {
      position: absolute;
      border: 1px solid black;
      width: 300px;
      height: 175px;
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      line-height: 1.5;
      resize: none;
      text-align: left;
      overflow-y: auto;
    }

    /*
     * Customer Message History => read/write, 300×175, same style
     */
    #customerMessageHistory {
      position: absolute;
      border: 1px solid black;
      width: 300px;
      height: 175px;
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      line-height: 1.5;
      resize: none;
      text-align: left;
      overflow-y: auto;
    }

    /*
     * Single-Line text boxes => bigger & bold, read-only
     */
    #dateOrdered,
    #shipDate {
      position: absolute;
      border: 1px solid black;
      width: 200px;
      height: 20px;
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      font-weight: bold;
    }

    /*
     * Title texts => removed "Message History"
     */
    #titleOrderDate,
    #titleShipDate,
    #titleOrderDetails,
    #titleBritesMessages,
    #titlePurchasedItems,
    #titleOrderNumber {
      position: absolute;
      font-size: 0.7em;
      margin: 0;
      padding: 0;
    }

    /* Configuration Modal styling */
    .modal {
      position: fixed !important;
      top: 150px !important;
      right: 0 !important;
      left: auto !important;
      transform: none !important;
      height: auto !important;
      max-height: 70vh !important;
      width: auto !important;
      max-width: 650px !important;
      overflow-y: scroll !important;
    }
    .modal .modal-content {
      overflow-y: auto;
      font-size: 0.9em;
    }
    .modal .modal-footer {
      text-align: right;
      padding: 10px;
      background: white;
      font-size: 0.9em;
    }

    table.striped {
      width: 100%;
    }
    table.striped th,
    table.striped td {
      padding: 8px;
      text-align: center;
    }
    input[type="number"] {
      width: 70px;
      font-size: 0.8em;
    }
  </style>
</head>

<body>
  <!-- Main UI Buttons -->
  <button id="connectEtsyBtn" class="configurable btn waves-effect waves-light">Connect to Etsy</button>
  <button id="openConfigBtn" class="configurable btn waves-effect waves-light">Open Config</button>

  <!-- The new "Order Link" button with smaller globe icon -->
  <button id="orderLinkBtn" name="Order Link">
    <img src="assets/Globe.png" alt="Order Link Icon" />
  </button>

  <!-- Etsy Order Fields -->
  <input type="text" id="etsyOrderNumber" placeholder="Etsy Order Number" />
  <textarea id="orderInformation" placeholder=" Order Information" readonly></textarea>

  <!-- Photo Grid (scaled 1.5×) -->
  <div id="Photo_Grid"></div>

  <!-- 16 text-box-absolute for quantity/metal -->
  <input type="text" id="quantityCell0" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell1" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell2" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell3" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell4" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell5" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell6" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell7" class="text-box-absolute" readonly />

  <input type="text" id="metalCell0" class="text-box-absolute" readonly />
  <input type="text" id="metalCell1" class="text-box-absolute" readonly />
  <input type="text" id="metalCell2" class="text-box-absolute" readonly />
  <input type="text" id="metalCell3" class="text-box-absolute" readonly />
  <input type="text" id="metalCell4" class="text-box-absolute" readonly />
  <input type="text" id="metalCell5" class="text-box-absolute" readonly />
  <input type="text" id="metalCell6" class="text-box-absolute" readonly />
  <input type="text" id="metalCell7" class="text-box-absolute" readonly />

  <!-- Order Details (read-only) -->
  <textarea id="orderDetails" readonly></textarea>

  <!-- Customer Message History => read/write now -->
  <textarea id="customerMessageHistory"></textarea>

  <!-- Title objects (removed "Message History:") -->
  <div id="titleOrderDate">Order Date:</div>
  <div id="titleShipDate">Ship By:</div>
  <div id="titleOrderDetails">Order Details:</div>
  <div id="titleBritesMessages">Brites Messages</div>
  <div id="titlePurchasedItems">Purchased Items:</div>
  <div id="titleOrderNumber">Order Number</div>

  <!-- Date/Ship Date boxes -->
  <input type="text" id="dateOrdered" readonly />
  <input type="text" id="shipDate"    readonly />

  <!-- Configuration Modal -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <table class="striped" id="configTable">
        <thead>
          <tr>
            <th>Component Name</th>
            <th>Left (px)</th>
            <th>Top (px)</th>
            <th>Width (px)</th>
            <th>Height (px)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <a href="#!" id="saveConfigBtn" class="modal-close waves-effect waves-green btn">Save Config</a>
    </div>
  </div>

  <!-- jQuery & Materialize -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"
  ></script>

  <script>
    /*
     * Final merged file with all changes:
     *  - Payment Status -> Order Status
     *  - Removed "Message History:" title object
     *  - #customerMessageHistory is now read/write
     *  - #orderLinkBtn is half the size it was (14×14)
     *  - #Photo_Grid is scaled by 1.5
     *  - #etsyOrderNumber has no extra spacing below text
     *  - Text box read-only logic for dateOrdered, shipDate, orderDetails, etc.
     */

    window.orderName      = "";
    window.orderStatus    = "";
    window.orderIsShipped = "";
    window.cachedOrderItems = [];

    /********** Check for Access Token / Code **********/
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const accessToken = urlParams.get("access_token");
      if (accessToken) {
        localStorage.setItem("access_token", accessToken);
        window.history.replaceState({}, document.title, window.location.pathname);
        M.toast({ html: "Connection Successful!" });
        console.log("Access token received:", accessToken);
      } else {
        const authCode = urlParams.get("code");
        if (authCode) {
          const storedCodeVerifier = localStorage.getItem("etsy_code_verifier");
          if (storedCodeVerifier) {
            window.location.href = "/.netlify/functions/exchangeToken?code="
                                   + encodeURIComponent(authCode)
                                   + "&code_verifier="
                                   + encodeURIComponent(storedCodeVerifier);
          } else {
            console.error("No code verifier found in localStorage.");
          }
        }
      }
    })();

    /********** Etsy OAuth: Connect to Etsy **********/
    function generateRandomString(length) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let text = "";
      for (let i = 0; i < length; i++){
        text += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return text;
    }
    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
              .replace(/\+/g,"-")
              .replace(/\//g,"_")
              .replace(/=+$/,"");
    }
    document.getElementById("connectEtsyBtn").addEventListener("click", async ()=>{
      const codeVerifier = generateRandomString(64);
      localStorage.setItem("etsy_code_verifier", codeVerifier);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const state = "randomState123";
      const scope = "listings_w listings_r transactions_r transactions_w";
      const CLIENT_ID = "k75zdspz4r99txpqdji7i2em"; 
      const redirectUri = "https://gokushipping.netlify.app"; 
      const etsyAuthUrl = `https://www.etsy.com/oauth/connect?response_type=code`
                        + `&client_id=${CLIENT_ID}`
                        + `&redirect_uri=${encodeURIComponent(redirectUri)}`
                        + `&scope=${encodeURIComponent(scope)}`
                        + `&state=${state}`
                        + `&code_challenge=${encodeURIComponent(codeChallenge)}`
                        + `&code_challenge_method=S256`;
      console.log("Redirecting to Etsy OAuth URL:", etsyAuthUrl);
      window.location.href = etsyAuthUrl;
    });

    /********** UI Configuration **********/
    const configComponentIDs = [
      "connectEtsyBtn",
      "openConfigBtn",
      "orderLinkBtn",
      "etsyOrderNumber",
      "orderInformation",
      "Photo_Grid",
      "quantityCell0","quantityCell1","quantityCell2","quantityCell3","quantityCell4","quantityCell5","quantityCell6","quantityCell7",
      "metalCell0","metalCell1","metalCell2","metalCell3","metalCell4","metalCell5","metalCell6","metalCell7",
      "orderDetails",
      "customerMessageHistory",
      "dateOrdered",
      "shipDate",
      "titleOrderDate",
      "titleShipDate",
      "titleOrderDetails",
      "titleBritesMessages",
      "titlePurchasedItems",
      "titleOrderNumber"
    ];

    function loadPositions() {
      configComponentIDs.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          const left   = localStorage.getItem(`pos-${id}-left`);
          const top    = localStorage.getItem(`pos-${id}-top`);
          const width  = localStorage.getItem(`pos-${id}-width`);
          const height = localStorage.getItem(`pos-${id}-height`);
          if (left   !== null) el.style.left   = left + "px";
          if (top    !== null) el.style.top    = top + "px";
          if (width  !== null) el.style.width  = width + "px";
          if (height !== null) el.style.height = height+ "px";
        }
      });
    }
    function populateConfigTable() {
      const tbody = document.getElementById("configTable").querySelector("tbody");
      tbody.innerHTML = "";
      configComponentIDs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const compName = el.textContent.trim() || el.value?.trim() || id;
        const cs = window.getComputedStyle(el);
        const leftVal   = (cs.left === "auto") ? 0 : parseInt(cs.left);
        const topVal    = (cs.top === "auto") ? 0 : parseInt(cs.top);
        const widthVal  = (cs.width === "auto")? 0 : parseInt(cs.width);
        const heightVal = (cs.height=== "auto")? 0 : parseInt(cs.height);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${compName}</td>
          <td><input type="number" value="${leftVal}"   data-id="${id}" class="left-input"></td>
          <td><input type="number" value="${topVal}"    data-id="${id}" class="top-input"></td>
          <td><input type="number" value="${widthVal}"  data-id="${id}" class="width-input"></td>
          <td><input type="number" value="${heightVal}" data-id="${id}" class="height-input"></td>
        `;
        tbody.appendChild(row);

        // Live updates
        row.querySelector(".left-input").addEventListener("input", function(){
          const tgt=document.getElementById(this.getAttribute("data-id"));
          if(tgt) tgt.style.left= parseInt(this.value)+"px";
        });
        row.querySelector(".top-input").addEventListener("input", function(){
          const tgt=document.getElementById(this.getAttribute("data-id"));
          if(tgt) tgt.style.top= parseInt(this.value)+"px";
        });
        row.querySelector(".width-input").addEventListener("input", function(){
          const tgt=document.getElementById(this.getAttribute("data-id"));
          if(tgt) tgt.style.width= parseInt(this.value)+"px";
        });
        row.querySelector(".height-input").addEventListener("input", function(){
          const tgt=document.getElementById(this.getAttribute("data-id"));
          if(tgt) tgt.style.height= parseInt(this.value)+"px";
        });
      });
    }
    function saveConfiguration() {
      configComponentIDs.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          const cs       = window.getComputedStyle(el);
          const leftVal  = parseInt(cs.left)   || 0;
          const topVal   = parseInt(cs.top)    || 0;
          const widthVal = parseInt(cs.width)  || 0;
          const heightVal= parseInt(cs.height) || 0;
          localStorage.setItem(`pos-${id}-left`,   leftVal);
          localStorage.setItem(`pos-${id}-top`,    topVal);
          localStorage.setItem(`pos-${id}-width`,  widthVal);
          localStorage.setItem(`pos-${id}-height`, heightVal);
        }
      });
      console.log("Configuration saved.");
    }

    /************************************************************************
     * showItemDetails(index):
     *   " ORDER FROM: [name]"
     *   " Order Status: [status]" (replaced Payment Status)
     *   " Shipping Status: [Shipped!/Not Shipped]"
     *   blank line
     *   " ORDER DETAILS:"
     ************************************************************************/
    function showItemDetails(index) {
      if(!window.cachedOrderItems || !window.cachedOrderItems[index]) {
        console.warn("No item at index:", index);
        return;
      }
      const item = window.cachedOrderItems[index];

      let details="";
      if(window.orderName){
        details+=" ORDER FROM: " + window.orderName + "\n";
      }
      if(window.orderStatus){
        details+=" Order Status: " + window.orderStatus + "\n";
      }
      if(window.orderIsShipped){
        details+=" Shipping Status: " + window.orderIsShipped + "\n\n";
      } else {
        details+="\n";
      }
      details+=" ORDER DETAILS:\n\n";

      if(item.title){
        const firstFourWords=item.title.trim().split(" ").slice(0,4).join(" ");
        details+=" Title: " + firstFourWords + "\n";
      }
      if(item.sku){
        details+=" SKU: " + item.sku + "\n";
      }

      if(item.variations && Array.isArray(item.variations)){
        const acceptedMetalNames=[
          "metal","metal choice","metal - engraving","metal colour","color","metal choice / engraving option"
        ];
        const acceptedLengthNames=[
          "length","necklace length","metal/necklace length","metal choice / necklace length","necklace length in inches"
        ];
        item.variations.forEach(v=>{
          if(v.formatted_name && v.formatted_value){
            const nameLower=v.formatted_name.trim().toLowerCase();
            let val=v.formatted_value.trim();
            if(nameLower==="personalization" && val==="Not requested on this item."){
              val="Not Requested";
              details+=" Personalization: " + val + "\n";
            } else if(acceptedMetalNames.includes(nameLower)){
              details+=" Metal Choice: " + val + "\n";
            } else if(acceptedLengthNames.includes(nameLower)){
              const lengthMapping={
                '14&quot;':'14 Inches','16&quot;':'16 Inches','18&quot;':'18 Inches','20&quot;':'20 Inches',
                '14""':'14 Inches','16""':'16 Inches','18""':'18 Inches','20""':'20 Inches'
              };
              if(lengthMapping[val]){
                val=lengthMapping[val];
              }
              details+=" Item Length: " + val + "\n";
            } else {
              details+=" " + v.formatted_name + ": " + v.formatted_value + "\n";
            }
          }
        });
      }
      document.getElementById("orderDetails").value = details;
    }

    /*
     * fetchListingImages => unchanged
     */
    async function fetchListingImages(listingId) {
      const response = await fetch(`/.netlify/functions/etsyImages?listingId=${listingId}`, {
        headers: {"access-token": localStorage.getItem("access_token")}
      });
      if (!response.ok) {
        throw new Error(`Error fetching images for listing ${listingId}: ${response.statusText}`);
      }
      const data = await response.json();
      return data.results;
    }

    /*
     * updateImageGrid => unchanged
     */
    async function updateImageGrid(data) {
      let items=[];
      if(data.transactions && Array.isArray(data.transactions)){
        items=data.transactions;
      } else if(data.shipments && Array.isArray(data.shipments)){
        items=data.shipments;
      } else if(Array.isArray(data)){
        items=data;
      } else if(data.results && Array.isArray(data.results)){
        items=data.results;
      } else if(data.orders && Array.isArray(data.orders)){
        items=data.orders;
      } else if(typeof data==='object' && data!==null){
        for(const key in data){
          if(Array.isArray(data[key])){
            items=data[key];
            break;
          }
        }
      }
      window.cachedOrderItems=items;

      for(let i=0; i<8; i++){
        const cell = document.getElementById("previewCell" + i);
        const qtyBox = document.getElementById("quantityCell" + i);
        const metalBox = document.getElementById("metalCell" + i);

        if(cell){
          if(i < items.length){
            const item = items[i];
            try {
              const images = await fetchListingImages(item.listing_id);
              if(images && images.length>0){
                cell.innerHTML = `<img src="${images[0].url_fullxfull}" alt="Listing Image ${i}">`;
              } else {
                cell.innerHTML = "No images found";
              }
            } catch(err){
              console.error(`Error fetching listing ${item.listing_id}:`, err);
              cell.innerHTML = "Error loading image";
            }
            cell.style.cursor = "pointer";
            cell.onclick = ()=> showItemDetails(i);

            if(qtyBox){
              const actualQty = (item.quantity!=null)? item.quantity : 0;
              qtyBox.value = " Quantity: " + actualQty;
            }
            if(metalBox){
              let metalSel="";
              if(item.variations && Array.isArray(item.variations)){
                const acceptedMetalNames=[
                  "metal","metal choice","metal - engraving","metal colour","color","metal choice / engraving option"
                ];
                const metalVar = item.variations.find(v=>
                  v.formatted_name && acceptedMetalNames.includes(v.formatted_name.trim().toLowerCase())
                );
                if(metalVar){
                  metalSel=metalVar.formatted_value||"";
                }
              }
              metalBox.value = " Metal: " + metalSel;
            }
          } else {
            cell.innerHTML = "Empty";
            cell.style.cursor = "default";
            cell.onclick = null;
            if(qtyBox)   qtyBox.value="";
            if(metalBox) metalBox.value="";
          }
        }
      }
      if(items.length>0){
        showItemDetails(0);
      } else {
        document.getElementById("orderDetails").value=" ORDER DETAILS:\n\nNo items found.";
      }
    }

    /*
     * pullEtsyOrderDetails => unchanged except removing "CUSTOMER MESSAGE HISTORY:"
     * and shipping color logic => if Shipped => #006400
     */
    function pullEtsyOrderDetails(orderNumber) {
      console.log("Pulling Etsy order details:", orderNumber);
      const token=localStorage.getItem("access_token");
      return fetch('/.netlify/functions/etsyOrderProxy?orderId=' + encodeURIComponent(orderNumber), {
        headers: {"access-token": token}
      })
      .then(r=>r.json())
      .then(data=>{
        console.log("Etsy Order Data:", data);
        document.getElementById("orderInformation").value = " " + JSON.stringify(data, null, 2);

        if(data.name){
          window.orderName = data.name;
        } else {
          window.orderName = "";
        }
        if(data.status){
          window.orderStatus = data.status;
        } else {
          window.orderStatus="";
        }
        if(data.is_shipped===true){
          window.orderIsShipped="Shipped!";
        } else if(data.is_shipped===false){
          window.orderIsShipped="Not Shipped";
        } else {
          window.orderIsShipped="";
        }

        const msgBox=document.getElementById("customerMessageHistory");
        if(data.message_from_buyer){
          msgBox.value=data.message_from_buyer + "\n";
        } else{
          msgBox.value="";
        }

        if(data.transactions && data.transactions.length>0){
          const firstTrans=data.transactions[0];
          const monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          if(firstTrans.created_timestamp){
            const d=new Date(firstTrans.created_timestamp*1000);
            const day=("0"+d.getDate()).slice(-2);
            const mStr=monthNames[d.getMonth()];
            const y=d.getFullYear();
            document.getElementById("dateOrdered").value=" "+day+" "+mStr+" "+y;
          } else {
            document.getElementById("dateOrdered").value="";
          }
          const shipEl=document.getElementById("shipDate");
          shipEl.style.color="";
          if(firstTrans.expected_ship_date){
            const s=new Date(firstTrans.expected_ship_date*1000);
            const sDay=("0"+s.getDate()).slice(-2);
            const sMonth=monthNames[s.getMonth()];
            const sYear=s.getFullYear();
            shipEl.value=" "+sDay+" "+sMonth+" "+sYear;
            if(window.orderIsShipped==="Shipped!"){
              shipEl.style.color="#006400";
            } else {
              shipEl.style.color="";
            }
          } else {
            shipEl.value="";
          }
        } else {
          document.getElementById("dateOrdered").value="";
          const shipEl=document.getElementById("shipDate");
          shipEl.value="";
          shipEl.style.color="";
        }
        return data;
      })
      .catch(err=>{
        console.error("Error fetching Etsy order details:", err);
        return null;
      });
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      M.AutoInit();
      // Load imageGrid
      $("#Photo_Grid").load("imageGrid.html",(resp,status,xhr)=>{
        if(status==="error"){
          console.error("Error loading image grid:", xhr.status, xhr.statusText);
        } else{
          console.log("Image grid loaded successfully.");
        }
      });
      document.body.style.opacity=0;
      setTimeout(()=>{
        loadPositions();
        document.body.style.opacity=1;
      },250);

      document.getElementById("openConfigBtn").addEventListener("click", ()=>{
        populateConfigTable();
        const modalElem=document.getElementById("configModal");
        const instance=M.Modal.getInstance(modalElem);
        instance.open();
      });
      document.getElementById("saveConfigBtn").addEventListener("click", ()=>{
        saveConfiguration();
      });

      const etsyOrderInput=document.getElementById("etsyOrderNumber");
      etsyOrderInput.addEventListener("keydown", async e=>{
        if(e.key==="Enter"){
          const orderNumber=etsyOrderInput.value.trim();
          if(orderNumber!==""){
            const orderData=await pullEtsyOrderDetails(orderNumber);
            if(orderData){
              await updateImageGrid(orderData);
            }
          }
        }
      });

      // "Order Link" button => open new tab with custom link
      const orderLinkBtn=document.getElementById("orderLinkBtn");
      orderLinkBtn.addEventListener("click",()=>{
        const baseUrl="https://www.etsy.com/your/orders/sold?ref=seller-platform-mcnav&order_id=0000000000";
        const currentOrder=etsyOrderInput.value.trim();
        if(!currentOrder){
          console.log("No order number entered.");
          return;
        }
        const customLink=baseUrl.replace("0000000000", currentOrder);
        window.open(customLink,"_blank");
      });
    });
  </script>
</body>
</html>