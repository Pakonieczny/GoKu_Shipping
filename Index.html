<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Etsy Order & OAuth Integration</title>
  <!-- Materialize CSS -->
  <link rel="stylesheet" 
        href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <style>
    /* Hide the page initially */
    body {
      background-color: white;
      margin: 0;
      height: 100vh;
      position: relative;
      opacity: 0;
      transition: opacity 0s;
    }

    /* Buttons */
    #connectEtsyBtn {
      position: absolute;
      left: 50px;
      top: 20px;
    }
    #openConfigBtn {
      position: absolute;
      left: 50px;
      top: 80px;
    }

    /*
     * #etsyOrderNumber => NO leading space
     */
    #etsyOrderNumber {
      position: absolute;
      left: 50px;
      top: 140px;
      font-size: 1em;
      padding: 8px;
      width: 250px;
    }

    /*
     * #orderInformation => 1 leading space in placeholder
     */
    #orderInformation {
      position: absolute;
      left: 50px;
      top: 190px;
      width: 300px;
      height: 300px;
      font-size: 1em;
      padding: 8px;
      resize: none;
    }

    /*
     * The Photo Grid (8 preview cells) â€“ loaded from imageGrid.html
     */
    #Photo_Grid {
      position: absolute;
      left: 400px;
      top: 140px;
      width: 532px;
    }

    /*
     * 16 text-box-absolute for quantity & metal
     *   - 0.7em font
     *   - no border/outline
     *   - leading space in JS
     */
    .text-box-absolute {
      position: absolute;
      border: none !important;         
      outline: none !important;        
      background: transparent !important;
      text-decoration: none !important;
      box-shadow: none !important;     
      font-size: 0.7em !important;     
      width: 60px;
      height: 20px;
      text-align: left;
      line-height: 1.0;
      padding: 0 2px 2px 2px;
      box-sizing: border-box;
    }

    /* 
     * Increase the Order Details text box font size from 0.8em to 0.9em 
     * line-height: 1.5
     */
    #orderDetails {
      position: absolute;
      border: 1px solid black;
      width: 300px;
      height: 175px;
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em; /* was 0.8em, now 0.9em */
      line-height: 1.5;
      resize: none;
      text-align: left;
      overflow-y: auto;
    }

    /*
     * Single-Line text boxes for DateOrdered, ShipDate => bigger, bold,
     * plus leading space in JS
     */
    #dateOrdered,
    #shipDate {
      position: absolute;
      border: 1px solid black;
      width: 200px;
      height: 20px;
      box-sizing: border-box;
      outline: none;
      background: transparent;
      font-size: 0.9em;
      font-weight: bold;
    }

    /* 
     * Title text (labels) for "Order Date:" & "Ship By:"
     * in 0.7em font, absolutely positioned so you can place them
     * via the config table
     */
    #titleOrderDate,
    #titleShipDate {
      position: absolute;
      font-size: 0.7em;
      font-weight: normal;
      margin: 0;
      padding: 0;
    }

    /* Configuration Modal styling */
    .modal {
      position: fixed !important;
      top: 150px !important;
      right: 0 !important;
      left: auto !important;
      transform: none !important;
      height: auto !important;
      max-height: 70vh !important;
      width: auto !important;
      max-width: 650px !important;
      overflow-y: scroll !important;
    }
    .modal .modal-content {
      overflow-y: auto;
      font-size: 0.9em;
    }
    .modal .modal-footer {
      text-align: right;
      padding: 10px;
      background: white;
      font-size: 0.9em;
    }
    table.striped {
      width: 100%;
    }
    table.striped th,
    table.striped td {
      padding: 8px;
      text-align: center;
    }
    input[type="number"] {
      width: 70px;
      font-size: 0.8em;
    }
  </style>
</head>

<body>
  <!-- Buttons -->
  <button id="connectEtsyBtn" class="configurable btn waves-effect waves-light">Connect to Etsy</button>
  <button id="openConfigBtn" class="configurable btn waves-effect waves-light">Open Config</button>

  <!-- Etsy Order Fields -->
  <input 
    type="text" 
    id="etsyOrderNumber" 
    placeholder="Etsy Order Number"
  />

  <textarea 
    id="orderInformation" 
    placeholder=" Order Information" 
    readonly
  ></textarea>

  <!-- Photo Grid -->
  <div id="Photo_Grid"></div>

  <!-- 16 text-box-absolute for quantity/metal -->
  <input type="text" id="quantityCell0" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell1" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell2" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell3" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell4" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell5" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell6" class="text-box-absolute" readonly />
  <input type="text" id="quantityCell7" class="text-box-absolute" readonly />

  <input type="text" id="metalCell0" class="text-box-absolute" readonly />
  <input type="text" id="metalCell1" class="text-box-absolute" readonly />
  <input type="text" id="metalCell2" class="text-box-absolute" readonly />
  <input type="text" id="metalCell3" class="text-box-absolute" readonly />
  <input type="text" id="metalCell4" class="text-box-absolute" readonly />
  <input type="text" id="metalCell5" class="text-box-absolute" readonly />
  <input type="text" id="metalCell6" class="text-box-absolute" readonly />
  <input type="text" id="metalCell7" class="text-box-absolute" readonly />

  <!-- Order Details -->
  <textarea id="orderDetails"></textarea>

  <!-- Title labels for Order/Ship date (0.7em) -->
  <div id="titleOrderDate">Order Date:</div>
  <div id="titleShipDate">Ship By:</div>

  <!-- Date/Ship Date boxes -->
  <input type="text" id="dateOrdered" placeholder="" />
  <input type="text" id="shipDate"    placeholder="" />

  <!-- Configuration Modal -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <table class="striped" id="configTable">
        <thead>
          <tr>
            <th>Component Name</th>
            <th>Left (px)</th>
            <th>Top (px)</th>
            <th>Width (px)</th>
            <th>Height (px)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <a href="#!" id="saveConfigBtn" class="modal-close waves-effect waves-green btn">Save Config</a>
    </div>
  </div>

  <!-- jQuery & Materialize -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"
  ></script>

  <script>
    /***********************************************************************
     * We now rename:
     *   "Status:" => "Payment Status:"
     *   "is_shipped:" => "Shipping Status:"
     * And we have the newly added labels #titleOrderDate & #titleShipDate
     ***********************************************************************/
    window.orderName       = ""; 
    window.orderStatus     = "";
    window.orderIsShipped  = "";
    window.cachedOrderItems= [];

    /********** Check for Access Token / Code **********/
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const accessToken = urlParams.get("access_token");
      if (accessToken) {
        localStorage.setItem("access_token", accessToken);
        window.history.replaceState({}, document.title, window.location.pathname);
        M.toast({ html: "Connection Successful!" });
        console.log("Access token received:", accessToken);
      } else {
        const authCode = urlParams.get("code");
        if (authCode) {
          const storedCodeVerifier = localStorage.getItem("etsy_code_verifier");
          if (storedCodeVerifier) {
            window.location.href = "/.netlify/functions/exchangeToken?code="
                                   + encodeURIComponent(authCode)
                                   + "&code_verifier="
                                   + encodeURIComponent(storedCodeVerifier);
          } else {
            console.error("No code verifier found in localStorage.");
          }
        }
      }
    })();

    /********** Etsy OAuth: Connect to Etsy **********/
    function generateRandomString(length) {
      const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let text="";
      for(let i=0;i<length;i++){
        text+=chars.charAt(Math.floor(Math.random()*chars.length));
      }
      return text;
    }
    
    async function generateCodeChallenge(codeVerifier) {
      const encoder=new TextEncoder();
      const data=encoder.encode(codeVerifier);
      const digest=await crypto.subtle.digest("SHA-256",data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
              .replace(/\+/g,"-")
              .replace(/\//g,"_")
              .replace(/=+$/,"");
    }

    document.getElementById("connectEtsyBtn").addEventListener("click", async ()=>{
      const codeVerifier=generateRandomString(64);
      localStorage.setItem("etsy_code_verifier",codeVerifier);
      const codeChallenge=await generateCodeChallenge(codeVerifier);
      const state="randomState123";
      const scope="listings_w listings_r transactions_r transactions_w";
      const CLIENT_ID="k75zdspz4r99txpqdji7i2em"; 
      const redirectUri="https://gokushipping.netlify.app"; 
      const etsyAuthUrl=`https://www.etsy.com/oauth/connect?response_type=code`
                       +`&client_id=${CLIENT_ID}`
                       +`&redirect_uri=${encodeURIComponent(redirectUri)}`
                       +`&scope=${encodeURIComponent(scope)}`
                       +`&state=${state}`
                       +`&code_challenge=${encodeURIComponent(codeChallenge)}`
                       +`&code_challenge_method=S256`;
      console.log("Redirecting to Etsy OAuth URL:",etsyAuthUrl);
      window.location.href=etsyAuthUrl;
    });

    /********** UI Configuration **********/
    const configComponentIDs=[
      "connectEtsyBtn",
      "openConfigBtn",
      "etsyOrderNumber",
      "orderInformation",
      "Photo_Grid",
      "quantityCell0","quantityCell1","quantityCell2","quantityCell3","quantityCell4","quantityCell5","quantityCell6","quantityCell7",
      "metalCell0","metalCell1","metalCell2","metalCell3","metalCell4","metalCell5","metalCell6","metalCell7",
      "orderDetails",
      "dateOrdered",
      "shipDate",
      "titleOrderDate",
      "titleShipDate"
    ];

    function loadPositions(){
      configComponentIDs.forEach(id=>{
        const el=document.getElementById(id);
        if(el){
          const left=localStorage.getItem("pos-"+id+"-left");
          const top=localStorage.getItem("pos-"+id+"-top");
          const width=localStorage.getItem("pos-"+id+"-width");
          const height=localStorage.getItem("pos-"+id+"-height");
          if(left!==null)   el.style.left=left+"px";
          if(top!==null)    el.style.top=top+"px";
          if(width!==null)  el.style.width=width+"px";
          if(height!==null) el.style.height=height+"px";
        }
      });
    }
    function populateConfigTable(){
      const tbody=document.getElementById("configTable").querySelector("tbody");
      tbody.innerHTML="";
      configComponentIDs.forEach(id=>{
        const el=document.getElementById(id);
        if(!el)return;
        const compName=el.textContent.trim()||el.value?.trim()||id;
        const cs=window.getComputedStyle(el);
        const leftVal=(cs.left==="auto")?0:parseInt(cs.left);
        const topVal=(cs.top==="auto")?0:parseInt(cs.top);
        const widthVal=(cs.width==="auto")?0:parseInt(cs.width);
        const heightVal=(cs.height==="auto")?0:parseInt(cs.height);

        const row=document.createElement("tr");
        row.innerHTML=`
          <td>${compName}</td>
          <td><input type="number" value="${leftVal}" data-id="${id}" class="left-input"></td>
          <td><input type="number" value="${topVal}" data-id="${id}" class="top-input"></td>
          <td><input type="number" value="${widthVal}" data-id="${id}" class="width-input"></td>
          <td><input type="number" value="${heightVal}" data-id="${id}" class="height-input"></td>
        `;
        tbody.appendChild(row);

        // Live updates
        row.querySelector(".left-input").addEventListener("input",function(){
          const target=document.getElementById(this.getAttribute("data-id"));
          if(target)target.style.left=parseInt(this.value)+"px";
        });
        row.querySelector(".top-input").addEventListener("input",function(){
          const target=document.getElementById(this.getAttribute("data-id"));
          if(target)target.style.top=parseInt(this.value)+"px";
        });
        row.querySelector(".width-input").addEventListener("input",function(){
          const target=document.getElementById(this.getAttribute("data-id"));
          if(target)target.style.width=parseInt(this.value)+"px";
        });
        row.querySelector(".height-input").addEventListener("input",function(){
          const target=document.getElementById(this.getAttribute("data-id"));
          if(target)target.style.height=parseInt(this.value)+"px";
        });
      });
    }
    function saveConfiguration(){
      configComponentIDs.forEach(id=>{
        const el=document.getElementById(id);
        if(el){
          const cs=window.getComputedStyle(el);
          const leftVal=parseInt(cs.left)||0;
          const topVal=parseInt(cs.top)||0;
          const widthVal=parseInt(cs.width)||0;
          const heightVal=parseInt(cs.height)||0;
          localStorage.setItem("pos-"+id+"-left",  leftVal);
          localStorage.setItem("pos-"+id+"-top",   topVal);
          localStorage.setItem("pos-"+id+"-width", widthVal);
          localStorage.setItem("pos-"+id+"-height",heightVal);
        }
      });
      console.log("Configuration saved.");
    }

    /***********************************************************************
     * showItemDetails(index):
     *  - " ORDER FROM: [name]"
     *  - " Payment Status: [status]"
     *  - " Shipping Status: Shipped!/Not Shipped"
     *  - blank line
     *  - " ORDER DETAILS:"
     ***********************************************************************/
    function showItemDetails(index){
      if(!window.cachedOrderItems||!window.cachedOrderItems[index]){
        console.warn("No item at index:",index);
        return;
      }
      const item=window.cachedOrderItems[index];

      let details="";

      // 1) "ORDER FROM: [name]"
      if(window.orderName){
        details += " ORDER FROM: " + window.orderName + "\n";
      }

      // 2) "Status:" => "Payment Status:"
      if(window.orderStatus){
        details += " Payment Status: " + window.orderStatus + "\n";
      }

      // 3) "is_shipped:" => "Shipping Status:"
      if(window.orderIsShipped){
        details += " Shipping Status: " + window.orderIsShipped + "\n\n";
      } else {
        details += "\n"; 
      }

      // 4) " ORDER DETAILS:"
      details += " ORDER DETAILS:\n\n"; 

      // Title
      if(item.title){
        const firstFourWords=item.title.trim().split(" ").slice(0,4).join(" ");
        details+=" Title: " + firstFourWords + "\n";
      }

      // SKU
      if(item.sku){
        details+=" SKU: " + item.sku + "\n";
      }

      // Variation logic
      if(item.variations && Array.isArray(item.variations)){
        const acceptedMetalNames=[
          "metal","metal choice","metal - engraving","metal colour","color","metal choice / engraving option"
        ];
        const acceptedLengthNames=[
          "length","necklace length","metal/necklace length","metal choice / necklace length","necklace length in inches"
        ];
        item.variations.forEach(v=>{
          if(v.formatted_name && v.formatted_value){
            const nameLower=v.formatted_name.trim().toLowerCase();
            let val=v.formatted_value.trim();
            if(nameLower==="personalization" && val==="Not requested on this item."){
              val="Not Requested";
              details+=" Personalization: " + val + "\n";
            } else if(acceptedMetalNames.includes(nameLower)){
              details+=" Metal Choice: " + val + "\n";
            } else if(acceptedLengthNames.includes(nameLower)){
              const lengthMapping={
                '14&quot;':'14 Inches','16&quot;':'16 Inches','18&quot;':'18 Inches','20&quot;':'20 Inches',
                '14""':'14 Inches','16""':'16 Inches','18""':'18 Inches','20""':'20 Inches'
              };
              if(lengthMapping[val]){
                val=lengthMapping[val];
              }
              details+=" Item Length: " + val + "\n";
            } else {
              details+=" " + v.formatted_name + ": " + v.formatted_value + "\n";
            }
          }
        });
      }

      document.getElementById("orderDetails").value=details;
    }

    /********** fetchListingImages **********/
    async function fetchListingImages(listingId){
      const response=await fetch(`/.netlify/functions/etsyImages?listingId=${listingId}`,{
        headers:{"access-token":localStorage.getItem("access_token")}
      });
      if(!response.ok){
        throw new Error(`Error fetching images for listing ${listingId}: ${response.statusText}`);
      }
      const data=await response.json();
      return data.results;
    }

    /********** updateImageGrid **********/
    async function updateImageGrid(data){
      let items=[];
      if(data.transactions && Array.isArray(data.transactions)){
        items=data.transactions;
      } else if(data.shipments && Array.isArray(data.shipments)){
        items=data.shipments;
      } else if(Array.isArray(data)){
        items=data;
      } else if(data.results && Array.isArray(data.results)){
        items=data.results;
      } else if(data.orders && Array.isArray(data.orders)){
        items=data.orders;
      } else if(typeof data==='object' && data!==null){
        for(const key in data){
          if(Array.isArray(data[key])){
            items=data[key];
            break;
          }
        }
      }
      window.cachedOrderItems=items;

      for(let i=0;i<8;i++){
        const cell=document.getElementById("previewCell"+i);
        const qtyBox=document.getElementById("quantityCell"+i);
        const metalBox=document.getElementById("metalCell"+i);

        if(cell){
          if(i<items.length){
            const item=items[i];
            try{
              const images=await fetchListingImages(item.listing_id);
              if(images && images.length>0){
                cell.innerHTML=`<img src="${images[0].url_fullxfull}" alt="Listing Image ${i}">`;
              } else {
                cell.innerHTML="No images found";
              }
            } catch(err){
              console.error(`Error fetching listing ${item.listing_id}:`,err);
              cell.innerHTML="Error loading image";
            }
            cell.style.cursor="pointer";
            cell.onclick=()=>{ showItemDetails(i); };

            // quantity => leading space
            if(qtyBox){
              const actualQty=(item.quantity!=null)?item.quantity:0;
              qtyBox.value=" Quantity: "+actualQty;
            }
            // metal => leading space
            if(metalBox){
              let metalSelection="";
              if(item.variations && Array.isArray(item.variations)){
                const acceptedMetalNames=[
                  "metal","metal choice","metal - engraving","metal colour","color","metal choice / engraving option"
                ];
                const metalVar=item.variations.find(v=>
                  v.formatted_name && acceptedMetalNames.includes(v.formatted_name.trim().toLowerCase())
                );
                if(metalVar){
                  metalSelection=metalVar.formatted_value||"";
                }
              }
              metalBox.value=" Metal: "+metalSelection;
            }
          } else {
            cell.innerHTML="Empty";
            cell.style.cursor="default";
            cell.onclick=null;
            if(qtyBox)   qtyBox.value="";
            if(metalBox) metalBox.value="";
          }
        }
      }

      // default => item 0
      if(items.length>0){
        showItemDetails(0);
      } else {
        document.getElementById("orderDetails").value=" ORDER DETAILS:\n\nNo items found.";
      }
    }

    /********** pullEtsyOrderDetails **********/
    function pullEtsyOrderDetails(orderNumber){
      console.log("Pulling Etsy order details for order number:",orderNumber);
      const token=localStorage.getItem("access_token");
      return fetch('/.netlify/functions/etsyOrderProxy?orderId='+encodeURIComponent(orderNumber),{
        headers:{"access-token":token}
      })
      .then(r=>r.json())
      .then(data=>{
        console.log("Etsy Order Data:",data);

        // leading space in #orderInformation
        document.getElementById("orderInformation").value=" "+JSON.stringify(data,null,2);

        // name => window.orderName
        if(data.name){
          window.orderName=data.name;
        } else {
          window.orderName="";
        }

        // status => window.orderStatus
        if(data.status){
          window.orderStatus=data.status;
        } else {
          window.orderStatus="";
        }

        // is_shipped => window.orderIsShipped => Shipped!/Not Shipped
        if(data.is_shipped===true){
          window.orderIsShipped="Shipped!";
        } else if(data.is_shipped===false){
          window.orderIsShipped="Not Shipped";
        } else {
          window.orderIsShipped="";
        }

        if(data.transactions && data.transactions.length>0){
          const firstTrans=data.transactions[0];
          const monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

          // Date Ordered => leading space
          if(firstTrans.created_timestamp){
            const d=new Date(firstTrans.created_timestamp*1000);
            const day=String(d.getDate()).padStart(2,'0');
            const mStr=monthNames[d.getMonth()];
            const yr=d.getFullYear();
            document.getElementById("dateOrdered").value=" "+day+" "+mStr+" "+yr;
          } else {
            document.getElementById("dateOrdered").value="";
          }

          // Ship Date => leading space
          if(firstTrans.expected_ship_date){
            const s=new Date(firstTrans.expected_ship_date*1000);
            const sDay=String(s.getDate()).padStart(2,'0');
            const sMonth=monthNames[s.getMonth()];
            const sYear=s.getFullYear();
            document.getElementById("shipDate").value=" "+sDay+" "+sMonth+" "+sYear;
          } else {
            document.getElementById("shipDate").value="";
          }
        } else {
          document.getElementById("dateOrdered").value="";
          document.getElementById("shipDate").value="";
        }
        return data;
      })
      .catch(err=>{
        console.error("Error fetching Etsy order details:",err);
        return null;
      });
    }

    /********** DOMContentLoaded **********/
    document.addEventListener("DOMContentLoaded",()=>{
      M.AutoInit();

      // Load imageGrid.html
      $("#Photo_Grid").load("imageGrid.html",(resp,status,xhr)=>{
        if(status==="error"){
          console.error("Error loading image grid:",xhr.status,xhr.statusText);
        } else {
          console.log("Image grid loaded successfully.");
        }
      });
      document.body.style.opacity=0;
      setTimeout(()=>{
        loadPositions();
        document.body.style.opacity=1;
      },250);

      // open config
      document.getElementById("openConfigBtn").addEventListener("click",()=>{
        populateConfigTable();
        const modalElem=document.getElementById("configModal");
        const instance=M.Modal.getInstance(modalElem);
        instance.open();
      });
      // save config
      document.getElementById("saveConfigBtn").addEventListener("click",()=>{
        saveConfiguration();
      });

      // Press Enter => fetch order => update grid
      const etsyOrderInput=document.getElementById("etsyOrderNumber");
      etsyOrderInput.addEventListener("keydown",async e=>{
        if(e.key==="Enter"){
          const orderNumber=etsyOrderInput.value.trim();
          if(orderNumber!==""){
            const orderData=await pullEtsyOrderDetails(orderNumber);
            if(orderData){
              await updateImageGrid(orderData);
            }
          }
        }
      });
    });
  </script>
</body>
</html>