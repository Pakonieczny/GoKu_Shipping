<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game-Generator-1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    :root { --bg:#0b0d12; --card:#121624; --muted:#8b93a7; --text:#e9ecf5; --line:#242a3d; --accent: #2b6cff; --success: #7fdb96; --danger: #fca5a5; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    .wrap{ padding:14px; display:grid; grid-template-columns: 350px 1fr; gap:14px; max-width: 1600px; margin: 0 auto;}
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; }
    h1{ font-size:18px; margin:0 0 14px 0; color: #fff;}
    h2{ font-size:14px; margin:0 0 10px 0; color: var(--muted);}
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    select, input, textarea { width:100%; border-radius:10px; border:1px solid var(--line); background:#0e1220; color:var(--text); padding:10px; box-sizing:border-box; outline: none; font-family: inherit; }
    textarea { line-height: 1.4; }
    .row{ display:flex; gap:8px; align-items: center; }
    .btn{ cursor:pointer; border-radius:12px; border:1px solid var(--line); padding:10px 12px; background:#0e1220; color:var(--text); font-weight: 600; transition: all 0.2s;}
    .btn:hover{ background: #1a1e2b; }
    .btnPrimary { background: var(--accent); color: #fff; border-color: #1a4bbf; }
    .btnPrimary:hover { background: #1a4bbf; }
    .btnDanger { color: var(--danger); border-color: #7a3838; background: #3d1c1c; }
    .btnDanger:hover { background: #5c2424; }
    .btnSmall{ padding:6px 10px; border-radius:8px; font-size:11px; line-height:1; }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }
    
    .drop-zone {
      border: 2px dashed #3a4262; border-radius: 14px; padding: 16px; background: #0e1220;
      transition: all 0.2s ease; display: flex; flex-direction: column; gap: 10px; margin-bottom: 14px;
    }
    .drop-zone.hover { border-color: var(--success); background: #13221c; }
    .drop-header { display: flex; justify-content: space-between; align-items: center; }
    .drop-header strong { font-size: 14px; color: #fff; }
    .drop-header span { font-size: 11px; color: var(--muted); background: #1a1e2b; padding: 3px 8px; border-radius: 999px; }
    
    .file-list { display: flex; flex-direction: column; gap: 6px; }
    .file-item { 
      display: flex; justify-content: space-between; align-items: center; 
      background: #0b0d12; border: 1px solid var(--line); padding: 8px 12px; border-radius: 8px; font-size: 12px;
    }
    .file-name { word-break: break-all; margin-right: 10px; }
    .file-actions { display: flex; gap: 6px; }

    /* Progress UI */
    .status-bar { margin-top: 10px; padding: 10px; border-radius: 10px; background: #0e1220; border: 1px solid var(--line); font-size: 12px; color: var(--success); display: none;}
    .status-bar.active { display: block; }

    /* Visual Feedback for AI Updates */
    @keyframes pulse-border {
      0% { border-color: var(--line); box-shadow: 0 0 0 rgba(127, 219, 150, 0); }
      50% { border-color: var(--success); box-shadow: 0 0 10px rgba(127, 219, 150, 0.4); }
      100% { border-color: var(--line); box-shadow: 0 0 0 rgba(127, 219, 150, 0); }
    }
    .pulse-update {
      animation: pulse-border 2s ease-out;
    }
  </style>
</head>

<body>
  <div class="wrap">
    
    <div class="card">
      <h1>Game Generator Projects</h1>
      
      <label>Active Project</label>
      <select id="projectSelect">
        <option value="">Loading projects...</option>
      </select>

      <div style="margin-top: 20px; border-top: 1px solid var(--line); padding-top: 20px;">
        <label>Create New Project</label>
        <div class="row">
          <input type="text" id="newProjectName" placeholder="e.g. SpaceShooter_v1" />
          <button class="btn btnPrimary" id="createProjectBtn">Create</button>
        </div>
      </div>

      <div id="globalStatus" class="status-bar">System ready.</div>
      <div id="progressContainer" style="display: none; margin-top: 10px; background: var(--line); border-radius: 8px; height: 8px; overflow: hidden;">
        <div id="progressBar" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.2s ease;"></div>
      </div>
    </div>

    <div class="card" id="mainPanel" style="opacity: 0.5; pointer-events: none;">
      <div class="row" style="justify-content: space-between; margin-bottom: 20px;">
        <h1>Project Assets Manager</h1>
        <div class="row">
            <button class="btn btnPrimary" id="generateGameBtn" disabled>Generate Game Zip</button>
        </div>
      </div>

      <div id="dropZones">
      </div>

      <div style="margin-top: 30px; border-top: 1px solid var(--line); padding-top: 20px;">
        <h2>AI Context Window</h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <div id="aiChatLog" style="height: 150px; overflow-y: auto; background: #0b0d12; border: 1px solid var(--line); border-radius: 10px; padding: 10px; font-size: 12px; font-family: monospace; display: flex; flex-direction: column; gap: 8px;">
            <div style="color: var(--muted);">AI Context ready. Enter instructions below to modify the active project.</div>
          </div>
          
          <textarea id="aiPromptInput" placeholder="e.g., 'Change the player movement speed in main.js to 500 and update the index.html title...'" style="min-height: 80px; resize: vertical;"></textarea>
          
          <div class="row" style="justify-content: flex-end;">
            <button class="btn btnPrimary" id="sendToAiBtn">Apply AI Update</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    // ADDED uploadString to the imports below
    import { getStorage, ref, uploadBytesResumable, uploadString, getDownloadURL, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const ROOT = "game-generator-1/projects";
    
    // Config matches your Listing Generator
    const firebaseConfig = {
      apiKey: "AIzaSyBXhQLsYRa4i0bX1TPTRiElF9Zjy5vSHlA",
      authDomain: "gokudatabase.firebaseapp.com",
      projectId: "gokudatabase",
      storageBucket: "gokudatabase.firebasestorage.app",
      messagingSenderId: "1078662308113",
      appId: "1:1078662308113:web:41df0e5d229ff2af7a6cb0"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const auth = getAuth(app);

    // Categories config
    const FILE_CATEGORIES = [
      { id: "models", title: "3D Models", accepts: ".obj,.glb,.fbx,.js,.mtl", folder: "models" },
      { id: "html", title: "HTML Framework", accepts: ".html", folder: "html" },
      { id: "json", title: "JSON Configs", accepts: ".json", folder: "json" },
      { id: "js", title: "JavaScript Logic", accepts: ".js", folder: "js" },
      { id: "reference", title: "Reference Project ZIP", accepts: ".zip", folder: "reference_zip" }
    ];

    let currentProject = null;

    // --- UI Elements ---
    const projectSelect = document.getElementById('projectSelect');
    const newProjectName = document.getElementById('newProjectName');
    const createProjectBtn = document.getElementById('createProjectBtn');
    const mainPanel = document.getElementById('mainPanel');
    const dropZonesContainer = document.getElementById('dropZones');
    const globalStatus = document.getElementById('globalStatus');
    const generateGameBtn = document.getElementById('generateGameBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');

    // AI UI Elements
    const aiPromptInput = document.getElementById('aiPromptInput');
    const sendToAiBtn = document.getElementById('sendToAiBtn');
    const aiChatLog = document.getElementById('aiChatLog');

    function setStatus(msg) {
        globalStatus.textContent = msg;
        globalStatus.classList.add('active');
        setTimeout(() => globalStatus.classList.remove('active'), 4000);
    }

    // --- Auth Initialization ---
    async function ensureAuth() {
      if (auth.currentUser) return auth.currentUser;
      try { await signInAnonymously(auth); } catch(e) { console.error("Auth failed", e); }
      return new Promise(resolve => {
        const unsub = onAuthStateChanged(auth, u => {
          if (u) { unsub(); resolve(u); }
        });
      });
    }

    // --- Project Management ---
    async function loadProjects() {
      await ensureAuth();
      const listRef = ref(storage, ROOT);
      try {
        const res = await listAll(listRef);
        projectSelect.innerHTML = res.prefixes.length > 0 ? '' : '<option value="">No projects found</option>';
        
        res.prefixes.forEach(folderRef => {
          const opt = document.createElement('option');
          opt.value = folderRef.name;
          opt.textContent = folderRef.name;
          projectSelect.appendChild(opt);
        });

        if (res.prefixes.length > 0) {
          selectProject(projectSelect.value);
        }
      } catch (e) {
        console.error("Error loading projects", e);
        projectSelect.innerHTML = '<option value="">Error loading</option>';
      }
    }

    createProjectBtn.addEventListener('click', async () => {
      const name = newProjectName.value.trim().replace(/[^a-zA-Z0-9_-]/g, '_');
      if (!name) return alert("Enter a valid project name.");
      
      setStatus(`Creating project: ${name}...`);
      await ensureAuth();
      
      const dummyRef = ref(storage, `${ROOT}/${name}/meta.json`);
      const blob = new Blob([JSON.stringify({ created: new Date() })], { type: 'application/json' });
      await uploadBytesResumable(dummyRef, blob);
      
      newProjectName.value = '';
      await loadProjects();
      projectSelect.value = name;
      selectProject(name);
    });

    projectSelect.addEventListener('change', (e) => selectProject(e.target.value));

    function selectProject(name) {
      if (!name) return;
      currentProject = name;
      mainPanel.style.opacity = '1';
      mainPanel.style.pointerEvents = 'all';
      
      generateGameBtn.disabled = false; 

      setStatus(`Switched to project: ${name}`);
      renderDropZones();
      refreshAllFiles();
      aiChatLog.innerHTML = `<div style="color: var(--muted);">AI Context ready for project: ${name}. Enter instructions below.</div>`;
    }

    // --- Drag & Drop UI & Logic ---
    function renderDropZones() {
      dropZonesContainer.innerHTML = '';
      
      FILE_CATEGORIES.forEach(cat => {
        const zone = document.createElement('div');
        zone.className = 'drop-zone';
        zone.id = `zone_${cat.id}`;
        
        zone.innerHTML = `
          <div class="drop-header">
            <strong>${cat.title}</strong>
            <span>Accepts: ${cat.accepts}</span>
          </div>
          <div class="file-list" id="list_${cat.id}">
             <div style="font-size:11px; color:var(--muted);">Loading files...</div>
          </div>
          <input type="file" accept="${cat.accepts}" id="input_${cat.id}" style="display:none;" />
          <button class="btn btnSmall" onclick="document.getElementById('input_${cat.id}').click()" style="width: max-content;">+ Upload File</button>
        `;

        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('hover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('hover'));
        zone.addEventListener('drop', async (e) => {
          e.preventDefault();
          zone.classList.remove('hover');
          handleFiles(e.dataTransfer.files, cat);
        });

        const fileInput = zone.querySelector(`#input_${cat.id}`);
        fileInput.addEventListener('change', (e) => {
          handleFiles(e.target.files, cat);
          fileInput.value = ''; 
        });

        dropZonesContainer.appendChild(zone);
      });
    }

    async function handleFiles(files, categoryConfig, specificName = null) {
      if (!files || files.length === 0) return;
      await ensureAuth();

      const validExts = categoryConfig.accepts.split(',');
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        const parts = file.name.split('.');
        const hasExtension = parts.length > 1;
        const fileExt = hasExtension ? '.' + parts.pop().toLowerCase() : '';
        
        if (hasExtension && !validExts.includes(fileExt)) {
           alert(`Invalid file: ${file.name}. Expected ${categoryConfig.accepts}`);
           continue;
        }

        const fileName = specificName || file.name.replace(/[^a-zA-Z0-9_.-]/g, '_');
        const path = `${ROOT}/${currentProject}/${categoryConfig.folder}/${fileName}`;
        const targetRef = ref(storage, path);
        
        setStatus(`Uploading ${fileName}...`);
        
        try {
          await new Promise((resolve, reject) => {
            const task = uploadBytesResumable(targetRef, file);
            task.on('state_changed', null, reject, resolve);
          });
        } catch(e) {
          console.error("Upload failed", e);
          alert(`Upload failed for ${fileName}`);
        }
      }
      
      setStatus(`Uploads complete.`);
      refreshFileList(categoryConfig);
    }

    // --- File Listing & Actions ---
    async function refreshAllFiles() {
      FILE_CATEGORIES.forEach(cat => refreshFileList(cat));
    }

    async function refreshFileList(categoryConfig) {
      if (!currentProject) return;
      const listContainer = document.getElementById(`list_${categoryConfig.id}`);
      if (!listContainer) return;
      
      const folderRef = ref(storage, `${ROOT}/${currentProject}/${categoryConfig.folder}`);
      
      try {
        const res = await listAll(folderRef);
        listContainer.innerHTML = '';
        
        if (res.items.length === 0) {
            listContainer.innerHTML = `<div style="font-size:11px; color:var(--muted);">No files uploaded. Drag & Drop here.</div>`;
            return;
        }

        res.items.forEach(itemRef => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'file-item';
          itemDiv.id = `item_${itemRef.name.replace(/[^a-zA-Z0-9]/g, '_')}`; // For animations
          
          itemDiv.innerHTML = `
            <div class="file-name">${itemRef.name}</div>
            <div class="file-actions">
               <input type="file" style="display:none;" id="replace_${itemRef.name}" accept="${categoryConfig.accepts}">
               <button class="btn btnSmall" onclick="document.getElementById('replace_${itemRef.name}').click()">Replace</button>
               <button class="btn btnSmall btnDanger" id="del_${itemRef.name}">Delete</button>
            </div>
          `;

          itemDiv.querySelector(`[id="del_${itemRef.name}"]`).addEventListener('click', async () => {
             if(confirm(`Delete ${itemRef.name}?`)) {
                 setStatus(`Deleting ${itemRef.name}...`);
                 await deleteObject(itemRef);
                 refreshFileList(categoryConfig);
                 setStatus(`Deleted.`);
             }
          });

          itemDiv.querySelector(`[id="replace_${itemRef.name}"]`).addEventListener('change', (e) => {
              handleFiles(e.target.files, categoryConfig, itemRef.name);
          });

          listContainer.appendChild(itemDiv);
        });

      } catch (e) {
        console.error(`Error loading files for ${categoryConfig.id}`, e);
        listContainer.innerHTML = `<div style="font-size:11px; color:var(--danger);">Error fetching files.</div>`;
      }
    }

    // --- AI Context Window Logic & Loop ---
    function appendToChatLog(sender, message, type = 'normal') {
      const msgDiv = document.createElement('div');
      const color = sender === 'AI' ? 'var(--success)' : (type === 'error' ? 'var(--danger)' : 'var(--text)');
      msgDiv.innerHTML = `<strong style="color: ${color}">${sender}:</strong> ${message}`;
      aiChatLog.appendChild(msgDiv);
      aiChatLog.scrollTop = aiChatLog.scrollHeight;
    }

    sendToAiBtn.addEventListener('click', async () => {
      const prompt = aiPromptInput.value.trim();
      if (!prompt || !currentProject) return;

      aiPromptInput.value = '';
      sendToAiBtn.disabled = true;
      appendToChatLog('You', prompt);
      appendToChatLog('System', 'Gathering active project text files...', 'muted');

      try {
        // 1. Gather all text-based files (HTML, JS, JSON). We do not send binary 3D models.
        const textCategories = FILE_CATEGORIES.filter(c => ['html', 'js', 'json'].includes(c.id));
        const projectFiles = {};

        for (const cat of textCategories) {
          const folderRef = ref(storage, `${ROOT}/${currentProject}/${cat.folder}`);
          let res;
          try { res = await listAll(folderRef); } catch (e) { continue; } // Folder might not exist yet
          
          for (const itemRef of res.items) {
            const url = await getDownloadURL(itemRef);
            const fetched = await fetch(url);
            const text = await fetched.text();
            projectFiles[`${cat.folder}/${itemRef.name}`] = text; 
          }
        }

        if (Object.keys(projectFiles).length === 0) {
          throw new Error("No text files (HTML, JS, JSON) found in the project to edit.");
        }

        // 2. Send to Gemini Backend Proxy
        appendToChatLog('System', 'Analyzing and writing code...', 'muted');
        setStatus('AI is processing files...');
        
        const response = await fetch('/.netlify/functions/geminiCodeProxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, files: projectFiles })
        });

        if (!response.ok) throw new Error(`Server responded with HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (!result.updatedFiles || !Array.isArray(result.updatedFiles)) {
          throw new Error("Invalid response format from AI.");
        }

        // 3. Write updated files back to Firebase
        appendToChatLog('System', `Writing ${result.updatedFiles.length} updated files to Firebase...`, 'muted');
        
        for (const file of result.updatedFiles) {
          const targetRef = ref(storage, `${ROOT}/${currentProject}/${file.path}`);
          await uploadString(targetRef, file.content);
          
          // Visual feedback: Highlight the category zone temporarily
          const catFolder = file.path.split('/')[0];
          const catConfig = FILE_CATEGORIES.find(c => c.folder === catFolder);
          if (catConfig) {
            const zone = document.getElementById(`zone_${catConfig.id}`);
            if (zone) {
              zone.classList.remove('pulse-update'); // reset if already pulsing
              void zone.offsetWidth; // trigger reflow
              zone.classList.add('pulse-update');
            }
          }
        }

        // 4. Update UI
        appendToChatLog('AI', result.message || "Files have been updated successfully.");
        setStatus('AI update complete.');
        
        // Refresh UI so new files/updated timestamps are synced visually
        refreshAllFiles();

      } catch (error) {
        console.error("AI Update Error:", error);
        appendToChatLog('System', `Error: ${error.message}`, 'error');
        setStatus('AI update failed.');
      } finally {
        sendToAiBtn.disabled = false;
      }
    });

    // --- Zip Generation Logic (Template Matcher) ---
    generateGameBtn.addEventListener('click', async () => {
      if (!currentProject) return;
      
      try {
        generateGameBtn.disabled = true;
        progressContainer.style.display = 'block';
        progressBar.style.width = '5%';
        setStatus(`Fetching Reference ZIP for ${currentProject}...`);
        
        const refFolder = ref(storage, `${ROOT}/${currentProject}/reference_zip`);
        const refList = await listAll(refFolder);
        
        if (refList.items.length === 0) {
           alert("No Reference ZIP found! Please upload one to the Reference Project ZIP drop zone first.");
           throw new Error("Missing reference zip");
        }
        
        const referenceZipRef = refList.items[0]; 
        const refUrl = await getDownloadURL(referenceZipRef);
        const refRes = await fetch(refUrl);
        const refBlob = await refRes.blob();
        
        progressBar.style.width = '15%';
        setStatus(`Loading template ZIP into memory...`);
        const zip = new JSZip();
        await zip.loadAsync(refBlob);
        const zipPaths = Object.keys(zip.files);
        
        progressBar.style.width = '20%';
        setStatus(`Indexing project files...`);
        let totalFiles = 0;
        let processedFiles = 0;
        const cachedCategories = {};

        for (const cat of FILE_CATEGORIES) {
          if (cat.id === 'reference') continue;
          const folderRef = ref(storage, `${ROOT}/${currentProject}/${cat.folder}`);
          try { 
             const res = await listAll(folderRef); 
             cachedCategories[cat.id] = res.items;
             totalFiles += res.items.length;
          } catch(e) { 
             cachedCategories[cat.id] = []; 
          }
        }

        for (const cat of FILE_CATEGORIES) {
          if (cat.id === 'reference') continue; 
          
          const items = cachedCategories[cat.id];
          
          for (const itemRef of items) {
            setStatus(`Processing ${itemRef.name}...`);
            const url = await getDownloadURL(itemRef);
            const response = await fetch(url);
            const blob = await response.blob();
            
            const match = zipPaths.find(p => p === itemRef.name || p.endsWith('/' + itemRef.name));
            if (match) {
               zip.file(match, blob);
            } else {
               let newPath = cat.id === 'html' ? itemRef.name : `${cat.folder}/${itemRef.name}`;
               zip.file(newPath, blob);
            }

            processedFiles++;
            if (totalFiles > 0) {
               const percentComplete = 20 + ((processedFiles / totalFiles) * 65);
               progressBar.style.width = `${percentComplete}%`;
            }
          }
        }
        
        progressBar.style.width = '90%';
        setStatus(`Compiling final Game ZIP...`);
        
        const finalZipBlob = await zip.generateAsync({ type: "blob", compression: "STORE" });
        
        progressBar.style.width = '100%';
        setStatus(`Game Zip Generated Successfully! Downloading...`);

        const downloadUrl = URL.createObjectURL(finalZipBlob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `${currentProject}_Custom_Build.zip`;
        document.body.appendChild(a);
        a.click();
        
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

      } catch (error) {
        console.error("Zip generation error:", error);
        setStatus(`Error generating zip. Check console.`);
        progressBar.style.backgroundColor = 'var(--danger)';
      } finally {
        generateGameBtn.disabled = false;
        generateGameBtn.textContent = "Generate Game Zip"; 
        
        setTimeout(() => {
           progressContainer.style.display = 'none';
           progressBar.style.width = '0%';
           progressBar.style.backgroundColor = 'var(--accent)';
        }, 3000);
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      loadProjects();
    });
  </script>
</body>
</html>