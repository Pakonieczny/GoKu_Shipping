<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>High-Resolution QR Code – Integrated Single Item Print</title>

  <!-- pdfmake (and its fonts) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/vfs_fonts.js"></script>

  <!-- qrcode.js (for generating QR) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    /* Basic styling for the preview area */
    #qrPreview {
      margin-top: 20px;
    }
    #qrPreview img {
      border: 1px solid #000;
    }
  </style>
</head>
<body>
  <h3>High-Resolution QR Code (32px) – Single Listing Iframe Print</h3>

  <!-- Fallback inputs, in case no listing is found in localStorage -->
  <label>
    Enter text for QR code:
    <input type="text" id="qrValue" value="fallback text" style="width:300px" />
  </label>
  <button id="generateBtn">Generate & Print</button>

  <!-- A simple preview area for the QR code (optional) -->
  <div id="qrPreview"></div>

  <script>
    /********************************************************
     * DOM references
     ********************************************************/
    const qrInput = document.getElementById("qrValue");
    const generateBtn = document.getElementById("generateBtn");
    const previewContainer = document.getElementById("qrPreview");

    // A hidden container to render the large QR code (for high-res)
    const hiddenQRContainer = document.createElement("div");
    hiddenQRContainer.style.display = "none";
    document.body.appendChild(hiddenQRContainer);

    /********************************************************
     * "generateBtn" click => Single listing logic
     ********************************************************/
    generateBtn.addEventListener("click", async () => {
      try {
        // 1) Check localStorage for "qrPrintSingle"
        const singleStr = localStorage.getItem("qrPrintSingle");
        if (singleStr) {
          // We have a single listing object => parse, build, print
          const item = JSON.parse(singleStr);
          if (item && item.receipt_id) {
            await buildAndPrintLabelForItem(item);
            return;
          }
        }

        // 2) Otherwise fallback to user text
        console.log("No single listing found, using fallback text from #qrValue...");
        await fallbackQR();
      } catch (err) {
        console.error("Error generating or printing the single listing code:", err);
        alert("Failed to generate or print. See console for details.");
      }
    });

    /********************************************************
     * Build & Print label for a single item
     ********************************************************/
    async function buildAndPrintLabelForItem(item) {
      // item has: receipt_id => order number, keywords => for dot count
      const orderNum = item.receipt_id || "UnknownOrder";
      const dotCount = getDotCountForKeywords(item.keywords || []);

      // A) Generate a large QR code for the orderNum
      hiddenQRContainer.innerHTML = "";
      await makeLargeQRCode(orderNum);

      // B) Grab the rendered <img> from hiddenQRContainer
      let qrImg = hiddenQRContainer.querySelector("img");
      if (!qrImg) {
        const qrCanvas = hiddenQRContainer.querySelector("canvas");
        if (qrCanvas) {
          qrImg = convertCanvasToImg(qrCanvas);
        }
      }
      if (!qrImg) {
        alert("No QR image found for listing " + (item.listing_id || "N/A"));
        return;
      }

      // Show a small preview (optional)
      previewContainer.innerHTML = "";
      const cloned = qrImg.cloneNode(true);
      cloned.style.width = "128px";
      cloned.style.height = "128px";
      previewContainer.appendChild(cloned);

      const dataUrl = qrImg.src;

      // C) Build docDefinition with correct # of dots
      const docDefinition = buildPDFDocWithDots(dataUrl, dotCount);

      // D) Render the PDF in an <iframe>, then auto print
      const pdfDocGenerator = pdfMake.createPdf(docDefinition);
      pdfDocGenerator.getBlob((blob) => {
        const blobUrl = URL.createObjectURL(blob);
        // Clear body or place an iframe somewhere
        document.body.innerHTML = "";
        const iframe = document.createElement("iframe");
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        document.body.appendChild(iframe);
        iframe.src = blobUrl;
        setTimeout(() => {
          iframe.contentWindow.print();
        }, 500);
      });
    }

    /********************************************************
     * Fallback if no "qrPrintSingle" is found
     ********************************************************/
    async function fallbackQR() {
      const text = qrInput.value.trim();
      if (!text) {
        alert("Enter a value for the fallback QR code!");
        return;
      }
      hiddenQRContainer.innerHTML = "";
      await makeLargeQRCode(text);

      let qrImg = hiddenQRContainer.querySelector("img");
      if (!qrImg) {
        const qrCanvas = hiddenQRContainer.querySelector("canvas");
        if (qrCanvas) {
          qrImg = convertCanvasToImg(qrCanvas);
        }
      }
      if (!qrImg) {
        alert("No fallback QR found!");
        return;
      }

      // Show a small preview
      previewContainer.innerHTML = "";
      const cloned = qrImg.cloneNode(true);
      cloned.style.width = "128px";
      cloned.style.height = "128px";
      previewContainer.appendChild(cloned);

      const dataUrl = qrImg.src;
      const docDefinition = buildPDFDocWithDots(dataUrl, 1); // e.g. 1 dot fallback?

      const pdfDocGenerator = pdfMake.createPdf(docDefinition);
      pdfDocGenerator.getBlob((blob) => {
        const blobUrl = URL.createObjectURL(blob);
        document.body.innerHTML = "";
        const iframe = document.createElement("iframe");
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        document.body.appendChild(iframe);
        iframe.src = blobUrl;
        setTimeout(() => {
          iframe.contentWindow.print();
        }, 500);
      });
    }

    /********************************************************
     * Dot Count Logic => 1 or 2 dots
     ********************************************************/
    function getDotCountForKeywords(keyArr) {
      if (!Array.isArray(keyArr) || !keyArr.length) return 0;

      // group A => 2 dots
      const groupA = ["stud","stud earrings","earring","earrings","ring","rings"];
      // group B => 1 dot
      const groupB = [
        "necklace","necklaces","huggie","huggies","huggie earrings",
        "hoop","hoops","hoop earrings","bracelet","bracelets",
        "extender","extenders","chain","chains"
      ];

      const lower = keyArr.map(k => k.toLowerCase());
      if (lower.some(x => groupA.includes(x))) return 2;
      if (lower.some(x => groupB.includes(x))) return 1;
      return 0;
    }

    /********************************************************
     * Build PDF docDefinition with the specified # of dots
     ********************************************************/
    function buildPDFDocWithDots(dataUrl, dotCount) {
      // We'll place the QR at (x=80,y=30), 32px wide
      // Each dot = 6px diameter => radius=3, spaced 12px
      const dotEllipses = [];
      if (dotCount > 0) {
        const spacing = 12;
        for (let i = 0; i < dotCount; i++) {
          dotEllipses.push({
            type: 'ellipse',
            x: i*spacing, y: 0,
            r1: 3, r2: 3,
            color: 'black', fillOpacity: 1
          });
        }
      }

      return {
        pageSize: { width: 288, height: 432 }, // 4x6
        pageMargins: [0,0,0,0],
        content: [
          {
            absolutePosition: { x:80, y:20 },
            canvas: dotEllipses
          },
          {
            image: dataUrl,
            width: 32,
            absolutePosition: { x:80, y:30 }
          }
        ]
      };
    }

    /********************************************************
     * Make a Large 1024×1024 QR => high-res
     ********************************************************/
    async function makeLargeQRCode(text) {
      return new Promise(resolve => {
        new QRCode(hiddenQRContainer, {
          text: text,
          width: 1024,
          height: 1024,
          correctLevel: QRCode.CorrectLevel.H
        });
        setTimeout(resolve, 300);
      });
    }

    /********************************************************
     * Convert a <canvas> to <img>
     ********************************************************/
    function convertCanvasToImg(canvas) {
      const dataUrl = canvas.toDataURL("image/png");
      const imgEl = document.createElement("img");
      imgEl.src = dataUrl;
      return imgEl;
    }
  </script>
</body>
</html>