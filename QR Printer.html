<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Auto-Print QR Code for Multiple Listings</title>

  <!-- pdfmake (and its fonts) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/vfs_fonts.js"></script>

  <!-- qrcode.js (for generating QR) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- No fallback UI, no headings, no user text input -->
  <style>
    /* Body reset to remove margin/padding */
    html, body {
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
<script>
/********************************************************
 * On page load, read 'qrPrintAll' from localStorage,
 * gather the entire set of listings for that order,
 * build a single 4×6 PDF label with:
 *   1) a QR code for the order number
 *   2) 0–2 black dot(s) depending on whether any item
 *      in the entire order belongs to GroupA or GroupB
 * Then auto-print that PDF in an iframe.
 ********************************************************/
window.addEventListener("load", async () => {
  try {
    // 1) Load all items from localStorage
    const allStr = localStorage.getItem("qrPrintAll");
    if (!allStr) {
      console.error("No 'qrPrintAll' found in localStorage. Nothing to print.");
      return;
    }

    // Must be an array of listings
    const items = JSON.parse(allStr);
    if (!Array.isArray(items) || !items.length) {
      console.error("No array or empty array in 'qrPrintAll'.");
      return;
    }

    // 2) Figure out an order number to embed in the QR
    //    e.g. assume they share the same .receipt_id => take items[0].receipt_id
    const orderNum = items[0].receipt_id || "UnknownOrder";

    // 3) Compute the dot count cumulatively from all listings
    //    If any listing => GroupA => 2 dots
    //    Else if none are GroupA but at least one => GroupB => 1 dot
    //    Else => 0
    const dotCount = getCumulativeDotCount(items);

    // 4) Build & print the PDF label
    await buildAndPrintLabel(orderNum, dotCount);

  } catch (err) {
    console.error("Error in QR Printer auto-run:", err);
  }
});

/********************************************************
 * getCumulativeDotCount(listings):
 * checks group A/B for each listing in the array.
 * If any listing is group A => 2 dots
 * else if any listing is group B => 1 dot
 * else => 0
 ********************************************************/
function getCumulativeDotCount(listings) {
  let foundGroupA = false;
  let foundGroupB = false;

  // group A => 2 dots
  const groupA = [
    "stud","stud earrings","earring","earrings","ring","rings"
  ];
  // group B => 1 dot
  const groupB = [
    "necklace","necklaces","huggie","huggies","huggie earrings",
    "hoop","hoops","hoop earrings","bracelet","bracelets",
    "extender","extenders","chain","chains"
  ];

  listings.forEach((listing) => {
    const kw = Array.isArray(listing.keywords) ? listing.keywords : [];
    const lower = kw.map(k => k.toLowerCase());

    // If any keyword is in groupA => mark foundGroupA
    if (lower.some(x => groupA.includes(x))) foundGroupA = true;
    // If any keyword is in groupB => mark foundGroupB
    if (lower.some(x => groupB.includes(x))) foundGroupB = true;
  });

  if (foundGroupA) return 2;
  if (foundGroupB) return 1;
  return 0;
}

/********************************************************
 * buildAndPrintLabel(orderNum, dotCount):
 * 1) Generate a high-res (1024×1024) QR code
 * 2) Build a 4×6 PDF => embed => auto-print
 ********************************************************/
async function buildAndPrintLabel(orderNum, dotCount) {
  // 1) Generate a large QR code (1024×1024) for high-res
  const hiddenQRContainer = document.createElement("div");
  hiddenQRContainer.style.display = "none";
  document.body.appendChild(hiddenQRContainer);

  await makeLargeQRCode(orderNum, hiddenQRContainer);

  // Try to grab the rendered <img> or else convert <canvas> to <img>
  let qrImg = hiddenQRContainer.querySelector("img");
  if (!qrImg) {
    const qrCanvas = hiddenQRContainer.querySelector("canvas");
    if (qrCanvas) {
      qrImg = convertCanvasToImg(qrCanvas);
    }
  }
  if (!qrImg) {
    console.error("No QR image rendered for order:", orderNum);
    return;
  }

  // 2) Build docDefinition with a 64px QR + dotCount dots
  const dataUrl = qrImg.src;
  const docDefinition = buildPDFDocWithDots(dataUrl, dotCount);

  // 3) Render PDF => embed => auto-print
  const pdfDocGenerator = pdfMake.createPdf(docDefinition);
  pdfDocGenerator.getBlob((blob) => {
    const blobUrl = URL.createObjectURL(blob);

    // Clear the page, embed PDF in a fullpage <iframe>
    document.body.innerHTML = "";
    const iframe = document.createElement("iframe");
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    document.body.appendChild(iframe);
    iframe.src = blobUrl;

    // Auto print after a short delay
    setTimeout(() => {
      iframe.contentWindow.print();
    }, 500);
  });
}

/********************************************************
 * buildPDFDocWithDots(dataUrl, dotCount):
 * Places the QR code at (x=80,y=30), 64px wide,
 * Dot(s) as small black circles at (x=0..12..24,y=0).
 ********************************************************/
function buildPDFDocWithDots(dataUrl, dotCount) {
  // Dot = 6px diameter => radius=3, spaced 12px
  const dotEllipses = [];
  if (dotCount > 0) {
    const spacing = 12;
    for (let i = 0; i < dotCount; i++) {
      dotEllipses.push({
        type: 'ellipse',
        x: i*spacing, y: 0,
        r1: 3, r2: 3,
        color: 'black', fillOpacity: 1
      });
    }
  }

  return {
    pageSize: { width: 288, height: 432 }, // 4×6 label in points
    pageMargins: [0,0,0,0],
    content: [
      {
        absolutePosition: { x:80, y:20 },
        canvas: dotEllipses
      },
      {
        image: dataUrl,
        width: 64,
        absolutePosition: { x:80, y:30 }
      }
    ]
  };
}

/********************************************************
 * makeLargeQRCode(text, container)
 * Renders a 1024×1024 high-res QR with qrcode.js
 ********************************************************/
async function makeLargeQRCode(text, container) {
  return new Promise(resolve => {
    new QRCode(container, {
      text: text,
      width: 1024,
      height: 1024,
      correctLevel: QRCode.CorrectLevel.H
    });
    setTimeout(resolve, 300);
  });
}

/********************************************************
 * convertCanvasToImg(canvas)
 * Takes a <canvas>, returns an <img> with the same image
 ********************************************************/
function convertCanvasToImg(canvas) {
  const dataUrl = canvas.toDataURL("image/png");
  const imgEl = document.createElement("img");
  imgEl.src = dataUrl;
  return imgEl;
}
</script>
</body>
</html>